# (C) Datadog, Inc. 2018-present
# All rights reserved
# Licensed under a 3-clause BSD style license (see LICENSE)
import os

from datadog_checks.cockroachdb.metrics import METRIC_MAP
from datadog_checks.dev import get_docker_hostname

HOST = get_docker_hostname()
PORT = '8080'

COCKROACHDB_VERSION = os.getenv('COCKROACHDB_VERSION')

KNOWN_HISTOGRAMS = {
    'admission_wait_durations_kv',
    'admission_wait_durations_kv_stores',
    'admission_wait_durations_sql_kv_response',
    'admission_wait_durations_sql_leaf_start',
    'admission_wait_durations_sql_root_start',
    'admission_wait_durations_sql_sql_response',
    'changefeed_admit_latency',
    'changefeed_checkpoint_hist_nanos',
    'changefeed_commit_latency',
    'changefeed_flush_hist_nanos',
    'changefeed_message_size_hist',
    'changefeed_sink_batch_hist_nanos',
    'exec_latency',
    'jobs_row_level_ttl_delete_duration',
    'jobs_row_level_ttl_range_total_duration',
    'jobs_row_level_ttl_select_duration',
    'kv_prober_read_latency',
    'kv_prober_write_latency',
    'liveness_heartbeatlatency',
    'raft_process_applycommitted_latency',
    'raft_process_commandcommit_latency',
    'raft_process_handleready_latency',
    'raft_process_logcommit_latency',
    'raft_scheduler_latency',
    'round_trip_latency',
    'sql_conn_latency',
    'sql_disk_distsql_max',
    'sql_distsql_exec_latency',
    'sql_distsql_exec_latency_internal',
    'sql_distsql_flows_queue_wait',
    'sql_distsql_service_latency',
    'sql_distsql_service_latency_internal',
    'sql_exec_latency',
    'sql_exec_latency_internal',
    'sql_mem_bulk_max',
    'sql_mem_distsql_max',
    'sql_mem_internal_session_max',
    'sql_mem_internal_txn_max',
    'sql_mem_root_max',
    'sql_mem_sql_txn_max',
    'sql_service_latency',
    'sql_service_latency_internal',
    'sql_stats_flush_duration',
    'sql_stats_mem_max',
    'sql_stats_reported_mem_max',
    'sql_stats_txn_stats_collection_duration',
    'sql_txn_latency',
    'sql_txn_latency_internal',
    'txn_durations',
    'txn_restarts',
    'txnwaitqueue_pusher_wait_time',
    'txnwaitqueue_query_wait_time',
}
KNOWN_COUNTERS = {
    'addsstable_applications',
    'addsstable_copies',
    'addsstable_proposals',
    'compactor_compactingnanos',
    'compactor_compactions_failure',
    'compactor_compactions_success',
    'compactor_suggestionbytes_compacted',
    'compactor_suggestionbytes_skipped',
    'distsender_batches',
    'distsender_batches_partial',
    'distsender_errors_notleaseholder',
    'distsender_rpc_sent',
    'distsender_rpc_sent_local',
    'distsender_rpc_sent_nextreplicaerror',
    'exec_error',
    'exec_success',
    'gossip_bytes_received',
    'gossip_bytes_sent',
    'gossip_connections_refused',
    'gossip_infos_received',
    'gossip_infos_sent',
    'leases_error',
    'leases_success',
    'leases_transfers_error',
    'leases_transfers_success',
    'liveness_epochincrements',
    'liveness_heartbeatfailures',
    'liveness_heartbeatsuccesses',
    'queue_consistency_process_failure',
    'queue_consistency_process_success',
    'queue_consistency_processingnanos',
    'queue_gc_info_abortspanconsidered',
    'queue_gc_info_abortspangcnum',
    'queue_gc_info_abortspanscanned',
    'queue_gc_info_intentsconsidered',
    'queue_gc_info_intenttxns',
    'queue_gc_info_numkeysaffected',
    'queue_gc_info_pushtxn',
    'queue_gc_info_resolvesuccess',
    'queue_gc_info_resolvetotal',
    'queue_gc_info_transactionspangcaborted',
    'queue_gc_info_transactionspangccommitted',
    'queue_gc_info_transactionspangcpending',
    'queue_gc_info_transactionspanscanned',
    'queue_gc_process_failure',
    'queue_gc_process_success',
    'queue_gc_processingnanos',
    'queue_raftlog_process_failure',
    'queue_raftlog_process_success',
    'queue_raftlog_processingnanos',
    'queue_raftsnapshot_process_failure',
    'queue_raftsnapshot_process_success',
    'queue_raftsnapshot_processingnanos',
    'queue_replicagc_process_failure',
    'queue_replicagc_process_success',
    'queue_replicagc_processingnanos',
    'queue_replicagc_removereplica',
    'queue_replicate_addreplica',
    'queue_replicate_process_failure',
    'queue_replicate_process_success',
    'queue_replicate_processingnanos',
    'queue_replicate_rebalancereplica',
    'queue_replicate_removedeadreplica',
    'queue_replicate_removereplica',
    'queue_replicate_transferlease',
    'queue_split_process_failure',
    'queue_split_process_success',
    'queue_split_processingnanos',
    'queue_tsmaintenance_process_failure',
    'queue_tsmaintenance_process_success',
    'queue_tsmaintenance_processingnanos',
    'raft_commandsapplied',
    'raft_process_tickingnanos',
    'raft_process_workingnanos',
    'raft_rcvd_app',
    'raft_rcvd_appresp',
    'raft_rcvd_dropped',
    'raft_rcvd_heartbeat',
    'raft_rcvd_heartbeatresp',
    'raft_rcvd_prevote',
    'raft_rcvd_prevoteresp',
    'raft_rcvd_prop',
    'raft_rcvd_snap',
    'raft_rcvd_timeoutnow',
    'raft_rcvd_transferleader',
    'raft_rcvd_vote',
    'raft_rcvd_voteresp',
    'raft_ticks',
    'raftlog_truncated',
    'range_adds',
    'range_raftleadertransfers',
    'range_removes',
    'range_snapshots_generated',
    'range_snapshots_normal_applied',
    'range_snapshots_preemptive_applied',
    'range_splits',
    'schedules_BACKUP_failed',
    'schedules_BACKUP_started',
    'schedules_BACKUP_succeeded',
    'sql_bytesin',
    'sql_bytesout',
    'sql_ddl_count',
    'sql_delete_count',
    'sql_distsql_flows_total',
    'sql_distsql_queries_total',
    'sql_distsql_select_count',
    'sql_insert_count',
    'sql_misc_count',
    'sql_query_count',
    'sql_select_count',
    'sql_txn_abort_count',
    'sql_txn_begin_count',
    'sql_txn_commit_count',
    'sql_txn_rollback_count',
    'sql_update_count',
    'timeseries_write_bytes',
    'timeseries_write_errors',
    'timeseries_write_samples',
    'tscache_skl_read_rotations',
    'tscache_skl_write_rotations',
    'txn_abandons',
    'txn_aborts',
    'txn_autoretries',
    'txn_commits',
    'txn_commits1PC',
    'txn_restarts_deleterange',
    'txn_restarts_possiblereplay',
    'txn_restarts_serializable',
    'txn_restarts_writetooold',
    'addsstable_aswrites',
    'addsstable_delay_enginebackpressure',
    'addsstable_delay_total',
    'admission_admitted_kv',
    'admission_admitted_kv_stores',
    'admission_admitted_sql_kv_response',
    'admission_admitted_sql_leaf_start',
    'admission_admitted_sql_root_start',
    'admission_admitted_sql_sql_response',
    'admission_errored_kv',
    'admission_errored_kv_stores',
    'admission_errored_sql_kv_response',
    'admission_errored_sql_leaf_start',
    'admission_errored_sql_root_start',
    'admission_errored_sql_sql_response',
    'admission_granter_io_tokens_exhausted_duration_kv',
    'admission_requested_kv',
    'admission_requested_kv_stores',
    'admission_requested_sql_kv_response',
    'admission_requested_sql_leaf_start',
    'admission_requested_sql_root_start',
    'admission_requested_sql_sql_response',
    'admission_wait_sum_kv',
    'admission_wait_sum_kv_stores',
    'admission_wait_sum_sql_kv_response',
    'admission_wait_sum_sql_leaf_start',
    'admission_wait_sum_sql_root_start',
    'admission_wait_sum_sql_sql_response',
    'changefeed_buffer_entries_in',
    'changefeed_buffer_entries_mem_acquired',
    'changefeed_buffer_entries_mem_released',
    'changefeed_buffer_entries_out',
    'changefeed_buffer_entries_released',
    'changefeed_bytes_messages_pushback_nanos',
    'changefeed_emitted_bytes',
    'changefeed_emitted_messages',
    'changefeed_error_retries',
    'changefeed_failures',
    'changefeed_flush_messages_pushback_nanos',
    'changefeed_flushed_bytes',
    'changefeed_flushes',
    'changefeed_forwarded_resolved_messages',
    'changefeed_frontier_updates',
    'changefeed_messages_messages_pushback_nanos',
    'changefeed_queue_time_nanos',
    'changefeed_table_metadata_nanos',
    'distsender_batches_async_sent',
    'distsender_batches_async_throttled',
    'distsender_errors_inleasetransferbackoffs',
    'distsender_rangefeed_error_catchup_ranges',
    'distsender_rangefeed_restart_stuck',
    'distsender_rangelookups',
    'distsender_rpc_addsstable_sent',
    'distsender_rpc_adminchangereplicas_sent',
    'distsender_rpc_adminmerge_sent',
    'distsender_rpc_adminrelocaterange_sent',
    'distsender_rpc_adminscatter_sent',
    'distsender_rpc_adminsplit_sent',
    'distsender_rpc_admintransferlease_sent',
    'distsender_rpc_adminunsplit_sent',
    'distsender_rpc_adminverifyprotectedtimestamp_sent',
    'distsender_rpc_barrier_sent',
    'distsender_rpc_checkconsistency_sent',
    'distsender_rpc_clearrange_sent',
    'distsender_rpc_computechecksum_sent',
    'distsender_rpc_conditionalput_sent',
    'distsender_rpc_delete_sent',
    'distsender_rpc_deleterange_sent',
    'distsender_rpc_endtxn_sent',
    'distsender_rpc_err_ambiguousresulterrtype',
    'distsender_rpc_err_batchtimestampbeforegcerrtype',
    'distsender_rpc_err_communicationerrtype',
    'distsender_rpc_err_conditionfailederrtype',
    'distsender_rpc_err_errordetailtype_0_',
    'distsender_rpc_err_errordetailtype_15_',
    'distsender_rpc_err_errordetailtype_19_',
    'distsender_rpc_err_errordetailtype_20_',
    'distsender_rpc_err_errordetailtype_21_',
    'distsender_rpc_err_errordetailtype_23_',
    'distsender_rpc_err_errordetailtype_24_',
    'distsender_rpc_err_errordetailtype_29_',
    'distsender_rpc_err_errordetailtype_30_',
    'distsender_rpc_err_errordetailtype_33_',
    'distsender_rpc_err_indeterminatecommiterrtype',
    'distsender_rpc_err_integeroverflowerrtype',
    'distsender_rpc_err_intentmissingerrtype',
    'distsender_rpc_err_internalerrtype',
    'distsender_rpc_err_invalidleaseerrtype',
    'distsender_rpc_err_leaserejectederrtype',
    'distsender_rpc_err_mergeinprogresserrtype',
    'distsender_rpc_err_mintimestampboundunsatisfiableerrtype',
    'distsender_rpc_err_mvcchistorymutationerrtype',
    'distsender_rpc_err_nodeunavailableerrtype',
    'distsender_rpc_err_notleaseholdererrtype',
    'distsender_rpc_err_oprequirestxnerrtype',
    'distsender_rpc_err_optimisticevalconflictserrtype',
    'distsender_rpc_err_raftgroupdeletederrtype',
    'distsender_rpc_err_rangefeedretryerrtype',
    'distsender_rpc_err_rangekeymismatcherrtype',
    'distsender_rpc_err_rangenotfounderrtype',
    'distsender_rpc_err_readwithinuncertaintyintervalerrtype',
    'distsender_rpc_err_refreshfailederrtype',
    'distsender_rpc_err_replicacorruptionerrtype',
    'distsender_rpc_err_replicatooolderrtype',
    'distsender_rpc_err_storenotfounderrtype',
    'distsender_rpc_err_transactionabortederrtype',
    'distsender_rpc_err_transactionpusherrtype',
    'distsender_rpc_err_transactionretryerrtype',
    'distsender_rpc_err_transactionretrywithprotorefresherrtype',
    'distsender_rpc_err_transactionstatuserrtype',
    'distsender_rpc_err_txnalreadyencounterederrtype',
    'distsender_rpc_err_unsupportedrequesterrtype',
    'distsender_rpc_err_writeintenterrtype',
    'distsender_rpc_err_writetooolderrtype',
    'distsender_rpc_export_sent',
    'distsender_rpc_gc_sent',
    'distsender_rpc_get_sent',
    'distsender_rpc_heartbeattxn_sent',
    'distsender_rpc_increment_sent',
    'distsender_rpc_initput_sent',
    'distsender_rpc_leaseinfo_sent',
    'distsender_rpc_merge_sent',
    'distsender_rpc_migrate_sent',
    'distsender_rpc_probe_sent',
    'distsender_rpc_pushtxn_sent',
    'distsender_rpc_put_sent',
    'distsender_rpc_queryintent_sent',
    'distsender_rpc_querylocks_sent',
    'distsender_rpc_queryresolvedtimestamp_sent',
    'distsender_rpc_querytxn_sent',
    'distsender_rpc_rangestats_sent',
    'distsender_rpc_recomputestats_sent',
    'distsender_rpc_recovertxn_sent',
    'distsender_rpc_refresh_sent',
    'distsender_rpc_refreshrange_sent',
    'distsender_rpc_requestlease_sent',
    'distsender_rpc_resolveintent_sent',
    'distsender_rpc_resolveintentrange_sent',
    'distsender_rpc_reversescan_sent',
    'distsender_rpc_revertrange_sent',
    'distsender_rpc_scan_sent',
    'distsender_rpc_scaninterleavedintents_sent',
    'distsender_rpc_subsume_sent',
    'distsender_rpc_transferlease_sent',
    'distsender_rpc_truncatelog_sent',
    'distsender_rpc_writebatch_sent',
    'engine_stalls',
    'exportrequest_delay_total',
    'follower_reads_success_count',
    'intentresolver_async_throttled',
    'intentresolver_finalized_txns_failed',
    'intentresolver_intents_failed',
    'intents_abort_attempts',
    'intents_poison_attempts',
    'intents_resolve_attempts',
    'jobs_adopt_iterations',
    'jobs_auto_create_stats_fail_or_cancel_completed',
    'jobs_auto_create_stats_fail_or_cancel_failed',
    'jobs_auto_create_stats_fail_or_cancel_retry_error',
    'jobs_auto_create_stats_resume_completed',
    'jobs_auto_create_stats_resume_failed',
    'jobs_auto_create_stats_resume_retry_error',
    'jobs_auto_span_config_reconciliation_fail_or_cancel_completed',
    'jobs_auto_span_config_reconciliation_fail_or_cancel_failed',
    'jobs_auto_span_config_reconciliation_fail_or_cancel_retry_error',
    'jobs_auto_span_config_reconciliation_resume_completed',
    'jobs_auto_span_config_reconciliation_resume_failed',
    'jobs_auto_span_config_reconciliation_resume_retry_error',
    'jobs_auto_sql_stats_compaction_fail_or_cancel_completed',
    'jobs_auto_sql_stats_compaction_fail_or_cancel_failed',
    'jobs_auto_sql_stats_compaction_fail_or_cancel_retry_error',
    'jobs_auto_sql_stats_compaction_resume_completed',
    'jobs_auto_sql_stats_compaction_resume_failed',
    'jobs_auto_sql_stats_compaction_resume_retry_error',
    'jobs_backup_fail_or_cancel_completed',
    'jobs_backup_fail_or_cancel_failed',
    'jobs_backup_fail_or_cancel_retry_error',
    'jobs_backup_resume_completed',
    'jobs_backup_resume_failed',
    'jobs_backup_resume_retry_error',
    'jobs_changefeed_fail_or_cancel_completed',
    'jobs_changefeed_fail_or_cancel_failed',
    'jobs_changefeed_fail_or_cancel_retry_error',
    'jobs_changefeed_resume_completed',
    'jobs_changefeed_resume_failed',
    'jobs_changefeed_resume_retry_error',
    'jobs_claimed_jobs',
    'jobs_create_stats_fail_or_cancel_completed',
    'jobs_create_stats_fail_or_cancel_failed',
    'jobs_create_stats_fail_or_cancel_retry_error',
    'jobs_create_stats_resume_completed',
    'jobs_create_stats_resume_failed',
    'jobs_create_stats_resume_retry_error',
    'jobs_import_fail_or_cancel_completed',
    'jobs_import_fail_or_cancel_failed',
    'jobs_import_fail_or_cancel_retry_error',
    'jobs_import_resume_completed',
    'jobs_import_resume_failed',
    'jobs_import_resume_retry_error',
    'jobs_migration_fail_or_cancel_completed',
    'jobs_migration_fail_or_cancel_failed',
    'jobs_migration_fail_or_cancel_retry_error',
    'jobs_migration_resume_completed',
    'jobs_migration_resume_failed',
    'jobs_migration_resume_retry_error',
    'jobs_new_schema_change_fail_or_cancel_completed',
    'jobs_new_schema_change_fail_or_cancel_failed',
    'jobs_new_schema_change_fail_or_cancel_retry_error',
    'jobs_new_schema_change_resume_completed',
    'jobs_new_schema_change_resume_failed',
    'jobs_new_schema_change_resume_retry_error',
    'jobs_restore_fail_or_cancel_completed',
    'jobs_restore_fail_or_cancel_failed',
    'jobs_restore_fail_or_cancel_retry_error',
    'jobs_restore_resume_completed',
    'jobs_restore_resume_failed',
    'jobs_restore_resume_retry_error',
    'jobs_resumed_claimed_jobs',
    'jobs_row_level_ttl_fail_or_cancel_completed',
    'jobs_row_level_ttl_fail_or_cancel_failed',
    'jobs_row_level_ttl_fail_or_cancel_retry_error',
    'jobs_row_level_ttl_resume_completed',
    'jobs_row_level_ttl_resume_failed',
    'jobs_row_level_ttl_resume_retry_error',
    'jobs_row_level_ttl_rows_deleted',
    'jobs_row_level_ttl_rows_selected',
    'jobs_schema_change_fail_or_cancel_completed',
    'jobs_schema_change_fail_or_cancel_failed',
    'jobs_schema_change_fail_or_cancel_retry_error',
    'jobs_schema_change_gc_fail_or_cancel_completed',
    'jobs_schema_change_gc_fail_or_cancel_failed',
    'jobs_schema_change_gc_fail_or_cancel_retry_error',
    'jobs_schema_change_gc_resume_completed',
    'jobs_schema_change_gc_resume_failed',
    'jobs_schema_change_gc_resume_retry_error',
    'jobs_schema_change_resume_completed',
    'jobs_schema_change_resume_failed',
    'jobs_schema_change_resume_retry_error',
    'jobs_stream_ingestion_fail_or_cancel_completed',
    'jobs_stream_ingestion_fail_or_cancel_failed',
    'jobs_stream_ingestion_fail_or_cancel_retry_error',
    'jobs_stream_ingestion_resume_completed',
    'jobs_stream_ingestion_resume_failed',
    'jobs_stream_ingestion_resume_retry_error',
    'jobs_stream_replication_fail_or_cancel_completed',
    'jobs_stream_replication_fail_or_cancel_failed',
    'jobs_stream_replication_fail_or_cancel_retry_error',
    'jobs_stream_replication_resume_completed',
    'jobs_stream_replication_resume_failed',
    'jobs_stream_replication_resume_retry_error',
    'jobs_typedesc_schema_change_fail_or_cancel_completed',
    'jobs_typedesc_schema_change_fail_or_cancel_failed',
    'jobs_typedesc_schema_change_fail_or_cancel_retry_error',
    'jobs_typedesc_schema_change_resume_completed',
    'jobs_typedesc_schema_change_resume_failed',
    'jobs_typedesc_schema_change_resume_retry_error',
    'kv_allocator_load_based_lease_transfers_cannot_find_better_candidate',
    'kv_allocator_load_based_lease_transfers_delta_not_significant',
    'kv_allocator_load_based_lease_transfers_existing_not_overfull',
    'kv_allocator_load_based_lease_transfers_missing_stats_for_existing_stores',
    'kv_allocator_load_based_lease_transfers_should_transfer',
    'kv_allocator_load_based_lease_transfers_significantly_switches_relative_disposition',
    'kv_allocator_load_based_replica_rebalancing_cannot_find_better_candidate',
    'kv_allocator_load_based_replica_rebalancing_delta_not_significant',
    'kv_allocator_load_based_replica_rebalancing_existing_not_overfull',
    'kv_allocator_load_based_replica_rebalancing_missing_stats_for_existing_store',
    'kv_allocator_load_based_replica_rebalancing_should_transfer',
    'kv_allocator_load_based_replica_rebalancing_significantly_switches_relative_disposition',
    'kv_prober_planning_attempts',
    'kv_prober_planning_failures',
    'kv_prober_read_attempts',
    'kv_prober_read_failures',
    'kv_prober_write_attempts',
    'kv_prober_write_failures',
    'kv_protectedts_reconciliation_errors',
    'kv_protectedts_reconciliation_num_runs',
    'kv_protectedts_reconciliation_records_processed',
    'kv_protectedts_reconciliation_records_removed',
    'kv_rangefeed_budget_allocation_blocked',
    'kv_rangefeed_budget_allocation_failed',
    'kv_rangefeed_catchup_scan_nanos',
    'kv_replica_circuit_breaker_num_tripped_events',
    'kv_tenant_rate_limit_read_batches_admitted',
    'kv_tenant_rate_limit_read_bytes_admitted',
    'kv_tenant_rate_limit_read_requests_admitted',
    'kv_tenant_rate_limit_write_batches_admitted',
    'kv_tenant_rate_limit_write_bytes_admitted',
    'kv_tenant_rate_limit_write_requests_admitted',
    'queue_gc_info_resolvefailed',
    'queue_gc_info_transactionresolvefailed',
    'queue_gc_info_transactionspangcstaging',
    'queue_merge_process_failure',
    'queue_merge_process_success',
    'queue_merge_processingnanos',
    'queue_replicate_addnonvoterreplica',
    'queue_replicate_addvoterreplica',
    'queue_replicate_nonvoterpromotions',
    'queue_replicate_rebalancenonvoterreplica',
    'queue_replicate_rebalancevoterreplica',
    'queue_replicate_removedeadnonvoterreplica',
    'queue_replicate_removedeadvoterreplica',
    'queue_replicate_removedecommissioningnonvoterreplica',
    'queue_replicate_removedecommissioningreplica',
    'queue_replicate_removedecommissioningvoterreplica',
    'queue_replicate_removelearnerreplica',
    'queue_replicate_removenonvoterreplica',
    'queue_replicate_removevoterreplica',
    'queue_replicate_voterdemotions',
    'raft_entrycache_accesses',
    'raft_entrycache_hits',
    'raft_timeoutcampaign',
    'range_merges',
    'range_recoveries',
    'range_snapshots_applied_initial',
    'range_snapshots_applied_non_voter',
    'range_snapshots_applied_voter',
    'range_snapshots_rcvd_bytes',
    'range_snapshots_sent_bytes',
    'rebalancing_lease_transfers',
    'rebalancing_range_rebalances',
    'rpc_batches_recv',
    'rpc_heartbeats_loops_exited',
    'rpc_heartbeats_loops_started',
    'rpc_method_addsstable_recv',
    'rpc_method_adminchangereplicas_recv',
    'rpc_method_adminmerge_recv',
    'rpc_method_adminrelocaterange_recv',
    'rpc_method_adminscatter_recv',
    'rpc_method_adminsplit_recv',
    'rpc_method_admintransferlease_recv',
    'rpc_method_adminunsplit_recv',
    'rpc_method_adminverifyprotectedtimestamp_recv',
    'rpc_method_barrier_recv',
    'rpc_method_checkconsistency_recv',
    'rpc_method_clearrange_recv',
    'rpc_method_computechecksum_recv',
    'rpc_method_conditionalput_recv',
    'rpc_method_delete_recv',
    'rpc_method_deleterange_recv',
    'rpc_method_endtxn_recv',
    'rpc_method_export_recv',
    'rpc_method_gc_recv',
    'rpc_method_get_recv',
    'rpc_method_heartbeattxn_recv',
    'rpc_method_increment_recv',
    'rpc_method_initput_recv',
    'rpc_method_leaseinfo_recv',
    'rpc_method_merge_recv',
    'rpc_method_migrate_recv',
    'rpc_method_probe_recv',
    'rpc_method_pushtxn_recv',
    'rpc_method_put_recv',
    'rpc_method_queryintent_recv',
    'rpc_method_querylocks_recv',
    'rpc_method_queryresolvedtimestamp_recv',
    'rpc_method_querytxn_recv',
    'rpc_method_rangestats_recv',
    'rpc_method_recomputestats_recv',
    'rpc_method_recovertxn_recv',
    'rpc_method_refresh_recv',
    'rpc_method_refreshrange_recv',
    'rpc_method_requestlease_recv',
    'rpc_method_resolveintent_recv',
    'rpc_method_resolveintentrange_recv',
    'rpc_method_reversescan_recv',
    'rpc_method_revertrange_recv',
    'rpc_method_scan_recv',
    'rpc_method_scaninterleavedintents_recv',
    'rpc_method_subsume_recv',
    'rpc_method_transferlease_recv',
    'rpc_method_truncatelog_recv',
    'rpc_method_writebatch_recv',
    'schedules_scheduled_row_level_ttl_executor_failed',
    'schedules_scheduled_row_level_ttl_executor_started',
    'schedules_scheduled_row_level_ttl_executor_succeeded',
    'schedules_scheduled_sql_stats_compaction_executor_failed',
    'schedules_scheduled_sql_stats_compaction_executor_started',
    'schedules_scheduled_sql_stats_compaction_executor_succeeded',
    'sql_conn_failures',
    'sql_contention_resolver_failed_resolutions',
    'sql_contention_resolver_retries',
    'sql_contention_txn_id_cache_miss',
    'sql_contention_txn_id_cache_read',
    'sql_copy_count',
    'sql_copy_count_internal',
    'sql_copy_started_count',
    'sql_copy_started_count_internal',
    'sql_ddl_count_internal',
    'sql_ddl_started_count',
    'sql_ddl_started_count_internal',
    'sql_delete_count_internal',
    'sql_delete_started_count',
    'sql_delete_started_count_internal',
    'sql_disk_distsql_spilled_bytes_read',
    'sql_disk_distsql_spilled_bytes_written',
    'sql_distsql_contended_queries_count',
    'sql_distsql_flows_scheduled',
    'sql_distsql_queries_spilled',
    'sql_distsql_select_count_internal',
    'sql_failure_count',
    'sql_failure_count_internal',
    'sql_feature_flag_denial',
    'sql_full_scan_count',
    'sql_full_scan_count_internal',
    'sql_guardrails_full_scan_rejected_count',
    'sql_guardrails_full_scan_rejected_count_internal',
    'sql_guardrails_max_row_size_err_count',
    'sql_guardrails_max_row_size_err_count_internal',
    'sql_guardrails_max_row_size_log_count',
    'sql_guardrails_max_row_size_log_count_internal',
    'sql_guardrails_transaction_rows_read_err_count',
    'sql_guardrails_transaction_rows_read_err_count_internal',
    'sql_guardrails_transaction_rows_read_log_count',
    'sql_guardrails_transaction_rows_read_log_count_internal',
    'sql_guardrails_transaction_rows_written_err_count',
    'sql_guardrails_transaction_rows_written_err_count_internal',
    'sql_guardrails_transaction_rows_written_log_count',
    'sql_guardrails_transaction_rows_written_log_count_internal',
    'sql_hydrated_table_cache_hits',
    'sql_hydrated_table_cache_misses',
    'sql_insert_count_internal',
    'sql_insert_started_count',
    'sql_insert_started_count_internal',
    'sql_misc_count_internal',
    'sql_misc_started_count',
    'sql_misc_started_count_internal',
    'sql_new_conns',
    'sql_optimizer_fallback_count',
    'sql_optimizer_fallback_count_internal',
    'sql_optimizer_plan_cache_hits',
    'sql_optimizer_plan_cache_hits_internal',
    'sql_optimizer_plan_cache_misses',
    'sql_optimizer_plan_cache_misses_internal',
    'sql_pgwire_cancel_ignored',
    'sql_pgwire_cancel_successful',
    'sql_pgwire_cancel_total',
    'sql_query_count_internal',
    'sql_query_started_count',
    'sql_query_started_count_internal',
    'sql_restart_savepoint_count',
    'sql_restart_savepoint_count_internal',
    'sql_restart_savepoint_release_count',
    'sql_restart_savepoint_release_count_internal',
    'sql_restart_savepoint_release_started_count',
    'sql_restart_savepoint_release_started_count_internal',
    'sql_restart_savepoint_rollback_count',
    'sql_restart_savepoint_rollback_count_internal',
    'sql_restart_savepoint_rollback_started_count',
    'sql_restart_savepoint_rollback_started_count_internal',
    'sql_restart_savepoint_started_count',
    'sql_restart_savepoint_started_count_internal',
    'sql_savepoint_count',
    'sql_savepoint_count_internal',
    'sql_savepoint_release_count',
    'sql_savepoint_release_count_internal',
    'sql_savepoint_release_started_count',
    'sql_savepoint_release_started_count_internal',
    'sql_savepoint_rollback_count',
    'sql_savepoint_rollback_count_internal',
    'sql_savepoint_rollback_started_count',
    'sql_savepoint_rollback_started_count_internal',
    'sql_savepoint_started_count',
    'sql_savepoint_started_count_internal',
    'sql_schema_changer_permanent_errors',
    'sql_schema_changer_retry_errors',
    'sql_schema_changer_successes',
    'sql_select_count_internal',
    'sql_select_started_count',
    'sql_select_started_count_internal',
    'sql_stats_cleanup_rows_removed',
    'sql_stats_discarded_current',
    'sql_stats_flush_count',
    'sql_stats_flush_error',
    'sql_temp_object_cleaner_schemas_deletion_error',
    'sql_temp_object_cleaner_schemas_deletion_success',
    'sql_temp_object_cleaner_schemas_to_delete',
    'sql_txn_abort_count_internal',
    'sql_txn_begin_count_internal',
    'sql_txn_begin_started_count',
    'sql_txn_begin_started_count_internal',
    'sql_txn_commit_count_internal',
    'sql_txn_commit_started_count',
    'sql_txn_commit_started_count_internal',
    'sql_txn_contended_count',
    'sql_txn_contended_count_internal',
    'sql_txn_rollback_count_internal',
    'sql_txn_rollback_started_count',
    'sql_txn_rollback_started_count_internal',
    'sql_update_count_internal',
    'sql_update_started_count',
    'sql_update_started_count_internal',
    'sqlliveness_is_alive_cache_hits',
    'sqlliveness_is_alive_cache_misses',
    'sqlliveness_sessions_deleted',
    'sqlliveness_sessions_deletion_runs',
    'sqlliveness_write_failures',
    'sqlliveness_write_successes',
    'streaming_events_ingested',
    'streaming_flushes',
    'streaming_ingested_bytes',
    'streaming_resolved_events_ingested',
    'tscache_skl_rotations',
    'txn_commit_waits',
    'txn_commit_waits_before_commit_trigger',
    'txn_condensed_intent_spans',
    'txn_condensed_intent_spans_rejected',
    'txn_parallelcommits',
    'txn_refresh_auto_retries',
    'txn_refresh_fail',
    'txn_refresh_fail_with_condensed_spans',
    'txn_refresh_memory_limit_exceeded',
    'txn_refresh_success',
    'txn_restarts_asyncwritefailure',
    'txn_restarts_commitdeadlineexceeded',
    'txn_restarts_readwithinuncertainty',
    'txn_restarts_txnaborted',
    'txn_restarts_txnpush',
    'txn_restarts_unknown',
    'txn_restarts_writetoooldmulti',
    'txn_rollbacks_async_failed',
    'txn_rollbacks_failed',
    'txnrecovery_attempts_total',
    'txnrecovery_failures',
    'txnrecovery_successes_aborted',
    'txnrecovery_successes_committed',
    'txnrecovery_successes_pending',
    'txnwaitqueue_deadlocks_total',
}

EXPECTED_METRICS = []
for raw_metric_name, metric_name in METRIC_MAP.items():
    if raw_metric_name in KNOWN_HISTOGRAMS or raw_metric_name.endswith(('_durations', '_latency', '_max', '_restarts')):
        metric_name += '.bucket'
    elif raw_metric_name in KNOWN_COUNTERS and not metric_name.endswith('.count'):
        metric_name += '.count'

    EXPECTED_METRICS.append(metric_name)


def assert_metrics(aggregator):
    for metric in EXPECTED_METRICS:
        aggregator.assert_metric('cockroachdb.{}'.format(metric), at_least=0)

    # Custom transformer
    aggregator.assert_metric('cockroachdb.build.timestamp')

    assert aggregator.metrics_asserted_pct > 80, 'Missing metrics {}'.format(aggregator.not_asserted())
