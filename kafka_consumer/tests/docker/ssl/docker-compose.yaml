services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.3.0
    ports:
      - 2181:2181
    container_name: zookeeper
    hostname: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    healthcheck:
      test: ["CMD", "bash", "-c", "echo 'srvr' | nc localhost 2181 | grep -q 'Mode:'"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka1:
    image: confluentinc/cp-kafka:${CONFLUENT_VERSION}
    container_name: kafka1
    hostname: kafka1
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,SSL:SSL
      KAFKA_LISTENERS: PLAINTEXT://kafka1:29092,SSL://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka1:29092,SSL://localhost:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_SSL_TRUSTSTORE_FILENAME: kafka.truststore.jks
      KAFKA_SSL_KEYSTORE_FILENAME: kafka1.server.keystore.jks
      KAFKA_SSL_KEY_CREDENTIALS: kafka_ssl_key_credentials
      KAFKA_SSL_KEYSTORE_CREDENTIALS: kafka_ssl_keystore_credentials
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: kafka_ssl_truststore_credentials
      KAFKA_SSL_CLIENT_AUTH: required
      KAFKA_SSL_PRINCIPAL_MAPPING_RULES: 'RULE:^CN=(.*?),OU=ServiceUsers.*$/$1/,RULE:^CN=(.*?),OU=(.*?),O=(.*?),L=(.*?),ST=(.*?),C=(.*?)$/$1@$2/L,RULE:^.*[Cc][Nn]=([a-zA-Z0-9.]*).*$/$1/L,DEFAULT'
      KAFKA_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: https
      KAFKA_SUPER_USERS: User:kafka
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    volumes:
      - ./truststore/kafka.truststore.jks:/etc/kafka/secrets/kafka.truststore.jks
      - ./keystore/kafka1.server.keystore.jks:/etc/kafka/secrets/kafka1.server.keystore.jks
      - ./secrets/kafka_ssl_key_credentials:/etc/kafka/secrets/kafka_ssl_key_credentials
      - ./secrets/kafka_ssl_keystore_credentials:/etc/kafka/secrets/kafka_ssl_keystore_credentials
      - ./secrets/kafka_ssl_truststore_credentials:/etc/kafka/secrets/kafka_ssl_truststore_credentials
      - ./ssl-client-kafka1.properties:/etc/kafka/ssl-client.properties
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 --command-config /etc/kafka/ssl-client.properties || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    depends_on:
      zookeeper:
        condition: service_healthy

  kafka2:
    image: confluentinc/cp-kafka:${CONFLUENT_VERSION}
    container_name: kafka2
    hostname: kafka2
    ports:
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,SSL:SSL
      KAFKA_LISTENERS: PLAINTEXT://kafka2:29093,SSL://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka2:29093,SSL://localhost:9093
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_SSL_TRUSTSTORE_FILENAME: kafka.truststore.jks
      KAFKA_SSL_KEYSTORE_FILENAME: kafka2.server.keystore.jks
      KAFKA_SSL_KEY_CREDENTIALS: kafka_ssl_key_credentials
      KAFKA_SSL_KEYSTORE_CREDENTIALS: kafka_ssl_keystore_credentials
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: kafka_ssl_truststore_credentials
      KAFKA_SSL_CLIENT_AUTH: required
      KAFKA_SSL_PRINCIPAL_MAPPING_RULES: 'RULE:^CN=(.*?),OU=ServiceUsers.*$/$1/,RULE:^CN=(.*?),OU=(.*?),O=(.*?),L=(.*?),ST=(.*?),C=(.*?)$/$1@$2/L,RULE:^.*[Cc][Nn]=([a-zA-Z0-9.]*).*$/$1/L,DEFAULT'
      KAFKA_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: https
      KAFKA_SUPER_USERS: User:kafka
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    volumes:
      - ./truststore/kafka.truststore.jks:/etc/kafka/secrets/kafka.truststore.jks
      - ./keystore/kafka2.server.keystore.jks:/etc/kafka/secrets/kafka2.server.keystore.jks
      - ./secrets/kafka_ssl_key_credentials:/etc/kafka/secrets/kafka_ssl_key_credentials
      - ./secrets/kafka_ssl_keystore_credentials:/etc/kafka/secrets/kafka_ssl_keystore_credentials
      - ./secrets/kafka_ssl_truststore_credentials:/etc/kafka/secrets/kafka_ssl_truststore_credentials
      - ./ssl-client-kafka2.properties:/etc/kafka/ssl-client.properties
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9093 --command-config /etc/kafka/ssl-client.properties || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    depends_on:
      zookeeper:
        condition: service_healthy
