# https://github.com/DataDog/slapr

name: Slack emoji PR updates
on:
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [closed]
permissions: read-all

jobs:

  run_slapr_agent_integrations:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        slack_channel_variable:
          - SLACK_CHANNEL_ID
          - SLACK_CHANNEL_ID_AGENT_INTEGRATIONS_REVIEWS
          - SLACK_CHANNEL_ID_INFRA_INTEGRATIONS
    steps:
    - run: |
        REVIEWER_ID=$(echo "${{ github.event.review.user.login }}")
        DATADOG_TEAMS=$(gh api graphql --paginate -f query='{organization(login: "DataDog") {teams(first: 100, userLogins: ["$REVIEWER_ID"]) { edges {node {name}}}}}' | jq -r '.data.organization.teams.edges[].node.name')
        echo "::set-output name=TEAM::$DATADOG_TEAMS"
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
    - uses: DataDog/slapr@master
      env:
        GITHUB_CONTEXT: "${{ toJson(github) }}"
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        SLACK_CHANNEL_ID: "${{ secrets[matrix.slack_channel_variable] }}"
        SLACK_API_TOKEN: "${{ secrets.SLACK_API_TOKEN }}"
        SLAPR_BOT_USER_ID: "${{ secrets.SLAPR_BOT_USER_ID }}"
        SLAPR_EMOJI_REVIEW_STARTED: "review_started"
        SLAPR_EMOJI_APPROVED: "approved2"
        SLAPR_EMOJI_CHANGES_REQUESTED: "changes_requested"
        SLAPR_EMOJI_MERGED: "merged"
        SLAPR_EMOJI_CLOSED: "closed"
