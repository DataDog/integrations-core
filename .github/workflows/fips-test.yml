name: Test FIPS

on:
  pull_request:
    paths:
    - datadog_checks_base/datadog_checks/**
    - .github/workflows/fips/**
  schedule:
    - cron: '0 0,8,16 * * *'

defaults:
  run:
    shell: bash

jobs:
  run:
    strategy:
      matrix:
        platform: [linux, windows]
        agent-type: [fips-agent, standard-agent]
    runs-on: ${{ matrix.platform == 'linux' && 'ubuntu-22.04' || 'windows-2022' }}
    name: "Test FIPS"

    env:
      FORCE_COLOR: "1"
      PYTHON_VERSION: "3.12"
      AGENT_TYPE: "${{ matrix.agent-type }}"

    steps:

    - uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: "${{ env.PYTHON_VERSION }}"
        cache: 'pip'

    - name: Install pytest
      run: |
        pip install pytest

    - name: Cache Docker layers
      uses: actions/cache@v3
      with:
        path: ~/.docker
        key: ${{ runner.os }}-docker-${{ matrix.platform }}-${{ matrix.agent-type }}
        restore-keys: |
          ${{ runner.os }}-docker-${{ matrix.platform }}-

    - name: Set up Linux containers
      if: matrix.platform == 'linux'
      env:
        AGENT_IMAGE: "${{ matrix.agent-type == 'fips-agent' && 'datadog/agent-dev:master-fips' || 'datadog/agent-dev:master-py3' }}"
        DD_API_KEY: ${{ secrets.DD_API_KEY }}
      run: |
        docker compose -f .github/workflows/fips/compose/compose-linux.yml up -d

    - name: Set up Windows containers
      if: matrix.platform == 'windows'
      env:
        AGENT_IMAGE: "${{ matrix.agent-type == 'fips-agent' && 'datadog/agent-dev:main-py3-fips-win-servercore-ltsc2022' || 'datadog/agent-dev:master-py3-win-servercore' }}"
        DD_API_KEY: ${{ secrets.DD_API_KEY }}
      run: |
        docker compose -f .github/workflows/fips/compose/compose-windows.yml up -d

    - name: Run tests
      run: |
        pytest -s -vv .github/workflows/fips/tests

