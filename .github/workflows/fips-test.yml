name: Test FIPS

on:
  pull_request:
    paths:
    - datadog_checks_base/datadog_checks/**
    - .github/workflows/fips/**
  schedule:
    - cron: '0 0,8,16 * * *'

jobs:
  run:
    strategy:
      matrix:
        platform: [linux, windows]
        agent-type: [fips-agent, standard-agent]
    runs-on: ${{ matrix.platform == 'linux' && 'ubuntu-22.04' || 'windows-2022' }}
    name: "Test FIPS"

    env:
      FORCE_COLOR: "1"
      PYTHON_VERSION: "3.12"
      AGENT_TYPE: "${{ matrix.agent-type }}"

    steps:

    - uses: actions/checkout@v4

    - uses: Vampire/setup-wsl@v4
      if: matrix.platform == 'windows'

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: "${{ env.PYTHON_VERSION }}"
        cache: 'pip'

    - name: Install pytest
      run: |
        pip install pytest

    - name: Set up Linux containers
      if: matrix.platform == 'linux'
      env:
        AGENT_IMAGE: "${{ matrix.agent-type == 'fips-agent' && 'datadog/agent-dev:master-fips' || 'datadog/agent-dev:master-py3' }}"
        SERVER_IMAGE: 'alpine:3.14'
        DD_API_KEY: ${{ secrets.DD_API_KEY }}
      run: |
        docker compose -f .github/workflows/fips/compose/docker-compose.yml up -d

    - name: Set up Windows containers
      if: matrix.platform == 'windows'
      shell: wsl-bash {0}
      env:
        AGENT_IMAGE: "${{ matrix.agent-type == 'fips-agent' && 'mcr.microsoft.com/windows/servercore:ltsc2022' || 'mcr.microsoft.com/windows/servercore:ltsc2022' }}"
        SERVER_IMAGE: 'mcr.microsoft.com/windows/servercore:ltsc2022'
        DOCKER_DEFAULT_PLATFORM: linux/amd64
        DD_API_KEY: ${{ secrets.DD_API_KEY }}
      run: |
        docker compose -f .github/workflows/fips/compose/docker-compose.yml up -d

    - name: Run tests
      run: |
        pytest -vv .github/workflows/fips/tests

