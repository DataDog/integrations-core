name: Test target

on:
  workflow_call:
    inputs:
      repo:
        required: true
        type: string
      os:
        required: true
        type: string
      target:
        required: true
        type: string
      target-name:
        required: true
        type: string

      python-version:
        required: false
        default: "3.8"
        type: string
      standard:
        required: false
        default: false
        type: boolean
      benchmark:
        required: false
        default: false
        type: boolean
      latest:
        required: false
        default: false
        type: boolean
      minimum-base-package:
        required: false
        default: false
        type: boolean
      test-py2:
        required: false
        default: false
        type: boolean
      test-py3:
        required: false
        default: true
        type: boolean
      agent-image:
        required: false
        default: ""
        type: string
      agent-image-py2:
        required: false
        default: ""
        type: string
      agent-image-windows:
        required: false
        default: "datadog/agent-dev:master-py3-win-servercore"
        type: string
      agent-image-windows-py2:
        required: false
        default: "datadog/agent-dev:master-py2-win-servercore"
        type: string
      traces-artifact-name:
        required: false
        default: ""
        type: string
      trace-agent-port:
        required: false
        default: ""
        type: string

jobs:
  run:
    name: "${{ inputs.target-name }}"
    runs-on: "${{ inputs.os }}"

    env:
      FORCE_COLOR: "1"
      SKIP_ENV_NAME: "${{ (inputs.test-py2 && inputs.test-py3) && '' || (inputs.test-py2 && !inputs.test-py3) && 'py3.*' || 'py2.*' }}"
      # Windows E2E requires Windows containers
      DDEV_E2E_AGENT: "${{ startsWith(inputs.os, 'windows-') && inputs.agent-image-windows || inputs.agent-image }}"
      DDEV_E2E_AGENT_PY2: "${{ startsWith(inputs.os, 'windows-') && inputs.agent-image-windows-py2 || inputs.agent-image-py2 }}"
      # Tracing to monitor our test suite
      DD_ENV: "ci"
      DD_SERVICE: "ddev-integrations-${{ inputs.repo }}"
      DD_TAGS: "team:agent-integrations,integration:${{ inputs.target }},platform:${{ startsWith(inputs.os, 'windows-') && 'windows' || startsWith(inputs.os, 'macos-') && 'macos' || 'linux' }}"
      DD_TRACE_ANALYTICS_ENABLED: "true"
      # Capture traces for a separate job to do the submission
      TRACE_CAPTURE_FILE: "trace-capture-${{ inputs.target-name }}"
      TRACE_CAPTURE_LOG: "trace-captures.log"

    steps:
    - name: Set up Windows
      if: runner.os == 'Windows'
      run: |-
        # # https://github.com/actions/runner-images/issues/6561#issuecomment-1460061208
        # Set-MpPreference -DisableRealtimeMonitoring $true
        # Enable disk performance counters
        diskperf -y
      shell: bash

    - uses: actions/checkout@v3

    - name: Set up Python 2.7
      if: inputs.test-py2
      uses: actions/setup-python@v4
      with:
        python-version: "2.7"

    - name: Set up Python ${{ inputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: "${{ inputs.python-version }}"

    - name: Install ddev from local folder
      if: inputs.repo == 'core'
      run: |-
        pip install ./datadog_checks_dev[cli]
        pip install ./ddev
      shell: bash

    - name: Install ddev from PyPI
      if: inputs.repo != 'core'
      run: pip install ddev
      shell: bash

    - name: Configure ddev
      run: |-
        ddev config set repos.${{ inputs.repo }} .
        ddev config set repo ${{ inputs.repo }}
      shell: bash

    - name: Prepare ${{ inputs.target }} for testing
      env:
        PYTHONUNBUFFERED: 1
        DOCKER_USERNAME: "${{ secrets.DOCKER_USERNAME }}"
        DOCKER_ACCESS_TOKEN: "${{ secrets.DOCKER_ACCESS_TOKEN }}"
        ORACLE_DOCKER_USERNAME: "${{ secrets.ORACLE_DOCKER_USERNAME }}"
        ORACLE_DOCKER_PASSWORD: "${{ secrets.ORACLE_DOCKER_PASSWORD }}"
      run: ddev ci setup ${{ inputs.target }}
      shell: bash

    - name: Set up trace capturing
      if: inputs.trace-agent-port
      run: |-
        pipx install mitmproxy
        mitmdump -p "${{ inputs.trace-agent-port }}" -w "${{ env.TRACE_CAPTURE_FILE }}" > "${{ env.TRACE_CAPTURE_LOG }}" 2>&1 &
      shell: bash

    - name: Run Unit & Integration tests
      if: inputs.standard && !inputs.minimum-base-package
      env:
        DDEV_TEST_ENABLE_TRACING: "${{ inputs.trace-agent-port && '1' || '0' }}"
      run: ddev test --cov --junit ${{ inputs.target }}
      shell: bash

    - name: Run Unit & Integration tests with minimum version of base package
      if: inputs.standard && inputs.minimum-base-package
      run: ddev test --force-base-min --force-env-rebuild --junit ${{ inputs.target }}
      shell: bash

    - name: Run E2E tests with latest base package
      if: inputs.standard && inputs.repo == 'core'
      env:
        DD_API_KEY: "${{ secrets.DD_API_KEY }}"
      run: ddev env test --base --new-env --junit ${{ inputs.target }}
      shell: bash

    - name: Run E2E tests
      if: inputs.standard && inputs.repo != 'core'
      env:
        DD_API_KEY: "${{ secrets.DD_API_KEY }}"
      run: ddev env test --new-env --junit ${{ inputs.target }}
      shell: bash

    - name: Run benchmarks
      if: inputs.benchmark
      run: ddev test --bench --junit ${{ inputs.target }}
      shell: bash

    - name: Run tests and verify support for the latest version
      if: inputs.latest
      run: ddev test --latest --junit ${{ inputs.target }}
      shell: bash

    - name: Run E2E tests for the latest version
      if: inputs.latest
      env:
        DD_API_KEY: "${{ secrets.DD_API_KEY }}"
        DDEV_TEST_ENABLE_TRACING: "${{ inputs.trace-agent-port && '1' || '0' }}"
      run: ddev env test --base --new-env --junit ${{ inputs.target }}:latest
      shell: bash

    - name: Save trace captures
      if: inputs.trace-agent-port
      run: |-
        ${{ runner.os == 'Windows' && 'Stop-Process -Name "*mitmdump*"' || 'kill -2 $(pgrep mitmdump)' }}
        cat "${{ env.TRACE_CAPTURE_LOG }}"

    - uses: actions/upload-artifact@v3
      if: always()
      with:
        name: "${{ inputs.traces-artifact-name }}"
        path: "${{ env.TRACE_CAPTURE_FILE }}"
