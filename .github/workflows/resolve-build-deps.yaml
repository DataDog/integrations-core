name: Resolve Dependencies and Build Wheels

on:
  workflow_dispatch:
  pull_request:
    branches:
    - master
    - 7.*.*

  pull_request_target:
    types: [labeled]
    branches:
    - master
    - 7.*.*

  push:
    branches:
    - master
    - 7.*.*

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ (github.event_name == 'pull_request' || github.event_name == 'pull_request_target') && true || false }}

defaults:
  run:
    shell: bash

env:
  PYTHONUNBUFFERED: "1"
  PYTHON_VERSION: "3.13"
  DIRECT_DEPENDENCY_FILE: agent_requirements.in
  # https://reproducible-builds.org/specs/source-date-epoch/
  SOURCE_DATE_EPOCH: "1580601600"

jobs:
  # measure-disk-usage.yml depends on this workflow being triggered and completed,
  # so it can wait for the build to calculate dependency sizes.
  # The 'on' setting ensures it runs, but this job cancels it if no dependency changes are detected.

  check-should-run:
    name: Check if build should run
    runs-on: ubuntu-22.04
    permissions:
      actions: write
      contents: read
    outputs:
      builder_changed: ${{ steps.dependency-check.outputs.builder_changed || steps.dependency-check-skip.outputs.builder_changed }}
      should_run_build: ${{ steps.dependency-check.outputs.should_run_build || steps.dependency-check-skip.outputs.should_run_build }}
      checkout_ref: ${{ steps.set_sha.outputs.curr_sha || github.sha }}
    steps:
      - name: Verify label and fork status
        id: pr-target-precheck
        if: github.event_name == 'pull_request_target'
        run: |
          if [ "${{ github.event.label.name }}" != "bot/resolve-build-deps" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=Label is not bot/resolve-build-deps" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "is_fork=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "skip=false" >> $GITHUB_OUTPUT
          echo "is_fork=false" >> $GITHUB_OUTPUT

      - name: Define diff commits
        id: set_sha
        if: github.event_name != 'workflow_dispatch'
        run: .github/workflows/scripts/resolve_deps_define_diff_commits.sh
        env:
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          EVENT_BEFORE: ${{ github.event.before }}

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: >-
            ${{ github.event_name == 'workflow_dispatch'
              && github.sha
              || steps.set_sha.outputs.curr_sha }}

      - name: Get changed files
        id: changed-files
        if: github.event_name != 'workflow_dispatch' && (github.event_name != 'pull_request_target' || steps.pr-target-precheck.outputs.skip != 'true')
        run: |
          REPO="${{ github.repository }}"

          CHANGED_FILES=$(gh api "repos/$REPO/compare/${{ steps.set_sha.outputs.prev_sha }}...${{ steps.set_sha.outputs.curr_sha }}" --paginate | \
          jq -r 'select(.files != null) | .files | map(.filename) | join(" ")')

          echo "files_changed=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "files_changed=$CHANGED_FILES"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if build should run
        id: dependency-check
        if: github.event_name != 'pull_request_target' || steps.pr-target-precheck.outputs.skip != 'true'
        run: .github/workflows/scripts/resolve_deps_check_should_run.sh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FILES_CHANGED: ${{ steps.changed-files.outputs.files_changed }}

      - name: Skip build (non-matching label or fork PR)
        id: dependency-check-skip
        if: github.event_name == 'pull_request_target' && steps.pr-target-precheck.outputs.skip == 'true'
        run: |
          echo "should_run_build=false" >> $GITHUB_OUTPUT
          echo "builder_changed=false" >> $GITHUB_OUTPUT

  test:
    name: Run tests
    needs:
      - check-should-run
    if: needs.check-should-run.outputs.should_run_build == 'true'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ needs.check-should-run.outputs.checkout_ref }}

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: |
          pip install -r .builders/deps/host_dependencies.txt
          pip install -r .builders/test_dependencies.txt
      - name: Run tests
        run: |
          cd .builders
          pytest -vvv

  build:
    name: Target ${{ matrix.job.image }} on ${{ matrix.job.os }}
    needs:
      - check-should-run
    if: needs.check-should-run.outputs.should_run_build == 'true'
    runs-on: ${{ matrix.job.os }}
    strategy:
      fail-fast: false
      matrix:
        job:
        - os: ubuntu-22.04-arm
          image: linux-aarch64
        - os: ubuntu-22.04
          image: linux-x86_64
        - os: windows-2022
          image: windows-x86_64

    permissions:
      packages: write

    env:
      OUT_DIR: output/${{ matrix.job.image }}
      BUILDER_IMAGE: ghcr.io/datadog/agent-int-builder:${{ matrix.job.image }}
      DOCKER: docker

    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        ref: ${{ needs.check-should-run.outputs.checkout_ref }}

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install management dependencies
      run: pip install -r .builders/deps/host_dependencies.txt

    - name: Log in to GitHub Packages
      uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build image and wheels
      if: needs.check-should-run.outputs.builder_changed == 'true'
      run: python .builders/build.py ${{ matrix.job.image }} --python 3 ${{ env.OUT_DIR }}/py3

    - name: Pull image and build wheels
      if: needs.check-should-run.outputs.builder_changed == 'false'
      run: |
        digest=$(jq -r '.["${{ matrix.job.image }}"]' .deps/image_digests.json)
        python .builders/build.py ${{ matrix.job.image }} --python 3 ${{ env.OUT_DIR }}/py3 --digest $digest

    - name: Publish image
      if: github.event_name == 'push' && needs.check-should-run.outputs.builder_changed == 'true'
      run: ${DOCKER} push ${{ env.BUILDER_IMAGE }}

    - name: Save new image digest
      if: github.event_name == 'push' && needs.check-should-run.outputs.builder_changed == 'true'
      run: >-
        ${DOCKER} inspect --format "{{index .RepoDigests 0}}" ${{ env.BUILDER_IMAGE }}
        | cut -d '@' -f 2
        > ${{ env.OUT_DIR }}/image_digest

    - name: Persist current image digest
      if: needs.check-should-run.outputs.builder_changed == 'false'
      run: >-
        jq -r '.["${{ matrix.job.image }}"]' .deps/image_digests.json
        > ${{ env.OUT_DIR }}/image_digest

    - name: Upload artifacts
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: target-${{ matrix.job.image }}
        path: output

  build-macos:
    name: Target macOS/${{ matrix.job.arch }} on ${{ matrix.job.os }}
    needs:
      - check-should-run
    if: needs.check-should-run.outputs.should_run_build == 'true'
    runs-on: ${{ matrix.job.os }}
    strategy:
      fail-fast: false
      matrix:
        job:
        - arch: x86_64
          os: macos-14-large
        - arch: aarch64
          os: macos-14 # "macOS 14 Arm64" as per https://github.com/actions/runner-images/blob/main/README.md
    env:
      TARGET_NAME: macos-${{ matrix.job.arch }}
      OUT_DIR: output/macos-${{ matrix.job.arch }}
      DD_PYTHON3: "/Library/Frameworks/Python.framework/Versions/3.13/bin/python"

    permissions:
      packages: write

    steps:
    - name: Set up environment
      run: |
        # We remove everything that comes pre-installed via Homebrew to avoid depending on or shipping stuff that
        # comes in the runner through Homebrew to better control what might get shipped in the wheels via `delocate`
        brew remove --force --ignore-dependencies $(brew list --formula)
        brew install coreutils

    - name: Set up Python
      # Use PBS as suggested by: https://github.com/DataDog/integrations-core/pull/21692#pullrequestreview-3358660684
      # PBS stands for "Python Build Standalone": https://astral.sh/blog/python-build-standalone
      env:
        PYTHON_PATCH: 11
        PBS_RELEASE: 20251217
        PBS_SHA256__aarch64: 324b24ebd50c16cf3a88360fc0e85ced38b04abcf580bc73cf95def4852e0c29
        PBS_SHA256__x86_64: 70f76d40609999213b44a37e947dc0fe0b975f48d206f8931992892870bd4026
      run: |
        set -u
        curl -fsSL -o pbs.tgz "https://github.com/astral-sh/python-build-standalone/releases/download/$PBS_RELEASE/cpython-$PYTHON_VERSION.$PYTHON_PATCH+$PBS_RELEASE-${{ matrix.job.arch }}-apple-darwin-install_only_stripped.tar.gz"
        echo "$PBS_SHA256__${{ matrix.job.arch }} *pbs.tgz" | shasum -a 256 -c -
        prefix=$(dirname "$(dirname "$DD_PYTHON3")")
        sudo mkdir -p "$prefix"
        sudo tar -xzf pbs.tgz -C "$prefix" --strip-components=1
        rm pbs.tgz

    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        ref: ${{ needs.check-should-run.outputs.checkout_ref }}

    - name: Install management dependencies
      run: |
        ${DD_PYTHON3} -m pip install -r .builders/deps/host_dependencies.txt
        ${DD_PYTHON3} -m pip install --no-warn-script-location -r ".builders/images/runner_dependencies.txt"

    - name: Cache builder root
      id: cache-builder-root
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
      with:
        path: ~/builder_root
        key: macos-${{ matrix.job.arch }}-deps-builder-root-cache-${{ hashFiles('./.builders/images/macos/*', './.builders/images/*', './.builders/deps/*', './.builders/build.py', './.github/workflows/resolve-build-deps.yml') }}

    - name: Run the build
      env:
        # This sets the minimum macOS version compatible for all built artifacts
        MACOSX_DEPLOYMENT_TARGET: "11.0" # https://docs.datadoghq.com/agent/supported_platforms/?tab=macos
        CACHE_HIT: ${{ steps.cache-builder-root.outputs.cache-hit }}
      run: |
        # If we hit the cache, we can skip the builder setup
        if [[ ${CACHE_HIT} == "true" ]]; then
          ${DD_PYTHON3} .builders/build.py ${{ env.TARGET_NAME }} --builder-root ~/builder_root --python 3 ${{ env.OUT_DIR }}/py3 --skip-setup
        else
          mkdir ~/builder_root
          ${DD_PYTHON3} .builders/build.py ${{ env.TARGET_NAME }} --builder-root ~/builder_root --python 3 ${{ env.OUT_DIR }}/py3
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: target-macos-${{ matrix.job.arch }}
        path: output


  publish:
    name: Publish artifacts and update lockfiles via PR
    if: >-
      needs.check-should-run.outputs.should_run_build == 'true'
      && (
        github.event_name == 'push'
        || github.event_name == 'pull_request_target'
        || (
          github.event_name == 'workflow_dispatch'
          && (github.ref_name == github.event.repository.default_branch || startsWith(github.ref_name, '7.'))
        )
      )
    needs:
    - build
    - build-macos
    - check-should-run
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
    - name: Create token
      uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1.12.0
      id: token-generator
      with:
        app-id: ${{ vars.DD_AGENT_INTEGRATIONS_BOT_APP_ID }}
        private-key: ${{ secrets.DD_AGENT_INTEGRATIONS_BOT_PRIVATE_KEY }}
        repositories: integrations-core

    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        token: ${{ steps.token-generator.outputs.token }}
        ref: ${{ needs.check-should-run.outputs.checkout_ref }}

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install management dependencies
      run: pip install -r .builders/deps/host_dependencies.txt

    - name: Download artifacts
      uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
      with:
        path: targets
        pattern: target-*
        merge-multiple: true

    - name: Get credentials
      id: auth
      uses: google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f # v2.1.7
      with:
        project_id: datadog-agent-int-build
        workload_identity_provider: projects/574011472402/locations/global/workloadIdentityPools/github/providers/integrations-core

    - name: Upload wheels and create lock files 
      run: python .builders/upload.py targets

    - name: Clean up repository
      run: |
        rm ${{ steps.auth.outputs.credentials_file_path }}
        rm -rf targets

    - name: Commit and push `.deps/` to the PR branch
      if: github.event_name == 'pull_request_target'
      run: |-
        if [ -z "$(git status --porcelain)" ]; then
          echo "No changes to commit."
          exit 0
        fi

        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config user.name "github-actions[bot]"

        git add .deps

        if git diff --cached --quiet; then
          echo "No changes staged."
          exit 0
        fi

        git commit -m "Update dependency resolution"
        git push origin "HEAD:${{ github.event.pull_request.head.ref }}"

    - name: Create pull request
      if: github.event_name != 'pull_request_target'
      uses: peter-evans/create-pull-request@4e1beaa7521e8b457b572c090b25bd3db56bf1c5 # v5.0.3
      with:
        token: ${{ steps.token-generator.outputs.token }}
        title: Update dependency resolution
        commit-message: Update dependency resolution
        branch: bot/update-dependency-resolution
        branch-suffix: timestamp
        delete-branch: true
        labels: bot,qa/skip-qa,bot/resolve-build-deps
        body: |-
          ### Motivation

          Direct dependencies were updated in ${{ github.sha }}.

          ### Additional Notes

          This PR was automatically generated by the following workflow:
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
