name: Measure Disk Usage

on:
  pull_request:
    branches:
      - master

env:
  PYTHON_VERSION: "3.12"
permissions:
  contents: read
  pull-requests: write

jobs:
  measure-disk-usage:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}


      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # - name: Install ddev
      #   run: |
      #     pip install -e ./datadog_checks_dev[cli]
      #     pip install -e ./ddev

      # Dummy test artifact for demo
      - name: Create artifact
        run: |
          echo "hola" > hola.txt

      - name: Upload artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: hola.txt
          path: hola.txt
          if-no-files-found: error

      - name: Fetch master and PR branch
        run: |
          git fetch origin master:refs/remotes/origin/master
          git fetch origin ${{ github.head_ref }}:refs/remotes/origin/temp-${{ github.head_ref }}

      - name: Get merge base commit
        id: merge_base
        run: |
          base=$(git merge-base origin/temp-${{ github.head_ref }} origin/master)
          echo "sha=$base" >> $GITHUB_OUTPUT
          echo "ðŸ” Merge-base is: $base" >> $GITHUB_STEP_SUMMARY

      - name: Find workflow run at exact merge-base SHA (push event included)
        id: find_run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MERGE_BASE=${{ steps.merge_base.outputs.sha }}
          echo "ðŸ” Searching for workflow run at SHA: $MERGE_BASE" >> $GITHUB_STEP_SUMMARY

          count=$(git rev-list --count ${{ steps.merge_base.outputs.sha }}..origin/master)
          count_plus_one=$((count + 1))
          echo "ðŸ” Count of commits between merge-base and PR branch: $count_plus_one" >> $GITHUB_STEP_SUMMARY
          run_id=$(gh run list --workflow "Measure Disk Usage" --limit $count_plus_one --branch "master" --json databaseId,headSha,event \
            | jq -r --arg sha "$MERGE_BASE" '.[] | select(.headSha == $sha) | .databaseId' | head -n 1)
          if [ -z "$run_id" ]; then
            echo "No workflow run found for that SHA" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # echo "Found run_id=$run_id" >> $GITHUB_STEP_SUMMARY 
          echo "run_id=$run_id" >> $GITHUB_OUTPUT
          # echo "run_id=$run_id" >> $GITHUB_STEP_SUMMARY

      - name: Download artifact from merge-base run
        run: gh run download ${{ steps.find_run.outputs.run_id }} --name uncompressed_status.csv
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List downloaded files
        run: |
          echo "Downloaded files:" >> $GITHUB_STEP_SUMMARY
          ls -lh >> $GITHUB_STEP_SUMMARY

      - name: add comment to PR
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "Removed:{'Name': 'botocore', 'Version': '1.38.41', 'Size_Bytes': '13343171', 'Type': 'Dependency', 'Platform': 'macos-aarch64', 'Python_Version': '3.12'}[Dependency] botocore 1.38.41: - 0{'Name': 'lxml', 'Version': '5.1.1', 'Size_Bytes': '8761615', 'Type': 'Dependency', 'Platform': 'macos-aarch64', 'Python_Version': '3.12'}[Dependency] lxml 5.1.1: - 0{'Name': 'cryptography', 'Version': '45.0.4', 'Size_Bytes': '7038592', 'Type': 'Dependency', 'Platform': 'macos-aarch64', 'Python_Version': '3.12'}[Dependency] cryptography 45.0.4: - 0{'Name': 'ddtrace', 'Version': '3.9.3', 'Size_Bytes': '6807288', 'Type': 'Dependency', 'Platform': 'macos-aarch64', 'Python_Version': '3.12'}[Dependency] ddtrace 3.9.3: - 0{'Name': 'confluent-kafka', 'Version': '2.8.0', 'Size_Bytes': '4133925', 'Type': 'Dependency', 'Platform': 'macos-aarch64', 'Python_Version': '3.12'}"


    # run: gh run download ${{ steps.find_run.outputs.run_id }} --name uncompressed_status.csv

    # ------------------------------------------------------------
    # - name: Measure disk usage (uncompressed)
    #   run: | 
    #     ddev size status --to-dd-key ${{secrets.DD_API_KEY}} > size-uncompressed.txt 
    #     ddev size status  --format png,csv,markdown
    #     cat size-uncompressed.txt
    #     echo "# Size (uncompressed)" >> $GITHUB_STEP_SUMMARY
    #     cat uncompressed_status.md >> $GITHUB_STEP_SUMMARY
  
    # - name: Measure disk usage (compressed)
    #   run: |
    #     ddev size status --compressed --to-dd-key ${{secrets.DD_API_KEY}} > size-compressed.txt 
    #     ddev size status --compressed  --format png,csv,markdown
    #     cat size-compressed.txt
    #     echo "# Size (compressed)" >> $GITHUB_STEP_SUMMARY
    #     cat compressed_status.md >> $GITHUB_STEP_SUMMARY



    # - name: Measure disk usage differences from last commit (uncompressed)
    #   run: | 
    #     BEFORE=$(git rev-parse HEAD^)
    #     AFTER=$(git rev-parse HEAD)
    #     ddev size diff $BEFORE $AFTER > diff-uncompressed.txt
    #     ddev size diff $BEFORE $AFTER  --format png,csv,markdown
    #     cat diff-uncompressed.txt
    #     echo "# Size diff (uncompressed)" >> $GITHUB_STEP_SUMMARY
    #     if [ -f uncompressed_diff.md ]; then
    #         cat uncompressed_diff.md >> $GITHUB_STEP_SUMMARY
    #     fi

    # - name: Measure disk usage differences from last commit (compressed)
    #   run: | 
    #     BEFORE=$(git rev-parse HEAD^)
    #     AFTER=$(git rev-parse HEAD)
    #     ddev size diff $BEFORE $AFTER --compressed > diff-compressed.txt
    #     ddev size diff $BEFORE $AFTER --compressed  --format png,csv,markdown
    #     cat diff-compressed.txt
    #     echo "# Size diff (compressed)" >> $GITHUB_STEP_SUMMARY
    #     if [ -f compressed_diff.md ]; then
    #         cat compressed_diff.md >> $GITHUB_STEP_SUMMARY
    #     fi

    # - name: Upload file sizes (uncompressed)
    #   uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
    #   with:
    #     name: uncompressed_status.csv
    #     path: uncompressed_status.csv
    #     if-no-files-found: error

    # - name: Upload file sizes (compressed)
    #   uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
    #   with:
    #     name: compressed_status.csv
    #     path: compressed_status.csv
    #     if-no-files-found: error
  
    # - name: Upload file sizes diff (uncompressed)
    #   uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
    #   with:
    #     name: uncompressed_diff.csv
    #     path: uncompressed_diff.csv
    #     if-no-files-found: warn

    # - name: Upload file sizes diff (compressed)
    #   uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
    #   with:
    #     name: compressed_diff.csv
    #     path: compressed_diff.csv
    #     if-no-files-found: warn

    # - name: Upload status PNGs
    #   uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
    #   with:
    #     name: size-visuals
    #     path: size_status_visualizations/
    #     if-no-files-found: error

    # - name: Upload diff PNGs
    #   uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
    #   with:
    #     name: diff-visuals
    #     path: size_diff_visualizations/
    #     if-no-files-found: warn
    
