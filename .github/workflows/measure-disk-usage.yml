name: Measure Disk Usage

on:
  workflow_call:
  # workflow_run:
  #   workflows: ['Resolve Dependencies and Build Wheels']
  #   types:
  #     - completed
env:
  PYTHON_VERSION: "3.12"

jobs:
  set-platforms:
    runs-on: ubuntu-22.04
    outputs:
      platforms: ${{ steps.set.outputs.platforms }}
    steps:
      - id: set
        run: echo 'platforms=["macos-x86_64","macos-aarch64", "linux-aarch64","linux-x86_64","windows-x86_64"]' >> "$GITHUB_OUTPUT" 

  measure-disk-usage:
    runs-on: ubuntu-22.04
    needs:
      - set-platforms
    permissions:
        contents: read
        actions: read
    strategy:
      matrix:
        platform: ${{ fromJSON(needs.set-platforms.outputs.platforms) }}
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0
    - name: Set up Python ${{env.PYTHON_VERSION}}
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
      with:
        python-version: ${{env.PYTHON_VERSION}}
    - name: Install ddev
      run: |
        pip install -e ./datadog_checks_dev[cli]
        pip install -e ./ddev
    - name: Configure ddev
      run: |
            ddev config override

    - name: Determine commit SHAs
      id: commits
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
            if [ "${{ github.event_name }}" = "pull_request" ]; then # CHANGE TO github.event.workflow_run.event
              echo "current_sha=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
              echo "base_sha=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
            elif [ "${{ github.event_name }}" = "push" ]; then # CHANGE TO github.event.workflow_run.event
              echo "current_sha=${{ github.sha }}" >> "$GITHUB_OUTPUT"
            fi

    - name: Measure disk usage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cmd="ddev size status \
        --platform ${{ matrix.platform }} \
        --commit ${{ steps.commits.outputs.current_sha }} \
        --format json"

        # Send metrics to Datadog only on push to default branch
        if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref_name }}" = "${{ github.event.repository.default_branch }}" ]; then # CHANGE TO github.event.workflow_run.event
          cmd="$cmd --to-dd-key ${{ secrets.DD_API_KEY }}"
        fi
        
        $cmd

        $cmd --compressed

    - name: Upload JSON uncompressed sizes artifact
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: status_uncompressed_${{ matrix.platform }}.json
        path: status_uncompressed_${{ matrix.platform }}.json
        if-no-files-found: error
  
    - name: Upload JSON compressed sizes artifact
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: status_compressed_${{ matrix.platform }}.json
        path: status_compressed_${{ matrix.platform }}.json
        if-no-files-found: error        