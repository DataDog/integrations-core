name: Trigger Integration Release

# This workflow triggers wheel builds in the private agent-integration-wheels-release repo
# when new integration versions are ready to release
# TRIGGER

on:
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      integrations:
        description: 'JSON array of integrations to release (e.g., ["postgres", "mysql"])'
        required: true
        type: string
      ref:
        description: "Git reference to build from (commit SHA, branch, or tag)"
        required: false
        type: string
        default: "master"

  # PR trigger for testing (only test branch, not master)
  pull_request:
    branches:
      - dk/test-release-trigger

  # TODO: Add tag trigger after testing
  # push:
  #   tags:
  #     - '*-*'

jobs:
  trigger-release:
    name: Trigger wheel build
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for OIDC token generation (dd-octo-sts)
      contents: read # Required for repository_dispatch API call

    steps:
      - name: Extract inputs
        id: extract
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # PR testing - use test integrations and PR head ref
            INTEGRATIONS='["postgres", "mysql"]'
            SOURCE_REF='${{ github.event.pull_request.head.sha }}'
            POLICY_NAME="integrations-core.dispatch-wheel-builds-test"
            echo "PR testing mode"
          else
            # Manual trigger - use workflow inputs
            INTEGRATIONS='${{ inputs.integrations }}'
            SOURCE_REF='${{ inputs.ref }}'
            POLICY_NAME="integrations-core.dispatch-wheel-builds"
            echo "Manual trigger mode"
          fi

          echo "Integrations to build: $INTEGRATIONS"
          echo "Source ref: $SOURCE_REF"
          echo "Policy: $POLICY_NAME"

          echo "integrations=$INTEGRATIONS" >> $GITHUB_OUTPUT
          echo "source-ref=$SOURCE_REF" >> $GITHUB_OUTPUT
          echo "policy=$POLICY_NAME" >> $GITHUB_OUTPUT

      - name: Get GitHub token via dd-octo-sts
        id: octo-sts
        uses: DataDog/dd-octo-sts-action@08f2144903ced3254a3dafec2592563409ba2aa0 # v1.0.1
        with:
          scope: DataDog/agent-integration-wheels-release
          policy: ${{ steps.extract.outputs.policy }}

      - name: Trigger wheel build in agent-integration-wheels-release
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          INTEGRATIONS_JSON: ${{ steps.extract.outputs.integrations }}
          SOURCE_REF: ${{ steps.extract.outputs.source-ref }}
          EVENT_NAME: ${{ github.event_name }}
        with:
          github-token: ${{ steps.octo-sts.outputs.token }}
          script: |
            // Parse inputs from environment to prevent code injection
            const integrations = JSON.parse(process.env.INTEGRATIONS_JSON);
            const sourceRef = process.env.SOURCE_REF;
            const eventName = process.env.EVENT_NAME;

            console.log('üöÄ Triggering build for:', integrations);
            console.log('üì¶ Source: integrations-core at', sourceRef);

            try {
              let workflowUrl;

              if (eventName === 'pull_request') {
                // For PRs: use workflow_dispatch to target the feature branch
                console.log('üìã Using workflow_dispatch for PR testing');

                const response = await github.rest.actions.createWorkflowDispatch({
                  owner: 'DataDog',
                  repo: 'agent-integration-wheels-release',
                  workflow_id: 'release-integrations.yml',
                  ref: '01-28-add_release_workflow',
                  inputs: {
                    integrations: JSON.stringify(integrations),
                    'source-repo': 'integrations-core',
                    'source-repo-ref': sourceRef,
                    'release-cli-ref': '01-28-add_release_workflow'
                  }
                });

                workflowUrl = `https://github.com/DataDog/agent-integration-wheels-release/actions/workflows/release-integrations.yml`;
              } else {
                // For manual triggers: use repository_dispatch (will work once workflow is on main)
                console.log('üìã Using repository_dispatch for production');

                await github.rest.repos.createDispatchEvent({
                  owner: 'DataDog',
                  repo: 'agent-integration-wheels-release',
                  event_type: 'build-integrations',
                  client_payload: {
                    integrations: integrations,
                    source_repo: 'integrations-core',
                    source_repo_ref: sourceRef,
                    triggered_by_repo: context.repo.repo,
                    triggered_by_ref: context.ref,
                    triggered_by_sha: context.sha
                  }
                });

                workflowUrl = 'https://github.com/DataDog/agent-integration-wheels-release/actions';
              }

              console.log('‚úÖ Build triggered successfully');
              console.log(`üìä Check build status at: ${workflowUrl}`);
            } catch (error) {
              console.error('‚ùå Failed to trigger build:', error.message);
              throw error;
            }
