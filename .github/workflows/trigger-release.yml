name: Trigger Integration Release

# This workflow triggers wheel builds in the private agent-integration-wheels-release repo
# when new integration versions are ready to release

on:
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      integrations:
        description: 'JSON array of integrations to release (e.g., ["postgres", "mysql"])'
        required: true
        type: string
      ref:
        description: 'Git reference to build from (commit SHA, branch, or tag)'
        required: false
        type: string
        default: 'master'

  # TODO: Add tag trigger after testing
  # push:
  #   tags:
  #     - '*-*'

jobs:
  trigger-release:
    name: Trigger wheel build
    runs-on: ubuntu-latest

    steps:
      - name: Extract inputs
        id: extract
        run: |
          # For manual trigger, use workflow inputs
          INTEGRATIONS='${{ inputs.integrations }}'
          SOURCE_REF='${{ inputs.ref }}'

          echo "Integrations to build: $INTEGRATIONS"
          echo "Source ref: $SOURCE_REF"

          echo "integrations=$INTEGRATIONS" >> $GITHUB_OUTPUT
          echo "source-ref=$SOURCE_REF" >> $GITHUB_OUTPUT

      - name: Trigger wheel build in agent-integration-wheels-release
        uses: actions/github-script@v7
        env:
          INTEGRATIONS_JSON: ${{ steps.extract.outputs.integrations }}
          SOURCE_REF: ${{ steps.extract.outputs.source-ref }}
        with:
          github-token: ${{ secrets.INTEGRATION_RELEASE_TOKEN }}
          script: |
            // Parse inputs from environment to prevent code injection
            const integrations = JSON.parse(process.env.INTEGRATIONS_JSON);
            const sourceRef = process.env.SOURCE_REF;

            console.log('üöÄ Triggering build for:', integrations);
            console.log('üì¶ Source: integrations-core at', sourceRef);

            try {
              await github.rest.repos.createDispatchEvent({
                owner: 'DataDog',
                repo: 'agent-integration-wheels-release',
                event_type: 'build-integrations',
                client_payload: {
                  integrations: integrations,
                  source_repo: 'integrations-core',
                  source_repo_ref: sourceRef,
                  triggered_by_repo: context.repo.repo,
                  triggered_by_ref: context.ref,
                  triggered_by_sha: context.sha
                }
              });

              console.log('‚úÖ Build triggered successfully');
              console.log('üìä Check build status at: https://github.com/DataDog/agent-integration-wheels-release/actions');
            } catch (error) {
              console.error('‚ùå Failed to trigger build:', error.message);
              throw error;
            }
