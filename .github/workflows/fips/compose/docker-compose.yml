services:
  agent:
    image: ${AGENT_IMAGE}
    volumes:
      - ./agent/checks.d:/etc/datadog-agent/checks.d
      - ./agent/conf.d:/etc/datadog-agent/conf.d
    healthcheck:
      test: ["CMD", "agent", "status"]
      interval: 5s
      timeout: 2s
      retries: 3
  fips-server:
    build: ./server
    ports:
      - "8443:443"
    volumes:
      - ./server/ca.crt:/etc/ssl/certs/server.crt
      - ./server/ca.key:/etc/ssl/private/server.key
    command: ["/usr/local/bin/start-server.sh", "ECDHE-RSA-AES128-SHA256"]
    healthcheck:
      test: ["CMD", "curl", "-f", "https://localhost:443"]
      interval: 30s
      timeout: 10s
      retries: 3

  non-fips-server:
    build: ./server
    ports:
      - "9443:443"
    volumes:
      - ./server/ca.crt:/etc/ssl/certs/server.crt
      - ./server/ca.key:/etc/ssl/private/server.key
    command: ["/usr/local/bin/start-server.sh", "ECDHE-RSA-CHACHA20-POLY1305"]
    healthcheck:
      test: ["CMD", "curl", "-f", "https://localhost:443"]
      interval: 30s
      timeout: 10s
      retries: 3
