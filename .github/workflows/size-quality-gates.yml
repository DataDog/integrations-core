name: Quality Gates

on:
  workflow_call:
    inputs:
      platform:
        required: true
        type: string
      run-id:
        required: true
        type: string
# on:
#   workflow_run:
#     workflows: 
#       - "Measure Disk Usage" 
#     types:
#       - completed
env:
  PYTHON_VERSION: "3.12"

jobs:
  get-diff:
    runs-on: ubuntu-22.04
    outputs:
      run_id_base: ${{ steps.find_run.outputs.run_id_base }}
    strategy:
      matrix:
        platform: [macos-x86_64, macos-aarch64, linux-x86_64, linux-aarch64, windows-x86_64]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install ddev
        run: |
          pip install -e ./datadog_checks_dev[cli]
          pip install -e ./ddev

      - name: Configure ddev
        run: |
          ddev config set repos.core .
          ddev config set repo core
      - name: Get merge base commit
        id: merge_base
        run: |
          git fetch origin master:refs/remotes/origin/master
          git fetch origin ${{ github.head_ref }}:refs/remotes/origin/temp-${{ github.head_ref }}
          base=$(git merge-base origin/temp-${{ github.head_ref }} origin/master)
          echo "sha=$base" >> $GITHUB_OUTPUT
      - name: Find workflow run at exact merge-base SHA 
        id: find_run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MERGE_BASE=${{ steps.merge_base.outputs.sha }}
          count=$(git rev-list --count ${{ steps.merge_base.outputs.sha }}..origin/master)
          count_plus_one=$((count + 1))
          run_id_base=$(
            (
              gh run list --workflow "Measure Disk Usage" --limit $count_plus_one --branch "master" --json databaseId,headSha,event
            ) | jq -s '[.[][]] | .[] | select(.headSha == "'"$MERGE_BASE"'") | .databaseId' | head -n 1
          )
          echo "run_id_base=$run_id_base" >> $GITHUB_OUTPUT
          if [ -z "$run_id_base" ]; then
            echo "No workflow run found for that SHA" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  
      - name: Download artifact from merge-base run
        run: gh run download ${{ steps.find_run.outputs.run_id_base}} --name compressed_status.csv # ${{ matrix.platform }}_compressed_status.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Rename previous sizes artifact
        run: |
          mv compressed_status.csv ${{ matrix.platform }}_prev_compressed_status.csv


      - name: Download current sizes artifact
        run: gh run download ${{ github.event.workflow_run.id }} --name ${{ matrix.platform }}_compressed_status.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Rename current sizes artifact
        run: |
          mv ${{ matrix.platform }}_compressed_status.json ${{ matrix.platform }}_curr_compressed_status.json
          
      - name: Calculate diffs
        run: |
          python ddev/src/ddev/cli/size/utils/gha_diff.py --prev-sizes ${{ matrix.platform }}_prev_compressed_status.csv --curr-sizes ${{ matrix.platform }}_curr_compressed_status.json --output ${{ matrix.platform }}_diffs.json > $GITHUB_STEP_SUMMARY

      - name: Upload diffs artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: ${{ matrix.platform }}_diffs.json
          path: ${{ matrix.platform }}_diffs.json

      - name: Upload current sizes artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: ${{ matrix.platform }}_curr_compressed_status.json
          path: ${{ matrix.platform }}_compressed_status.json


  












