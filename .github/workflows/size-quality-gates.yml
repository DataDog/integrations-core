name: Quality Gates

on:
  workflow_call:
    inputs:
      platform:
        required: true
        type: string

# on:
#   workflow_run:
#     workflows: 
#       - "Measure Disk Usage" 
#     types:
#       - completed
env:
  PYTHON_VERSION: "3.12"

jobs:
  get-diff:
    runs-on: ubuntu-22.04
    outputs:
      run_id_base: ${{ steps.find_run.outputs.run_id_base }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install ddev
        run: |
          pip install -e ./datadog_checks_dev[cli]
          pip install -e ./ddev
      - name: Configure ddev
        run: |
          ddev config set repos.core .
          ddev config set repo core
      - name: Get merge base commit
        id: merge_base
        run: |
          git fetch origin master:refs/remotes/origin/master
          git fetch origin ${{ github.head_ref }}:refs/remotes/origin/temp-${{ github.head_ref }}
          base=$(git merge-base origin/temp-${{ github.head_ref }} origin/master)
          echo "sha=$base" >> $GITHUB_OUTPUT
          echo "base=$base" >> $GITHUB_STEP_SUMMARY
      - name: Find workflow run at exact merge-base SHA 
        id: find_run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MERGE_BASE=${{ steps.merge_base.outputs.sha }}
          count=$(git rev-list --count ${{ steps.merge_base.outputs.sha }}..origin/master)
          count_plus_one=$((count + 1))
          echo "count=$count" >> $GITHUB_STEP_SUMMARY
          run_id_base=$(
            (
              gh run list --workflow "Measure Disk Usage" --limit $count_plus_one --branch "master" --json databaseId,headSha,event
            ) | jq -s '[.[][]] | .[] | select(.headSha == "'"$MERGE_BASE"'") | .databaseId' | head -n 1
          )
          echo "run_id_base=$run_id_base" >> $GITHUB_OUTPUT
          if [ -z "$run_id_base" ]; then
            echo "No workflow run found for that SHA" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
  
      - name: Download artifact from merge-base run
        run: gh run download ${{ steps.find_run.outputs.run_id_base}} --name compressed_status.csv # ${{ inputs.platform }}_compressed_status.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Rename previous sizes artifact
        run: |
          mv compressed_status.csv status_compressed_${{ inputs.platform }}_prev.csv

      - name: Download current sizes artifact
        run: gh run download ${{ github.run_id }} --name status_compressed_${{ inputs.platform }}.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Rename current sizes artifact
        run: |
          mv status_compressed_${{ inputs.platform }}.json status_compressed_${{ inputs.platform }}_curr.json
          
      - name: Calculate diffs 
        run: |
          MERGE_BASE_SHORT=$(echo "${{ steps.merge_base.outputs.sha }}" | cut -c1-7)
          echo "Comparing with base [($MERGE_BASE_SHORT)](https://github.com/${{ github.repository }}/commit/${{ steps.merge_base.outputs.sha }})" \
            > size_diffs_output.txt
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref_name }}" == "${{ github.event.repository.default_branch }}" ]]; then
            # send metrics to datadog if this is a push to master
            python ddev/src/ddev/cli/size/utils/gha_diff.py --send-to-datadog --prev-sizes status_compressed_${{ inputs.platform }}_prev.csv --curr-sizes status_compressed_${{ inputs.platform }}_curr.json --output diffs_${{ inputs.platform }}.json >> size_diffs_output.txt
          else
            python ddev/src/ddev/cli/size/utils/gha_diff.py --prev-sizes status_compressed_${{ inputs.platform }}_prev.csv --curr-sizes status_compressed_${{ inputs.platform }}_curr.json --output diffs_${{ inputs.platform }}.json >> size_diffs_output.txt
          fi
          cat size_diffs_output.txt >> $GITHUB_STEP_SUMMARY

      - name: Upload size diffs as artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: size_diffs_output_${{ inputs.platform }}
          path: size_diffs_output.txt

      - name: Upload diffs artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: diffs_${{ inputs.platform }}.json
          path: diffs_${{ inputs.platform }}.json

     





