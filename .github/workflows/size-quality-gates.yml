name: Quality Gates

on:
  workflow_call: # this is used by the resolve-build-deps and size-qg-prev-dep-sizes-json workflows 
    inputs:
      platform:
        required: true
        type: string
    outputs:
      base_sha:
        description: Merge-base SHA
        value: ${{ jobs.get-diff.outputs.base_sha }}
      passes_qg:
        description: Whether the quality gates passed
        value: ${{ jobs.get-diff.outputs.passes_qg }}

env:
  PYTHON_VERSION: "3.12"

jobs:
  get-diff: 
    runs-on: ubuntu-22.04
    outputs:
      run_id_base: ${{ steps.find_run.outputs.run_id_base }}
      base_sha: ${{ steps.merge_base.outputs.base_sha }}
      total_diff: ${{ steps.calculate_diffs.outputs.total_diff }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install ddev
        run: |
          pip install -e ./datadog_checks_dev[cli]
          pip install -e ./ddev
      - name: Configure ddev
        run: |
          ddev config set repos.core .
          ddev config set repo core
      - name: Get merge base commit
        id: merge_base
        run: |
          git fetch origin master:refs/remotes/origin/master
          base=$(git merge-base HEAD origin/master)
          echo "base_sha=$base" >> $GITHUB_OUTPUT
      - name: Find workflow run at exact merge-base SHA 
        id: find_run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MERGE_BASE=${{ steps.merge_base.outputs.base_sha }}
          count=$(git rev-list --count ${{ steps.merge_base.outputs.base_sha }}..origin/master)
          count_plus_one=$((count + 1))
          run_id_base=$(
            (
              gh run list --workflow "Measure Disk Usage" --limit $count_plus_one --branch "master" --json databaseId,headSha,event
            ) | jq -r -s --arg sha "$MERGE_BASE" '[.[][]] | .[] | select(.headSha == $sha) | .databaseId' | head -n 1
          )
          echo "run_id_base=$run_id_base" >> $GITHUB_OUTPUT
          if [ -z "$run_id_base" ]; then
            echo "No workflow run found for that SHA" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
  
      - name: Download artifact from merge-base run
        run: |
          gh run download ${{ steps.find_run.outputs.run_id_base}} --name compressed_status.csv # $status_compressed_${{ inputs.platform }}.json
          gh run download ${{ steps.find_run.outputs.run_id_base}} --name uncompressed_status.csv # $status_uncompressed_${{ inputs.platform }}.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Rename previous sizes artifact
        run: |
          mv compressed_status.csv status_compressed_${{ inputs.platform }}_prev.csv
          mv uncompressed_status.csv status_uncompressed_${{ inputs.platform }}_prev.csv

      - name: Download current sizes artifact
        run: |
          gh run download ${{ github.run_id }} --name status_compressed_${{ inputs.platform }}.json
          gh run download ${{ github.run_id }} --name status_uncompressed_${{ inputs.platform }}.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Rename current sizes artifact
        run: |
          mv status_compressed_${{ inputs.platform }}.json status_compressed_${{ inputs.platform }}_curr.json
          mv status_uncompressed_${{ inputs.platform }}.json status_uncompressed_${{ inputs.platform }}_curr.json
          
      - name: Calculate diffs 
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref_name }}" == "${{ github.event.repository.default_branch }}" ]]; then
            # send metrics to datadog if this is a push to master
            PASSES_QG=$(python ddev/src/ddev/cli/size/utils/gha_diff.py --send-to-datadog ${{secrets.DD_API_KEY}} --compressed-prev-sizes status_compressed_${{ inputs.platform }}_prev.csv --compressed-curr-sizes status_compressed_${{ inputs.platform }}_curr.json --uncompressed-prev-sizes status_uncompressed_${{ inputs.platform }}_prev.csv --uncompressed-curr-sizes status_uncompressed_${{ inputs.platform }}_curr.json --output diffs_${{ inputs.platform }}.json --html-long-out size_diffs_output_${{ inputs.platform }}.txt --html-short-out size_diffs_output_short_${{ inputs.platform }}.txt --threshold -100000000000) >> $GITHUB_STEP_SUMMARY
          else
            PASSES_QG=$(python ddev/src/ddev/cli/size/utils/gha_diff.py --compressed-prev-sizes status_compressed_${{ inputs.platform }}_prev.csv --compressed-curr-sizes status_compressed_${{ inputs.platform }}_curr.json --uncompressed-prev-sizes status_uncompressed_${{ inputs.platform }}_prev.csv --uncompressed-curr-sizes status_uncompressed_${{ inputs.platform }}_curr.json --output diffs_${{ inputs.platform }}.json --html-long-out size_diffs_output_${{ inputs.platform }}.txt --html-short-out size_diffs_output_short_${{ inputs.platform }}.txt --threshold -10000000000) >> $GITHUB_STEP_SUMMARY
          fi
          echo "passes_qg=$PASSES_QG" >> $GITHUB_OUTPUT
          if [[ "$PASSES_QG" == "false" ]]; then
            cat size_diffs_output_${{ inputs.platform }}.txt >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload long size diffs output as artifact
        if: ${{ steps.calculate_diffs.outputs.passes_qg == 'false' }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: size_diffs_output_${{ inputs.platform }}.txt
          path: size_diffs_output_${{ inputs.platform }}.txt
          retention-days: 1
          

      - name: Upload short size diffs output as artifact
        if: ${{ steps.calculate_diffs.outputs.passes_qg == 'false' }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: size_diffs_output_short_${{ inputs.platform }}.txt
          path: size_diffs_output_short_${{ inputs.platform }}.txt
          retention-days: 1

      - name: Upload diffs artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: diffs_${{ inputs.platform }}.json
          path: diffs_${{ inputs.platform }}.json


     






