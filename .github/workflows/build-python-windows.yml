name: Build CPython Installer

on:
  workflow_call:
    inputs:
      python_version:
        required: true
        type: string
        description: 'The version of CPython to build (e.g., 3.12)'
      openssl_version:
        required: true
        type: string
        description: 'The version of OpenSSL to build (e.g., 3.0.15)'
      openssl_fips_version:
        required: true
        type: string
        description: 'The version of OpenSSL FIPS to build (e.g., 3.0.9)'

jobs:
  build-python:
    strategy:
      matrix:
        os: [windows-2019, windows-2022]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    

    env:
      PYTHON_TAG: v${{ inputs.python_version }}
      PYTHON_REPO_PATH: C:/repos/cpython
      OPENSSL_VERSION: openssl-${{ inputs.openssl_version }}
      OPENSSL_FIPS_VERSION: openssl-${{ inputs.openssl_fips_version }}
      MSYS2_PATH: C:/msys64/
      ARTIFACT_NAME: python-${{ matrix.os }}-${{ inputs.python_version }}-amd64.zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Disabe for now
      - name: Select Toolchain
        if: matrix.os == 'windows-2022' && false
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
          sdk: 10.0.19041.0

      - name: Install dotnet PowerShell
        run: dotnet tool install --global PowerShell

      - name: Clone CPython repository
        run: git clone --branch $env:PYTHON_TAG --depth 1 https://github.com/python/cpython.git $env:PYTHON_REPO_PATH

      - name: Install OpenSSL dependencies
        run: pwsh -File .github/workflows/scripts/python-build/install-openssl-dependencies.ps1 -Msys2Path $env:MSYS2_PATH

      - name: Download and configure OpenSSL
        run: pwsh -File .github/workflows/scripts/python-build/download-and-configure-openssl.ps1 -Msys2Path $env:MSYS2_PATH -OpenSSLVersion $env:OPENSSL_VERSION

      - name: Build OpenSSL
        run: pwsh -File .github/workflows/scripts/python-build/build-openssl.ps1 -Msys2Path $env:MSYS2_PATH -OpenSSLVersion $env:OPENSSL_VERSION

      - name: Integrate OpenSSL with Python
        run: pwsh -File .github/workflows/scripts/python-build/integrate-with-python.ps1 -Msys2Path $env:MSYS2_PATH -OpenSSLVersion $env:OPENSSL_VERSION -PythonRepoPath $env:PYTHON_REPO_PATH

      - name: Build Python
        run: pwsh -File .github/workflows/scripts/python-build/build-python.ps1 -PythonRepoPath $env:PYTHON_REPO_PATH -Pgo

      - name: Build FIPS Module - Download and Configure OpenSSL
        run: pwsh -File .github/workflows/scripts/python-build/download-and-configure-openssl.ps1 -Msys2Path $env:MSYS2_PATH -OpenSSLVersion $env:OPENSSL_FIPS_VERSION -Fips

      - name: Build FIPS Module
        run: pwsh -File .github/workflows/scripts/python-build/build-openssl.ps1 -Msys2Path $env:MSYS2_PATH -OpenSSLVersion $env:OPENSSL_FIPS_VERSION -Fips

      - name: Package Python
        run: pwsh -File .github/workflows/scripts/python-build/package-python.ps1 -PythonRepoPath $env:PYTHON_REPO_PATH -Msys2Path $env:MSYS2_PATH

      - uses: actions/upload-artifact@v4
        with:
          name: python-${{ matrix.os }}-${{ inputs.python_version }}-amd64.zip
          path: C:/repos/cpython/installed
          if-no-files-found: error
          retention-days: 7

      - name: Rename Artifacts
        run: | 
          mv $env:PYTHON_REPO_PATH/python.zip $env:PYTHON_REPO_PATH/$env:ARTIFACT_NAME.zip
          mv $env:PYTHON_REPO_PATH/python.zip.sha256 $env:PYTHON_REPO_PATH/$env:ARTIFACT_NAME.zip.sha256

      - name: Upload artifact to S3
        shell: powershell
        run: |
          $env:AWS_ACCESS_KEY_ID = "${{ secrets.PYTHON_BUILD_SANDBOX_AWS_ACCESS_KEY_ID }}"
          $env:AWS_SECRET_ACCESS_KEY = "${{ secrets.PYTHON_BUILD_SANDBOX_AWS_SECRET_ACCESS_KEY }}"
          aws s3 cp $env:PYTHON_REPO_PATH/$env:ARTIFACT_NAME.zip s3://agent-ints-python-build-sandbox/ --region eu-north-1
          aws s3 cp $env:PYTHON_REPO_PATH/$env:ARTIFACT_NAME.zip.sha256 s3://agent-ints-python-build-sandbox/ --region eu-north-1
        