name: Build CPython Installer

on:
  workflow_call:
    inputs:
      python_version:
        required: true
        type: string
        description: 'The version of CPython to build (e.g., 3.12)'

jobs:
  build_cpython:
    runs-on: windows-latest
    timeout-minutes: 60
    env:
      IncludeFreethreaded: false # Todo: Check if we are using free-threading in our embedded Python. It's enabled in 3.13+ by default.
    steps:
      - name: Checkout CPython Source
        uses: actions/checkout@v3
        with:
          repository: python/cpython
          ref: v${{ inputs.python_version }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x
      
      - name: Build CPython installer
        run: | 
          .\tools\msi\buildrelease.bat -x64

      - uses: actions/upload-artifact@v4
        with:
          name: python-${{ inputs.python_version }}-amd64.exe
          path: PCbuild\amd64\en-us\python-${{ inputs.python_version }}-amd64.exe
          if-no-files-found: error
          retention-days: 1
          
      - name: Create Python Zip
        run: |
          curl -L https://raw.githubusercontent.com/DataDog/integrations-core/refs/heads/nubtron/python-build-experiments/.github/workflows/scripts/Generate-Pyzip.ps1 -o Generate-Pyzip.ps1
          $outDir = ".\out"
          mkdir $outDir
          .\Generate-Pyzip.ps1 -Version ${{ inputs.python_version }} -OutDir $outDir -InputFile "PCbuild\amd64\en-us\python-${{ inputs.python_version }}-amd64.exe"

      - uses: actions/upload-artifact@v4
        with:
          name: python-windows-${{ inputs.python_version }}-amd64.zip
          path: ./out/python-windows-${{ inputs.python_version }}-amd64.zip
          if-no-files-found: error
          retention-days: 1
