name: ZZ - POC - Trigger PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  trigger-checks:
    name: Trigger Matrix Workflows
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      pull-requests: read
      id-token: write

    steps:
      - name: Check out repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.13'

      - uses: DataDog/dd-octo-sts-action@08f2144903ced3254a3dafec2592563409ba2aa0
        id: octo-sts
        with:
          scope: DataDog/integrations-core
          policy: self.test-dispatcher

      - name: Trigger workflows for PR
        env:
          GH_TOKEN: ${{ steps.octo-sts.outputs.token }}
        run: |
          echo "Triggering workflows for PR #${{ github.event.pull_request.number }}"
          echo "Merge commit SHA: ${{ github.sha }}"
          echo "PR head SHA: ${{ github.event.pull_request.head.sha }}"

          python gh_workflow.py \
            --checkout_ref refs/pull/${{ github.event.pull_request.number }}/merge \
            --source_sha ${{ github.event.pull_request.head.sha }} \
            --multiply 1 \
            --limit 5

      - name: Summary
        if: always()
        run: |
          echo "## Workflow Trigger Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Triggered matrix workflows for PR #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Merge commit SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR head SHA**: ${{ github.event.pull_request.head.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Job limit**: 10" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The triggered workflows will appear as separate checks on this PR." >> $GITHUB_STEP_SUMMARY

