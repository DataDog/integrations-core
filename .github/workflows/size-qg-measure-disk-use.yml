name: Measure Disk Usage

on:
  workflow_call: # this is used by the resolve-build-deps and size-qg-prev-dep-sizes-json workflows 
    inputs:
      platform:
        required: true
        type: string
      run-id:
        required: true
        type: string
      resolved-deps:
        required: true
        type: boolean
env:
  PYTHON_VERSION: "3.12"

jobs:
  label:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0
    - name: Add label
      if: github.event.pull_request.draft == false
      run: |
        gh pr edit ${{ github.event.pull_request.number }} --add-label "show-size-delta"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  measure-disk-usage:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Install ddev
      run: |
        pip install -e ./datadog_checks_dev[cli]
        pip install -e ./ddev

    - name: Configure ddev
      run: |
        ddev config set repos.core .
        ddev config set repo core

    - name: Download dependency sizes artifact - resolved-deps
      if: ${{ inputs.resolved-deps }}
      run: gh run download ${{ inputs.run-id }} --name target-${{ inputs.platform }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Rename sizes.json to platform.json
      if: ${{ inputs.resolved-deps }}
      run: |
        cp "${{ inputs.platform }}/py3/sizes.json" dependency_sizes_"${{ inputs.platform }}.json"
      shell: bash

    - name: Download dependency sizes artifact - no resolved-deps
      if: ${{ !inputs.resolved-deps }}
      run: gh run download ${{ inputs.run-id }} --name dependency_sizes_${{ inputs.platform }}.json
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Measure disk usage
      run: |
        # if this is a push to master, sends metrics to datadog
        if github.event_name == 'push' && github.ref_name == github.event.repository.default_branch; then
          ddev size status --platform ${{ inputs.platform }} --dependency-sizes dependency_sizes_${{ inputs.platform }}.json --format json --to-dd-key ${{secrets.DD_API_KEY}}
          ddev size status --platform ${{ inputs.platform }} --compressed --dependency-sizes dependency_sizes_${{ inputs.platform }}.json --format json --to-dd-key ${{secrets.DD_API_KEY}}
        else
          ddev size status --platform ${{ inputs.platform }} --dependency-sizes dependency_sizes_${{ inputs.platform }}.json --format json 
          ddev size status --platform ${{ inputs.platform }} --compressed --dependency-sizes dependency_sizes_${{ inputs.platform }}.json --format json 
        fi
    - name: Upload platform.json artifact
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: dependency_sizes_${{ inputs.platform }}.json
        path: dependency_sizes_${{ inputs.platform }}.json
        if-no-files-found: error
    
    - name: Upload JSON uncompressed sizes artifact
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: status_uncompressed_${{ inputs.platform }}.json
        path: status_uncompressed_${{ inputs.platform }}.json
        if-no-files-found: error

    - name: Upload JSON compressed sizes artifact
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: status_compressed_${{ inputs.platform }}.json
        path: status_compressed_${{ inputs.platform }}.json
        if-no-files-found: error

 