name: Size Delta with Master (No Dependency Resolution) # this is part of the size-quality-gates workflow

on:   # only runs if there are no dependency changes
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

jobs:
  check-file-changes:
    runs-on: ubuntu-22.04
    outputs:
      builders_changed: ${{ steps.filter.outputs.builders_changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Use path filter to check for changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        id: filter
        with:
          filters: |
            builders:
              - '.builders/**'
              - '.github/workflows/resolve-build-deps.yml'
              - 'agent_requirements.in'

  get-merge-base:
    needs: check-file-changes
    if: needs.check-file-changes.outputs.builders_changed == 'false'
    runs-on: ubuntu-22.04
    outputs:
      run_id: ${{ steps.get-merge-base-run-id.outputs.run_id }}
    steps:
      - name: Get merge base run id
        id: get-merge-base-run-id
        run: ./.github/workflows/scripts/get_merge_base_run_id.sh "Measure Disk Usage"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}

  download-artifacts:
    needs: get-merge-base
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        platform: [macos-x86_64, macos-aarch64, linux-x86_64, linux-aarch64, windows-x86_64]
    steps:
      - name: Download artifact from merge-base run
        run: gh run download ${{ needs.get-merge-base.outputs.run_id }} --name dependency_sizes_${{ matrix.platform }}.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload platform.json artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: dependency_sizes_${{ matrix.platform }}.json
          path: dependency_sizes_${{ matrix.platform }}.json
          if-no-files-found: error

  measure-disk-usage:
    needs: 
      - download-artifacts
    strategy:
      matrix:
        platform: [macos-x86_64, macos-aarch64, linux-x86_64, linux-aarch64, windows-x86_64]
    uses: ./.github/workflows/size-qg-measure-disk-use.yml
    with:
      platform: ${{ matrix.platform }}
      run-id: ${{ github.run_id }}
      resolved-deps: false

  calculate-size-diffs:
    needs: measure-disk-usage
    strategy:
      matrix:
        platform: [macos-x86_64, macos-aarch64, linux-x86_64, linux-aarch64, windows-x86_64]
    uses: ./.github/workflows/size-quality-gates.yml
    with:
      platform: ${{ matrix.platform }}
      

  comment-size-diffs-on-pr:
    needs:
      - calculate-size-diffs
    if: >
      contains(github.event.pull_request.labels.*.name, 'show-size-delta') && 
      needs.calculate-size-diffs.outputs.passes_qg == false
    env:
      PLATFORMS: "macos-x86_64 macos-aarch64 linux-x86_64 linux-aarch64 windows-x86_64"
      GITHUB_RUN_ID: ${{ github.run_id }}
      GITHUB_REPOSITORY: ${{ github.repository }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      BASE_SHA: ${{ github.event.pull_request.base.sha }}
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      
      - name: Create output size diffs
        run: ./.github/workflows/scripts/output_size_diffs.sh

      - name: Find last comment
        uses: peter-evans/find-comment@3eae4d37986fb5a8592848f6a574fdf654e61f9e # v3.1.0
        id: find_comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: "<h3>Dependency Size Changes</h3>"

      - name: Delete last comment
        if: steps.find_comment.outputs.comment-id != ''
        run: |
          echo "Deleting comment: ${{ steps.find_comment.outputs.comment-id }}"
          gh api \
          --method DELETE \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \ 
          /repos/Datadog/integrations-core/pulls/comments/${{ steps.find_comment.outputs.comment-id }}

      - name: Create comment
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.txt
