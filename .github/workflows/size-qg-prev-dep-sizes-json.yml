name: Fetch Previous Sizes JSON

on:   # only runs if dependency sizes have not changed
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

jobs:
  check-file-changes:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Use path filter to check for changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        id: filter
        with:
          filters: 
            builders:
              - '.builders/**'
              - '.github/workflows/resolve-build-deps.yml'
              - 'agent_requirements.in'

  get-merge-base:
    needs: check-file-changes
    if: needs.check-file-changes.outputs.builders_changed == 'false'
    runs-on: ubuntu-22.04
    outputs:
      run_id: ${{ steps.find_run.outputs.run_id }}
      base_sha: ${{ steps.merge_base.outputs.base_sha }}
    steps:

      - name: Get merge base commit
        id: merge_base
        run: |
          git fetch origin master:refs/remotes/origin/master
          base=$(git merge-base HEAD origin/master)
          echo "base_sha=$base" >> $GITHUB_OUTPUT
      - name: Find workflow run at exact merge-base SHA 
        id: find_run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MERGE_BASE=${{ steps.merge_base.outputs.base_sha }}

          count=$(git rev-list --count ${{ steps.merge_base.outputs.base_sha }}..origin/master)
          count_plus_one=$((count + 1))
          run_id=$(
            (
              gh run list --workflow "Measure Disk Usage" --limit $count_plus_one --branch "master" --json databaseId,headSha,event
            ) | jq -s '[.[][]] | .[] | select(.headSha == "'"$MERGE_BASE"'") | .databaseId' | head -n 1
          )
          if [ -z "$run_id" ]; then
            echo "No workflow run found for that SHA" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  download-artifacts:
    needs: get-merge-base
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        platform: [macos-x86_64, macos-aarch64, linux-x86_64, linux-aarch64, windows-x86_64]
    steps:
      - name: Download artifact from merge-base run
        run: gh run download ${{ needs.get-merge-base.outputs.run_id }} --name dependency_sizes_${{ matrix.platform }}.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload platform.json artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: dependency_sizes_${{ matrix.platform }}.json
          path: dependency_sizes_${{ matrix.platform }}.json
          if-no-files-found: error

  measure-disk-usage:
    needs: download-artifacts
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        platform: [macos-x86_64, macos-aarch64, linux-x86_64, linux-aarch64, windows-x86_64]
    env:
      PYTHON_VERSION: "3.12"
    uses: ./.github/workflows/size-qg-measure-disk-use.yml
    with:
      platform: ${{ matrix.platform }}
      run-id: ${{ github.run_id }}
      resolved-deps: false

  calculate-size-diffs:
    needs: measure-disk-usage
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        platform: [macos-x86_64, macos-aarch64, linux-x86_64, linux-aarch64, windows-x86_64]
    uses: ./.github/workflows/size-quality-gates.yml
    with:
      platform: ${{ matrix.platform }}

  comment-size-diffs-on-pr:
    needs:
      - calculate-size-diffs
      - get-merge-base
    if: >
      contains(github.event.pull_request.labels.*.name, 'show-size-delta')
      && needs.calculate-size-diffs.outputs.passes_qg == 'false'
    env:
      PYTHON_VERSION: "3.12"
      PLATFORMS: "macos-x86_64 macos-aarch64 linux-x86_64 linux-aarch64 windows-x86_64"
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Join size diffs in order
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_SHA="${{ needs.get-merge-base.outputs.base_sha }}"
          BASE_SHORT="${BASE_SHA:0:7}"
          echo "<h3>Dependency Size Changes</h3>" > comment.txt
          echo >> comment.txt
          echo "Comparing with base [($BASE_SHORT)](https://github.com/${{ github.repository }}/commit/$BASE_SHA)" >> comment.txt
          for p in $PLATFORMS; do
            gh run download "${{ github.run_id }}" --name "size_diffs_output_${p}.txt"
            cat "size_diffs_output_${p}.txt" >> comment.txt
          done
          if [ $(wc -c < comment.txt) -gt 65536 ]; then
            echo "<h3>Dependency Size Changes</h3>" > comment.txt
            echo >> comment.txt
            echo "Comparing with base [($BASE_SHORT)](https://github.com/${{ github.repository }}/commit/$BASE_SHA)" >> comment.txt
            for p in $PLATFORMS; do
              gh run download "${{ github.run_id }}" --name "size_diffs_output_short_${p}.txt"
              cat "size_diffs_output_short_${p}.txt" >> comment.txt
            done
            GITHUB_RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo "<br/><a href=\"$GITHUB_RUN_URL\">ðŸ“‹ View detailed breakdown in GitHub Step Summary</a>" >> comment.txt
          fi

      - name: Output results
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --delete-last --yes
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.txt
        env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

