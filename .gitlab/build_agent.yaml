---
.build-agent-tpl:
  stage: build
  trigger:
    project: DataDog/datadog-agent
    branch: main
    # It's more convenient to directly show if downstream pipeline succeeded.
    strategy: depend
    variables:
      RELEASE_VERSION_6: "nightly"
      RELEASE_VERSION_7: "nightly-a7"
      BUCKET_BRANCH: "dev"
      DEPLOY_AGENT: "false"
      INTEGRATIONS_CORE_VERSION: ${CI_COMMIT_REF_NAME}
      # disable kitchen and e2e tests
      RUN_KITCHEN_TESTS: "false"
      RUN_E2E_TESTS: "off"

build-agent-auto:
  extends: .build-agent-tpl
  variables:
    AGENT_BRANCH: main
  only:
    changes:
      paths:
        - .deps/*
        - .gitlab/build_agent.yaml
      compare_to: "$CI_DEFAULT_BRANCH"

build-agent-manual:
  extends: .build-agent-tpl
  when: manual
  variables:
    AGENT_BRANCH: main
  rules:
    # By default we test with Agent's main branch.
    # From a release branch we want to use the same release branch in the agent repo.
    - if: $CI_COMMIT_BRANCH =~ "/^7.\d+.x$/"
      variables:
        AGENT_BRANCH: ${CI_COMMIT_BRANCH}
