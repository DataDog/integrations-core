name: ClickHouse
fleet_configurable: true
files:
- name: clickhouse.yaml
  options:
  - template: init_config
    options:
    - template: init_config/db
      overrides:
        global_custom_queries.value.example:
          - query: <QUERY>
            columns: <COLUMNS>
            tags: <TAGS>
    - template: init_config/default
  - template: instances
    options:
    - name: server
<<<<<<< HEAD
      fleet_configurable: true
=======
>>>>>>> 94ec4700cd (Cleanup cloud metadata)
      required: true
      description: The hostname used to connect to the system.
      value:
        type: string
    - name: port
      description: The port used to connect to the system.
      fleet_configurable: true
      value:
        type: integer
        example: 9000
    - name: username
      description: The database user to authenticate as.
      fleet_configurable: true
      value:
          type: string
          example: default
    - name: password
      description: The password of `username`.
      fleet_configurable: true
      secret: true
      value:
        type: string
    - name: db
      description: The database to connect to.
      fleet_configurable: true
      value:
        type: string
        display_default: default
    - name: connect_timeout
      description: The timeout for connecting to the `server`.
      fleet_configurable: true
      value:
        type: integer
        example: 10
    - name: read_timeout
      description: The timeout for reading from the `server`.
      fleet_configurable: true
      value:
        type: integer
        example: 10
    - name: compression
      description: |
        The compression algorithm to use. The default is no compression.
        If br is specified, the brotli library must be installed separately.

        Valid values are:
          - lz4
          - zstd
          - br
          - gzip
      fleet_configurable: true
      value:
        type: string
    - name: tls_ca_cert
      description: The path to the CA certificate file.
      value:
        type: string
    - name: tls_verify
      description: Whether or not to connect securely using TLS. The server must also support this.
      value:
        type: boolean
        example: False
    - name: verify
      description: Indicates if a certificate is required and if it will be validated after a connection is established.
      value:
        type: boolean
        example: True
    - name: dbm
      description: |
        Enable Database Monitoring (DBM) to collect query activity, metrics, and samples.
        This feature provides deep observability into query performance.
      value:
        type: boolean
        example: false
    - name: database_identifier
      description: |
        Controls how the database is identified. Each unique value of this identifier will appear in DBM as a separate
        billable instance.

        The default value is "$server:$port:$db" which uniquely identifies a ClickHouse database by its server, port,
        and database name.

        This value will be used as-is for the display name of the instance but will be normalized
        when applied as the `database_instance` tag. Please see https://docs.datadoghq.com/getting_started/tagging/
        for more details on Datadog tag normalization.
      options:
        - name: template
          description: |
            The template string for the database identifier. Supports variable substitution using $variable syntax.
            Available variables: $server, $port, $db, plus any custom tags (e.g., $env, $region).
          value:
            type: string
            display_default: "$server:$port:$db"
            example: "$env-$server:$port:$db"
    - name: single_endpoint_mode
      description: Set to `true` when connecting through a single endpoint for ClickHouse Cloud.
      value:
        type: boolean
        example: false
    - name: query_activity
      description: Configure collection of database activity snapshots from system.processes
      options:
        - name: enabled
          description: |
            Enable collection of database activity snapshots. Requires `dbm: true`.
            Activity snapshots show currently executing queries and connection counts.
          value:
            type: boolean
            example: true
        - name: collection_interval
          description: |
            Set the activity snapshot collection interval (in seconds). Each collection involves a single query to
            `system.processes` to capture currently executing queries.
          value:
            type: number
            example: 1
        - name: payload_row_limit
          description: |
            Set the maximum number of active sessions to include in each activity snapshot.
          value:
            type: integer
            example: 1000
        - name: run_sync
          hidden: true
          description: |
            Run the activity collection synchronously. This is useful for testing purposes, but should not be used
            in production as it can block the main thread and cause performance issues.
          value:
            type: boolean
            example: false
    - name: query_metrics
      description: Configure collection of query metrics
      options:
        - name: enabled
          description: |
            Enable collection of query metrics. Requires `dbm: true`.
          value:
            type: boolean
            example: true
        - name: collection_interval
          description: |
            Set the query metric collection interval (in seconds). Each collection involves a single query to
            `system.query_log`. If a non-default value is chosen then that exact same value must be used for *every*
            check instance. Running different instances with different collection intervals is not supported.
          value:
            type: number
            example: 10
        - name: run_sync
          hidden: true
          description: |
            Run the query metrics collection synchronously. This is useful for testing purposes, but should not be used
            in production as it can block the main thread and cause performance issues.
          value:
            type: boolean
            example: false
        - name: full_statement_text_cache_max_size
          hidden: true
          description: |
            Set the max size of the cache used for the full statement text.
          value:
            type: number
            default: 10000
        - name: full_statement_text_samples_per_hour_per_query
          hidden: true
          description: |
            Set the max number of full statement text samples to collect per hour per query.
          value:
            type: number
            default: 1
    - name: completed_query_samples
      description: Configure collection of completed query samples from system.query_log
      options:
        - name: enabled
          description: |
            Enable collection of completed query samples. Requires `dbm: true`.
            These samples represent individual completed queries and appear on the DBM Query Samples page.
          value:
            type: boolean
            example: true
        - name: collection_interval
          description: |
            Set the completed query samples collection interval (in seconds).
            Lower values show more recent queries but increase collection overhead.
          value:
            type: number
            example: 10
        - name: samples_per_hour_per_query
          description: |
            Set the maximum number of samples to collect per hour per unique query signature.
            This rate limiting prevents excessive data collection for frequently executed queries.
          value:
            type: number
            example: 15
        - name: seen_samples_cache_maxsize
          hidden: true
          description: |
            Set the max size of the cache used for rate limiting samples.
          value:
            type: number
            default: 10000
        - name: max_samples_per_collection
          hidden: true
          description: |
            Maximum number of samples to collect in a single run (applies LIMIT in SQL).
            Prevents overwhelming the agent with too many samples at once.
          value:
            type: number
            default: 1000
        - name: run_sync
          hidden: true
          description: |
            Run the completed query samples collection synchronously. For testing only.
          value:
            type: boolean
            example: false
    - template: instances/db
      overrides:
        custom_queries.value.example:
          - query: SELECT foo, COUNT(*) FROM table.events GROUP BY foo
            columns:
              - name: foo
                type: tag
              - name: event.total
                type: gauge
            tags:
              - test:clickhouse
            metric_prefix: clickhouse
    - template: instances/default
  - template: logs
    example:
    - source: clickhouse
      type: file
      path:  /var/log/clickhouse-server/clickhouse-server.log
      log_processing_rules:
        - type: multi_line
          name: log_start_with_date
          pattern: \d{4}\.\d{2}\.\d{2}
    - source: clickhouse
      type: file
      path: /var/log/clickhouse-server/clickhouse-server.err.log
      log_processing_rules:
        - type: multi_line
          name: log_start_with_date
          pattern: \d{4}\.\d{2}\.\d{2}
