name: ClickHouse
files:
- name: clickhouse.yaml
  options:
  - template: init_config
    options:
    - template: init_config/db
      overrides:
        global_custom_queries.value.example:
          - query: <QUERY>
            columns: <COLUMNS>
            tags: <TAGS>
    - template: init_config/default
  - template: instances
    options:
    - name: server
      required: true
      description: The hostname used to connect to the system.
      value:
        type: string
    - name: port
      description: The port used to connect to the system.
      value:
        type: integer
        example: 9000
    - name: username
      description: The database user to authenticate as.
      value:
          type: string
          example: default
    - name: password
      description: The password of `username`.
      secret: true
      value:
        type: string
    - name: db
      description: The database to connect to.
      value:
        type: string
        display_default: default
    - name: connect_timeout
      description: The timeout for connecting to the `server`.
      value:
        type: integer
        example: 10
    - name: read_timeout
      description: The timeout for reading from the `server`.
      value:
        type: integer
        example: 10
    - name: compression
      description: |
        The compression algorithm to use. The default is no compression.
        If br is specified, the brotli library must be installed separately.

        Valid values are:
          - lz4
          - zstd
          - br
          - gzip
      value:
        type: string
    - name: tls_ca_cert
      description: The path to the CA certificate file.
      value:
        type: string
    - name: tls_verify
      description: Whether or not to connect securely using TLS. The server must also support this.
      value:
        type: boolean
        example: False
    - name: verify
      description: Indicates if a certificate is required and if it will be validated after a connection is established.
      value:
        type: boolean
        example: True
    - name: dbm
      description: |
        Enable Database Monitoring (DBM) to collect query samples and execution plans.
        This feature provides deep observability into query performance.
      value:
        type: boolean
        example: false
    - name: query_samples
      description: Configure collection of query samples
      options:
        - name: enabled
          description: |
            Enable collection of query samples. Requires `dbm: true`.
          value:
            type: boolean
            example: true
        - name: collection_interval
          description: |
            Set the query sample collection interval (in seconds). Each collection involves a single query to
            `system.processes` to capture currently executing queries.
          value:
            type: number
            example: 1
        - name: samples_per_hour_per_query
          description: |
            Set the rate limit for how many query sample events will be ingested per hour per normalized query.
          value:
            type: integer
            example: 15
        - name: seen_samples_cache_maxsize
          description: |
            Set the max size of the cache used for the samples_per_hour_per_query rate limit. This should be increased
            for databases with a very large number of unique normalized queries which exceed the cache's limit.
          value:
            type: integer
            example: 10000
        - name: run_sync
          hidden: true
          description: |
            Run the query samples collection synchronously. This is useful for testing purposes, but should not be used
            in production as it can block the main thread and cause performance issues.
          value:
            type: boolean
            example: false
        - name: activity_enabled
          description: |
            Enable collection of database activity snapshots. Requires `dbm: true`.
          value:
            type: boolean
            example: true
        - name: activity_collection_interval
          hidden: true
          description: |
            Set the activity snapshot collection interval (in seconds). This number cannot be smaller than
            the `query_samples` configured collection_interval.
          value:
            type: number
            example: 10
        - name: activity_max_rows
          description: |
            Set the maximum number of active sessions to include in each activity snapshot.
          value:
            type: integer
            example: 1000
    - name: query_metrics
      description: Configure collection of query metrics
      options:
        - name: enabled
          description: |
            Enable collection of query metrics. Requires `dbm: true`.
          value:
            type: boolean
            example: true
        - name: collection_interval
          description: |
            Set the query metric collection interval (in seconds). Each collection involves a single query to
            `system.query_log`. If a non-default value is chosen then that exact same value must be used for *every*
            check instance. Running different instances with different collection intervals is not supported.
          value:
            type: number
            example: 10
        - name: run_sync
          hidden: true
          description: |
            Run the query metrics collection synchronously. This is useful for testing purposes, but should not be used
            in production as it can block the main thread and cause performance issues.
          value:
            type: boolean
            example: false
        - name: full_statement_text_cache_max_size
          hidden: true
          description: |
            Set the max size of the cache used for the full statement text.
          value:
            type: number
            default: 10000
        - name: full_statement_text_samples_per_hour_per_query
          hidden: true
          description: |
            Set the max number of full statement text samples to collect per hour per query.
          value:
            type: number
            default: 1
    - name: database_instance_collection_interval
      hidden: true
      description: |
        Set the database instance collection interval (in seconds). The database instance collection sends
        basic information about the database instance along with a signal that it still exists.
        This collection does not involve any additional queries to the database.
      value:
        type: number
        default: 300
    - template: instances/db
      overrides:
        custom_queries.value.example:
          - query: SELECT foo, COUNT(*) FROM table.events GROUP BY foo
            columns:
              - name: foo
                type: tag
              - name: event.total
                type: gauge
            tags:
              - test:clickhouse
            metric_prefix: clickhouse
    - template: instances/default
  - template: logs
    example:
    - source: clickhouse
      type: file
      path:  /var/log/clickhouse-server/clickhouse-server.log
      log_processing_rules:
        - type: multi_line
          name: log_start_with_date
          pattern: \d{4}\.\d{2}\.\d{2}
    - source: clickhouse
      type: file
      path: /var/log/clickhouse-server/clickhouse-server.err.log
      log_processing_rules:
        - type: multi_line
          name: log_start_with_date
          pattern: \d{4}\.\d{2}\.\d{2}
