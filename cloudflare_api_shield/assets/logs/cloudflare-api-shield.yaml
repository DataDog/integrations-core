id: cloudflare-api-shield
metric_id: cloudflare-api-shield
backend_only: false
facets:
  - facetType: range
    groups:
      - Measure
    name: Duration
    path: duration
    source: log
    type: double
    unit:
      family: time
      name: nanosecond
  - groups:
      - Event
    name: Event Name
    path: evt.name
    source: log
  - groups:
      - Event
    name: Event Outcome
    path: evt.outcome
    source: log
  - groups:
      - Web Access
    name: Method
    path: http.method
    source: log
  - groups:
      - Web Access
    name: Status Code
    path: http.status_code
    source: log
  - groups:
      - Web Access
    name: URL Host
    path: http.url_details.host
    source: log
  - groups:
      - Web Access
    name: URL Path
    path: http.url_details.path
    source: log
  - groups:
      - Web Access
    name: URL scheme
    path: http.url_details.scheme
    source: log
  - groups:
      - Web Access
    name: User-Agent
    path: http.useragent
    source: log
  - groups:
      - Web Access
    name: Browser
    path: http.useragent_details.browser.family
    source: log
  - groups:
      - Web Access
    name: Device
    path: http.useragent_details.device.family
    source: log
  - groups:
      - Web Access
    name: OS
    path: http.useragent_details.os.family
    source: log
  - groups:
      - Geoip
    name: City Name
    path: network.client.geoip.city.name
    source: log
  - groups:
      - Geoip
    name: Continent Code
    path: network.client.geoip.continent.code
    source: log
  - groups:
      - Geoip
    name: Continent Name
    path: network.client.geoip.continent.name
    source: log
  - groups:
      - Geoip
    name: Country ISO Code
    path: network.client.geoip.country.iso_code
    source: log
  - groups:
      - Geoip
    name: Country Name
    path: network.client.geoip.country.name
    source: log
  - groups:
      - Geoip
    name: Subdivision ISO Code
    path: network.client.geoip.subdivision.iso_code
    source: log
  - groups:
      - Geoip
    name: Subdivision Name
    path: network.client.geoip.subdivision.name
    source: log
  - groups:
      - Web Access
    name: Client IP
    path: network.client.ip
    source: log
  - groups:
      - User
    name: User Email
    path: usr.email
    source: log
  - groups:
      - User
    name: User ID
    path: usr.id
    source: log
pipeline:
  type: pipeline
  name: Cloudflare API Shield
  enabled: true
  filter:
    query: source:cloudflare-api-shield
  processors:
    - type: pipeline
      name: Processing of HTTP Request Logs
      enabled: true
      filter:
        query: service:http-request-logs
      processors:
        - type: attribute-remapper
          name: Map `clientIP` to `network.client.ip`
          enabled: true
          sources:
            - clientIP
          sourceType: attribute
          target: network.client.ip
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: attribute-remapper
          name: Map `edgeResponseStatus` to `http.status_code`
          enabled: true
          sources:
            - edgeResponseStatus
          sourceType: attribute
          target: http.status_code
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: attribute-remapper
          name: Map `originResponseDurationMs` to `duration`
          enabled: true
          sources:
            - originResponseDurationMs
          sourceType: attribute
          target: duration
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: attribute-remapper
          name: Map `userAgent` to `http.useragent`
          enabled: true
          sources:
            - userAgent
          sourceType: attribute
          target: http.useragent
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: attribute-remapper
          name: Map `clientRequestHTTPMethodName` to `http.method`
          enabled: true
          sources:
            - clientRequestHTTPMethodName
          sourceType: attribute
          target: http.method
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: attribute-remapper
          name: Map `clientRequestHTTPHost` to `http.url_details.host`
          enabled: true
          sources:
            - clientRequestHTTPHost
          sourceType: attribute
          target: http.url_details.host
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: attribute-remapper
          name: Map `clientRequestScheme` to `http.url_details.scheme`
          enabled: true
          sources:
            - clientRequestScheme
          sourceType: attribute
          target: http.url_details.scheme
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: attribute-remapper
          name: Map `clientRequestPath` to `http.url_details.path`
          enabled: true
          sources:
            - clientRequestPath
          sourceType: attribute
          target: http.url_details.path
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: attribute-remapper
          name: Map `clientRequestQuery` to `http.url_details.queryString`
          enabled: true
          sources:
            - clientRequestQuery
          sourceType: attribute
          target: http.url_details.queryString
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: date-remapper
          name: Define `datetime` as the official date of the log
          enabled: true
          sources:
            - datetime
        - type: attribute-remapper
          name: Map `securityAction` to `evt.outcome`
          enabled: true
          sources:
            - securityAction
          sourceType: attribute
          target: evt.outcome
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
    - type: pipeline
      name: Processing of Audit Logs
      enabled: true
      filter:
        query: service:audit-logs
      processors:
        - type: attribute-remapper
          name: Map `action.result` to `evt.outcome`
          enabled: true
          sources:
            - action.result
          sourceType: attribute
          target: evt.outcome
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: attribute-remapper
          name: Map `action.description` to `evt.name`
          enabled: true
          sources:
            - action.description
          sourceType: attribute
          target: evt.name
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: attribute-remapper
          name: Map `actor.id` to `usr.id`
          enabled: true
          sources:
            - actor.id
          sourceType: attribute
          target: usr.id
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: attribute-remapper
          name: Map `actor.email` to `usr.email`
          enabled: true
          sources:
            - actor.email
          sourceType: attribute
          target: usr.email
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: attribute-remapper
          name: Map `actor.ip_address` to `network.client.ip`
          enabled: true
          sources:
            - actor.ip_address
          sourceType: attribute
          target: network.client.ip
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: attribute-remapper
          name: Map `raw.method` to `http.method`
          enabled: true
          sources:
            - raw.method
          sourceType: attribute
          target: http.method
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: attribute-remapper
          name: Map `raw.status_code` to `http.status_code`
          enabled: true
          sources:
            - raw.status_code
          sourceType: attribute
          target: http.status_code
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: attribute-remapper
          name: Map `raw.user_agent` to `http.useragent`
          enabled: true
          sources:
            - raw.user_agent
          sourceType: attribute
          target: http.useragent
          targetType: attribute
          preserveSource: false
          overrideOnConflict: false
        - type: date-remapper
          name: Define `action.time` as the official date of the log
          enabled: true
          sources:
            - action.time
    - type: geo-ip-parser
      name: Extract geolocation information from the Client IP
      enabled: true
      sources:
        - network.client.ip
      target: network.client.geoip
      ip_processing_behavior: do-nothing
    - type: user-agent-parser
      name: Extract user agent details from `http.useragent`
      enabled: true
      sources:
        - http.useragent
      target: http.useragent_details
      encoded: false
      combineVersionDetails: false
