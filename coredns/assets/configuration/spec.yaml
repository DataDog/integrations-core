name: CoreDNS
files:
- name: coredns.yaml
  options:
  - template: init_config
    options:
      - template: init_config/openmetrics
  - template: instances
    options:
    - template: instances/openmetrics
      overrides:
        openmetrics_endpoint.enabled: true
        openmetrics_endpoint.required: false
        openmetrics_endpoint.value.example: http://%%host%%:9153/metrics
        tags.display_priority: 1
        tags.value.example:
          - "dns-pod:%%host%%"
        metrics.hidden: false
        metrics.value.example:
          - coredns_template_matches_total: template_matches_count
          - coredns_template_template_failures_total: template_templating_failures_count
          - coredns_template_rr_failures_total: template_resource_record_failures_count
    - template: instances/openmetrics_legacy_base
      hidden: true
      overrides:
        prometheus_url.required: false
- name: auto_conf.yaml
  options:
  - template: ad_identifiers
    overrides:
      value.example:
      - coredns
  - template: init_config
    options: []
  - template: instances
    options:
    - name: openmetrics_endpoint
      description: |
        To enable CoreDNS metrics you must specify the openmetrics endpoint url
        and enable the plugin within coredns
        See: https://coredns.io/plugins/metrics/
      required: false
      value:
        type: string
        example: "http://%%host%%:9153/metrics"
    - name: tags
      description: |
        List of tags to attach to every metric and service check emitted by this integration.

        Learn more about tagging: https://docs.datadoghq.com/tagging/
      required: True
      value:
        type: array
        items:
          type: string
        example:
          - "dns-pod:%%host%%"
    - name: metrics
      description: |
        Metrics from the CoreDNS plugins for 'metrics', 'proxy', 'forward' and 'cache'
        are enabled by default, however in order to scrape metrics for optional
        plugins, enable the plugin in the CoreDNS corefile and then add the metric below.
        As an example, the 'template' plugin's metrics are below
      value:
        type: array
        items:
          type: string
        example:
          - coredns_template_matches_total: template_matches_count
          - coredns_template_template_failures_total: template_templating_failures_count
          - coredns_template_rr_failures_total: template_resource_record_failures_count
