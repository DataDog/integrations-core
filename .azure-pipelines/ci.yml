trigger:
- master

pr:
- master

stages:
- stage: Test_Changed
  condition: eq(variables['Build.Reason'], 'PullRequest')

  jobs:
  - job: Linux

    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - template: './install-deps.yml'
    - template: './run-validations.yml'
    - script: ddev test --cov
      displayName: 'Run tests'

  - job: Windows

    pool:
      vmImage: 'win1803'

    steps:
    - template: './set-up-windows.yml'
    - template: './install-deps.yml'
    # Only test any of these that have changed for pull requests
    - script: ddev test --changed --cov datadog_checks_base datadog_checks_dev active_directory aspdotnet disk dotnetclr exchange_server iis pdh_check sqlserver win32_event_log windows_service wmi_check
      displayName: 'Run Windows tests'

# - stage: Test_All
#   condition: ne(variables['Build.Reason'], 'PullRequest')
#   jobs:
#   - job: B1
#   - job: B2
