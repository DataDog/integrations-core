trigger:
- master

pr:
- master

stages:
- stage: All
  displayName: 'Test All'

  # Run in parallel
  dependsOn: []

  # Run only on master
  condition: eq(variables['Build.Reason'], 'PullRequest')

  jobs:
  - template: './test-all.yml'

- stage: Changed
  displayName: 'Test Changed'

  # Run in parallel
  dependsOn: []

  # Run only on pull requests
  condition: ne(variables['Build.Reason'], 'PullRequest')

  jobs:
  - job: Linux

    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - template: './checkout-code.yml'
    - template: './install-deps-python.yml'
    - template: './run-validations.yml'
    - script: ddev test --cov
      displayName: 'Run tests'
    - script: ddev test --bench
      displayName: 'Run benchmarks'

  - job: Windows

    pool:
      vmImage: 'windows-2019'

    steps:
    - template: './checkout-code.yml'
    - template: './set-up-windows.yml'
    - template: './install-deps-python.yml'
    # Only test any of these that have changed for pull requests
    - script: ddev test --changed --cov datadog_checks_base datadog_checks_dev active_directory aspdotnet disk dotnetclr exchange_server iis pdh_check sqlserver win32_event_log windows_service wmi_check
      displayName: 'Run tests'
