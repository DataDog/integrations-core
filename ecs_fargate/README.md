# ECS Fargate Integration

## Overview

Get metrics from all your containers running in ECS Fargate:

* CPU/Memory usage & limit metrics
* I/O metrics

## Setup
### Installation

The ECS Fargate check is packaged with the Agent, [run the Agent][1] with your containers to start collecting metrics.

### Deploying the Datadog Agent on AWS Fargate

To start monitoring AWS Fargate tasks and services, deploy the containerized Datadog Agent on Fargate. In addition to passing the usual `DD_API_KEY` environment variable, you must set the `ECS_FARGATE `environment variable to `true`.

The example task definition below deploys the Datadog Agent to Fargate, along with a Redis container in the same task.

```
{'containerDefinitions': [{'dockerLabels': {'com.datadoghq.ad.check_names': '["redisdb"]',
                                            'com.datadoghq.ad.init_configs': '[{}]',
                                            'com.datadoghq.ad.instances': '[{"host": "%%host%%", "port": 6379}]'},
                           'essential': true,
                           'image': 'redis:latest',
                           'name': 'redis'},
                          {'environment': [{'name': 'DD_API_KEY',
                                            'value': '$YOUR_API_KEY'},
                                           {'name': 'ECS_FARGATE',
                                            'value': 'true'}],
                           'essential': true,
                           'image': 'datadog/agent:latest',
                           'name': 'datadog-agent'}],
 'cpu': '256',
 'family': 'redis-datadog',
 'memory': '512',
 'networkMode': 'awsvpc',
 'requiresCompatibilities': ['FARGATE']}
```

After saving that task definition locally as `redis-datadog.json`, register the task with ECS using the [AWS CLI][11]:

```
aws ecs register-task-definition --cli-input-json file://./redis-datadog.json
```

Once the task has been registered, you can run it in a Fargate cluster, making sure to provide one or more private subnets and security groups for your task. Note that Fargate version 1.1.0 or greater is required, so specify the platform version in the command:

```
aws ecs create-cluster --cluster-name "fargate-test" aws ecs run-task --cluster fargate-test \
--network-configuration "awsvpcConfiguration={subnets=["$PRIVATE_SUBNET"],securityGroups=["$SECURITY_GROUP"]}" \
--task-definition arn:aws:ecs:us-east-1:$AWS_ACCOUNT_NUMBER:task-definition/redis-datadog:1 \
--region us-east-1 --launch-type FARGATE --platform-version 1.1.0
```

Check the status of the task in the [ECS Console][12]. After a few moments, Fargate containers appear on the Datadog [Containers][13] page.

### Configuration

#### Metric Collection

1. Edit the `ecs_fargate.d/conf.yaml` file, in the `conf.d/` folder at the root of your [Agent's configuration directory][7] to start collecting your ECS Fargate performance data. See the [sample ecs_fargate.d/conf.yaml][6] for all available configuration options.

2. Re-deploy the Agent task with the updated configuration.

#### Log Collection

1. Define the Fargate AwsLogDriver in your task. [Consult the AWS Fargate developer guide][8] to learn how to do it.

2. Fargate task definitions only support the awslogs log driver for the log configuration. This configures your Fargate tasks to send log information to Amazon CloudWatch Logs. The following shows a snippet of a task definition where the awslogs log driver is configured:

    ```
    "logConfiguration": { 
       "logDriver": "awslogs",
       "options": { 
          "awslogs-group" : "/ecs/fargate-task-definition",
          "awslogs-region": "us-east-1",
          "awslogs-stream-prefix": "ecs"
    }
    ```

    For more information about using the awslogs log driver in task definitions to send your container logs to CloudWatch Logs, see [Using the awslogs Log Driver][9].

    This driver collects logs generated by the container and sends them to CloudWatch directly.

3. Finally, [use a lambda function in order to collect logs from CloudWatch and send them to Datadog][10].

### Validation

[Run the Agent's `status` subcommand][1] and look for `ecs_fargate` under the Checks section.

## Data Collected

### Metrics

See [metadata.csv][2] for a list of metrics provided by this integration.

### Events

The ECS Fargate check does not include any events at this time.

### Service Checks

The ECS Fargate check does not include any service checks at this time.

## Troubleshooting

Need help? Contact [Datadog Support][3].

## Further Reading

* [Monitor AWS Fargate applications with Datadog][4]


[1]: https://docs.datadoghq.com/agent/faq/agent-commands/#agent-status-and-information
[2]: https://github.com/DataDog/integrations-core/blob/master/ecs_fargate/metadata.csv
[3]: https://docs.datadoghq.com/help/
[4]: https://www.datadoghq.com/blog/monitor-aws-fargate/
[5]: https://docs.datadoghq.com/agent/faq/agent-commands/#start-stop-restart-the-agent
[6]: https://github.com/DataDog/integrations-core/blob/master/ecs_fargate/datadog_checks/ecs_fargate/data/conf.yaml.example
[7]: https://docs.datadoghq.com/agent/faq/agent-configuration-files/#agent-configuration-directory
[8]: https://docs.aws.amazon.com/AmazonECS/latest/developerguide/AWS_Fargate.html
[9]: https://docs.aws.amazon.com/AmazonECS/latest/developerguide/using_awslogs.html
[10]: https://docs.datadoghq.com/integrations/amazon_lambda/#log-collection
[11]: https://aws.amazon.com/cli/
[12]: https://console.aws.amazon.com/ecs/home
[13]: https://app.datadoghq.com/containers
