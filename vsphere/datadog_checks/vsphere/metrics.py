# (C) Datadog, Inc. 2019-present
# All rights reserved
# Licensed under Simplified BSD License (see LICENSE)
from pyVmomi import vim

# https://code.vmware.com/apis/358/vsphere/doc/cpu_counters.html

# Set of metrics that are emitted as percentages between 0 and 100. For those metrics, we divide the value by 100
# to get a float between 0 and 1.
PERCENT_METRICS = {
    'cpu.capacity.contention.avg',
    'cpu.coreUtilization.avg',
    'cpu.coreUtilization.max',
    'cpu.coreUtilization.min',
    'cpu.coreUtilization.raw',
    'cpu.corecount.contention.avg',
    'cpu.demandEntitlementRatio.latest',
    'cpu.latency.avg',
    'cpu.readiness.avg',
    'cpu.usage.avg',
    'cpu.usage.max',
    'cpu.usage.min',
    'cpu.usage.raw',
    'cpu.utilization.avg',
    'cpu.utilization.max',
    'cpu.utilization.min',
    'cpu.utilization.raw',
    'datastore.siocActiveTimePercentage.avg',
    'disk.capacity.contention.avg',
    'disk.scsiReservationCnflctsPct.avg',
    'gpu.mem.usage.avg',
    'gpu.mem.usage.max',
    'gpu.mem.usage.min',
    'gpu.mem.usage.raw',
    'gpu.utilization.avg',
    'gpu.utilization.max',
    'gpu.utilization.min',
    'gpu.utilization.raw',
    'mem.capacity.contention.avg',
    'mem.latency.avg',
    'mem.reservedCapacityPct.avg',
    'mem.usage.avg',
    'mem.usage.max',
    'mem.usage.min',
    'mem.usage.raw',
    'mem.vmfs.pbc.capMissRatio.latest',
    'power.capacity.usagePct.avg',
    'rescpu.actav1.latest',
    'rescpu.actav15.latest',
    'rescpu.actav5.latest',
    'rescpu.actpk1.latest',
    'rescpu.actpk15.latest',
    'rescpu.actpk5.latest',
    'rescpu.maxLimited1.latest',
    'rescpu.maxLimited15.latest',
    'rescpu.maxLimited5.latest',
    'rescpu.runav1.latest',
    'rescpu.runav15.latest',
    'rescpu.runav5.latest',
    'rescpu.runpk1.latest',
    'rescpu.runpk15.latest',
    'rescpu.runpk5.latest',
    'storageAdapter.OIOsPct.avg',
    'sys.diskUsage.latest',
    'sys.resourceCpuAct1.latest',
    'sys.resourceCpuAct5.latest',
    'sys.resourceCpuMaxLimited1.latest',
    'sys.resourceCpuMaxLimited5.latest',
    'sys.resourceCpuRun1.latest',
    'sys.resourceCpuRun5.latest',
    'vcResources.priviledgedcpuusage.avg',
    'vcResources.processcpuusage.avg',
    'vcResources.systemcpuusage.avg',
    'vcResources.systemnetusage.avg',
    'vcResources.usercpuusage.avg',
    'vsanDomObj.readCacheHitRate.latest',
}

# All metrics that can be collected from VirtualMachines.
VM_METRICS = {
    'cpu.costop.sum',
    'cpu.demand.avg',
    'cpu.demandEntitlementRatio.latest',
    'cpu.entitlement.latest',
    'cpu.idle.sum',
    'cpu.latency.avg',
    'cpu.maxlimited.sum',
    'cpu.overlap.sum',
    'cpu.readiness.avg',
    'cpu.ready.sum',
    'cpu.run.sum',
    'cpu.swapwait.sum',
    'cpu.system.sum',
    'cpu.usage.avg',
    'cpu.usage.max',
    'cpu.usage.min',
    'cpu.usage.raw',
    'cpu.usagemhz.avg',
    'cpu.usagemhz.max',
    'cpu.usagemhz.min',
    'cpu.usagemhz.raw',
    'cpu.used.sum',
    'cpu.wait.sum',
    'datastore.maxTotalLatency.latest',
    'datastore.numberReadAveraged.avg',
    'datastore.numberWriteAveraged.avg',
    'datastore.read.avg',
    'datastore.totalReadLatency.avg',
    'datastore.totalWriteLatency.avg',
    'datastore.write.avg',
    'disk.busResets.sum',
    'disk.commands.sum',
    'disk.commandsAborted.sum',
    'disk.commandsAveraged.avg',
    'disk.maxTotalLatency.latest',
    'disk.numberRead.sum',
    'disk.numberReadAveraged.avg',
    'disk.numberWrite.sum',
    'disk.numberWriteAveraged.avg',
    'disk.read.avg',
    'disk.usage.avg',
    'disk.usage.max',
    'disk.usage.min',
    'disk.usage.raw',
    'disk.write.avg',
    'hbr.hbrNetRx.avg',
    'hbr.hbrNetTx.avg',
    'mem.active.avg',
    'mem.active.max',
    'mem.active.min',
    'mem.active.raw',
    'mem.activewrite.avg',
    'mem.compressed.avg',
    'mem.compressionRate.avg',
    'mem.consumed.avg',
    'mem.consumed.max',
    'mem.consumed.min',
    'mem.consumed.raw',
    'mem.decompressionRate.avg',
    'mem.entitlement.avg',
    'mem.granted.avg',
    'mem.granted.max',
    'mem.granted.min',
    'mem.granted.raw',
    'mem.latency.avg',
    'mem.llSwapInRate.avg',
    'mem.llSwapOutRate.avg',
    'mem.llSwapUsed.avg',
    'mem.llSwapUsed.max',
    'mem.llSwapUsed.min',
    'mem.llSwapUsed.raw',
    'mem.overhead.avg',
    'mem.overhead.max',
    'mem.overhead.min',
    'mem.overhead.raw',
    'mem.overheadMax.avg',
    'mem.overheadTouched.avg',
    'mem.shared.avg',
    'mem.shared.max',
    'mem.shared.min',
    'mem.shared.raw',
    'mem.swapin.avg',
    'mem.swapin.max',
    'mem.swapin.min',
    'mem.swapin.raw',
    'mem.swapinRate.avg',
    'mem.swapout.avg',
    'mem.swapout.max',
    'mem.swapout.min',
    'mem.swapout.raw',
    'mem.swapoutRate.avg',
    'mem.swapped.avg',
    'mem.swapped.max',
    'mem.swapped.min',
    'mem.swapped.raw',
    'mem.swaptarget.avg',
    'mem.swaptarget.max',
    'mem.swaptarget.min',
    'mem.swaptarget.raw',
    'mem.usage.avg',
    'mem.usage.max',
    'mem.usage.min',
    'mem.usage.raw',
    'mem.vmmemctl.avg',
    'mem.vmmemctl.max',
    'mem.vmmemctl.min',
    'mem.vmmemctl.raw',
    'mem.vmmemctltarget.avg',
    'mem.vmmemctltarget.max',
    'mem.vmmemctltarget.min',
    'mem.vmmemctltarget.raw',
    'mem.zero.avg',
    'mem.zero.max',
    'mem.zero.min',
    'mem.zero.raw',
    'mem.zipSaved.latest',
    'mem.zipped.latest',
    'net.broadcastRx.sum',
    'net.broadcastTx.sum',
    'net.bytesRx.avg',
    'net.bytesTx.avg',
    'net.droppedRx.sum',
    'net.droppedTx.sum',
    'net.multicastRx.sum',
    'net.multicastTx.sum',
    'net.packetsRx.sum',
    'net.packetsTx.sum',
    'net.pnicBytesRx.avg',
    'net.pnicBytesTx.avg',
    'net.received.avg',
    'net.transmitted.avg',
    'net.usage.avg',
    'net.usage.max',
    'net.usage.min',
    'net.usage.raw',
    'power.energy.sum',
    'power.power.avg',
    'rescpu.actav1.latest',
    'rescpu.actav15.latest',
    'rescpu.actav5.latest',
    'rescpu.actpk1.latest',
    'rescpu.actpk15.latest',
    'rescpu.actpk5.latest',
    'rescpu.maxLimited1.latest',
    'rescpu.maxLimited15.latest',
    'rescpu.maxLimited5.latest',
    'rescpu.runav1.latest',
    'rescpu.runav15.latest',
    'rescpu.runav5.latest',
    'rescpu.runpk1.latest',
    'rescpu.runpk15.latest',
    'rescpu.runpk5.latest',
    'rescpu.sampleCount.latest',
    'rescpu.samplePeriod.latest',
    'sys.heartbeat.latest',
    'sys.heartbeat.sum',
    'sys.osUptime.latest',
    'sys.uptime.latest',
    'virtualDisk.busResets.sum',
    'virtualDisk.commandsAborted.sum',
    'virtualDisk.largeSeeks.latest',
    'virtualDisk.mediumSeeks.latest',
    'virtualDisk.numberReadAveraged.avg',
    'virtualDisk.numberWriteAveraged.avg',
    'virtualDisk.read.avg',
    'virtualDisk.readIOSize.latest',
    'virtualDisk.readLatencyUS.latest',
    'virtualDisk.readLoadMetric.latest',
    'virtualDisk.readOIO.latest',
    'virtualDisk.smallSeeks.latest',
    'virtualDisk.totalReadLatency.avg',
    'virtualDisk.totalWriteLatency.avg',
    'virtualDisk.write.avg',
    'virtualDisk.writeIOSize.latest',
    'virtualDisk.writeLatencyUS.latest',
    'virtualDisk.writeLoadMetric.latest',
    'virtualDisk.writeOIO.latest',
}

# All metrics that can be collected from ESXi Hosts.
HOST_METRICS = {
    'cpu.coreUtilization.avg',
    'cpu.coreUtilization.max',
    'cpu.coreUtilization.min',
    'cpu.coreUtilization.raw',
    'cpu.costop.sum',
    'cpu.demand.avg',
    'cpu.idle.sum',
    'cpu.latency.avg',
    'cpu.readiness.avg',
    'cpu.ready.sum',
    'cpu.reservedCapacity.avg',
    'cpu.swapwait.sum',
    'cpu.totalCapacity.avg',
    'cpu.usage.avg',
    'cpu.usage.max',
    'cpu.usage.min',
    'cpu.usage.raw',
    'cpu.usagemhz.avg',
    'cpu.usagemhz.max',
    'cpu.usagemhz.min',
    'cpu.usagemhz.raw',
    'cpu.used.sum',
    'cpu.utilization.avg',
    'cpu.utilization.max',
    'cpu.utilization.min',
    'cpu.utilization.raw',
    'cpu.wait.sum',
    'datastore.datastoreIops.avg',
    'datastore.datastoreMaxQueueDepth.latest',
    'datastore.datastoreNormalReadLatency.latest',
    'datastore.datastoreNormalWriteLatency.latest',
    'datastore.datastoreReadBytes.latest',
    'datastore.datastoreReadIops.latest',
    'datastore.datastoreReadLoadMetric.latest',
    'datastore.datastoreReadOIO.latest',
    'datastore.datastoreVMObservedLatency.latest',
    'datastore.datastoreWriteBytes.latest',
    'datastore.datastoreWriteIops.latest',
    'datastore.datastoreWriteLoadMetric.latest',
    'datastore.datastoreWriteOIO.latest',
    'datastore.maxTotalLatency.latest',
    'datastore.numberReadAveraged.avg',
    'datastore.numberWriteAveraged.avg',
    'datastore.read.avg',
    'datastore.siocActiveTimePercentage.avg',
    'datastore.sizeNormalizedDatastoreLatency.avg',
    'datastore.totalReadLatency.avg',
    'datastore.totalWriteLatency.avg',
    'datastore.write.avg',
    'disk.busResets.sum',
    'disk.commands.sum',
    'disk.commandsAborted.sum',
    'disk.commandsAveraged.avg',
    'disk.deviceLatency.avg',
    'disk.deviceReadLatency.avg',
    'disk.deviceWriteLatency.avg',
    'disk.kernelLatency.avg',
    'disk.kernelReadLatency.avg',
    'disk.kernelWriteLatency.avg',
    'disk.maxQueueDepth.avg',
    'disk.maxTotalLatency.latest',
    'disk.numberRead.sum',
    'disk.numberReadAveraged.avg',
    'disk.numberWrite.sum',
    'disk.numberWriteAveraged.avg',
    'disk.queueLatency.avg',
    'disk.queueReadLatency.avg',
    'disk.queueWriteLatency.avg',
    'disk.read.avg',
    'disk.scsiReservationCnflctsPct.avg',
    'disk.scsiReservationConflicts.sum',
    'disk.totalLatency.avg',
    'disk.totalReadLatency.avg',
    'disk.totalWriteLatency.avg',
    'disk.usage.avg',
    'disk.usage.max',
    'disk.usage.min',
    'disk.usage.raw',
    'disk.write.avg',
    'hbr.hbrNetRx.avg',
    'hbr.hbrNetTx.avg',
    'hbr.hbrNumVms.avg',
    'mem.active.avg',
    'mem.active.max',
    'mem.active.min',
    'mem.active.raw',
    'mem.activewrite.avg',
    'mem.compressed.avg',
    'mem.compressionRate.avg',
    'mem.consumed.avg',
    'mem.consumed.max',
    'mem.consumed.min',
    'mem.consumed.raw',
    'mem.consumed.userworlds.avg',
    'mem.consumed.vms.avg',
    'mem.decompressionRate.avg',
    'mem.granted.avg',
    'mem.granted.max',
    'mem.granted.min',
    'mem.granted.raw',
    'mem.heap.avg',
    'mem.heap.max',
    'mem.heap.min',
    'mem.heap.raw',
    'mem.heapfree.avg',
    'mem.heapfree.max',
    'mem.heapfree.min',
    'mem.heapfree.raw',
    'mem.latency.avg',
    'mem.llSwapIn.avg',
    'mem.llSwapIn.max',
    'mem.llSwapIn.min',
    'mem.llSwapIn.raw',
    'mem.llSwapInRate.avg',
    'mem.llSwapOut.avg',
    'mem.llSwapOut.max',
    'mem.llSwapOut.min',
    'mem.llSwapOut.raw',
    'mem.llSwapOutRate.avg',
    'mem.llSwapUsed.avg',
    'mem.llSwapUsed.max',
    'mem.llSwapUsed.min',
    'mem.llSwapUsed.raw',
    'mem.lowfreethreshold.avg',
    'mem.overhead.avg',
    'mem.overhead.max',
    'mem.overhead.min',
    'mem.overhead.raw',
    'mem.reservedCapacity.avg',
    'mem.shared.avg',
    'mem.shared.max',
    'mem.shared.min',
    'mem.shared.raw',
    'mem.sharedcommon.avg',
    'mem.sharedcommon.max',
    'mem.sharedcommon.min',
    'mem.sharedcommon.raw',
    'mem.state.latest',
    'mem.swapin.avg',
    'mem.swapin.max',
    'mem.swapin.min',
    'mem.swapin.raw',
    'mem.swapinRate.avg',
    'mem.swapout.avg',
    'mem.swapout.max',
    'mem.swapout.min',
    'mem.swapout.raw',
    'mem.swapoutRate.avg',
    'mem.swapused.avg',
    'mem.swapused.max',
    'mem.swapused.min',
    'mem.swapused.raw',
    'mem.sysUsage.avg',
    'mem.sysUsage.max',
    'mem.sysUsage.min',
    'mem.sysUsage.raw',
    'mem.totalCapacity.avg',
    'mem.unreserved.avg',
    'mem.unreserved.max',
    'mem.unreserved.min',
    'mem.unreserved.raw',
    'mem.usage.avg',
    'mem.usage.max',
    'mem.usage.min',
    'mem.usage.raw',
    'mem.vmfs.pbc.capMissRatio.latest',
    'mem.vmfs.pbc.overhead.latest',
    'mem.vmfs.pbc.size.latest',
    'mem.vmfs.pbc.sizeMax.latest',
    'mem.vmfs.pbc.workingSet.latest',
    'mem.vmfs.pbc.workingSetMax.latest',
    'mem.vmmemctl.avg',
    'mem.vmmemctl.max',
    'mem.vmmemctl.min',
    'mem.vmmemctl.raw',
    'mem.zero.avg',
    'mem.zero.max',
    'mem.zero.min',
    'mem.zero.raw',
    'net.broadcastRx.sum',
    'net.broadcastTx.sum',
    'net.bytesRx.avg',
    'net.bytesTx.avg',
    'net.droppedRx.sum',
    'net.droppedTx.sum',
    'net.errorsRx.sum',
    'net.errorsTx.sum',
    'net.multicastRx.sum',
    'net.multicastTx.sum',
    'net.packetsRx.sum',
    'net.packetsTx.sum',
    'net.received.avg',
    'net.transmitted.avg',
    'net.unknownProtos.sum',
    'net.usage.avg',
    'net.usage.max',
    'net.usage.min',
    'net.usage.raw',
    'power.energy.sum',
    'power.power.avg',
    'power.powerCap.avg',
    'rescpu.actav1.latest',
    'rescpu.actav15.latest',
    'rescpu.actav5.latest',
    'rescpu.actpk1.latest',
    'rescpu.actpk15.latest',
    'rescpu.actpk5.latest',
    'rescpu.maxLimited1.latest',
    'rescpu.maxLimited15.latest',
    'rescpu.maxLimited5.latest',
    'rescpu.runav1.latest',
    'rescpu.runav15.latest',
    'rescpu.runav5.latest',
    'rescpu.runpk1.latest',
    'rescpu.runpk15.latest',
    'rescpu.runpk5.latest',
    'rescpu.sampleCount.latest',
    'rescpu.samplePeriod.latest',
    'storageAdapter.commandsAveraged.avg',
    'storageAdapter.maxTotalLatency.latest',
    'storageAdapter.numberReadAveraged.avg',
    'storageAdapter.numberWriteAveraged.avg',
    'storageAdapter.outstandingIOs.avg',
    'storageAdapter.queueDepth.avg',
    'storageAdapter.queueLatency.avg',
    'storageAdapter.queued.avg',
    'storageAdapter.read.avg',
    'storageAdapter.totalReadLatency.avg',
    'storageAdapter.totalWriteLatency.avg',
    'storageAdapter.write.avg',
    'storagePath.busResets.sum',
    'storagePath.commandsAborted.sum',
    'storagePath.commandsAveraged.avg',
    'storagePath.maxTotalLatency.latest',
    'storagePath.numberReadAveraged.avg',
    'storagePath.numberWriteAveraged.avg',
    'storagePath.read.avg',
    'storagePath.totalReadLatency.avg',
    'storagePath.totalWriteLatency.avg',
    'storagePath.write.avg',
    'sys.resourceCpuAct1.latest',
    'sys.resourceCpuAct5.latest',
    'sys.resourceCpuAllocMax.latest',
    'sys.resourceCpuAllocMin.latest',
    'sys.resourceCpuAllocShares.latest',
    'sys.resourceCpuMaxLimited1.latest',
    'sys.resourceCpuMaxLimited5.latest',
    'sys.resourceCpuRun1.latest',
    'sys.resourceCpuRun5.latest',
    'sys.resourceCpuUsage.avg',
    'sys.resourceCpuUsage.max',
    'sys.resourceCpuUsage.min',
    'sys.resourceCpuUsage.raw',
    'sys.resourceFdUsage.latest',
    'sys.resourceMemAllocMax.latest',
    'sys.resourceMemAllocMin.latest',
    'sys.resourceMemAllocShares.latest',
    'sys.resourceMemConsumed.latest',
    'sys.resourceMemCow.latest',
    'sys.resourceMemMapped.latest',
    'sys.resourceMemOverhead.latest',
    'sys.resourceMemShared.latest',
    'sys.resourceMemSwapped.latest',
    'sys.resourceMemTouched.latest',
    'sys.resourceMemZero.latest',
    'sys.uptime.latest',
    'virtualDisk.busResets.sum',
    'virtualDisk.commandsAborted.sum',
}

# All metrics that can be collected from Datastores.
DATASTORE_METRICS = {
    'datastore.busResets.sum',
    'datastore.commandsAborted.sum',
    'datastore.numberReadAveraged.avg',
    'datastore.numberWriteAveraged.avg',
    'datastore.throughput.contention.avg',
    'datastore.throughput.usage.avg',
    'disk.busResets.sum',
    'disk.capacity.contention.avg',
    'disk.capacity.latest',
    'disk.capacity.provisioned.avg',
    'disk.capacity.usage.avg',
    'disk.numberReadAveraged.avg',
    'disk.numberWriteAveraged.avg',
    'disk.provisioned.latest',
    'disk.unshared.latest',
    'disk.used.latest',
}

# All metrics that can be collected from Datacenters.
DATACENTER_METRICS = {
    'vmop.numChangeDS.latest',
    'vmop.numChangeHost.latest',
    'vmop.numChangeHostDS.latest',
    'vmop.numClone.latest',
    'vmop.numCreate.latest',
    'vmop.numDeploy.latest',
    'vmop.numDestroy.latest',
    'vmop.numPoweroff.latest',
    'vmop.numPoweron.latest',
    'vmop.numRebootGuest.latest',
    'vmop.numReconfigure.latest',
    'vmop.numRegister.latest',
    'vmop.numReset.latest',
    'vmop.numSVMotion.latest',
    'vmop.numShutdownGuest.latest',
    'vmop.numStandbyGuest.latest',
    'vmop.numSuspend.latest',
    'vmop.numUnregister.latest',
    'vmop.numVMotion.latest',
    'vmop.numXVMotion.latest',
}

# All metrics that can be collected from Clusters.
CLUSTER_METRICS = {
    # clusterServices are only available for DRS and HA clusters, and are causing errors. Let's deactivate for now
    # but they were collected before so investigate why
    'clusterServices.cpufairness.latest',
    'clusterServices.effectivecpu.avg',
    'clusterServices.effectivemem.avg',
    'clusterServices.failover.latest',
    'clusterServices.memfairness.latest',
    'cpu.totalmhz.avg',
    'cpu.usage.avg',
    'cpu.usagemhz.avg',
    'mem.consumed.avg',
    'mem.overhead.avg',
    'mem.totalmb.avg',
    'mem.usage.avg',
    'mem.vmmemctl.avg',
    'vmop.numChangeDS.latest',
    'vmop.numChangeHost.latest',
    'vmop.numChangeHostDS.latest',
    'vmop.numClone.latest',
    'vmop.numCreate.latest',
    'vmop.numDeploy.latest',
    'vmop.numDestroy.latest',
    'vmop.numPoweroff.latest',
    'vmop.numPoweron.latest',
    'vmop.numRebootGuest.latest',
    'vmop.numReconfigure.latest',
    'vmop.numRegister.latest',
    'vmop.numReset.latest',
    'vmop.numSVMotion.latest',
    'vmop.numShutdownGuest.latest',
    'vmop.numStandbyGuest.latest',
    'vmop.numSuspend.latest',
    'vmop.numUnregister.latest',
    'vmop.numVMotion.latest',
    'vmop.numXVMotion.latest',
}

ALLOWED_METRICS_FOR_MOR = {
    vim.VirtualMachine: VM_METRICS,
    vim.HostSystem: HOST_METRICS,
    vim.Datacenter: DATACENTER_METRICS,
    vim.Datastore: DATASTORE_METRICS,
    vim.ClusterComputeResource: CLUSTER_METRICS,
}
