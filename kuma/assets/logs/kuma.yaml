id: kuma
metric_id: kuma
backend_only: false
facets:
  - description: ""
    facetType: list
    groups:
      - Source Code
    name: Logger Name
    path: logger.name
    source: log
    type: string
  - description: ""
    facetType: list
    groups:
      - Source Code
    name: Thread Name
    path: logger.thread_name
    source: log
    type: string
  - description: Kubernetes namespace tag
    facetType: list
    groups:
      - Kubernetes
    name: Kubernetes Namespace
    path: kube_namespace
    source: tag
    type: string
  - description: Pod name tag
    facetType: list
    groups:
      - Kubernetes
    name: Pod Name
    path: pod_name
    source: tag
    type: string
  - description: Container name tag
    facetType: list
    groups:
      - Docker
    name: Container Name
    path: container_name
    source: tag
    type: string
  - description: Image name tag
    facetType: list
    groups:
      - Docker
    name: Image Name
    path: image_name
    source: tag
    type: string
pipeline:
  type: pipeline
  name: Kuma
  enabled: true
  filter:
    query: source:kuma OR source:kuma-cp OR source:kuma-dp
  processors:
    - type: grok-parser
      name: Kuma Log Parser
      enabled: true
      source: message
      samples:
        - '2025-05-26T20:47:04.174Z	INFO	controllers.Service	annotating service
          which is part of the mesh	{"service":
          {"name":"datadog-admission-controller","namespace":"datadog-operator"},
          "annotation": "ingress.kubernetes.io/service-upstream=true"}'
        - "[2025-06-03 18:54:16.678][33][info][main]
          [source/server/server.cc:430]   envoy.ssl.server_context_factory:
          envoy.ssl.server_context_factory.default"
        - 2025-05-26T20:45:01.427Z	INFO	plugins.authn.api-server.tokens	bootstrap
          of Admin User Token is enabled. To extract credentials execute
          'kubectl get secret admin-user-token -n kuma-system
          --template={{.data.value}} | base64 -d'. You configure kumactl with
          them 'kumactl config control-planes add --auth-type=tokens --auth-conf
          token=YOUR_TOKEN'. To disable bootstrap of Admin User Token set
          KUMA_API_SERVER_AUTHN_TOKENS_BOOTSTRAP_ADMIN_TOKEN to false.
        - "[INFO] SIGTERM: Shutting down servers then terminating"
      grok:
        supportRules: |-
          isoTimestamp %{date("yyyy-MM-dd'T'HH:mm:ss.SSSZZ")}
          notTab       %{regex("[^\\t]+")}
          goTimestamp  %{date("yyyy/MM/dd HH:mm:ss")}
        matchRules: >
          # Log messages in structured format

          # Samples

          # 2025-05-26T20:44:41.327Z	INFO	plugin.runtime.gateway	registered gateway plugin

          # 2025-05-26T20:47:04.174Z	INFO	controllers.Service	annotating service which is part of the mesh	{"service": {"name":"datadog-admission-controller","namespace":"datadog-operator"}, "annotation": "ingress.kubernetes.io/service-upstream=true"}

          kuma_cp_structured_log %{isoTimestamp:date}\t%{word:level}\t%{notSpace:loggger.name}\t%{notTab:message}(\t%{data::json})?


          # Log messages from Kubernetes libraries used by Kuma

          # Sample

          # I0526 20:44:41.456499       1 leaderelection.go:257] attempting to acquire leader lease kuma-system/cp-leader-lease...

          kuma_cp_glog %{regex("\\w"):level}%{date("MMdd HH:mm:ss.SSSSSS"):date}\s+%{number:logger.thread_id} %{notSpace:logger.name}:%{number:logger.lineno}\] %{data:message}


          # Log messages from Kuma's built-in HTTP server

          # Sample

          # 2025/05/31 15:56:10 http: TLS handshake error from 10.42.0.1:41588: EOF

          # \s%{word:prefix}.* #\s%{data:message}

          kuma_cp_go_http  %{goTimestamp:timestamp}\s%{word:prefix}:\s%{data:message}


          # Log message from a Kuma dataplane

          # Samples

          # [2025-06-03 18:44:06.650][31][info][upstream] [source/common/listener_manager/lds_api.cc:106] lds: add/update listener 'outbound:10.43.182.159:80'

          # [2025-06-03 18:54:23.975][32][info][main] [source/server/server.cc:998] main dispatch loop exited

          kuma_dp \[%{date("yyyy-MM-dd HH:mm:ss.SSS"):date}\]\[%{number:logger.thread_id}\]\[%{word:level}\]\[%{word:component}\] \[%{data:logger.file}:%{number:logger.lineno}\] %{data:message}


          # Log message for Kuma dataplane shutdown (SIGTERM)

          # Sample:

          # [INFO] SIGTERM: Shutting down servers then terminating

          kuma_dp_signal \[%{word:level}\] %{word:signal}: %{data:message}
    - type: message-remapper
      name: Define `message` as the official message of the of the log
      enabled: true
      sources:
        - message
    - type: status-remapper
      name: Define `level` as the official status of the log
      enabled: true
      sources:
        - level
    - type: date-remapper
      name: Define 'date' as the official date of the log
      enabled: true
      sources:
        - date
