services:
  nexus:
    image: sonatype/nexus3:3.79.0
    container_name: nexus
    ports:
      - "8081:8081"
    volumes:
      - ./nexus:/opt/sonatype/sonatype-work/nexus3
    networks:
      - nexus-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8081/service/rest/v1/status" ]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s

  validator:
    image: datadog/agent:latest
    container_name: nexus-validator
    volumes:
      - ../../validate_connectiopn.py:/validate_connectiopn.py:ro
      - ./nexus/admin.password:/admin.password:ro
    networks:
      - nexus-network
    depends_on:
      nexus:
        condition: service_healthy
    command:
      - /bin/sh
      - -c
      - |
        set -e
        echo "Nexus is healthy, waiting a bit more..." 1>&2
        sleep 5
        echo "Reading admin password..." 1>&2
        PASS=$$(cat /admin.password)
        echo "Running validation script..." 1>&2
        exec /opt/datadog-agent/embedded/bin/python3 -u /validate_connectiopn.py --url http://nexus:8081/service/rest/v1/status/check --username admin --password "$$PASS" 2>&1

networks:
  nexus-network:
    driver: bridge
