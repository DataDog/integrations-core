Remove unused code and improve test coverage for connection error handling.
