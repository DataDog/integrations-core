version: '3.8'

services:
  aerospike:
    container_name: aerospike
    image: aerospike/aerospike-server:${AEROSPIKE_VERSION}
    ports:
      - "3000:3000"
    volumes:
      - ${AEROSPIKE_CONFIG}:/etc/aerospike
    healthcheck:
      test: ["CMD", "grep", "-q", "soon there will be cake", "/var/log/aerospike/aerospike.log"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  aerospike-tools-asbench:
    image: aerospike/aerospike-tools
    container_name: aerospike-tools-asbench
    command: asbench -h aerospike -p 3000 -T 10 -t 10 -n test -s mysets -K 0 -k 900000 -o B80 -w RU,60 -z 64 -t 86400 -g 4000

  aerospike-prometheus-exporter:
    container_name: aerospike-prometheus-exporter
    image: aerospike/aerospike-prometheus-exporter:${AEROSPIKE_EXPORTER_VERSION}
    ports:
      - "9145:9145"
    depends_on:
      - aerospike-tools-asbench
    environment:
      AS_HOST: aerospike
      AS_PORT: 3000
      AGENT_LOG_LEVEL: trace
