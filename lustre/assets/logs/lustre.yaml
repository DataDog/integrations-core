id: lustre
metric_id: lustre
backend_only: false
facets:
  - groups:
      - Web Access
    name: Client IP
    path: network.client.ip
    source: log
  - groups:
      - Lustre
    name: Job ID
    path: lustre.job_id
    source: log
    type: string
  - groups:
      - Lustre
    name: Open Mode
    path: lustre.open_mode
    source: log
    type: string
  - groups:
      - Lustre
    name: Operation Type
    path: lustre.operation_type
    source: log
    type: string
  - groups:
      - Lustre
    name: Group
    path: lustre.group
    source: log
    type: integer
  - groups:
      - Other
    name: User
    path: usr.id
    source: log
    type: integer
pipeline:
  type: pipeline
  name: Lustre
  enabled: true
  filter:
    query: source:lustre
  processors:
    - type: grok-parser
      name: Main parser
      enabled: true
      source: message
      samples:
        - t=[0x200000bd1:0x3:0x0] ef=0x13 u=0:0 nid=172.31.38.176@tcp
          p=[0x200000007:0x1:0x0] some_dir
        - t=[0x200000bd1:0x14:0x0] j=vim.0 ef=0x1b u=0:0 nid=172.31.38.176@tcp
          x=user.job p=[0x200000007:0x1:0x0]
        - >
          t=[0:0x0:0x0] j=vim.0 ef=0x13 u=0:0 nid=172.31.38.176@tcp
          p=[0x200000007:0x1:0x0] vim_edited_file.txt~ s=[0x200000bd1:0x26:0x0]
          sp=[0x200000007:0x1:0x0] vim_edited_file.txt
        - |
          t=[0x200000bd1:0x2b:0x0] j=vim.0 ef=0x13 u=0:0 nid=172.31.38.176@tcp
      grok:
        supportRules: key_value %{data::keyvalue("=", ":\\[\\]")}
        matchRules: >-
          double_rule
          %{key_value}\s%{regex("[^=]*"):target_name}\s%{key_value}\s%{regex("[^=]*"):source_name}

          single_rule %{key_value}(\s%{regex("[^=]*"):target_name})?
    - type: grok-parser
      name: NID separator
      enabled: true
      source: nid
      samples:
        - 172.31.38.176@tcp
      grok:
        supportRules: ""
        matchRules: rule %{ip:network.client.ip}@%{word:network.client.protocol}
    - type: grok-parser
      name: User
      enabled: true
      source: u
      samples:
        - 123:456
      grok:
        supportRules: ""
        matchRules: rule %{integer:usr.id}:%{integer:lustre.group}
    - type: attribute-remapper
      name: Operation Type
      enabled: true
      sources:
        - operation_type
      sourceType: attribute
      target: lustre.operation_type
      targetType: attribute
      preserveSource: false
      overrideOnConflict: false
    - type: attribute-remapper
      name: Flags
      enabled: true
      sources:
        - flags
      sourceType: attribute
      target: lustre.flags
      targetType: attribute
      preserveSource: false
      overrideOnConflict: false
    - type: attribute-remapper
      name: Target FID
      enabled: true
      sources:
        - t
      sourceType: attribute
      target: lustre.target_fid
      targetType: attribute
      preserveSource: false
      overrideOnConflict: false
    - type: attribute-remapper
      name: Extended flags
      enabled: true
      sources:
        - ef
      sourceType: attribute
      target: lustre.extended_flags
      targetType: attribute
      preserveSource: false
      overrideOnConflict: false
    - type: attribute-remapper
      name: User
      enabled: true
      sources:
        - u
      sourceType: attribute
      target: lustre.uid_gid
      targetType: attribute
      preserveSource: false
      overrideOnConflict: false
    - type: attribute-remapper
      name: Parent FID
      enabled: true
      sources:
        - p
      sourceType: attribute
      target: lustre.parent_fid
      targetType: attribute
      preserveSource: false
      overrideOnConflict: false
    - type: attribute-remapper
      name: Open mode
      enabled: true
      sources:
        - m
      sourceType: attribute
      target: lustre.open_mode
      targetType: attribute
      preserveSource: false
      overrideOnConflict: false
    - type: attribute-remapper
      name: Source FID
      enabled: true
      sources:
        - s
      sourceType: attribute
      target: lustre.source_fid
      targetType: attribute
      preserveSource: false
      overrideOnConflict: false
    - type: attribute-remapper
      name: Source parent FID
      enabled: true
      sources:
        - sp
      sourceType: attribute
      target: lustre.source_parent_fid
      targetType: attribute
      preserveSource: false
      overrideOnConflict: false
    - type: attribute-remapper
      name: Source parent FID
      enabled: true
      sources:
        - sp
      sourceType: attribute
      target: lustre.source_parent_fid
      targetType: attribute
      preserveSource: false
      overrideOnConflict: false
    - type: attribute-remapper
      name: Job ID
      enabled: true
      sources:
        - j
      sourceType: attribute
      target: lustre.job_id
      targetType: attribute
      preserveSource: false
      overrideOnConflict: false
    - type: attribute-remapper
      name: Extended attribute
      enabled: true
      sources:
        - x
      sourceType: attribute
      target: lustre.extended_attribute
      targetType: attribute
      preserveSource: false
      overrideOnConflict: false
    - type: attribute-remapper
      name: Target
      enabled: true
      sources:
        - target_name
      sourceType: attribute
      target: lustre.target_name
      targetType: attribute
      preserveSource: false
      overrideOnConflict: false
    - type: attribute-remapper
      name: Source
      enabled: true
      sources:
        - source_name
      sourceType: attribute
      target: lustre.source_name
      targetType: attribute
      preserveSource: false
      overrideOnConflict: false
    - type: attribute-remapper
      name: NID
      enabled: true
      sources:
        - nid
      sourceType: attribute
      target: lustre.nid
      targetType: attribute
      preserveSource: false
      overrideOnConflict: false
