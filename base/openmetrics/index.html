<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The home of Agent Integrations developer documentation"><meta name=author content=Datadog><link href=https://datadoghq.dev/integrations-core/base/openmetrics/ rel=canonical><link href=../databases/ rel=prev><link href=../logs-crawlers/ rel=next><link rel=icon href=../../assets/images/favicon.ico><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.4.14"><title>OpenMetrics - Agent Integrations</title><link rel=stylesheet href=../../assets/stylesheets/main.fad675c6.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.356b1318.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/_mkdocstrings.css><link rel=stylesheet href=../../assets/css/custom.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/firacode@6.2.0/distr/fira_code.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=custom data-md-color-accent=indigo> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#openmetrics class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Agent Integrations" class="md-header__button md-logo" aria-label="Agent Integrations" data-md-component=logo> <img src=../../assets/images/logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Agent Integrations </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> OpenMetrics </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=custom data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=custom data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/DataDog/integrations-core title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class=md-source__repository> datadog/integrations-core </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../about/ class=md-tabs__link> Base Package </a> </li> <li class=md-tabs__item> <a href=../../ddev/about/ class=md-tabs__link> Dev Package </a> </li> <li class=md-tabs__item> <a href=../../guidelines/pr/ class=md-tabs__link> Guidelines </a> </li> <li class=md-tabs__item> <a href=../../meta/ci/testing/ class=md-tabs__link> Meta </a> </li> <li class=md-tabs__item> <a href=../../tutorials/jmx/integration/ class=md-tabs__link> Tutorials </a> </li> <li class=md-tabs__item> <a href=../../architecture/ibm_i/ class=md-tabs__link> Architecture </a> </li> <li class=md-tabs__item> <a href=../../faq/faq/ class=md-tabs__link> FAQ </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Agent Integrations" class="md-nav__button md-logo" aria-label="Agent Integrations" data-md-component=logo> <img src=../../assets/images/logo.svg alt=logo> </a> Agent Integrations </label> <div class=md-nav__source> <a href=https://github.com/DataDog/integrations-core title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class=md-source__repository> datadog/integrations-core </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex> <span class=md-ellipsis> Home </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> About </span> </a> </li> <li class=md-nav__item> <a href=../../setup/ class=md-nav__link> <span class=md-ellipsis> Setup </span> </a> </li> <li class=md-nav__item> <a href=../../testing/ class=md-nav__link> <span class=md-ellipsis> Testing </span> </a> </li> <li class=md-nav__item> <a href=../../e2e/ class=md-nav__link> <span class=md-ellipsis> E2E </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Base Package </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Base Package </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../about/ class=md-nav__link> <span class=md-ellipsis> About </span> </a> </li> <li class=md-nav__item> <a href=../basics/ class=md-nav__link> <span class=md-ellipsis> Basics </span> </a> </li> <li class=md-nav__item> <a href=../http/ class=md-nav__link> <span class=md-ellipsis> HTTP </span> </a> </li> <li class=md-nav__item> <a href=../tls/ class=md-nav__link> <span class=md-ellipsis> TLS/SSL </span> </a> </li> <li class=md-nav__item> <a href=../databases/ class=md-nav__link> <span class=md-ellipsis> Databases </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> OpenMetrics </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> OpenMetrics </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#interface class=md-nav__link> <span class=md-ellipsis> Interface </span> </a> <nav class=md-nav aria-label=Interface> <ul class=md-nav__list> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2 class=md-nav__link> <span class=md-ellipsis> OpenMetricsBaseCheckV2 </span> </a> <nav class=md-nav aria-label=OpenMetricsBaseCheckV2> <ul class=md-nav__list> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2.check class=md-nav__link> <span class=md-ellipsis> check </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2.configure_scrapers class=md-nav__link> <span class=md-ellipsis> configure_scrapers </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2.create_scraper class=md-nav__link> <span class=md-ellipsis> create_scraper </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#scrapers class=md-nav__link> <span class=md-ellipsis> Scrapers </span> </a> <nav class=md-nav aria-label=Scrapers> <ul class=md-nav__list> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper class=md-nav__link> <span class=md-ellipsis> OpenMetricsScraper </span> </a> <nav class=md-nav aria-label=OpenMetricsScraper> <ul class=md-nav__list> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.scrape class=md-nav__link> <span class=md-ellipsis> scrape </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.consume_metrics class=md-nav__link> <span class=md-ellipsis> consume_metrics </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.parse_metrics class=md-nav__link> <span class=md-ellipsis> parse_metrics </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.generate_sample_data class=md-nav__link> <span class=md-ellipsis> generate_sample_data </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.stream_connection_lines class=md-nav__link> <span class=md-ellipsis> stream_connection_lines </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.filter_connection_lines class=md-nav__link> <span class=md-ellipsis> filter_connection_lines </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.get_connection class=md-nav__link> <span class=md-ellipsis> get_connection </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.set_dynamic_tags class=md-nav__link> <span class=md-ellipsis> set_dynamic_tags </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.submit_health_check class=md-nav__link> <span class=md-ellipsis> submit_health_check </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#transformers class=md-nav__link> <span class=md-ellipsis> Transformers </span> </a> <nav class=md-nav aria-label=Transformers> <ul class=md-nav__list> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.transform.Transformers class=md-nav__link> <span class=md-ellipsis> Transformers </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#options class=md-nav__link> <span class=md-ellipsis> Options </span> </a> </li> <li class=md-nav__item> <a href=#legacy class=md-nav__link> <span class=md-ellipsis> Legacy </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../logs-crawlers/ class=md-nav__link> <span class=md-ellipsis> Log Crawlers </span> </a> </li> <li class=md-nav__item> <a href=../metadata/ class=md-nav__link> <span class=md-ellipsis> Metadata </span> </a> </li> <li class=md-nav__item> <a href=../api/ class=md-nav__link> <span class=md-ellipsis> API </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Dev Package </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Dev Package </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ddev/about/ class=md-nav__link> <span class=md-ellipsis> What's in the box? </span> </a> </li> <li class=md-nav__item> <a href=../../ddev/test/ class=md-nav__link> <span class=md-ellipsis> Test framework </span> </a> </li> <li class=md-nav__item> <a href=../../ddev/plugins/ class=md-nav__link> <span class=md-ellipsis> Plugins </span> </a> </li> <li class=md-nav__item> <a href=../../ddev/configuration/ class=md-nav__link> <span class=md-ellipsis> Configuration </span> </a> </li> <li class=md-nav__item> <a href=../../ddev/cli/ class=md-nav__link> <span class=md-ellipsis> CLI </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Guidelines </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Guidelines </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../guidelines/pr/ class=md-nav__link> <span class=md-ellipsis> Pull requests </span> </a> </li> <li class=md-nav__item> <a href=../../guidelines/style/ class=md-nav__link> <span class=md-ellipsis> Style </span> </a> </li> <li class=md-nav__item> <a href=../../guidelines/dashboards/ class=md-nav__link> <span class=md-ellipsis> Dashboards </span> </a> </li> <li class=md-nav__item> <a href=../../guidelines/conventions/ class=md-nav__link> <span class=md-ellipsis> Conventions </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> Meta </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Meta </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_1> <label class=md-nav__link for=__nav_5_1 id=__nav_5_1_label tabindex> <span class=md-ellipsis> CI </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_1_label aria-expanded=false> <label class=md-nav__title for=__nav_5_1> <span class="md-nav__icon md-icon"></span> CI </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../meta/ci/testing/ class=md-nav__link> <span class=md-ellipsis> Testing </span> </a> </li> <li class=md-nav__item> <a href=../../meta/ci/validation/ class=md-nav__link> <span class=md-ellipsis> Validation </span> </a> </li> <li class=md-nav__item> <a href=../../meta/ci/labels/ class=md-nav__link> <span class=md-ellipsis> Labels </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../meta/docs/ class=md-nav__link> <span class=md-ellipsis> Docs </span> </a> </li> <li class=md-nav__item> <a href=../../meta/config-specs/ class=md-nav__link> <span class=md-ellipsis> Config specs </span> </a> </li> <li class=md-nav__item> <a href=../../meta/config-models/ class=md-nav__link> <span class=md-ellipsis> Config models </span> </a> </li> <li class=md-nav__item> <a href=../../meta/status/ class=md-nav__link> <span class=md-ellipsis> Status </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6_1> <label class=md-nav__link for=__nav_6_1 id=__nav_6_1_label tabindex> <span class=md-ellipsis> JMX </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_1_label aria-expanded=false> <label class=md-nav__title for=__nav_6_1> <span class="md-nav__icon md-icon"></span> JMX </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tutorials/jmx/integration/ class=md-nav__link> <span class=md-ellipsis> JMX integration </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/jmx/tools/ class=md-nav__link> <span class=md-ellipsis> JMX Tools </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6_2> <label class=md-nav__link for=__nav_6_2 id=__nav_6_2_label tabindex> <span class=md-ellipsis> SNMP </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_2_label aria-expanded=false> <label class=md-nav__title for=__nav_6_2> <span class="md-nav__icon md-icon"></span> SNMP </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tutorials/snmp/introduction/ class=md-nav__link> <span class=md-ellipsis> Introduction to SNMP </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/snmp/profiles/ class=md-nav__link> <span class=md-ellipsis> Build an SNMP Profile </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/snmp/how-to/ class=md-nav__link> <span class=md-ellipsis> SNMP How-To </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/snmp/profile-format/ class=md-nav__link> <span class=md-ellipsis> Profile Format Reference </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/snmp/sim-format/ class=md-nav__link> <span class=md-ellipsis> Simulation Data Format Reference </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/snmp/tools/ class=md-nav__link> <span class=md-ellipsis> Tools </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6_3> <label class=md-nav__link for=__nav_6_3 id=__nav_6_3_label tabindex> <span class=md-ellipsis> Logs </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_3_label aria-expanded=false> <label class=md-nav__title for=__nav_6_3> <span class="md-nav__icon md-icon"></span> Logs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tutorials/logs/http-crawler/ class=md-nav__link> <span class=md-ellipsis> Submit Logs from HTTP API </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex> <span class=md-ellipsis> Architecture </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Architecture </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../architecture/ibm_i/ class=md-nav__link> <span class=md-ellipsis> IBM i </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/snmp/ class=md-nav__link> <span class=md-ellipsis> SNMP </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/vsphere/ class=md-nav__link> <span class=md-ellipsis> vSphere </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/win32_event_log/ class=md-nav__link> <span class=md-ellipsis> Windows Event Log </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex> <span class=md-ellipsis> FAQ </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> FAQ </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../faq/faq/ class=md-nav__link> <span class=md-ellipsis> FAQ </span> </a> </li> <li class=md-nav__item> <a href=../../faq/acknowledgements/ class=md-nav__link> <span class=md-ellipsis> Acknowledgements </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#interface class=md-nav__link> <span class=md-ellipsis> Interface </span> </a> <nav class=md-nav aria-label=Interface> <ul class=md-nav__list> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2 class=md-nav__link> <span class=md-ellipsis> OpenMetricsBaseCheckV2 </span> </a> <nav class=md-nav aria-label=OpenMetricsBaseCheckV2> <ul class=md-nav__list> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2.check class=md-nav__link> <span class=md-ellipsis> check </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2.configure_scrapers class=md-nav__link> <span class=md-ellipsis> configure_scrapers </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2.create_scraper class=md-nav__link> <span class=md-ellipsis> create_scraper </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#scrapers class=md-nav__link> <span class=md-ellipsis> Scrapers </span> </a> <nav class=md-nav aria-label=Scrapers> <ul class=md-nav__list> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper class=md-nav__link> <span class=md-ellipsis> OpenMetricsScraper </span> </a> <nav class=md-nav aria-label=OpenMetricsScraper> <ul class=md-nav__list> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.scrape class=md-nav__link> <span class=md-ellipsis> scrape </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.consume_metrics class=md-nav__link> <span class=md-ellipsis> consume_metrics </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.parse_metrics class=md-nav__link> <span class=md-ellipsis> parse_metrics </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.generate_sample_data class=md-nav__link> <span class=md-ellipsis> generate_sample_data </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.stream_connection_lines class=md-nav__link> <span class=md-ellipsis> stream_connection_lines </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.filter_connection_lines class=md-nav__link> <span class=md-ellipsis> filter_connection_lines </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.get_connection class=md-nav__link> <span class=md-ellipsis> get_connection </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.set_dynamic_tags class=md-nav__link> <span class=md-ellipsis> set_dynamic_tags </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.submit_health_check class=md-nav__link> <span class=md-ellipsis> submit_health_check </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#transformers class=md-nav__link> <span class=md-ellipsis> Transformers </span> </a> <nav class=md-nav aria-label=Transformers> <ul class=md-nav__list> <li class=md-nav__item> <a href=#datadog_checks.base.checks.openmetrics.v2.transform.Transformers class=md-nav__link> <span class=md-ellipsis> Transformers </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#options class=md-nav__link> <span class=md-ellipsis> Options </span> </a> </li> <li class=md-nav__item> <a href=#legacy class=md-nav__link> <span class=md-ellipsis> Legacy </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/DataDog/integrations-core/blob/master/docs/developer/base/openmetrics.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg> </a> <h1 id=openmetrics>OpenMetrics<a class=headerlink href=#openmetrics title="Permanent link">&para;</a></h1> <hr> <p>OpenMetrics is used for collecting metrics using the CNCF-backed OpenMetrics format. This version is the default version for all new OpenMetric-checks, and it is compatible with Python 3 only.</p> <h2 id=interface>Interface<a class=headerlink href=#interface title="Permanent link">&para;</a></h2> <div class="doc doc-object doc-class"> <h3 id=datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2 class="doc doc-heading"> <code>datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2</code> <a href=#datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2 class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents first"> <p>OpenMetricsBaseCheckV2 is an updated class of OpenMetricsBaseCheck to scrape endpoints that emit Prometheus metrics.</p> <p>Minimal example configuration:</p> <div class=highlight><pre><span></span><code><span class=nt>instances</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>openmetrics_endpoint</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http://example.com/endpoint</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=s>&quot;foobar&quot;</span>
<span class=w>  </span><span class=nt>metrics</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bar</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo</span>
</code></pre></div> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/base.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos=" 15 "></span><span class=k>class</span> <span class=nc>OpenMetricsBaseCheckV2</span><span class=p>(</span><span class=n>AgentCheck</span><span class=p>):</span>
<span class=linenos data-linenos=" 16 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 17 "></span><span class=sd>    OpenMetricsBaseCheckV2 is an updated class of OpenMetricsBaseCheck to scrape endpoints that emit Prometheus metrics.</span>
<span class=linenos data-linenos=" 18 "></span>
<span class=linenos data-linenos=" 19 "></span><span class=sd>    Minimal example configuration:</span>
<span class=linenos data-linenos=" 20 "></span>
<span class=linenos data-linenos=" 21 "></span><span class=sd>    ```yaml</span>
<span class=linenos data-linenos=" 22 "></span><span class=sd>    instances:</span>
<span class=linenos data-linenos=" 23 "></span><span class=sd>    - openmetrics_endpoint: http://example.com/endpoint</span>
<span class=linenos data-linenos=" 24 "></span><span class=sd>      namespace: &quot;foobar&quot;</span>
<span class=linenos data-linenos=" 25 "></span><span class=sd>      metrics:</span>
<span class=linenos data-linenos=" 26 "></span><span class=sd>      - bar</span>
<span class=linenos data-linenos=" 27 "></span><span class=sd>      - foo</span>
<span class=linenos data-linenos=" 28 "></span><span class=sd>    ```</span>
<span class=linenos data-linenos=" 29 "></span>
<span class=linenos data-linenos=" 30 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 31 "></span>
<span class=linenos data-linenos=" 32 "></span>    <span class=n>DEFAULT_METRIC_LIMIT</span> <span class=o>=</span> <span class=mi>2000</span>
<span class=linenos data-linenos=" 33 "></span>
<span class=linenos data-linenos=" 34 "></span>    <span class=c1># Allow tracing for openmetrics integrations</span>
<span class=linenos data-linenos=" 35 "></span>    <span class=k>def</span> <span class=nf>__init_subclass__</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=linenos data-linenos=" 36 "></span>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>__init_subclass__</span><span class=p>(</span><span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<span class=linenos data-linenos=" 37 "></span>        <span class=k>return</span> <span class=n>traced_class</span><span class=p>(</span><span class=bp>cls</span><span class=p>)</span>
<span class=linenos data-linenos=" 38 "></span>
<span class=linenos data-linenos=" 39 "></span>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>init_config</span><span class=p>,</span> <span class=n>instances</span><span class=p>):</span>
<span class=linenos data-linenos=" 40 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 41 "></span><span class=sd>        The base class for any OpenMetrics-based integration.</span>
<span class=linenos data-linenos=" 42 "></span>
<span class=linenos data-linenos=" 43 "></span><span class=sd>        Subclasses are expected to override this to add their custom scrapers or transformers.</span>
<span class=linenos data-linenos=" 44 "></span><span class=sd>        When overriding, make sure to call this (the parent&#39;s) __init__ first!</span>
<span class=linenos data-linenos=" 45 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 46 "></span>        <span class=nb>super</span><span class=p>(</span><span class=n>OpenMetricsBaseCheckV2</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>init_config</span><span class=p>,</span> <span class=n>instances</span><span class=p>)</span>
<span class=linenos data-linenos=" 47 "></span>
<span class=linenos data-linenos=" 48 "></span>        <span class=c1># All desired scraper configurations, which subclasses can override as needed</span>
<span class=linenos data-linenos=" 49 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>scraper_configs</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>instance</span><span class=p>]</span>
<span class=linenos data-linenos=" 50 "></span>
<span class=linenos data-linenos=" 51 "></span>        <span class=c1># All configured scrapers keyed by the endpoint</span>
<span class=linenos data-linenos=" 52 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>scrapers</span> <span class=o>=</span> <span class=p>{}</span>
<span class=linenos data-linenos=" 53 "></span>
<span class=linenos data-linenos=" 54 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>check_initializations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>configure_scrapers</span><span class=p>)</span>
<span class=linenos data-linenos=" 55 "></span>
<span class=linenos data-linenos=" 56 "></span>    <span class=k>def</span> <span class=nf>check</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>_</span><span class=p>):</span>
<span class=linenos data-linenos=" 57 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 58 "></span><span class=sd>        Perform an openmetrics-based check.</span>
<span class=linenos data-linenos=" 59 "></span>
<span class=linenos data-linenos=" 60 "></span><span class=sd>        Subclasses should typically not need to override this, as most common customization</span>
<span class=linenos data-linenos=" 61 "></span><span class=sd>        needs are covered by the use of custom scrapers.</span>
<span class=linenos data-linenos=" 62 "></span><span class=sd>        Another thing to note is that this check ignores its instance argument completely.</span>
<span class=linenos data-linenos=" 63 "></span><span class=sd>        We take care of instance-level customization at initialization time.</span>
<span class=linenos data-linenos=" 64 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 65 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>refresh_scrapers</span><span class=p>()</span>
<span class=linenos data-linenos=" 66 "></span>
<span class=linenos data-linenos=" 67 "></span>        <span class=k>for</span> <span class=n>endpoint</span><span class=p>,</span> <span class=n>scraper</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>scrapers</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
<span class=linenos data-linenos=" 68 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s1>&#39;Scraping OpenMetrics endpoint: </span><span class=si>%s</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>endpoint</span><span class=p>)</span>
<span class=linenos data-linenos=" 69 "></span>
<span class=linenos data-linenos=" 70 "></span>            <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>adopt_namespace</span><span class=p>(</span><span class=n>scraper</span><span class=o>.</span><span class=n>namespace</span><span class=p>):</span>
<span class=linenos data-linenos=" 71 "></span>                <span class=k>try</span><span class=p>:</span>
<span class=linenos data-linenos=" 72 "></span>                    <span class=n>scraper</span><span class=o>.</span><span class=n>scrape</span><span class=p>()</span>
<span class=linenos data-linenos=" 73 "></span>                <span class=k>except</span> <span class=p>(</span><span class=ne>ConnectionError</span><span class=p>,</span> <span class=n>RequestException</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<span class=linenos data-linenos=" 74 "></span>                    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=s2>&quot;There was an error scraping endpoint </span><span class=si>%s</span><span class=s2>: </span><span class=si>%s</span><span class=s2>&quot;</span><span class=p>,</span> <span class=n>endpoint</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<span class=linenos data-linenos=" 75 "></span>                    <span class=k>raise</span> <span class=nb>type</span><span class=p>(</span><span class=n>e</span><span class=p>)(</span><span class=s2>&quot;There was an error scraping endpoint </span><span class=si>{}</span><span class=s2>: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>endpoint</span><span class=p>,</span> <span class=n>e</span><span class=p>))</span> <span class=kn>from</span> <span class=kc>None</span>
<span class=linenos data-linenos=" 76 "></span>
<span class=linenos data-linenos=" 77 "></span>    <span class=k>def</span> <span class=nf>configure_scrapers</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=linenos data-linenos=" 78 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 79 "></span><span class=sd>        Creates a scraper configuration for each instance.</span>
<span class=linenos data-linenos=" 80 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 81 "></span>
<span class=linenos data-linenos=" 82 "></span>        <span class=n>scrapers</span> <span class=o>=</span> <span class=p>{}</span>
<span class=linenos data-linenos=" 83 "></span>
<span class=linenos data-linenos=" 84 "></span>        <span class=k>for</span> <span class=n>config</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>scraper_configs</span><span class=p>:</span>
<span class=linenos data-linenos=" 85 "></span>            <span class=n>endpoint</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;openmetrics_endpoint&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 86 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>endpoint</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos=" 87 "></span>                <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;The setting `openmetrics_endpoint` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 88 "></span>            <span class=k>elif</span> <span class=ow>not</span> <span class=n>endpoint</span><span class=p>:</span>
<span class=linenos data-linenos=" 89 "></span>                <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;The setting `openmetrics_endpoint` is required&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 90 "></span>
<span class=linenos data-linenos=" 91 "></span>            <span class=n>scrapers</span><span class=p>[</span><span class=n>endpoint</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_scraper</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
<span class=linenos data-linenos=" 92 "></span>
<span class=linenos data-linenos=" 93 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>scrapers</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
<span class=linenos data-linenos=" 94 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>scrapers</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>scrapers</span><span class=p>)</span>
<span class=linenos data-linenos=" 95 "></span>
<span class=linenos data-linenos=" 96 "></span>    <span class=k>def</span> <span class=nf>create_scraper</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>config</span><span class=p>):</span>
<span class=linenos data-linenos=" 97 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 98 "></span><span class=sd>        Subclasses can override to return a custom scraper based on instance configuration.</span>
<span class=linenos data-linenos=" 99 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos="100 "></span>        <span class=k>return</span> <span class=n>OpenMetricsScraper</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_config_with_defaults</span><span class=p>(</span><span class=n>config</span><span class=p>))</span>
<span class=linenos data-linenos="101 "></span>
<span class=linenos data-linenos="102 "></span>    <span class=k>def</span> <span class=nf>set_dynamic_tags</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>tags</span><span class=p>):</span>
<span class=linenos data-linenos="103 "></span>        <span class=k>for</span> <span class=n>scraper</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>scrapers</span><span class=o>.</span><span class=n>values</span><span class=p>():</span>
<span class=linenos data-linenos="104 "></span>            <span class=n>scraper</span><span class=o>.</span><span class=n>set_dynamic_tags</span><span class=p>(</span><span class=o>*</span><span class=n>tags</span><span class=p>)</span>
<span class=linenos data-linenos="105 "></span>
<span class=linenos data-linenos="106 "></span>    <span class=k>def</span> <span class=nf>get_config_with_defaults</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>config</span><span class=p>):</span>
<span class=linenos data-linenos="107 "></span>        <span class=k>return</span> <span class=n>ChainMap</span><span class=p>(</span><span class=n>config</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_default_config</span><span class=p>())</span>
<span class=linenos data-linenos="108 "></span>
<span class=linenos data-linenos="109 "></span>    <span class=k>def</span> <span class=nf>get_default_config</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=linenos data-linenos="110 "></span>        <span class=k>return</span> <span class=p>{}</span>
<span class=linenos data-linenos="111 "></span>
<span class=linenos data-linenos="112 "></span>    <span class=k>def</span> <span class=nf>refresh_scrapers</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=linenos data-linenos="113 "></span>        <span class=k>pass</span>
<span class=linenos data-linenos="114 "></span>
<span class=linenos data-linenos="115 "></span>    <span class=nd>@contextmanager</span>
<span class=linenos data-linenos="116 "></span>    <span class=k>def</span> <span class=nf>adopt_namespace</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>namespace</span><span class=p>):</span>
<span class=linenos data-linenos="117 "></span>        <span class=n>old_namespace</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>__NAMESPACE__</span>
<span class=linenos data-linenos="118 "></span>
<span class=linenos data-linenos="119 "></span>        <span class=k>try</span><span class=p>:</span>
<span class=linenos data-linenos="120 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>__NAMESPACE__</span> <span class=o>=</span> <span class=n>namespace</span> <span class=ow>or</span> <span class=n>old_namespace</span>
<span class=linenos data-linenos="121 "></span>            <span class=k>yield</span>
<span class=linenos data-linenos="122 "></span>        <span class=k>finally</span><span class=p>:</span>
<span class=linenos data-linenos="123 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>__NAMESPACE__</span> <span class=o>=</span> <span class=n>old_namespace</span>
</code></pre></div> </details> <div class="doc doc-children"> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2.__init__ class="doc doc-heading"> <code class="highlight language-python"><span class=fm>__init__</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>init_config</span><span class=p>,</span> <span class=n>instances</span><span class=p>)</span></code> <a href=#datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2.__init__ class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>The base class for any OpenMetrics-based integration.</p> <p>Subclasses are expected to override this to add their custom scrapers or transformers. When overriding, make sure to call this (the parent's) <strong>init</strong> first!</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/base.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="39 "></span><span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>init_config</span><span class=p>,</span> <span class=n>instances</span><span class=p>):</span>
<span class=linenos data-linenos="40 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="41 "></span><span class=sd>    The base class for any OpenMetrics-based integration.</span>
<span class=linenos data-linenos="42 "></span>
<span class=linenos data-linenos="43 "></span><span class=sd>    Subclasses are expected to override this to add their custom scrapers or transformers.</span>
<span class=linenos data-linenos="44 "></span><span class=sd>    When overriding, make sure to call this (the parent&#39;s) __init__ first!</span>
<span class=linenos data-linenos="45 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="46 "></span>    <span class=nb>super</span><span class=p>(</span><span class=n>OpenMetricsBaseCheckV2</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>init_config</span><span class=p>,</span> <span class=n>instances</span><span class=p>)</span>
<span class=linenos data-linenos="47 "></span>
<span class=linenos data-linenos="48 "></span>    <span class=c1># All desired scraper configurations, which subclasses can override as needed</span>
<span class=linenos data-linenos="49 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>scraper_configs</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>instance</span><span class=p>]</span>
<span class=linenos data-linenos="50 "></span>
<span class=linenos data-linenos="51 "></span>    <span class=c1># All configured scrapers keyed by the endpoint</span>
<span class=linenos data-linenos="52 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>scrapers</span> <span class=o>=</span> <span class=p>{}</span>
<span class=linenos data-linenos="53 "></span>
<span class=linenos data-linenos="54 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>check_initializations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>configure_scrapers</span><span class=p>)</span>
</code></pre></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2.check class="doc doc-heading"> <code class="highlight language-python"><span class=n>check</span><span class=p>(</span><span class=n>_</span><span class=p>)</span></code> <a href=#datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2.check class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Perform an openmetrics-based check.</p> <p>Subclasses should typically not need to override this, as most common customization needs are covered by the use of custom scrapers. Another thing to note is that this check ignores its instance argument completely. We take care of instance-level customization at initialization time.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/base.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="56 "></span><span class=k>def</span> <span class=nf>check</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>_</span><span class=p>):</span>
<span class=linenos data-linenos="57 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="58 "></span><span class=sd>    Perform an openmetrics-based check.</span>
<span class=linenos data-linenos="59 "></span>
<span class=linenos data-linenos="60 "></span><span class=sd>    Subclasses should typically not need to override this, as most common customization</span>
<span class=linenos data-linenos="61 "></span><span class=sd>    needs are covered by the use of custom scrapers.</span>
<span class=linenos data-linenos="62 "></span><span class=sd>    Another thing to note is that this check ignores its instance argument completely.</span>
<span class=linenos data-linenos="63 "></span><span class=sd>    We take care of instance-level customization at initialization time.</span>
<span class=linenos data-linenos="64 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="65 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>refresh_scrapers</span><span class=p>()</span>
<span class=linenos data-linenos="66 "></span>
<span class=linenos data-linenos="67 "></span>    <span class=k>for</span> <span class=n>endpoint</span><span class=p>,</span> <span class=n>scraper</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>scrapers</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
<span class=linenos data-linenos="68 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s1>&#39;Scraping OpenMetrics endpoint: </span><span class=si>%s</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>endpoint</span><span class=p>)</span>
<span class=linenos data-linenos="69 "></span>
<span class=linenos data-linenos="70 "></span>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>adopt_namespace</span><span class=p>(</span><span class=n>scraper</span><span class=o>.</span><span class=n>namespace</span><span class=p>):</span>
<span class=linenos data-linenos="71 "></span>            <span class=k>try</span><span class=p>:</span>
<span class=linenos data-linenos="72 "></span>                <span class=n>scraper</span><span class=o>.</span><span class=n>scrape</span><span class=p>()</span>
<span class=linenos data-linenos="73 "></span>            <span class=k>except</span> <span class=p>(</span><span class=ne>ConnectionError</span><span class=p>,</span> <span class=n>RequestException</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<span class=linenos data-linenos="74 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=s2>&quot;There was an error scraping endpoint </span><span class=si>%s</span><span class=s2>: </span><span class=si>%s</span><span class=s2>&quot;</span><span class=p>,</span> <span class=n>endpoint</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<span class=linenos data-linenos="75 "></span>                <span class=k>raise</span> <span class=nb>type</span><span class=p>(</span><span class=n>e</span><span class=p>)(</span><span class=s2>&quot;There was an error scraping endpoint </span><span class=si>{}</span><span class=s2>: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>endpoint</span><span class=p>,</span> <span class=n>e</span><span class=p>))</span> <span class=kn>from</span> <span class=kc>None</span>
</code></pre></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2.configure_scrapers class="doc doc-heading"> <code class="highlight language-python"><span class=n>configure_scrapers</span><span class=p>()</span></code> <a href=#datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2.configure_scrapers class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Creates a scraper configuration for each instance.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/base.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="77 "></span><span class=k>def</span> <span class=nf>configure_scrapers</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=linenos data-linenos="78 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="79 "></span><span class=sd>    Creates a scraper configuration for each instance.</span>
<span class=linenos data-linenos="80 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="81 "></span>
<span class=linenos data-linenos="82 "></span>    <span class=n>scrapers</span> <span class=o>=</span> <span class=p>{}</span>
<span class=linenos data-linenos="83 "></span>
<span class=linenos data-linenos="84 "></span>    <span class=k>for</span> <span class=n>config</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>scraper_configs</span><span class=p>:</span>
<span class=linenos data-linenos="85 "></span>        <span class=n>endpoint</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;openmetrics_endpoint&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="86 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>endpoint</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="87 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;The setting `openmetrics_endpoint` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="88 "></span>        <span class=k>elif</span> <span class=ow>not</span> <span class=n>endpoint</span><span class=p>:</span>
<span class=linenos data-linenos="89 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;The setting `openmetrics_endpoint` is required&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="90 "></span>
<span class=linenos data-linenos="91 "></span>        <span class=n>scrapers</span><span class=p>[</span><span class=n>endpoint</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_scraper</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
<span class=linenos data-linenos="92 "></span>
<span class=linenos data-linenos="93 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>scrapers</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
<span class=linenos data-linenos="94 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>scrapers</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>scrapers</span><span class=p>)</span>
</code></pre></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2.create_scraper class="doc doc-heading"> <code class="highlight language-python"><span class=n>create_scraper</span><span class=p>(</span><span class=n>config</span><span class=p>)</span></code> <a href=#datadog_checks.base.checks.openmetrics.v2.base.OpenMetricsBaseCheckV2.create_scraper class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Subclasses can override to return a custom scraper based on instance configuration.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/base.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos=" 96 "></span><span class=k>def</span> <span class=nf>create_scraper</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>config</span><span class=p>):</span>
<span class=linenos data-linenos=" 97 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 98 "></span><span class=sd>    Subclasses can override to return a custom scraper based on instance configuration.</span>
<span class=linenos data-linenos=" 99 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="100 "></span>    <span class=k>return</span> <span class=n>OpenMetricsScraper</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_config_with_defaults</span><span class=p>(</span><span class=n>config</span><span class=p>))</span>
</code></pre></div> </details> </div> </div> </div> </div> </div><h2 id=scrapers>Scrapers<a class=headerlink href=#scrapers title="Permanent link">&para;</a></h2> <div class="doc doc-object doc-class"> <h3 id=datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper class="doc doc-heading"> <code>datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper</code> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents first"> <p>OpenMetricsScraper is a class that can be used to override the default scraping behavior for OpenMetricsBaseCheckV2.</p> <p>Minimal example configuration:</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>openmetrics_endpoint</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http://example.com/endpoint</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=s>&quot;foobar&quot;</span>
<span class=w>  </span><span class=nt>metrics</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bar</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo</span>
<span class=w>  </span><span class=nt>raw_metric_prefix</span><span class=p>:</span><span class=w> </span><span class=s>&quot;test&quot;</span>
<span class=w>  </span><span class=nt>telemetry</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span>
<span class=w>  </span><span class=nt>hostname_label</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">node</span>
</code></pre></div> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/scraper.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos=" 28 "></span><span class=k>class</span> <span class=nc>OpenMetricsScraper</span><span class=p>:</span>
<span class=linenos data-linenos=" 29 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 30 "></span><span class=sd>    OpenMetricsScraper is a class that can be used to override the default scraping behavior for OpenMetricsBaseCheckV2.</span>
<span class=linenos data-linenos=" 31 "></span>
<span class=linenos data-linenos=" 32 "></span><span class=sd>    Minimal example configuration:</span>
<span class=linenos data-linenos=" 33 "></span>
<span class=linenos data-linenos=" 34 "></span><span class=sd>    ```yaml</span>
<span class=linenos data-linenos=" 35 "></span><span class=sd>    - openmetrics_endpoint: http://example.com/endpoint</span>
<span class=linenos data-linenos=" 36 "></span><span class=sd>      namespace: &quot;foobar&quot;</span>
<span class=linenos data-linenos=" 37 "></span><span class=sd>      metrics:</span>
<span class=linenos data-linenos=" 38 "></span><span class=sd>      - bar</span>
<span class=linenos data-linenos=" 39 "></span><span class=sd>      - foo</span>
<span class=linenos data-linenos=" 40 "></span><span class=sd>      raw_metric_prefix: &quot;test&quot;</span>
<span class=linenos data-linenos=" 41 "></span><span class=sd>      telemetry: &quot;true&quot;</span>
<span class=linenos data-linenos=" 42 "></span><span class=sd>      hostname_label: node</span>
<span class=linenos data-linenos=" 43 "></span><span class=sd>    ```</span>
<span class=linenos data-linenos=" 44 "></span>
<span class=linenos data-linenos=" 45 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 46 "></span>
<span class=linenos data-linenos=" 47 "></span>    <span class=n>SERVICE_CHECK_HEALTH</span> <span class=o>=</span> <span class=s1>&#39;openmetrics.health&#39;</span>
<span class=linenos data-linenos=" 48 "></span>
<span class=linenos data-linenos=" 49 "></span>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>check</span><span class=p>,</span> <span class=n>config</span><span class=p>):</span>
<span class=linenos data-linenos=" 50 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 51 "></span><span class=sd>        The base class for any scraper overrides.</span>
<span class=linenos data-linenos=" 52 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 53 "></span>
<span class=linenos data-linenos=" 54 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>config</span> <span class=o>=</span> <span class=n>config</span>
<span class=linenos data-linenos=" 55 "></span>
<span class=linenos data-linenos=" 56 "></span>        <span class=c1># Save a reference to the check instance</span>
<span class=linenos data-linenos=" 57 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>check</span> <span class=o>=</span> <span class=n>check</span>
<span class=linenos data-linenos=" 58 "></span>
<span class=linenos data-linenos=" 59 "></span>        <span class=c1># Parse the configuration</span>
<span class=linenos data-linenos=" 60 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>endpoint</span> <span class=o>=</span> <span class=n>config</span><span class=p>[</span><span class=s1>&#39;openmetrics_endpoint&#39;</span><span class=p>]</span>
<span class=linenos data-linenos=" 61 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>target_info</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;target_info&#39;</span><span class=p>,</span> <span class=kc>False</span><span class=p>)</span>
<span class=linenos data-linenos=" 62 "></span>
<span class=linenos data-linenos=" 63 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>metric_transformer</span> <span class=o>=</span> <span class=n>MetricTransformer</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=p>,</span> <span class=n>config</span><span class=p>)</span>
<span class=linenos data-linenos=" 64 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>label_aggregator</span> <span class=o>=</span> <span class=n>LabelAggregator</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=p>,</span> <span class=n>config</span><span class=p>)</span>
<span class=linenos data-linenos=" 65 "></span>
<span class=linenos data-linenos=" 66 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>enable_telemetry</span> <span class=o>=</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;telemetry&#39;</span><span class=p>,</span> <span class=kc>False</span><span class=p>))</span>
<span class=linenos data-linenos=" 67 "></span>        <span class=c1># Make every telemetry submission method a no-op to avoid many lookups of `self.enable_telemetry`</span>
<span class=linenos data-linenos=" 68 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>enable_telemetry</span><span class=p>:</span>
<span class=linenos data-linenos=" 69 "></span>            <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>_</span> <span class=ow>in</span> <span class=n>inspect</span><span class=o>.</span><span class=n>getmembers</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>predicate</span><span class=o>=</span><span class=n>inspect</span><span class=o>.</span><span class=n>ismethod</span><span class=p>):</span>
<span class=linenos data-linenos=" 70 "></span>                <span class=k>if</span> <span class=n>name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;submit_telemetry_&#39;</span><span class=p>):</span>
<span class=linenos data-linenos=" 71 "></span>                    <span class=nb>setattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>no_op</span><span class=p>)</span>
<span class=linenos data-linenos=" 72 "></span>
<span class=linenos data-linenos=" 73 "></span>        <span class=c1># Prevent overriding an integration&#39;s defined namespace</span>
<span class=linenos data-linenos=" 74 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>namespace</span> <span class=o>=</span> <span class=n>check</span><span class=o>.</span><span class=n>__NAMESPACE__</span> <span class=ow>or</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;namespace&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 75 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>namespace</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos=" 76 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `namespace` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 77 "></span>
<span class=linenos data-linenos=" 78 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>raw_metric_prefix</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;raw_metric_prefix&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 79 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>raw_metric_prefix</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos=" 80 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `raw_metric_prefix` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 81 "></span>
<span class=linenos data-linenos=" 82 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>enable_health_service_check</span> <span class=o>=</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;enable_health_service_check&#39;</span><span class=p>,</span> <span class=kc>True</span><span class=p>))</span>
<span class=linenos data-linenos=" 83 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>ignore_connection_errors</span> <span class=o>=</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;ignore_connection_errors&#39;</span><span class=p>,</span> <span class=kc>False</span><span class=p>))</span>
<span class=linenos data-linenos=" 84 "></span>
<span class=linenos data-linenos=" 85 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>hostname_label</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;hostname_label&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 86 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>hostname_label</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos=" 87 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `hostname_label` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 88 "></span>
<span class=linenos data-linenos=" 89 "></span>        <span class=n>hostname_format</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;hostname_format&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 90 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>hostname_format</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos=" 91 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `hostname_format` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 92 "></span>
<span class=linenos data-linenos=" 93 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>hostname_formatter</span> <span class=o>=</span> <span class=kc>None</span>
<span class=linenos data-linenos=" 94 "></span>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>hostname_label</span> <span class=ow>and</span> <span class=n>hostname_format</span><span class=p>:</span>
<span class=linenos data-linenos=" 95 "></span>            <span class=n>placeholder</span> <span class=o>=</span> <span class=s1>&#39;&lt;HOSTNAME&gt;&#39;</span>
<span class=linenos data-linenos=" 96 "></span>            <span class=k>if</span> <span class=n>placeholder</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>hostname_format</span><span class=p>:</span>
<span class=linenos data-linenos=" 97 "></span>                <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Setting `hostname_format` does not contain the placeholder `</span><span class=si>{</span><span class=n>placeholder</span><span class=si>}</span><span class=s1>`&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 98 "></span>
<span class=linenos data-linenos=" 99 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>hostname_formatter</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>hostname</span><span class=p>:</span> <span class=n>hostname_format</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;&lt;HOSTNAME&gt;&#39;</span><span class=p>,</span> <span class=n>hostname</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
<span class=linenos data-linenos="100 "></span>
<span class=linenos data-linenos="101 "></span>        <span class=n>exclude_labels</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;exclude_labels&#39;</span><span class=p>,</span> <span class=p>[])</span>
<span class=linenos data-linenos="102 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>exclude_labels</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="103 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `exclude_labels` must be an array&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="104 "></span>
<span class=linenos data-linenos="105 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>exclude_labels</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
<span class=linenos data-linenos="106 "></span>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>entry</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>exclude_labels</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="107 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>entry</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="108 "></span>                <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Entry #</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1> of setting `exclude_labels` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="109 "></span>
<span class=linenos data-linenos="110 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>exclude_labels</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
<span class=linenos data-linenos="111 "></span>
<span class=linenos data-linenos="112 "></span>        <span class=n>include_labels</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;include_labels&#39;</span><span class=p>,</span> <span class=p>[])</span>
<span class=linenos data-linenos="113 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>include_labels</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="114 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `include_labels` must be an array&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="115 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>include_labels</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
<span class=linenos data-linenos="116 "></span>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>entry</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>include_labels</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="117 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>entry</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="118 "></span>                <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Entry #</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1> of setting `include_labels` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="119 "></span>            <span class=k>if</span> <span class=n>entry</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>exclude_labels</span><span class=p>:</span>
<span class=linenos data-linenos="120 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
<span class=linenos data-linenos="121 "></span>                    <span class=s1>&#39;Label `</span><span class=si>%s</span><span class=s1>` is set in both `exclude_labels` and `include_labels`. Excluding label.&#39;</span><span class=p>,</span> <span class=n>entry</span>
<span class=linenos data-linenos="122 "></span>                <span class=p>)</span>
<span class=linenos data-linenos="123 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>include_labels</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
<span class=linenos data-linenos="124 "></span>
<span class=linenos data-linenos="125 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>rename_labels</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;rename_labels&#39;</span><span class=p>,</span> <span class=p>{})</span>
<span class=linenos data-linenos="126 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>rename_labels</span><span class=p>,</span> <span class=nb>dict</span><span class=p>):</span>
<span class=linenos data-linenos="127 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `rename_labels` must be a mapping&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="128 "></span>
<span class=linenos data-linenos="129 "></span>        <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>rename_labels</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
<span class=linenos data-linenos="130 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="131 "></span>                <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Value for label `</span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s1>` of setting `rename_labels` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="132 "></span>
<span class=linenos data-linenos="133 "></span>        <span class=n>exclude_metrics</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;exclude_metrics&#39;</span><span class=p>,</span> <span class=p>[])</span>
<span class=linenos data-linenos="134 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>exclude_metrics</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="135 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `exclude_metrics` must be an array&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="136 "></span>
<span class=linenos data-linenos="137 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
<span class=linenos data-linenos="138 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_pattern</span> <span class=o>=</span> <span class=kc>None</span>
<span class=linenos data-linenos="139 "></span>        <span class=n>exclude_metrics_patterns</span> <span class=o>=</span> <span class=p>[]</span>
<span class=linenos data-linenos="140 "></span>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>entry</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>exclude_metrics</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="141 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>entry</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="142 "></span>                <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Entry #</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1> of setting `exclude_metrics` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="143 "></span>
<span class=linenos data-linenos="144 "></span>            <span class=n>escaped_entry</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>escape</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
<span class=linenos data-linenos="145 "></span>            <span class=k>if</span> <span class=n>entry</span> <span class=o>==</span> <span class=n>escaped_entry</span><span class=p>:</span>
<span class=linenos data-linenos="146 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
<span class=linenos data-linenos="147 "></span>            <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="148 "></span>                <span class=n>exclude_metrics_patterns</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
<span class=linenos data-linenos="149 "></span>
<span class=linenos data-linenos="150 "></span>        <span class=k>if</span> <span class=n>exclude_metrics_patterns</span><span class=p>:</span>
<span class=linenos data-linenos="151 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_pattern</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>exclude_metrics_patterns</span><span class=p>))</span>
<span class=linenos data-linenos="152 "></span>
<span class=linenos data-linenos="153 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_by_labels</span> <span class=o>=</span> <span class=p>{}</span>
<span class=linenos data-linenos="154 "></span>        <span class=n>exclude_metrics_by_labels</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;exclude_metrics_by_labels&#39;</span><span class=p>,</span> <span class=p>{})</span>
<span class=linenos data-linenos="155 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>exclude_metrics_by_labels</span><span class=p>,</span> <span class=nb>dict</span><span class=p>):</span>
<span class=linenos data-linenos="156 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `exclude_metrics_by_labels` must be a mapping&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="157 "></span>        <span class=k>elif</span> <span class=n>exclude_metrics_by_labels</span><span class=p>:</span>
<span class=linenos data-linenos="158 "></span>            <span class=k>for</span> <span class=n>label</span><span class=p>,</span> <span class=n>values</span> <span class=ow>in</span> <span class=n>exclude_metrics_by_labels</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
<span class=linenos data-linenos="159 "></span>                <span class=k>if</span> <span class=n>values</span> <span class=ow>is</span> <span class=kc>True</span><span class=p>:</span>
<span class=linenos data-linenos="160 "></span>                    <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_by_labels</span><span class=p>[</span><span class=n>label</span><span class=p>]</span> <span class=o>=</span> <span class=n>return_true</span>
<span class=linenos data-linenos="161 "></span>                <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>values</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="162 "></span>                    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>values</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="163 "></span>                        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="164 "></span>                            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span>
<span class=linenos data-linenos="165 "></span>                                <span class=sa>f</span><span class=s1>&#39;Value #</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1> for label `</span><span class=si>{</span><span class=n>label</span><span class=si>}</span><span class=s1>` of setting `exclude_metrics_by_labels` &#39;</span>
<span class=linenos data-linenos="166 "></span>                                <span class=sa>f</span><span class=s1>&#39;must be a string&#39;</span>
<span class=linenos data-linenos="167 "></span>                            <span class=p>)</span>
<span class=linenos data-linenos="168 "></span>
<span class=linenos data-linenos="169 "></span>                    <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_by_labels</span><span class=p>[</span><span class=n>label</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
<span class=linenos data-linenos="170 "></span>                        <span class=k>lambda</span> <span class=n>label_value</span><span class=p>,</span> <span class=n>pattern</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>values</span><span class=p>)):</span> <span class=n>pattern</span><span class=o>.</span><span class=n>search</span><span class=p>(</span>  <span class=c1># noqa: B008</span>
<span class=linenos data-linenos="171 "></span>                            <span class=n>label_value</span>
<span class=linenos data-linenos="172 "></span>                        <span class=p>)</span>  <span class=c1># noqa: B008, E501</span>
<span class=linenos data-linenos="173 "></span>                        <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
<span class=linenos data-linenos="174 "></span>                    <span class=p>)</span>
<span class=linenos data-linenos="175 "></span>                <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="176 "></span>                    <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span>
<span class=linenos data-linenos="177 "></span>                        <span class=sa>f</span><span class=s1>&#39;Label `</span><span class=si>{</span><span class=n>label</span><span class=si>}</span><span class=s1>` of setting `exclude_metrics_by_labels` must be an array or set to `true`&#39;</span>
<span class=linenos data-linenos="178 "></span>                    <span class=p>)</span>
<span class=linenos data-linenos="179 "></span>
<span class=linenos data-linenos="180 "></span>        <span class=n>custom_tags</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;tags&#39;</span><span class=p>,</span> <span class=p>[])</span>  <span class=c1># type: List[str]</span>
<span class=linenos data-linenos="181 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>custom_tags</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="182 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `tags` must be an array&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="183 "></span>
<span class=linenos data-linenos="184 "></span>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>entry</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>custom_tags</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="185 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>entry</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="186 "></span>                <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Entry #</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1> of setting `tags` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="187 "></span>
<span class=linenos data-linenos="188 "></span>        <span class=c1># Some tags can be ignored to reduce the cardinality.</span>
<span class=linenos data-linenos="189 "></span>        <span class=c1># This can be useful for cost optimization in containerized environments</span>
<span class=linenos data-linenos="190 "></span>        <span class=c1># when the openmetrics check is configured to collect custom metrics.</span>
<span class=linenos data-linenos="191 "></span>        <span class=c1># Even when the Agent&#39;s Tagger is configured to add low-cardinality tags only,</span>
<span class=linenos data-linenos="192 "></span>        <span class=c1># some tags can still generate unwanted metric contexts (e.g pod annotations as tags).</span>
<span class=linenos data-linenos="193 "></span>        <span class=n>ignore_tags</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;ignore_tags&#39;</span><span class=p>,</span> <span class=p>[])</span>
<span class=linenos data-linenos="194 "></span>        <span class=k>if</span> <span class=n>ignore_tags</span><span class=p>:</span>
<span class=linenos data-linenos="195 "></span>            <span class=n>ignored_tags_re</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>ignore_tags</span><span class=p>)))</span>
<span class=linenos data-linenos="196 "></span>            <span class=n>custom_tags</span> <span class=o>=</span> <span class=p>[</span><span class=n>tag</span> <span class=k>for</span> <span class=n>tag</span> <span class=ow>in</span> <span class=n>custom_tags</span> <span class=k>if</span> <span class=ow>not</span> <span class=n>ignored_tags_re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>tag</span><span class=p>)]</span>
<span class=linenos data-linenos="197 "></span>
<span class=linenos data-linenos="198 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>static_tags</span> <span class=o>=</span> <span class=n>copy</span><span class=p>(</span><span class=n>custom_tags</span><span class=p>)</span>
<span class=linenos data-linenos="199 "></span>        <span class=k>if</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;tag_by_endpoint&#39;</span><span class=p>,</span> <span class=kc>True</span><span class=p>)):</span>
<span class=linenos data-linenos="200 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>static_tags</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;endpoint:</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>endpoint</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="201 "></span>
<span class=linenos data-linenos="202 "></span>        <span class=c1># These will be applied only to service checks</span>
<span class=linenos data-linenos="203 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>static_tags</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>static_tags</span><span class=p>)</span>
<span class=linenos data-linenos="204 "></span>        <span class=c1># These will be applied to everything except service checks</span>
<span class=linenos data-linenos="205 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>tags</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>static_tags</span>
<span class=linenos data-linenos="206 "></span>
<span class=linenos data-linenos="207 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>raw_line_filter</span> <span class=o>=</span> <span class=kc>None</span>
<span class=linenos data-linenos="208 "></span>        <span class=n>raw_line_filters</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;raw_line_filters&#39;</span><span class=p>,</span> <span class=p>[])</span>
<span class=linenos data-linenos="209 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>raw_line_filters</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="210 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `raw_line_filters` must be an array&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="211 "></span>        <span class=k>elif</span> <span class=n>raw_line_filters</span><span class=p>:</span>
<span class=linenos data-linenos="212 "></span>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>entry</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>raw_line_filters</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="213 "></span>                <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>entry</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="214 "></span>                    <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Entry #</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1> of setting `raw_line_filters` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="215 "></span>
<span class=linenos data-linenos="216 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>raw_line_filter</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>raw_line_filters</span><span class=p>))</span>
<span class=linenos data-linenos="217 "></span>
<span class=linenos data-linenos="218 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>http</span> <span class=o>=</span> <span class=n>RequestsWrapper</span><span class=p>(</span><span class=n>config</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>init_config</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>HTTP_CONFIG_REMAPPER</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>log</span><span class=p>)</span>
<span class=linenos data-linenos="219 "></span>
<span class=linenos data-linenos="220 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>_content_type</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
<span class=linenos data-linenos="221 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>_use_latest_spec</span> <span class=o>=</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;use_latest_spec&#39;</span><span class=p>,</span> <span class=kc>False</span><span class=p>))</span>
<span class=linenos data-linenos="222 "></span>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_use_latest_spec</span><span class=p>:</span>
<span class=linenos data-linenos="223 "></span>            <span class=n>accept_header</span> <span class=o>=</span> <span class=s1>&#39;application/openmetrics-text;version=1.0.0,application/openmetrics-text;version=0.0.1&#39;</span>
<span class=linenos data-linenos="224 "></span>        <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="225 "></span>            <span class=n>accept_header</span> <span class=o>=</span> <span class=s1>&#39;text/plain&#39;</span>
<span class=linenos data-linenos="226 "></span>
<span class=linenos data-linenos="227 "></span>        <span class=c1># Request the appropriate exposition format</span>
<span class=linenos data-linenos="228 "></span>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>http</span><span class=o>.</span><span class=n>options</span><span class=p>[</span><span class=s1>&#39;headers&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Accept&#39;</span><span class=p>)</span> <span class=o>==</span> <span class=s1>&#39;*/*&#39;</span><span class=p>:</span>
<span class=linenos data-linenos="229 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>http</span><span class=o>.</span><span class=n>options</span><span class=p>[</span><span class=s1>&#39;headers&#39;</span><span class=p>][</span><span class=s1>&#39;Accept&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>accept_header</span>
<span class=linenos data-linenos="230 "></span>
<span class=linenos data-linenos="231 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>use_process_start_time</span> <span class=o>=</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;use_process_start_time&#39;</span><span class=p>))</span>
<span class=linenos data-linenos="232 "></span>
<span class=linenos data-linenos="233 "></span>        <span class=c1># Used for monotonic counts</span>
<span class=linenos data-linenos="234 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>flush_first_value</span> <span class=o>=</span> <span class=kc>False</span>
<span class=linenos data-linenos="235 "></span>
<span class=linenos data-linenos="236 "></span>    <span class=k>def</span> <span class=nf>scrape</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=linenos data-linenos="237 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="238 "></span><span class=sd>        Execute a scrape, and for each metric collected, transform the metric.</span>
<span class=linenos data-linenos="239 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos="240 "></span>        <span class=n>runtime_data</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;flush_first_value&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>flush_first_value</span><span class=p>,</span> <span class=s1>&#39;static_tags&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>static_tags</span><span class=p>}</span>
<span class=linenos data-linenos="241 "></span>
<span class=linenos data-linenos="242 "></span>        <span class=c1># Determine which consume method to use based on target_info config</span>
<span class=linenos data-linenos="243 "></span>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>target_info</span><span class=p>:</span>
<span class=linenos data-linenos="244 "></span>            <span class=n>consume_method</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>consume_metrics_w_target_info</span>
<span class=linenos data-linenos="245 "></span>        <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="246 "></span>            <span class=n>consume_method</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>consume_metrics</span>
<span class=linenos data-linenos="247 "></span>
<span class=linenos data-linenos="248 "></span>        <span class=k>for</span> <span class=n>metric</span> <span class=ow>in</span> <span class=n>consume_method</span><span class=p>(</span><span class=n>runtime_data</span><span class=p>):</span>
<span class=linenos data-linenos="249 "></span>            <span class=n>transformer</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>metric_transformer</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>metric</span><span class=p>)</span>
<span class=linenos data-linenos="250 "></span>            <span class=k>if</span> <span class=n>transformer</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="251 "></span>                <span class=k>continue</span>
<span class=linenos data-linenos="252 "></span>
<span class=linenos data-linenos="253 "></span>            <span class=n>transformer</span><span class=p>(</span><span class=n>metric</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_sample_data</span><span class=p>(</span><span class=n>metric</span><span class=p>),</span> <span class=n>runtime_data</span><span class=p>)</span>
<span class=linenos data-linenos="254 "></span>
<span class=linenos data-linenos="255 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>flush_first_value</span> <span class=o>=</span> <span class=kc>True</span>
<span class=linenos data-linenos="256 "></span>
<span class=linenos data-linenos="257 "></span>    <span class=k>def</span> <span class=nf>consume_metrics</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>runtime_data</span><span class=p>):</span>
<span class=linenos data-linenos="258 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="259 "></span><span class=sd>        Yield the processed metrics and filter out excluded metrics, without checking for target_info metrics.</span>
<span class=linenos data-linenos="260 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos="261 "></span>
<span class=linenos data-linenos="262 "></span>        <span class=n>metric_parser</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>parse_metrics</span><span class=p>()</span>
<span class=linenos data-linenos="263 "></span>
<span class=linenos data-linenos="264 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>flush_first_value</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_process_start_time</span><span class=p>:</span>
<span class=linenos data-linenos="265 "></span>            <span class=n>metric_parser</span> <span class=o>=</span> <span class=n>first_scrape_handler</span><span class=p>(</span><span class=n>metric_parser</span><span class=p>,</span> <span class=n>runtime_data</span><span class=p>,</span> <span class=n>datadog_agent</span><span class=o>.</span><span class=n>get_process_start_time</span><span class=p>())</span>
<span class=linenos data-linenos="266 "></span>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>label_aggregator</span><span class=o>.</span><span class=n>configured</span><span class=p>:</span>
<span class=linenos data-linenos="267 "></span>            <span class=n>metric_parser</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>label_aggregator</span><span class=p>(</span><span class=n>metric_parser</span><span class=p>)</span>
<span class=linenos data-linenos="268 "></span>
<span class=linenos data-linenos="269 "></span>        <span class=k>for</span> <span class=n>metric</span> <span class=ow>in</span> <span class=n>metric_parser</span><span class=p>:</span>
<span class=linenos data-linenos="270 "></span>            <span class=c1># Skip excluded metrics</span>
<span class=linenos data-linenos="271 "></span>            <span class=k>if</span> <span class=n>metric</span><span class=o>.</span><span class=n>name</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics</span> <span class=ow>or</span> <span class=p>(</span>
<span class=linenos data-linenos="272 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_pattern</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_pattern</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>metric</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
<span class=linenos data-linenos="273 "></span>            <span class=p>):</span>
<span class=linenos data-linenos="274 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>submit_telemetry_number_of_ignored_metric_samples</span><span class=p>(</span><span class=n>metric</span><span class=p>)</span>
<span class=linenos data-linenos="275 "></span>                <span class=k>continue</span>
<span class=linenos data-linenos="276 "></span>
<span class=linenos data-linenos="277 "></span>            <span class=k>yield</span> <span class=n>metric</span>
<span class=linenos data-linenos="278 "></span>
<span class=linenos data-linenos="279 "></span>    <span class=k>def</span> <span class=nf>consume_metrics_w_target_info</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>runtime_data</span><span class=p>):</span>
<span class=linenos data-linenos="280 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="281 "></span><span class=sd>        Yield the processed metrics and filter out excluded metrics.</span>
<span class=linenos data-linenos="282 "></span><span class=sd>        Additionally, handle target_info metrics.</span>
<span class=linenos data-linenos="283 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos="284 "></span>
<span class=linenos data-linenos="285 "></span>        <span class=n>metric_parser</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>parse_metrics</span><span class=p>()</span>
<span class=linenos data-linenos="286 "></span>
<span class=linenos data-linenos="287 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>flush_first_value</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_process_start_time</span><span class=p>:</span>
<span class=linenos data-linenos="288 "></span>            <span class=n>metric_parser</span> <span class=o>=</span> <span class=n>first_scrape_handler</span><span class=p>(</span><span class=n>metric_parser</span><span class=p>,</span> <span class=n>runtime_data</span><span class=p>,</span> <span class=n>datadog_agent</span><span class=o>.</span><span class=n>get_process_start_time</span><span class=p>())</span>
<span class=linenos data-linenos="289 "></span>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>label_aggregator</span><span class=o>.</span><span class=n>configured</span><span class=p>:</span>
<span class=linenos data-linenos="290 "></span>            <span class=n>metric_parser</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>label_aggregator</span><span class=p>(</span><span class=n>metric_parser</span><span class=p>)</span>
<span class=linenos data-linenos="291 "></span>
<span class=linenos data-linenos="292 "></span>        <span class=k>for</span> <span class=n>metric</span> <span class=ow>in</span> <span class=n>metric_parser</span><span class=p>:</span>
<span class=linenos data-linenos="293 "></span>            <span class=c1># Skip excluded metrics</span>
<span class=linenos data-linenos="294 "></span>            <span class=k>if</span> <span class=n>metric</span><span class=o>.</span><span class=n>name</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics</span> <span class=ow>or</span> <span class=p>(</span>
<span class=linenos data-linenos="295 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_pattern</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_pattern</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>metric</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
<span class=linenos data-linenos="296 "></span>            <span class=p>):</span>
<span class=linenos data-linenos="297 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>submit_telemetry_number_of_ignored_metric_samples</span><span class=p>(</span><span class=n>metric</span><span class=p>)</span>
<span class=linenos data-linenos="298 "></span>                <span class=k>continue</span>
<span class=linenos data-linenos="299 "></span>
<span class=linenos data-linenos="300 "></span>            <span class=c1># Process target_info metrics</span>
<span class=linenos data-linenos="301 "></span>            <span class=k>if</span> <span class=n>metric</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s1>&#39;target_info&#39;</span><span class=p>:</span>
<span class=linenos data-linenos="302 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>label_aggregator</span><span class=o>.</span><span class=n>process_target_info</span><span class=p>(</span><span class=n>metric</span><span class=p>)</span>
<span class=linenos data-linenos="303 "></span>
<span class=linenos data-linenos="304 "></span>            <span class=k>yield</span> <span class=n>metric</span>
<span class=linenos data-linenos="305 "></span>
<span class=linenos data-linenos="306 "></span>    <span class=k>def</span> <span class=nf>parse_metrics</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=linenos data-linenos="307 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="308 "></span><span class=sd>        Get the line streamer and yield processed metrics.</span>
<span class=linenos data-linenos="309 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos="310 "></span>
<span class=linenos data-linenos="311 "></span>        <span class=n>line_streamer</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>stream_connection_lines</span><span class=p>()</span>
<span class=linenos data-linenos="312 "></span>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>raw_line_filter</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="313 "></span>            <span class=n>line_streamer</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>filter_connection_lines</span><span class=p>(</span><span class=n>line_streamer</span><span class=p>)</span>
<span class=linenos data-linenos="314 "></span>
<span class=linenos data-linenos="315 "></span>        <span class=c1># Since we determine `self.parse_metric_families` dynamically from the response and that&#39;s done as a</span>
<span class=linenos data-linenos="316 "></span>        <span class=c1># side effect inside the `line_streamer` generator, we need to consume the first line in order to</span>
<span class=linenos data-linenos="317 "></span>        <span class=c1># trigger that side effect.</span>
<span class=linenos data-linenos="318 "></span>        <span class=k>try</span><span class=p>:</span>
<span class=linenos data-linenos="319 "></span>            <span class=n>line_streamer</span> <span class=o>=</span> <span class=n>chain</span><span class=p>([</span><span class=nb>next</span><span class=p>(</span><span class=n>line_streamer</span><span class=p>)],</span> <span class=n>line_streamer</span><span class=p>)</span>
<span class=linenos data-linenos="320 "></span>        <span class=k>except</span> <span class=ne>StopIteration</span><span class=p>:</span>
<span class=linenos data-linenos="321 "></span>            <span class=c1># If line_streamer is an empty iterator, next(line_streamer) fails.</span>
<span class=linenos data-linenos="322 "></span>            <span class=k>return</span>
<span class=linenos data-linenos="323 "></span>
<span class=linenos data-linenos="324 "></span>        <span class=k>for</span> <span class=n>metric</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>parse_metric_families</span><span class=p>(</span><span class=n>line_streamer</span><span class=p>):</span>
<span class=linenos data-linenos="325 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>submit_telemetry_number_of_total_metric_samples</span><span class=p>(</span><span class=n>metric</span><span class=p>)</span>
<span class=linenos data-linenos="326 "></span>
<span class=linenos data-linenos="327 "></span>            <span class=c1># It is critical that the prefix is removed immediately so that</span>
<span class=linenos data-linenos="328 "></span>            <span class=c1># all other configuration may reference the trimmed metric name</span>
<span class=linenos data-linenos="329 "></span>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>raw_metric_prefix</span> <span class=ow>and</span> <span class=n>metric</span><span class=o>.</span><span class=n>name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>raw_metric_prefix</span><span class=p>):</span>
<span class=linenos data-linenos="330 "></span>                <span class=n>metric</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>metric</span><span class=o>.</span><span class=n>name</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>raw_metric_prefix</span><span class=p>)</span> <span class=p>:]</span>
<span class=linenos data-linenos="331 "></span>
<span class=linenos data-linenos="332 "></span>            <span class=k>yield</span> <span class=n>metric</span>
<span class=linenos data-linenos="333 "></span>
<span class=linenos data-linenos="334 "></span>    <span class=nd>@property</span>
<span class=linenos data-linenos="335 "></span>    <span class=k>def</span> <span class=nf>parse_metric_families</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=linenos data-linenos="336 "></span>        <span class=n>media_type</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_content_type</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;;&#39;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
<span class=linenos data-linenos="337 "></span>        <span class=c1># Setting `use_latest_spec` forces the use of the OpenMetrics format, otherwise</span>
<span class=linenos data-linenos="338 "></span>        <span class=c1># the format will be chosen based on the media type specified in the response&#39;s content-header.</span>
<span class=linenos data-linenos="339 "></span>        <span class=c1># The selection is based on what Prometheus does:</span>
<span class=linenos data-linenos="340 "></span>        <span class=c1># https://github.com/prometheus/prometheus/blob/v2.43.0/model/textparse/interface.go#L83-L90</span>
<span class=linenos data-linenos="341 "></span>        <span class=k>return</span> <span class=p>(</span>
<span class=linenos data-linenos="342 "></span>            <span class=n>parse_openmetrics</span>
<span class=linenos data-linenos="343 "></span>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_use_latest_spec</span> <span class=ow>or</span> <span class=n>media_type</span> <span class=o>==</span> <span class=s1>&#39;application/openmetrics-text&#39;</span>
<span class=linenos data-linenos="344 "></span>            <span class=k>else</span> <span class=n>parse_prometheus</span>
<span class=linenos data-linenos="345 "></span>        <span class=p>)</span>
<span class=linenos data-linenos="346 "></span>
<span class=linenos data-linenos="347 "></span>    <span class=k>def</span> <span class=nf>generate_sample_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>metric</span><span class=p>):</span>
<span class=linenos data-linenos="348 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="349 "></span><span class=sd>        Yield a sample of processed data.</span>
<span class=linenos data-linenos="350 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos="351 "></span>        <span class=n>label_normalizer</span> <span class=o>=</span> <span class=n>get_label_normalizer</span><span class=p>(</span><span class=n>metric</span><span class=o>.</span><span class=n>type</span><span class=p>)</span>
<span class=linenos data-linenos="352 "></span>
<span class=linenos data-linenos="353 "></span>        <span class=k>for</span> <span class=n>sample</span> <span class=ow>in</span> <span class=n>metric</span><span class=o>.</span><span class=n>samples</span><span class=p>:</span>
<span class=linenos data-linenos="354 "></span>            <span class=n>value</span> <span class=o>=</span> <span class=n>sample</span><span class=o>.</span><span class=n>value</span>
<span class=linenos data-linenos="355 "></span>            <span class=k>if</span> <span class=n>isnan</span><span class=p>(</span><span class=n>value</span><span class=p>)</span> <span class=ow>or</span> <span class=n>isinf</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
<span class=linenos data-linenos="356 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s1>&#39;Ignoring sample for metric `</span><span class=si>%s</span><span class=s1>` as it has an invalid value: </span><span class=si>%s</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>metric</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
<span class=linenos data-linenos="357 "></span>                <span class=k>continue</span>
<span class=linenos data-linenos="358 "></span>
<span class=linenos data-linenos="359 "></span>            <span class=n>tags</span> <span class=o>=</span> <span class=p>[]</span>
<span class=linenos data-linenos="360 "></span>            <span class=n>skip_sample</span> <span class=o>=</span> <span class=kc>False</span>
<span class=linenos data-linenos="361 "></span>            <span class=n>labels</span> <span class=o>=</span> <span class=n>sample</span><span class=o>.</span><span class=n>labels</span>
<span class=linenos data-linenos="362 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>label_aggregator</span><span class=o>.</span><span class=n>populate</span><span class=p>(</span><span class=n>labels</span><span class=p>)</span>
<span class=linenos data-linenos="363 "></span>            <span class=n>label_normalizer</span><span class=p>(</span><span class=n>labels</span><span class=p>)</span>
<span class=linenos data-linenos="364 "></span>
<span class=linenos data-linenos="365 "></span>            <span class=k>for</span> <span class=n>label_name</span><span class=p>,</span> <span class=n>label_value</span> <span class=ow>in</span> <span class=n>labels</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
<span class=linenos data-linenos="366 "></span>                <span class=n>sample_excluder</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_by_labels</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>label_name</span><span class=p>)</span>
<span class=linenos data-linenos="367 "></span>                <span class=k>if</span> <span class=n>sample_excluder</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>sample_excluder</span><span class=p>(</span><span class=n>label_value</span><span class=p>):</span>
<span class=linenos data-linenos="368 "></span>                    <span class=n>skip_sample</span> <span class=o>=</span> <span class=kc>True</span>
<span class=linenos data-linenos="369 "></span>                    <span class=k>break</span>
<span class=linenos data-linenos="370 "></span>                <span class=k>elif</span> <span class=n>label_name</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>exclude_labels</span><span class=p>:</span>
<span class=linenos data-linenos="371 "></span>                    <span class=k>continue</span>
<span class=linenos data-linenos="372 "></span>                <span class=k>elif</span> <span class=bp>self</span><span class=o>.</span><span class=n>include_labels</span> <span class=ow>and</span> <span class=n>label_name</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>include_labels</span><span class=p>:</span>
<span class=linenos data-linenos="373 "></span>                    <span class=k>continue</span>
<span class=linenos data-linenos="374 "></span>
<span class=linenos data-linenos="375 "></span>                <span class=n>label_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rename_labels</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>label_name</span><span class=p>,</span> <span class=n>label_name</span><span class=p>)</span>
<span class=linenos data-linenos="376 "></span>                <span class=n>tags</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>label_name</span><span class=si>}</span><span class=s1>:</span><span class=si>{</span><span class=n>label_value</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="377 "></span>
<span class=linenos data-linenos="378 "></span>            <span class=k>if</span> <span class=n>skip_sample</span><span class=p>:</span>
<span class=linenos data-linenos="379 "></span>                <span class=k>continue</span>
<span class=linenos data-linenos="380 "></span>
<span class=linenos data-linenos="381 "></span>            <span class=n>tags</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>tags</span><span class=p>)</span>
<span class=linenos data-linenos="382 "></span>
<span class=linenos data-linenos="383 "></span>            <span class=n>hostname</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span>
<span class=linenos data-linenos="384 "></span>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>hostname_label</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>hostname_label</span> <span class=ow>in</span> <span class=n>labels</span><span class=p>:</span>
<span class=linenos data-linenos="385 "></span>                <span class=n>hostname</span> <span class=o>=</span> <span class=n>labels</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>hostname_label</span><span class=p>]</span>
<span class=linenos data-linenos="386 "></span>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>hostname_formatter</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="387 "></span>                    <span class=n>hostname</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>hostname_formatter</span><span class=p>(</span><span class=n>hostname</span><span class=p>)</span>
<span class=linenos data-linenos="388 "></span>
<span class=linenos data-linenos="389 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>submit_telemetry_number_of_processed_metric_samples</span><span class=p>()</span>
<span class=linenos data-linenos="390 "></span>            <span class=k>yield</span> <span class=n>sample</span><span class=p>,</span> <span class=n>tags</span><span class=p>,</span> <span class=n>hostname</span>
<span class=linenos data-linenos="391 "></span>
<span class=linenos data-linenos="392 "></span>    <span class=k>def</span> <span class=nf>stream_connection_lines</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=linenos data-linenos="393 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="394 "></span><span class=sd>        Yield the connection line.</span>
<span class=linenos data-linenos="395 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos="396 "></span>
<span class=linenos data-linenos="397 "></span>        <span class=k>try</span><span class=p>:</span>
<span class=linenos data-linenos="398 "></span>            <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_connection</span><span class=p>()</span> <span class=k>as</span> <span class=n>connection</span><span class=p>:</span>
<span class=linenos data-linenos="399 "></span>                <span class=c1># Media type will be used to select parser dynamically</span>
<span class=linenos data-linenos="400 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>_content_type</span> <span class=o>=</span> <span class=n>connection</span><span class=o>.</span><span class=n>headers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Content-Type&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="401 "></span>                <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>connection</span><span class=o>.</span><span class=n>iter_lines</span><span class=p>(</span><span class=n>decode_unicode</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
<span class=linenos data-linenos="402 "></span>                    <span class=k>yield</span> <span class=n>line</span>
<span class=linenos data-linenos="403 "></span>        <span class=k>except</span> <span class=ne>ConnectionError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<span class=linenos data-linenos="404 "></span>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>ignore_connection_errors</span><span class=p>:</span>
<span class=linenos data-linenos="405 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&quot;OpenMetrics endpoint </span><span class=si>%s</span><span class=s2> is not accessible&quot;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>endpoint</span><span class=p>)</span>
<span class=linenos data-linenos="406 "></span>            <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="407 "></span>                <span class=k>raise</span> <span class=n>e</span>
<span class=linenos data-linenos="408 "></span>
<span class=linenos data-linenos="409 "></span>    <span class=k>def</span> <span class=nf>filter_connection_lines</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>line_streamer</span><span class=p>):</span>
<span class=linenos data-linenos="410 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="411 "></span><span class=sd>        Filter connection lines in the line streamer.</span>
<span class=linenos data-linenos="412 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos="413 "></span>
<span class=linenos data-linenos="414 "></span>        <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>line_streamer</span><span class=p>:</span>
<span class=linenos data-linenos="415 "></span>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>raw_line_filter</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>line</span><span class=p>):</span>
<span class=linenos data-linenos="416 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>submit_telemetry_number_of_ignored_lines</span><span class=p>()</span>
<span class=linenos data-linenos="417 "></span>            <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="418 "></span>                <span class=k>yield</span> <span class=n>line</span>
<span class=linenos data-linenos="419 "></span>
<span class=linenos data-linenos="420 "></span>    <span class=k>def</span> <span class=nf>get_connection</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=linenos data-linenos="421 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="422 "></span><span class=sd>        Send a request to scrape metrics. Return the response or throw an exception.</span>
<span class=linenos data-linenos="423 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos="424 "></span>
<span class=linenos data-linenos="425 "></span>        <span class=k>try</span><span class=p>:</span>
<span class=linenos data-linenos="426 "></span>            <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>send_request</span><span class=p>()</span>
<span class=linenos data-linenos="427 "></span>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<span class=linenos data-linenos="428 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>submit_health_check</span><span class=p>(</span><span class=n>ServiceCheck</span><span class=o>.</span><span class=n>CRITICAL</span><span class=p>,</span> <span class=n>message</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<span class=linenos data-linenos="429 "></span>            <span class=k>raise</span>
<span class=linenos data-linenos="430 "></span>        <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="431 "></span>            <span class=k>try</span><span class=p>:</span>
<span class=linenos data-linenos="432 "></span>                <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
<span class=linenos data-linenos="433 "></span>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<span class=linenos data-linenos="434 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>submit_health_check</span><span class=p>(</span><span class=n>ServiceCheck</span><span class=o>.</span><span class=n>CRITICAL</span><span class=p>,</span> <span class=n>message</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<span class=linenos data-linenos="435 "></span>                <span class=n>response</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<span class=linenos data-linenos="436 "></span>                <span class=k>raise</span>
<span class=linenos data-linenos="437 "></span>            <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="438 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>submit_health_check</span><span class=p>(</span><span class=n>ServiceCheck</span><span class=o>.</span><span class=n>OK</span><span class=p>)</span>
<span class=linenos data-linenos="439 "></span>
<span class=linenos data-linenos="440 "></span>                <span class=c1># Never derive the encoding from the locale</span>
<span class=linenos data-linenos="441 "></span>                <span class=k>if</span> <span class=n>response</span><span class=o>.</span><span class=n>encoding</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="442 "></span>                    <span class=n>response</span><span class=o>.</span><span class=n>encoding</span> <span class=o>=</span> <span class=s1>&#39;utf-8&#39;</span>
<span class=linenos data-linenos="443 "></span>
<span class=linenos data-linenos="444 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>submit_telemetry_endpoint_response_size</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
<span class=linenos data-linenos="445 "></span>
<span class=linenos data-linenos="446 "></span>                <span class=k>return</span> <span class=n>response</span>
<span class=linenos data-linenos="447 "></span>
<span class=linenos data-linenos="448 "></span>    <span class=k>def</span> <span class=nf>send_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=linenos data-linenos="449 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="450 "></span><span class=sd>        Send an HTTP GET request to the `openmetrics_endpoint` value.</span>
<span class=linenos data-linenos="451 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos="452 "></span>
<span class=linenos data-linenos="453 "></span>        <span class=n>kwargs</span><span class=p>[</span><span class=s1>&#39;stream&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
<span class=linenos data-linenos="454 "></span>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>http</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>endpoint</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<span class=linenos data-linenos="455 "></span>
<span class=linenos data-linenos="456 "></span>    <span class=k>def</span> <span class=nf>set_dynamic_tags</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>tags</span><span class=p>):</span>
<span class=linenos data-linenos="457 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="458 "></span><span class=sd>        Set dynamic tags.</span>
<span class=linenos data-linenos="459 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos="460 "></span>
<span class=linenos data-linenos="461 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>tags</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>chain</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>static_tags</span><span class=p>,</span> <span class=n>tags</span><span class=p>))</span>
<span class=linenos data-linenos="462 "></span>
<span class=linenos data-linenos="463 "></span>    <span class=k>def</span> <span class=nf>submit_health_check</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>status</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=linenos data-linenos="464 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="465 "></span><span class=sd>        If health service check is enabled, send an `openmetrics.health` service check.</span>
<span class=linenos data-linenos="466 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos="467 "></span>
<span class=linenos data-linenos="468 "></span>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>enable_health_service_check</span><span class=p>:</span>
<span class=linenos data-linenos="469 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>service_check</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>SERVICE_CHECK_HEALTH</span><span class=p>,</span> <span class=n>status</span><span class=p>,</span> <span class=n>tags</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>static_tags</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<span class=linenos data-linenos="470 "></span>
<span class=linenos data-linenos="471 "></span>    <span class=k>def</span> <span class=nf>submit_telemetry_number_of_total_metric_samples</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>metric</span><span class=p>):</span>
<span class=linenos data-linenos="472 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=s1>&#39;telemetry.metrics.input.count&#39;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>metric</span><span class=o>.</span><span class=n>samples</span><span class=p>),</span> <span class=n>tags</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>tags</span><span class=p>)</span>
<span class=linenos data-linenos="473 "></span>
<span class=linenos data-linenos="474 "></span>    <span class=k>def</span> <span class=nf>submit_telemetry_number_of_ignored_metric_samples</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>metric</span><span class=p>):</span>
<span class=linenos data-linenos="475 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=s1>&#39;telemetry.metrics.ignored.count&#39;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>metric</span><span class=o>.</span><span class=n>samples</span><span class=p>),</span> <span class=n>tags</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>tags</span><span class=p>)</span>
<span class=linenos data-linenos="476 "></span>
<span class=linenos data-linenos="477 "></span>    <span class=k>def</span> <span class=nf>submit_telemetry_number_of_processed_metric_samples</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=linenos data-linenos="478 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=s1>&#39;telemetry.metrics.processed.count&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>tags</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>tags</span><span class=p>)</span>
<span class=linenos data-linenos="479 "></span>
<span class=linenos data-linenos="480 "></span>    <span class=k>def</span> <span class=nf>submit_telemetry_number_of_ignored_lines</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=linenos data-linenos="481 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=s1>&#39;telemetry.metrics.blacklist.count&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>tags</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>tags</span><span class=p>)</span>
<span class=linenos data-linenos="482 "></span>
<span class=linenos data-linenos="483 "></span>    <span class=k>def</span> <span class=nf>submit_telemetry_endpoint_response_size</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>response</span><span class=p>):</span>
<span class=linenos data-linenos="484 "></span>        <span class=n>content_length</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>headers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Content-Length&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="485 "></span>        <span class=k>if</span> <span class=n>content_length</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="486 "></span>            <span class=n>content_length</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>content_length</span><span class=p>)</span>
<span class=linenos data-linenos="487 "></span>        <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="488 "></span>            <span class=n>content_length</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
<span class=linenos data-linenos="489 "></span>
<span class=linenos data-linenos="490 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>gauge</span><span class=p>(</span><span class=s1>&#39;telemetry.payload.size&#39;</span><span class=p>,</span> <span class=n>content_length</span><span class=p>,</span> <span class=n>tags</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>tags</span><span class=p>)</span>
<span class=linenos data-linenos="491 "></span>
<span class=linenos data-linenos="492 "></span>    <span class=k>def</span> <span class=fm>__getattr__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<span class=linenos data-linenos="493 "></span>        <span class=c1># Forward all unknown attribute lookups to the check instance for access to submission methods, hostname, etc.</span>
<span class=linenos data-linenos="494 "></span>        <span class=n>attribute</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=p>,</span> <span class=n>name</span><span class=p>)</span>
<span class=linenos data-linenos="495 "></span>        <span class=nb>setattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>attribute</span><span class=p>)</span>
<span class=linenos data-linenos="496 "></span>        <span class=k>return</span> <span class=n>attribute</span>
</code></pre></div> </details> <div class="doc doc-children"> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.__init__ class="doc doc-heading"> <code class="highlight language-python"><span class=fm>__init__</span><span class=p>(</span><span class=n>check</span><span class=p>,</span> <span class=n>config</span><span class=p>)</span></code> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.__init__ class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>The base class for any scraper overrides.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/scraper.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos=" 49 "></span><span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>check</span><span class=p>,</span> <span class=n>config</span><span class=p>):</span>
<span class=linenos data-linenos=" 50 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 51 "></span><span class=sd>    The base class for any scraper overrides.</span>
<span class=linenos data-linenos=" 52 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 53 "></span>
<span class=linenos data-linenos=" 54 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>config</span> <span class=o>=</span> <span class=n>config</span>
<span class=linenos data-linenos=" 55 "></span>
<span class=linenos data-linenos=" 56 "></span>    <span class=c1># Save a reference to the check instance</span>
<span class=linenos data-linenos=" 57 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>check</span> <span class=o>=</span> <span class=n>check</span>
<span class=linenos data-linenos=" 58 "></span>
<span class=linenos data-linenos=" 59 "></span>    <span class=c1># Parse the configuration</span>
<span class=linenos data-linenos=" 60 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>endpoint</span> <span class=o>=</span> <span class=n>config</span><span class=p>[</span><span class=s1>&#39;openmetrics_endpoint&#39;</span><span class=p>]</span>
<span class=linenos data-linenos=" 61 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>target_info</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;target_info&#39;</span><span class=p>,</span> <span class=kc>False</span><span class=p>)</span>
<span class=linenos data-linenos=" 62 "></span>
<span class=linenos data-linenos=" 63 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>metric_transformer</span> <span class=o>=</span> <span class=n>MetricTransformer</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=p>,</span> <span class=n>config</span><span class=p>)</span>
<span class=linenos data-linenos=" 64 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>label_aggregator</span> <span class=o>=</span> <span class=n>LabelAggregator</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=p>,</span> <span class=n>config</span><span class=p>)</span>
<span class=linenos data-linenos=" 65 "></span>
<span class=linenos data-linenos=" 66 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>enable_telemetry</span> <span class=o>=</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;telemetry&#39;</span><span class=p>,</span> <span class=kc>False</span><span class=p>))</span>
<span class=linenos data-linenos=" 67 "></span>    <span class=c1># Make every telemetry submission method a no-op to avoid many lookups of `self.enable_telemetry`</span>
<span class=linenos data-linenos=" 68 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>enable_telemetry</span><span class=p>:</span>
<span class=linenos data-linenos=" 69 "></span>        <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>_</span> <span class=ow>in</span> <span class=n>inspect</span><span class=o>.</span><span class=n>getmembers</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>predicate</span><span class=o>=</span><span class=n>inspect</span><span class=o>.</span><span class=n>ismethod</span><span class=p>):</span>
<span class=linenos data-linenos=" 70 "></span>            <span class=k>if</span> <span class=n>name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;submit_telemetry_&#39;</span><span class=p>):</span>
<span class=linenos data-linenos=" 71 "></span>                <span class=nb>setattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>no_op</span><span class=p>)</span>
<span class=linenos data-linenos=" 72 "></span>
<span class=linenos data-linenos=" 73 "></span>    <span class=c1># Prevent overriding an integration&#39;s defined namespace</span>
<span class=linenos data-linenos=" 74 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>namespace</span> <span class=o>=</span> <span class=n>check</span><span class=o>.</span><span class=n>__NAMESPACE__</span> <span class=ow>or</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;namespace&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 75 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>namespace</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos=" 76 "></span>        <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `namespace` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 77 "></span>
<span class=linenos data-linenos=" 78 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>raw_metric_prefix</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;raw_metric_prefix&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 79 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>raw_metric_prefix</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos=" 80 "></span>        <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `raw_metric_prefix` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 81 "></span>
<span class=linenos data-linenos=" 82 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>enable_health_service_check</span> <span class=o>=</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;enable_health_service_check&#39;</span><span class=p>,</span> <span class=kc>True</span><span class=p>))</span>
<span class=linenos data-linenos=" 83 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>ignore_connection_errors</span> <span class=o>=</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;ignore_connection_errors&#39;</span><span class=p>,</span> <span class=kc>False</span><span class=p>))</span>
<span class=linenos data-linenos=" 84 "></span>
<span class=linenos data-linenos=" 85 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>hostname_label</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;hostname_label&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 86 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>hostname_label</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos=" 87 "></span>        <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `hostname_label` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 88 "></span>
<span class=linenos data-linenos=" 89 "></span>    <span class=n>hostname_format</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;hostname_format&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 90 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>hostname_format</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos=" 91 "></span>        <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `hostname_format` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 92 "></span>
<span class=linenos data-linenos=" 93 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>hostname_formatter</span> <span class=o>=</span> <span class=kc>None</span>
<span class=linenos data-linenos=" 94 "></span>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>hostname_label</span> <span class=ow>and</span> <span class=n>hostname_format</span><span class=p>:</span>
<span class=linenos data-linenos=" 95 "></span>        <span class=n>placeholder</span> <span class=o>=</span> <span class=s1>&#39;&lt;HOSTNAME&gt;&#39;</span>
<span class=linenos data-linenos=" 96 "></span>        <span class=k>if</span> <span class=n>placeholder</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>hostname_format</span><span class=p>:</span>
<span class=linenos data-linenos=" 97 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Setting `hostname_format` does not contain the placeholder `</span><span class=si>{</span><span class=n>placeholder</span><span class=si>}</span><span class=s1>`&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 98 "></span>
<span class=linenos data-linenos=" 99 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>hostname_formatter</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>hostname</span><span class=p>:</span> <span class=n>hostname_format</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;&lt;HOSTNAME&gt;&#39;</span><span class=p>,</span> <span class=n>hostname</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
<span class=linenos data-linenos="100 "></span>
<span class=linenos data-linenos="101 "></span>    <span class=n>exclude_labels</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;exclude_labels&#39;</span><span class=p>,</span> <span class=p>[])</span>
<span class=linenos data-linenos="102 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>exclude_labels</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="103 "></span>        <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `exclude_labels` must be an array&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="104 "></span>
<span class=linenos data-linenos="105 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>exclude_labels</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
<span class=linenos data-linenos="106 "></span>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>entry</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>exclude_labels</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="107 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>entry</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="108 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Entry #</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1> of setting `exclude_labels` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="109 "></span>
<span class=linenos data-linenos="110 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>exclude_labels</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
<span class=linenos data-linenos="111 "></span>
<span class=linenos data-linenos="112 "></span>    <span class=n>include_labels</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;include_labels&#39;</span><span class=p>,</span> <span class=p>[])</span>
<span class=linenos data-linenos="113 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>include_labels</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="114 "></span>        <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `include_labels` must be an array&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="115 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>include_labels</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
<span class=linenos data-linenos="116 "></span>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>entry</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>include_labels</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="117 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>entry</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="118 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Entry #</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1> of setting `include_labels` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="119 "></span>        <span class=k>if</span> <span class=n>entry</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>exclude_labels</span><span class=p>:</span>
<span class=linenos data-linenos="120 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
<span class=linenos data-linenos="121 "></span>                <span class=s1>&#39;Label `</span><span class=si>%s</span><span class=s1>` is set in both `exclude_labels` and `include_labels`. Excluding label.&#39;</span><span class=p>,</span> <span class=n>entry</span>
<span class=linenos data-linenos="122 "></span>            <span class=p>)</span>
<span class=linenos data-linenos="123 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>include_labels</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
<span class=linenos data-linenos="124 "></span>
<span class=linenos data-linenos="125 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>rename_labels</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;rename_labels&#39;</span><span class=p>,</span> <span class=p>{})</span>
<span class=linenos data-linenos="126 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>rename_labels</span><span class=p>,</span> <span class=nb>dict</span><span class=p>):</span>
<span class=linenos data-linenos="127 "></span>        <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `rename_labels` must be a mapping&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="128 "></span>
<span class=linenos data-linenos="129 "></span>    <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>rename_labels</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
<span class=linenos data-linenos="130 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="131 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Value for label `</span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s1>` of setting `rename_labels` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="132 "></span>
<span class=linenos data-linenos="133 "></span>    <span class=n>exclude_metrics</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;exclude_metrics&#39;</span><span class=p>,</span> <span class=p>[])</span>
<span class=linenos data-linenos="134 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>exclude_metrics</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="135 "></span>        <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `exclude_metrics` must be an array&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="136 "></span>
<span class=linenos data-linenos="137 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
<span class=linenos data-linenos="138 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_pattern</span> <span class=o>=</span> <span class=kc>None</span>
<span class=linenos data-linenos="139 "></span>    <span class=n>exclude_metrics_patterns</span> <span class=o>=</span> <span class=p>[]</span>
<span class=linenos data-linenos="140 "></span>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>entry</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>exclude_metrics</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="141 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>entry</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="142 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Entry #</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1> of setting `exclude_metrics` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="143 "></span>
<span class=linenos data-linenos="144 "></span>        <span class=n>escaped_entry</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>escape</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
<span class=linenos data-linenos="145 "></span>        <span class=k>if</span> <span class=n>entry</span> <span class=o>==</span> <span class=n>escaped_entry</span><span class=p>:</span>
<span class=linenos data-linenos="146 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
<span class=linenos data-linenos="147 "></span>        <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="148 "></span>            <span class=n>exclude_metrics_patterns</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
<span class=linenos data-linenos="149 "></span>
<span class=linenos data-linenos="150 "></span>    <span class=k>if</span> <span class=n>exclude_metrics_patterns</span><span class=p>:</span>
<span class=linenos data-linenos="151 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_pattern</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>exclude_metrics_patterns</span><span class=p>))</span>
<span class=linenos data-linenos="152 "></span>
<span class=linenos data-linenos="153 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_by_labels</span> <span class=o>=</span> <span class=p>{}</span>
<span class=linenos data-linenos="154 "></span>    <span class=n>exclude_metrics_by_labels</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;exclude_metrics_by_labels&#39;</span><span class=p>,</span> <span class=p>{})</span>
<span class=linenos data-linenos="155 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>exclude_metrics_by_labels</span><span class=p>,</span> <span class=nb>dict</span><span class=p>):</span>
<span class=linenos data-linenos="156 "></span>        <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `exclude_metrics_by_labels` must be a mapping&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="157 "></span>    <span class=k>elif</span> <span class=n>exclude_metrics_by_labels</span><span class=p>:</span>
<span class=linenos data-linenos="158 "></span>        <span class=k>for</span> <span class=n>label</span><span class=p>,</span> <span class=n>values</span> <span class=ow>in</span> <span class=n>exclude_metrics_by_labels</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
<span class=linenos data-linenos="159 "></span>            <span class=k>if</span> <span class=n>values</span> <span class=ow>is</span> <span class=kc>True</span><span class=p>:</span>
<span class=linenos data-linenos="160 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_by_labels</span><span class=p>[</span><span class=n>label</span><span class=p>]</span> <span class=o>=</span> <span class=n>return_true</span>
<span class=linenos data-linenos="161 "></span>            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>values</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="162 "></span>                <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>values</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="163 "></span>                    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="164 "></span>                        <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span>
<span class=linenos data-linenos="165 "></span>                            <span class=sa>f</span><span class=s1>&#39;Value #</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1> for label `</span><span class=si>{</span><span class=n>label</span><span class=si>}</span><span class=s1>` of setting `exclude_metrics_by_labels` &#39;</span>
<span class=linenos data-linenos="166 "></span>                            <span class=sa>f</span><span class=s1>&#39;must be a string&#39;</span>
<span class=linenos data-linenos="167 "></span>                        <span class=p>)</span>
<span class=linenos data-linenos="168 "></span>
<span class=linenos data-linenos="169 "></span>                <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_by_labels</span><span class=p>[</span><span class=n>label</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
<span class=linenos data-linenos="170 "></span>                    <span class=k>lambda</span> <span class=n>label_value</span><span class=p>,</span> <span class=n>pattern</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>values</span><span class=p>)):</span> <span class=n>pattern</span><span class=o>.</span><span class=n>search</span><span class=p>(</span>  <span class=c1># noqa: B008</span>
<span class=linenos data-linenos="171 "></span>                        <span class=n>label_value</span>
<span class=linenos data-linenos="172 "></span>                    <span class=p>)</span>  <span class=c1># noqa: B008, E501</span>
<span class=linenos data-linenos="173 "></span>                    <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
<span class=linenos data-linenos="174 "></span>                <span class=p>)</span>
<span class=linenos data-linenos="175 "></span>            <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="176 "></span>                <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span>
<span class=linenos data-linenos="177 "></span>                    <span class=sa>f</span><span class=s1>&#39;Label `</span><span class=si>{</span><span class=n>label</span><span class=si>}</span><span class=s1>` of setting `exclude_metrics_by_labels` must be an array or set to `true`&#39;</span>
<span class=linenos data-linenos="178 "></span>                <span class=p>)</span>
<span class=linenos data-linenos="179 "></span>
<span class=linenos data-linenos="180 "></span>    <span class=n>custom_tags</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;tags&#39;</span><span class=p>,</span> <span class=p>[])</span>  <span class=c1># type: List[str]</span>
<span class=linenos data-linenos="181 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>custom_tags</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="182 "></span>        <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `tags` must be an array&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="183 "></span>
<span class=linenos data-linenos="184 "></span>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>entry</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>custom_tags</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="185 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>entry</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="186 "></span>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Entry #</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1> of setting `tags` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="187 "></span>
<span class=linenos data-linenos="188 "></span>    <span class=c1># Some tags can be ignored to reduce the cardinality.</span>
<span class=linenos data-linenos="189 "></span>    <span class=c1># This can be useful for cost optimization in containerized environments</span>
<span class=linenos data-linenos="190 "></span>    <span class=c1># when the openmetrics check is configured to collect custom metrics.</span>
<span class=linenos data-linenos="191 "></span>    <span class=c1># Even when the Agent&#39;s Tagger is configured to add low-cardinality tags only,</span>
<span class=linenos data-linenos="192 "></span>    <span class=c1># some tags can still generate unwanted metric contexts (e.g pod annotations as tags).</span>
<span class=linenos data-linenos="193 "></span>    <span class=n>ignore_tags</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;ignore_tags&#39;</span><span class=p>,</span> <span class=p>[])</span>
<span class=linenos data-linenos="194 "></span>    <span class=k>if</span> <span class=n>ignore_tags</span><span class=p>:</span>
<span class=linenos data-linenos="195 "></span>        <span class=n>ignored_tags_re</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>ignore_tags</span><span class=p>)))</span>
<span class=linenos data-linenos="196 "></span>        <span class=n>custom_tags</span> <span class=o>=</span> <span class=p>[</span><span class=n>tag</span> <span class=k>for</span> <span class=n>tag</span> <span class=ow>in</span> <span class=n>custom_tags</span> <span class=k>if</span> <span class=ow>not</span> <span class=n>ignored_tags_re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>tag</span><span class=p>)]</span>
<span class=linenos data-linenos="197 "></span>
<span class=linenos data-linenos="198 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>static_tags</span> <span class=o>=</span> <span class=n>copy</span><span class=p>(</span><span class=n>custom_tags</span><span class=p>)</span>
<span class=linenos data-linenos="199 "></span>    <span class=k>if</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;tag_by_endpoint&#39;</span><span class=p>,</span> <span class=kc>True</span><span class=p>)):</span>
<span class=linenos data-linenos="200 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>static_tags</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;endpoint:</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>endpoint</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="201 "></span>
<span class=linenos data-linenos="202 "></span>    <span class=c1># These will be applied only to service checks</span>
<span class=linenos data-linenos="203 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>static_tags</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>static_tags</span><span class=p>)</span>
<span class=linenos data-linenos="204 "></span>    <span class=c1># These will be applied to everything except service checks</span>
<span class=linenos data-linenos="205 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>tags</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>static_tags</span>
<span class=linenos data-linenos="206 "></span>
<span class=linenos data-linenos="207 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>raw_line_filter</span> <span class=o>=</span> <span class=kc>None</span>
<span class=linenos data-linenos="208 "></span>    <span class=n>raw_line_filters</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;raw_line_filters&#39;</span><span class=p>,</span> <span class=p>[])</span>
<span class=linenos data-linenos="209 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>raw_line_filters</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="210 "></span>        <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s1>&#39;Setting `raw_line_filters` must be an array&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="211 "></span>    <span class=k>elif</span> <span class=n>raw_line_filters</span><span class=p>:</span>
<span class=linenos data-linenos="212 "></span>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>entry</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>raw_line_filters</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="213 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>entry</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="214 "></span>                <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Entry #</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1> of setting `raw_line_filters` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="215 "></span>
<span class=linenos data-linenos="216 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>raw_line_filter</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>raw_line_filters</span><span class=p>))</span>
<span class=linenos data-linenos="217 "></span>
<span class=linenos data-linenos="218 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>http</span> <span class=o>=</span> <span class=n>RequestsWrapper</span><span class=p>(</span><span class=n>config</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>init_config</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>HTTP_CONFIG_REMAPPER</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>log</span><span class=p>)</span>
<span class=linenos data-linenos="219 "></span>
<span class=linenos data-linenos="220 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>_content_type</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
<span class=linenos data-linenos="221 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>_use_latest_spec</span> <span class=o>=</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;use_latest_spec&#39;</span><span class=p>,</span> <span class=kc>False</span><span class=p>))</span>
<span class=linenos data-linenos="222 "></span>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_use_latest_spec</span><span class=p>:</span>
<span class=linenos data-linenos="223 "></span>        <span class=n>accept_header</span> <span class=o>=</span> <span class=s1>&#39;application/openmetrics-text;version=1.0.0,application/openmetrics-text;version=0.0.1&#39;</span>
<span class=linenos data-linenos="224 "></span>    <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="225 "></span>        <span class=n>accept_header</span> <span class=o>=</span> <span class=s1>&#39;text/plain&#39;</span>
<span class=linenos data-linenos="226 "></span>
<span class=linenos data-linenos="227 "></span>    <span class=c1># Request the appropriate exposition format</span>
<span class=linenos data-linenos="228 "></span>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>http</span><span class=o>.</span><span class=n>options</span><span class=p>[</span><span class=s1>&#39;headers&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Accept&#39;</span><span class=p>)</span> <span class=o>==</span> <span class=s1>&#39;*/*&#39;</span><span class=p>:</span>
<span class=linenos data-linenos="229 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>http</span><span class=o>.</span><span class=n>options</span><span class=p>[</span><span class=s1>&#39;headers&#39;</span><span class=p>][</span><span class=s1>&#39;Accept&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>accept_header</span>
<span class=linenos data-linenos="230 "></span>
<span class=linenos data-linenos="231 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>use_process_start_time</span> <span class=o>=</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;use_process_start_time&#39;</span><span class=p>))</span>
<span class=linenos data-linenos="232 "></span>
<span class=linenos data-linenos="233 "></span>    <span class=c1># Used for monotonic counts</span>
<span class=linenos data-linenos="234 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>flush_first_value</span> <span class=o>=</span> <span class=kc>False</span>
</code></pre></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.scrape class="doc doc-heading"> <code class="highlight language-python"><span class=n>scrape</span><span class=p>()</span></code> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.scrape class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Execute a scrape, and for each metric collected, transform the metric.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/scraper.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="236 "></span><span class=k>def</span> <span class=nf>scrape</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=linenos data-linenos="237 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="238 "></span><span class=sd>    Execute a scrape, and for each metric collected, transform the metric.</span>
<span class=linenos data-linenos="239 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="240 "></span>    <span class=n>runtime_data</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;flush_first_value&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>flush_first_value</span><span class=p>,</span> <span class=s1>&#39;static_tags&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>static_tags</span><span class=p>}</span>
<span class=linenos data-linenos="241 "></span>
<span class=linenos data-linenos="242 "></span>    <span class=c1># Determine which consume method to use based on target_info config</span>
<span class=linenos data-linenos="243 "></span>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>target_info</span><span class=p>:</span>
<span class=linenos data-linenos="244 "></span>        <span class=n>consume_method</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>consume_metrics_w_target_info</span>
<span class=linenos data-linenos="245 "></span>    <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="246 "></span>        <span class=n>consume_method</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>consume_metrics</span>
<span class=linenos data-linenos="247 "></span>
<span class=linenos data-linenos="248 "></span>    <span class=k>for</span> <span class=n>metric</span> <span class=ow>in</span> <span class=n>consume_method</span><span class=p>(</span><span class=n>runtime_data</span><span class=p>):</span>
<span class=linenos data-linenos="249 "></span>        <span class=n>transformer</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>metric_transformer</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>metric</span><span class=p>)</span>
<span class=linenos data-linenos="250 "></span>        <span class=k>if</span> <span class=n>transformer</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="251 "></span>            <span class=k>continue</span>
<span class=linenos data-linenos="252 "></span>
<span class=linenos data-linenos="253 "></span>        <span class=n>transformer</span><span class=p>(</span><span class=n>metric</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_sample_data</span><span class=p>(</span><span class=n>metric</span><span class=p>),</span> <span class=n>runtime_data</span><span class=p>)</span>
<span class=linenos data-linenos="254 "></span>
<span class=linenos data-linenos="255 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>flush_first_value</span> <span class=o>=</span> <span class=kc>True</span>
</code></pre></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.consume_metrics class="doc doc-heading"> <code class="highlight language-python"><span class=n>consume_metrics</span><span class=p>(</span><span class=n>runtime_data</span><span class=p>)</span></code> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.consume_metrics class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Yield the processed metrics and filter out excluded metrics, without checking for target_info metrics.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/scraper.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="257 "></span><span class=k>def</span> <span class=nf>consume_metrics</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>runtime_data</span><span class=p>):</span>
<span class=linenos data-linenos="258 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="259 "></span><span class=sd>    Yield the processed metrics and filter out excluded metrics, without checking for target_info metrics.</span>
<span class=linenos data-linenos="260 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="261 "></span>
<span class=linenos data-linenos="262 "></span>    <span class=n>metric_parser</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>parse_metrics</span><span class=p>()</span>
<span class=linenos data-linenos="263 "></span>
<span class=linenos data-linenos="264 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>flush_first_value</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_process_start_time</span><span class=p>:</span>
<span class=linenos data-linenos="265 "></span>        <span class=n>metric_parser</span> <span class=o>=</span> <span class=n>first_scrape_handler</span><span class=p>(</span><span class=n>metric_parser</span><span class=p>,</span> <span class=n>runtime_data</span><span class=p>,</span> <span class=n>datadog_agent</span><span class=o>.</span><span class=n>get_process_start_time</span><span class=p>())</span>
<span class=linenos data-linenos="266 "></span>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>label_aggregator</span><span class=o>.</span><span class=n>configured</span><span class=p>:</span>
<span class=linenos data-linenos="267 "></span>        <span class=n>metric_parser</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>label_aggregator</span><span class=p>(</span><span class=n>metric_parser</span><span class=p>)</span>
<span class=linenos data-linenos="268 "></span>
<span class=linenos data-linenos="269 "></span>    <span class=k>for</span> <span class=n>metric</span> <span class=ow>in</span> <span class=n>metric_parser</span><span class=p>:</span>
<span class=linenos data-linenos="270 "></span>        <span class=c1># Skip excluded metrics</span>
<span class=linenos data-linenos="271 "></span>        <span class=k>if</span> <span class=n>metric</span><span class=o>.</span><span class=n>name</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics</span> <span class=ow>or</span> <span class=p>(</span>
<span class=linenos data-linenos="272 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_pattern</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_pattern</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>metric</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
<span class=linenos data-linenos="273 "></span>        <span class=p>):</span>
<span class=linenos data-linenos="274 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>submit_telemetry_number_of_ignored_metric_samples</span><span class=p>(</span><span class=n>metric</span><span class=p>)</span>
<span class=linenos data-linenos="275 "></span>            <span class=k>continue</span>
<span class=linenos data-linenos="276 "></span>
<span class=linenos data-linenos="277 "></span>        <span class=k>yield</span> <span class=n>metric</span>
</code></pre></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.parse_metrics class="doc doc-heading"> <code class="highlight language-python"><span class=n>parse_metrics</span><span class=p>()</span></code> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.parse_metrics class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Get the line streamer and yield processed metrics.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/scraper.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="306 "></span><span class=k>def</span> <span class=nf>parse_metrics</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=linenos data-linenos="307 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="308 "></span><span class=sd>    Get the line streamer and yield processed metrics.</span>
<span class=linenos data-linenos="309 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="310 "></span>
<span class=linenos data-linenos="311 "></span>    <span class=n>line_streamer</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>stream_connection_lines</span><span class=p>()</span>
<span class=linenos data-linenos="312 "></span>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>raw_line_filter</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="313 "></span>        <span class=n>line_streamer</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>filter_connection_lines</span><span class=p>(</span><span class=n>line_streamer</span><span class=p>)</span>
<span class=linenos data-linenos="314 "></span>
<span class=linenos data-linenos="315 "></span>    <span class=c1># Since we determine `self.parse_metric_families` dynamically from the response and that&#39;s done as a</span>
<span class=linenos data-linenos="316 "></span>    <span class=c1># side effect inside the `line_streamer` generator, we need to consume the first line in order to</span>
<span class=linenos data-linenos="317 "></span>    <span class=c1># trigger that side effect.</span>
<span class=linenos data-linenos="318 "></span>    <span class=k>try</span><span class=p>:</span>
<span class=linenos data-linenos="319 "></span>        <span class=n>line_streamer</span> <span class=o>=</span> <span class=n>chain</span><span class=p>([</span><span class=nb>next</span><span class=p>(</span><span class=n>line_streamer</span><span class=p>)],</span> <span class=n>line_streamer</span><span class=p>)</span>
<span class=linenos data-linenos="320 "></span>    <span class=k>except</span> <span class=ne>StopIteration</span><span class=p>:</span>
<span class=linenos data-linenos="321 "></span>        <span class=c1># If line_streamer is an empty iterator, next(line_streamer) fails.</span>
<span class=linenos data-linenos="322 "></span>        <span class=k>return</span>
<span class=linenos data-linenos="323 "></span>
<span class=linenos data-linenos="324 "></span>    <span class=k>for</span> <span class=n>metric</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>parse_metric_families</span><span class=p>(</span><span class=n>line_streamer</span><span class=p>):</span>
<span class=linenos data-linenos="325 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>submit_telemetry_number_of_total_metric_samples</span><span class=p>(</span><span class=n>metric</span><span class=p>)</span>
<span class=linenos data-linenos="326 "></span>
<span class=linenos data-linenos="327 "></span>        <span class=c1># It is critical that the prefix is removed immediately so that</span>
<span class=linenos data-linenos="328 "></span>        <span class=c1># all other configuration may reference the trimmed metric name</span>
<span class=linenos data-linenos="329 "></span>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>raw_metric_prefix</span> <span class=ow>and</span> <span class=n>metric</span><span class=o>.</span><span class=n>name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>raw_metric_prefix</span><span class=p>):</span>
<span class=linenos data-linenos="330 "></span>            <span class=n>metric</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>metric</span><span class=o>.</span><span class=n>name</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>raw_metric_prefix</span><span class=p>)</span> <span class=p>:]</span>
<span class=linenos data-linenos="331 "></span>
<span class=linenos data-linenos="332 "></span>        <span class=k>yield</span> <span class=n>metric</span>
</code></pre></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.generate_sample_data class="doc doc-heading"> <code class="highlight language-python"><span class=n>generate_sample_data</span><span class=p>(</span><span class=n>metric</span><span class=p>)</span></code> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.generate_sample_data class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Yield a sample of processed data.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/scraper.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="347 "></span><span class=k>def</span> <span class=nf>generate_sample_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>metric</span><span class=p>):</span>
<span class=linenos data-linenos="348 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="349 "></span><span class=sd>    Yield a sample of processed data.</span>
<span class=linenos data-linenos="350 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="351 "></span>    <span class=n>label_normalizer</span> <span class=o>=</span> <span class=n>get_label_normalizer</span><span class=p>(</span><span class=n>metric</span><span class=o>.</span><span class=n>type</span><span class=p>)</span>
<span class=linenos data-linenos="352 "></span>
<span class=linenos data-linenos="353 "></span>    <span class=k>for</span> <span class=n>sample</span> <span class=ow>in</span> <span class=n>metric</span><span class=o>.</span><span class=n>samples</span><span class=p>:</span>
<span class=linenos data-linenos="354 "></span>        <span class=n>value</span> <span class=o>=</span> <span class=n>sample</span><span class=o>.</span><span class=n>value</span>
<span class=linenos data-linenos="355 "></span>        <span class=k>if</span> <span class=n>isnan</span><span class=p>(</span><span class=n>value</span><span class=p>)</span> <span class=ow>or</span> <span class=n>isinf</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
<span class=linenos data-linenos="356 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s1>&#39;Ignoring sample for metric `</span><span class=si>%s</span><span class=s1>` as it has an invalid value: </span><span class=si>%s</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>metric</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
<span class=linenos data-linenos="357 "></span>            <span class=k>continue</span>
<span class=linenos data-linenos="358 "></span>
<span class=linenos data-linenos="359 "></span>        <span class=n>tags</span> <span class=o>=</span> <span class=p>[]</span>
<span class=linenos data-linenos="360 "></span>        <span class=n>skip_sample</span> <span class=o>=</span> <span class=kc>False</span>
<span class=linenos data-linenos="361 "></span>        <span class=n>labels</span> <span class=o>=</span> <span class=n>sample</span><span class=o>.</span><span class=n>labels</span>
<span class=linenos data-linenos="362 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>label_aggregator</span><span class=o>.</span><span class=n>populate</span><span class=p>(</span><span class=n>labels</span><span class=p>)</span>
<span class=linenos data-linenos="363 "></span>        <span class=n>label_normalizer</span><span class=p>(</span><span class=n>labels</span><span class=p>)</span>
<span class=linenos data-linenos="364 "></span>
<span class=linenos data-linenos="365 "></span>        <span class=k>for</span> <span class=n>label_name</span><span class=p>,</span> <span class=n>label_value</span> <span class=ow>in</span> <span class=n>labels</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
<span class=linenos data-linenos="366 "></span>            <span class=n>sample_excluder</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>exclude_metrics_by_labels</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>label_name</span><span class=p>)</span>
<span class=linenos data-linenos="367 "></span>            <span class=k>if</span> <span class=n>sample_excluder</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>sample_excluder</span><span class=p>(</span><span class=n>label_value</span><span class=p>):</span>
<span class=linenos data-linenos="368 "></span>                <span class=n>skip_sample</span> <span class=o>=</span> <span class=kc>True</span>
<span class=linenos data-linenos="369 "></span>                <span class=k>break</span>
<span class=linenos data-linenos="370 "></span>            <span class=k>elif</span> <span class=n>label_name</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>exclude_labels</span><span class=p>:</span>
<span class=linenos data-linenos="371 "></span>                <span class=k>continue</span>
<span class=linenos data-linenos="372 "></span>            <span class=k>elif</span> <span class=bp>self</span><span class=o>.</span><span class=n>include_labels</span> <span class=ow>and</span> <span class=n>label_name</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>include_labels</span><span class=p>:</span>
<span class=linenos data-linenos="373 "></span>                <span class=k>continue</span>
<span class=linenos data-linenos="374 "></span>
<span class=linenos data-linenos="375 "></span>            <span class=n>label_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rename_labels</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>label_name</span><span class=p>,</span> <span class=n>label_name</span><span class=p>)</span>
<span class=linenos data-linenos="376 "></span>            <span class=n>tags</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>label_name</span><span class=si>}</span><span class=s1>:</span><span class=si>{</span><span class=n>label_value</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="377 "></span>
<span class=linenos data-linenos="378 "></span>        <span class=k>if</span> <span class=n>skip_sample</span><span class=p>:</span>
<span class=linenos data-linenos="379 "></span>            <span class=k>continue</span>
<span class=linenos data-linenos="380 "></span>
<span class=linenos data-linenos="381 "></span>        <span class=n>tags</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>tags</span><span class=p>)</span>
<span class=linenos data-linenos="382 "></span>
<span class=linenos data-linenos="383 "></span>        <span class=n>hostname</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span>
<span class=linenos data-linenos="384 "></span>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>hostname_label</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>hostname_label</span> <span class=ow>in</span> <span class=n>labels</span><span class=p>:</span>
<span class=linenos data-linenos="385 "></span>            <span class=n>hostname</span> <span class=o>=</span> <span class=n>labels</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>hostname_label</span><span class=p>]</span>
<span class=linenos data-linenos="386 "></span>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>hostname_formatter</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="387 "></span>                <span class=n>hostname</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>hostname_formatter</span><span class=p>(</span><span class=n>hostname</span><span class=p>)</span>
<span class=linenos data-linenos="388 "></span>
<span class=linenos data-linenos="389 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>submit_telemetry_number_of_processed_metric_samples</span><span class=p>()</span>
<span class=linenos data-linenos="390 "></span>        <span class=k>yield</span> <span class=n>sample</span><span class=p>,</span> <span class=n>tags</span><span class=p>,</span> <span class=n>hostname</span>
</code></pre></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.stream_connection_lines class="doc doc-heading"> <code class="highlight language-python"><span class=n>stream_connection_lines</span><span class=p>()</span></code> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.stream_connection_lines class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Yield the connection line.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/scraper.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="392 "></span><span class=k>def</span> <span class=nf>stream_connection_lines</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=linenos data-linenos="393 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="394 "></span><span class=sd>    Yield the connection line.</span>
<span class=linenos data-linenos="395 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="396 "></span>
<span class=linenos data-linenos="397 "></span>    <span class=k>try</span><span class=p>:</span>
<span class=linenos data-linenos="398 "></span>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_connection</span><span class=p>()</span> <span class=k>as</span> <span class=n>connection</span><span class=p>:</span>
<span class=linenos data-linenos="399 "></span>            <span class=c1># Media type will be used to select parser dynamically</span>
<span class=linenos data-linenos="400 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>_content_type</span> <span class=o>=</span> <span class=n>connection</span><span class=o>.</span><span class=n>headers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Content-Type&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="401 "></span>            <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>connection</span><span class=o>.</span><span class=n>iter_lines</span><span class=p>(</span><span class=n>decode_unicode</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
<span class=linenos data-linenos="402 "></span>                <span class=k>yield</span> <span class=n>line</span>
<span class=linenos data-linenos="403 "></span>    <span class=k>except</span> <span class=ne>ConnectionError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<span class=linenos data-linenos="404 "></span>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>ignore_connection_errors</span><span class=p>:</span>
<span class=linenos data-linenos="405 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&quot;OpenMetrics endpoint </span><span class=si>%s</span><span class=s2> is not accessible&quot;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>endpoint</span><span class=p>)</span>
<span class=linenos data-linenos="406 "></span>        <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="407 "></span>            <span class=k>raise</span> <span class=n>e</span>
</code></pre></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.filter_connection_lines class="doc doc-heading"> <code class="highlight language-python"><span class=n>filter_connection_lines</span><span class=p>(</span><span class=n>line_streamer</span><span class=p>)</span></code> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.filter_connection_lines class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Filter connection lines in the line streamer.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/scraper.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="409 "></span><span class=k>def</span> <span class=nf>filter_connection_lines</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>line_streamer</span><span class=p>):</span>
<span class=linenos data-linenos="410 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="411 "></span><span class=sd>    Filter connection lines in the line streamer.</span>
<span class=linenos data-linenos="412 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="413 "></span>
<span class=linenos data-linenos="414 "></span>    <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>line_streamer</span><span class=p>:</span>
<span class=linenos data-linenos="415 "></span>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>raw_line_filter</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>line</span><span class=p>):</span>
<span class=linenos data-linenos="416 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>submit_telemetry_number_of_ignored_lines</span><span class=p>()</span>
<span class=linenos data-linenos="417 "></span>        <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="418 "></span>            <span class=k>yield</span> <span class=n>line</span>
</code></pre></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.get_connection class="doc doc-heading"> <code class="highlight language-python"><span class=n>get_connection</span><span class=p>()</span></code> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.get_connection class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Send a request to scrape metrics. Return the response or throw an exception.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/scraper.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="420 "></span><span class=k>def</span> <span class=nf>get_connection</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=linenos data-linenos="421 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="422 "></span><span class=sd>    Send a request to scrape metrics. Return the response or throw an exception.</span>
<span class=linenos data-linenos="423 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="424 "></span>
<span class=linenos data-linenos="425 "></span>    <span class=k>try</span><span class=p>:</span>
<span class=linenos data-linenos="426 "></span>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>send_request</span><span class=p>()</span>
<span class=linenos data-linenos="427 "></span>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<span class=linenos data-linenos="428 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>submit_health_check</span><span class=p>(</span><span class=n>ServiceCheck</span><span class=o>.</span><span class=n>CRITICAL</span><span class=p>,</span> <span class=n>message</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<span class=linenos data-linenos="429 "></span>        <span class=k>raise</span>
<span class=linenos data-linenos="430 "></span>    <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="431 "></span>        <span class=k>try</span><span class=p>:</span>
<span class=linenos data-linenos="432 "></span>            <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
<span class=linenos data-linenos="433 "></span>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<span class=linenos data-linenos="434 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>submit_health_check</span><span class=p>(</span><span class=n>ServiceCheck</span><span class=o>.</span><span class=n>CRITICAL</span><span class=p>,</span> <span class=n>message</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<span class=linenos data-linenos="435 "></span>            <span class=n>response</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<span class=linenos data-linenos="436 "></span>            <span class=k>raise</span>
<span class=linenos data-linenos="437 "></span>        <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="438 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>submit_health_check</span><span class=p>(</span><span class=n>ServiceCheck</span><span class=o>.</span><span class=n>OK</span><span class=p>)</span>
<span class=linenos data-linenos="439 "></span>
<span class=linenos data-linenos="440 "></span>            <span class=c1># Never derive the encoding from the locale</span>
<span class=linenos data-linenos="441 "></span>            <span class=k>if</span> <span class=n>response</span><span class=o>.</span><span class=n>encoding</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="442 "></span>                <span class=n>response</span><span class=o>.</span><span class=n>encoding</span> <span class=o>=</span> <span class=s1>&#39;utf-8&#39;</span>
<span class=linenos data-linenos="443 "></span>
<span class=linenos data-linenos="444 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>submit_telemetry_endpoint_response_size</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
<span class=linenos data-linenos="445 "></span>
<span class=linenos data-linenos="446 "></span>            <span class=k>return</span> <span class=n>response</span>
</code></pre></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.set_dynamic_tags class="doc doc-heading"> <code class="highlight language-python"><span class=n>set_dynamic_tags</span><span class=p>(</span><span class=o>*</span><span class=n>tags</span><span class=p>)</span></code> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.set_dynamic_tags class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Set dynamic tags.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/scraper.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="456 "></span><span class=k>def</span> <span class=nf>set_dynamic_tags</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>tags</span><span class=p>):</span>
<span class=linenos data-linenos="457 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="458 "></span><span class=sd>    Set dynamic tags.</span>
<span class=linenos data-linenos="459 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="460 "></span>
<span class=linenos data-linenos="461 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>tags</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>chain</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>static_tags</span><span class=p>,</span> <span class=n>tags</span><span class=p>))</span>
</code></pre></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.submit_health_check class="doc doc-heading"> <code class="highlight language-python"><span class=n>submit_health_check</span><span class=p>(</span><span class=n>status</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span></code> <a href=#datadog_checks.base.checks.openmetrics.v2.scraper.OpenMetricsScraper.submit_health_check class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>If health service check is enabled, send an <code>openmetrics.health</code> service check.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/scraper.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="463 "></span><span class=k>def</span> <span class=nf>submit_health_check</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>status</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=linenos data-linenos="464 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="465 "></span><span class=sd>    If health service check is enabled, send an `openmetrics.health` service check.</span>
<span class=linenos data-linenos="466 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="467 "></span>
<span class=linenos data-linenos="468 "></span>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>enable_health_service_check</span><span class=p>:</span>
<span class=linenos data-linenos="469 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>service_check</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>SERVICE_CHECK_HEALTH</span><span class=p>,</span> <span class=n>status</span><span class=p>,</span> <span class=n>tags</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>static_tags</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</code></pre></div> </details> </div> </div> </div> </div> </div><h2 id=transformers>Transformers<a class=headerlink href=#transformers title="Permanent link">&para;</a></h2> <div class="doc doc-object doc-class"> <h3 id=datadog_checks.base.checks.openmetrics.v2.transform.Transformers class="doc doc-heading"> <code>datadog_checks.base.checks.openmetrics.v2.transform.Transformers</code> <a href=#datadog_checks.base.checks.openmetrics.v2.transform.Transformers class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents first"> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/checks/openmetrics/v2/transform.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="202 "></span><span class=k>class</span> <span class=nc>Transformers</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
<span class=linenos data-linenos="203 "></span>    <span class=k>pass</span>
</code></pre></div> </details> </div> </div><h2 id=options>Options<a class=headerlink href=#options title="Permanent link">&para;</a></h2> <p>For complete documentation on every option, see the associated templates for the <a href=https://github.com/DataDog/integrations-core/blob/master/datadog_checks_dev/datadog_checks/dev/tooling/templates/configuration/instances/openmetrics.yaml>instance</a> and <a href=https://github.com/DataDog/integrations-core/blob/master/datadog_checks_dev/datadog_checks/dev/tooling/templates/configuration/init_config/openmetrics.yaml>init_config</a> sections.</p> <h2 id=legacy>Legacy<a class=headerlink href=#legacy title="Permanent link">&para;</a></h2> <p>This OpenMetrics implementation is the updated version of the original Prometheus/OpenMetrics implementation. The <a href=../../legacy/prometheus/ >docs for the deprecated implementation</a> are still available as a reference.</p> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">August 16, 2023</span> </small> </div> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../databases/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Databases"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Databases </div> </div> </a> <a href=../logs-crawlers/ class="md-footer__link md-footer__link--next" aria-label="Next: Log Crawlers"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Log Crawlers </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; Datadog, Inc. 2020-present </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://www.datadoghq.com/blog/engineering/ target=_blank rel=noopener title=www.datadoghq.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M192 32c0 17.7 14.3 32 32 32 123.7 0 224 100.3 224 224 0 17.7 14.3 32 32 32s32-14.3 32-32C512 128.9 383.1 0 224 0c-17.7 0-32 14.3-32 32zm0 96c0 17.7 14.3 32 32 32 70.7 0 128 57.3 128 128 0 17.7 14.3 32 32 32s32-14.3 32-32c0-106-86-192-192-192-17.7 0-32 14.3-32 32zm-96 16c0-26.5-21.5-48-48-48S0 117.5 0 144v224c0 79.5 64.5 144 144 144s144-64.5 144-144-64.5-144-144-144h-16v96h16c26.5 0 48 21.5 48 48s-21.5 48-48 48-48-21.5-48-48V144z"/></svg> </a> <a href=https://github.com/DataDog target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> <a href=https://twitter.com/datadoghq target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://www.instagram.com/datadoghq target=_blank rel=noopener title=www.instagram.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["content.action.edit", "content.code.copy", "navigation.expand", "navigation.footer", "navigation.instant", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.cd18aaf1.min.js></script> </body> </html>