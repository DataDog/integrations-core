<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The home of Agent Integrations developer documentation"><meta name=author content=Datadog><link href=https://datadoghq.dev/integrations-core/base/databases/ rel=canonical><link href=../tls/ rel=prev><link href=../openmetrics/ rel=next><link rel=icon href=../../assets/images/favicon.ico><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.4.14"><title>Databases - Agent Integrations</title><link rel=stylesheet href=../../assets/stylesheets/main.fad675c6.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.356b1318.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/_mkdocstrings.css><link rel=stylesheet href=../../assets/css/custom.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/firacode@6.2.0/distr/fira_code.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=custom data-md-color-accent=indigo> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#databases class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Agent Integrations" class="md-header__button md-logo" aria-label="Agent Integrations" data-md-component=logo> <img src=../../assets/images/logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Agent Integrations </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Databases </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=custom data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=custom data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/DataDog/integrations-core title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class=md-source__repository> datadog/integrations-core </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../about/ class=md-tabs__link> Base Package </a> </li> <li class=md-tabs__item> <a href=../../ddev/about/ class=md-tabs__link> Dev Package </a> </li> <li class=md-tabs__item> <a href=../../guidelines/pr/ class=md-tabs__link> Guidelines </a> </li> <li class=md-tabs__item> <a href=../../meta/ci/testing/ class=md-tabs__link> Meta </a> </li> <li class=md-tabs__item> <a href=../../tutorials/jmx/integration/ class=md-tabs__link> Tutorials </a> </li> <li class=md-tabs__item> <a href=../../architecture/ibm_i/ class=md-tabs__link> Architecture </a> </li> <li class=md-tabs__item> <a href=../../process/integration-release/ class=md-tabs__link> Process </a> </li> <li class=md-tabs__item> <a href=../../faq/faq/ class=md-tabs__link> FAQ </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Agent Integrations" class="md-nav__button md-logo" aria-label="Agent Integrations" data-md-component=logo> <img src=../../assets/images/logo.svg alt=logo> </a> Agent Integrations </label> <div class=md-nav__source> <a href=https://github.com/DataDog/integrations-core title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class=md-source__repository> datadog/integrations-core </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex> <span class=md-ellipsis> Home </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> About </span> </a> </li> <li class=md-nav__item> <a href=../../setup/ class=md-nav__link> <span class=md-ellipsis> Setup </span> </a> </li> <li class=md-nav__item> <a href=../../testing/ class=md-nav__link> <span class=md-ellipsis> Testing </span> </a> </li> <li class=md-nav__item> <a href=../../e2e/ class=md-nav__link> <span class=md-ellipsis> E2E </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Base Package </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Base Package </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../about/ class=md-nav__link> <span class=md-ellipsis> About </span> </a> </li> <li class=md-nav__item> <a href=../basics/ class=md-nav__link> <span class=md-ellipsis> Basics </span> </a> </li> <li class=md-nav__item> <a href=../http/ class=md-nav__link> <span class=md-ellipsis> HTTP </span> </a> </li> <li class=md-nav__item> <a href=../tls/ class=md-nav__link> <span class=md-ellipsis> TLS/SSL </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Databases </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Databases </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#interface class=md-nav__link> <span class=md-ellipsis> Interface </span> </a> <nav class=md-nav aria-label=Interface> <ul class=md-nav__list> <li class=md-nav__item> <a href=#datadog_checks.base.utils.db.query.Query class=md-nav__link> <span class=md-ellipsis> Query </span> </a> <nav class=md-nav aria-label=Query> <ul class=md-nav__list> <li class=md-nav__item> <a href=#datadog_checks.base.utils.db.query.Query.__init__ class=md-nav__link> <span class=md-ellipsis> __init__() </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.utils.db.query.Query.compile class=md-nav__link> <span class=md-ellipsis> compile() </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#datadog_checks.base.utils.db.core.QueryManager class=md-nav__link> <span class=md-ellipsis> QueryManager </span> </a> <nav class=md-nav aria-label=QueryManager> <ul class=md-nav__list> <li class=md-nav__item> <a href=#datadog_checks.base.utils.db.core.QueryManager.__init__ class=md-nav__link> <span class=md-ellipsis> __init__() </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.utils.db.core.QueryManager.execute class=md-nav__link> <span class=md-ellipsis> execute() </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#transformers class=md-nav__link> <span class=md-ellipsis> Transformers </span> </a> <nav class=md-nav aria-label=Transformers> <ul class=md-nav__list> <li class=md-nav__item> <a href=#column class=md-nav__link> <span class=md-ellipsis> Column </span> </a> <nav class=md-nav aria-label=Column> <ul class=md-nav__list> <li class=md-nav__item> <a href=#match class=md-nav__link> <span class=md-ellipsis> match </span> </a> </li> <li class=md-nav__item> <a href=#temporal_percent class=md-nav__link> <span class=md-ellipsis> temporal_percent </span> </a> </li> <li class=md-nav__item> <a href=#time_elapsed class=md-nav__link> <span class=md-ellipsis> time_elapsed </span> </a> </li> <li class=md-nav__item> <a href=#monotonic_gauge class=md-nav__link> <span class=md-ellipsis> monotonic_gauge </span> </a> </li> <li class=md-nav__item> <a href=#service_check class=md-nav__link> <span class=md-ellipsis> service_check </span> </a> </li> <li class=md-nav__item> <a href=#tag class=md-nav__link> <span class=md-ellipsis> tag </span> </a> </li> <li class=md-nav__item> <a href=#tag_list class=md-nav__link> <span class=md-ellipsis> tag_list </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#extra class=md-nav__link> <span class=md-ellipsis> Extra </span> </a> <nav class=md-nav aria-label=Extra> <ul class=md-nav__list> <li class=md-nav__item> <a href=#percent class=md-nav__link> <span class=md-ellipsis> percent </span> </a> </li> <li class=md-nav__item> <a href=#expression class=md-nav__link> <span class=md-ellipsis> expression </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../openmetrics/ class=md-nav__link> <span class=md-ellipsis> OpenMetrics </span> </a> </li> <li class=md-nav__item> <a href=../metadata/ class=md-nav__link> <span class=md-ellipsis> Metadata </span> </a> </li> <li class=md-nav__item> <a href=../api/ class=md-nav__link> <span class=md-ellipsis> API </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Dev Package </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Dev Package </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ddev/about/ class=md-nav__link> <span class=md-ellipsis> What's in the box? </span> </a> </li> <li class=md-nav__item> <a href=../../ddev/test/ class=md-nav__link> <span class=md-ellipsis> Test framework </span> </a> </li> <li class=md-nav__item> <a href=../../ddev/plugins/ class=md-nav__link> <span class=md-ellipsis> Plugins </span> </a> </li> <li class=md-nav__item> <a href=../../ddev/configuration/ class=md-nav__link> <span class=md-ellipsis> Configuration </span> </a> </li> <li class=md-nav__item> <a href=../../ddev/cli/ class=md-nav__link> <span class=md-ellipsis> CLI </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Guidelines </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Guidelines </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../guidelines/pr/ class=md-nav__link> <span class=md-ellipsis> Pull requests </span> </a> </li> <li class=md-nav__item> <a href=../../guidelines/style/ class=md-nav__link> <span class=md-ellipsis> Style </span> </a> </li> <li class=md-nav__item> <a href=../../guidelines/dashboards/ class=md-nav__link> <span class=md-ellipsis> Dashboards </span> </a> </li> <li class=md-nav__item> <a href=../../guidelines/conventions/ class=md-nav__link> <span class=md-ellipsis> Conventions </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> Meta </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Meta </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_1> <label class=md-nav__link for=__nav_5_1 id=__nav_5_1_label tabindex> <span class=md-ellipsis> CI </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_1_label aria-expanded=false> <label class=md-nav__title for=__nav_5_1> <span class="md-nav__icon md-icon"></span> CI </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../meta/ci/testing/ class=md-nav__link> <span class=md-ellipsis> Testing </span> </a> </li> <li class=md-nav__item> <a href=../../meta/ci/validation/ class=md-nav__link> <span class=md-ellipsis> Validation </span> </a> </li> <li class=md-nav__item> <a href=../../meta/ci/labels/ class=md-nav__link> <span class=md-ellipsis> Labels </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../meta/docs/ class=md-nav__link> <span class=md-ellipsis> Docs </span> </a> </li> <li class=md-nav__item> <a href=../../meta/config-specs/ class=md-nav__link> <span class=md-ellipsis> Config specs </span> </a> </li> <li class=md-nav__item> <a href=../../meta/config-models/ class=md-nav__link> <span class=md-ellipsis> Config models </span> </a> </li> <li class=md-nav__item> <a href=../../meta/status/ class=md-nav__link> <span class=md-ellipsis> Status </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6_1> <label class=md-nav__link for=__nav_6_1 id=__nav_6_1_label tabindex> <span class=md-ellipsis> JMX </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_1_label aria-expanded=false> <label class=md-nav__title for=__nav_6_1> <span class="md-nav__icon md-icon"></span> JMX </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tutorials/jmx/integration/ class=md-nav__link> <span class=md-ellipsis> JMX integration </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/jmx/tools/ class=md-nav__link> <span class=md-ellipsis> JMX Tools </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6_2> <label class=md-nav__link for=__nav_6_2 id=__nav_6_2_label tabindex> <span class=md-ellipsis> SNMP </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_2_label aria-expanded=false> <label class=md-nav__title for=__nav_6_2> <span class="md-nav__icon md-icon"></span> SNMP </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tutorials/snmp/introduction/ class=md-nav__link> <span class=md-ellipsis> Introduction to SNMP </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/snmp/profiles/ class=md-nav__link> <span class=md-ellipsis> Build an SNMP Profile </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/snmp/how-to/ class=md-nav__link> <span class=md-ellipsis> SNMP How-To </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/snmp/profile-format/ class=md-nav__link> <span class=md-ellipsis> Profile Format Reference </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/snmp/sim-format/ class=md-nav__link> <span class=md-ellipsis> Simulation Data Format Reference </span> </a> </li> <li class=md-nav__item> <a href=../../tutorials/snmp/tools/ class=md-nav__link> <span class=md-ellipsis> Tools </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../tutorials/memory-profiling/ class=md-nav__link> <span class=md-ellipsis> Memory profiling </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex> <span class=md-ellipsis> Architecture </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Architecture </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../architecture/ibm_i/ class=md-nav__link> <span class=md-ellipsis> IBM i </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/snmp/ class=md-nav__link> <span class=md-ellipsis> SNMP </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/vsphere/ class=md-nav__link> <span class=md-ellipsis> vSphere </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/win32_event_log/ class=md-nav__link> <span class=md-ellipsis> Windows Event Log </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex> <span class=md-ellipsis> Process </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Process </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../process/integration-release/ class=md-nav__link> <span class=md-ellipsis> Integration release </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_9> <label class=md-nav__link for=__nav_9 id=__nav_9_label tabindex> <span class=md-ellipsis> FAQ </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_9_label aria-expanded=false> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> FAQ </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../faq/faq/ class=md-nav__link> <span class=md-ellipsis> FAQ </span> </a> </li> <li class=md-nav__item> <a href=../../faq/acknowledgements/ class=md-nav__link> <span class=md-ellipsis> Acknowledgements </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#interface class=md-nav__link> <span class=md-ellipsis> Interface </span> </a> <nav class=md-nav aria-label=Interface> <ul class=md-nav__list> <li class=md-nav__item> <a href=#datadog_checks.base.utils.db.query.Query class=md-nav__link> <span class=md-ellipsis> Query </span> </a> <nav class=md-nav aria-label=Query> <ul class=md-nav__list> <li class=md-nav__item> <a href=#datadog_checks.base.utils.db.query.Query.__init__ class=md-nav__link> <span class=md-ellipsis> __init__() </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.utils.db.query.Query.compile class=md-nav__link> <span class=md-ellipsis> compile() </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#datadog_checks.base.utils.db.core.QueryManager class=md-nav__link> <span class=md-ellipsis> QueryManager </span> </a> <nav class=md-nav aria-label=QueryManager> <ul class=md-nav__list> <li class=md-nav__item> <a href=#datadog_checks.base.utils.db.core.QueryManager.__init__ class=md-nav__link> <span class=md-ellipsis> __init__() </span> </a> </li> <li class=md-nav__item> <a href=#datadog_checks.base.utils.db.core.QueryManager.execute class=md-nav__link> <span class=md-ellipsis> execute() </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#transformers class=md-nav__link> <span class=md-ellipsis> Transformers </span> </a> <nav class=md-nav aria-label=Transformers> <ul class=md-nav__list> <li class=md-nav__item> <a href=#column class=md-nav__link> <span class=md-ellipsis> Column </span> </a> <nav class=md-nav aria-label=Column> <ul class=md-nav__list> <li class=md-nav__item> <a href=#match class=md-nav__link> <span class=md-ellipsis> match </span> </a> </li> <li class=md-nav__item> <a href=#temporal_percent class=md-nav__link> <span class=md-ellipsis> temporal_percent </span> </a> </li> <li class=md-nav__item> <a href=#time_elapsed class=md-nav__link> <span class=md-ellipsis> time_elapsed </span> </a> </li> <li class=md-nav__item> <a href=#monotonic_gauge class=md-nav__link> <span class=md-ellipsis> monotonic_gauge </span> </a> </li> <li class=md-nav__item> <a href=#service_check class=md-nav__link> <span class=md-ellipsis> service_check </span> </a> </li> <li class=md-nav__item> <a href=#tag class=md-nav__link> <span class=md-ellipsis> tag </span> </a> </li> <li class=md-nav__item> <a href=#tag_list class=md-nav__link> <span class=md-ellipsis> tag_list </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#extra class=md-nav__link> <span class=md-ellipsis> Extra </span> </a> <nav class=md-nav aria-label=Extra> <ul class=md-nav__list> <li class=md-nav__item> <a href=#percent class=md-nav__link> <span class=md-ellipsis> percent </span> </a> </li> <li class=md-nav__item> <a href=#expression class=md-nav__link> <span class=md-ellipsis> expression </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/DataDog/integrations-core/blob/master/docs/developer/base/databases.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg> </a> <h1 id=databases>Databases<a class=headerlink href=#databases title="Permanent link">&para;</a></h1> <hr> <div align=center> <video preload=auto autoplay loop muted> <source src=https://media.giphy.com/media/dIBLtolI6axTGIGopo/giphy.mp4 type=video/mp4> </video> </div> <p>No matter the database you wish to monitor, the base package provides a standard way to define and collect data from arbitrary queries.</p> <p>The core premise is that you define a function that accepts a query (usually a <code>str</code>) and it returns a sequence of equal length results.</p> <h2 id=interface>Interface<a class=headerlink href=#interface title="Permanent link">&para;</a></h2> <p>All the functionality is exposed by the <code>Query</code> and <code>QueryManager</code> classes.</p> <div class="doc doc-object doc-class"> <h3 id=datadog_checks.base.utils.db.query.Query class="doc doc-heading"> <code>datadog_checks.base.utils.db.query.Query</code> <a href=#datadog_checks.base.utils.db.query.Query class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents first"> <p>This class accepts a single <code>dict</code> argument which is necessary to run the query. The representation is based on our <code>custom_queries</code> format originally designed and implemented in <a class="magiclink magiclink-github magiclink-pull" href=https://github.com/DataDog/integrations-core/pull/1528 title="GitHub Pull Request: DataDog/integrations-core #1528">#1528</a>.</p> <p>It is now part of all our database integrations and <a href=https://cloud.google.com/solutions/sap/docs/sap-hana-monitoring-agent-planning-guide#defining_custom_queries>other</a> products have since adopted this format.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/utils/db/query.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos=" 15 "></span><span class=k>class</span> <span class=nc>Query</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
<span class=linenos data-linenos=" 16 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 17 "></span><span class=sd>    This class accepts a single `dict` argument which is necessary to run the query. The representation</span>
<span class=linenos data-linenos=" 18 "></span><span class=sd>    is based on our `custom_queries` format originally designed and implemented in !1528.</span>
<span class=linenos data-linenos=" 19 "></span>
<span class=linenos data-linenos=" 20 "></span><span class=sd>    It is now part of all our database integrations and</span>
<span class=linenos data-linenos=" 21 "></span><span class=sd>    [other](https://cloud.google.com/solutions/sap/docs/sap-hana-monitoring-agent-planning-guide#defining_custom_queries)</span>
<span class=linenos data-linenos=" 22 "></span><span class=sd>    products have since adopted this format.</span>
<span class=linenos data-linenos=" 23 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 24 "></span>
<span class=linenos data-linenos=" 25 "></span>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query_data</span><span class=p>):</span>
<span class=linenos data-linenos=" 26 "></span><span class=w>        </span><span class=sd>&#39;&#39;&#39;</span>
<span class=linenos data-linenos=" 27 "></span><span class=sd>        Parameters:</span>
<span class=linenos data-linenos=" 28 "></span><span class=sd>            query_data (Dict[str, Any]): The query data to run the query. It should contain the following fields:</span>
<span class=linenos data-linenos=" 29 "></span><span class=sd>                - name (str): The name of the query.</span>
<span class=linenos data-linenos=" 30 "></span><span class=sd>                - query (str): The query to run.</span>
<span class=linenos data-linenos=" 31 "></span><span class=sd>                - columns (List[Dict[str, Any]]): Each column should contain the following fields:</span>
<span class=linenos data-linenos=" 32 "></span><span class=sd>                    - name (str): The name of the column.</span>
<span class=linenos data-linenos=" 33 "></span><span class=sd>                    - type (str): The type of the column.</span>
<span class=linenos data-linenos=" 34 "></span><span class=sd>                    - (Optional) Any other field that the column transformer for the type requires.</span>
<span class=linenos data-linenos=" 35 "></span><span class=sd>                - (Optional) extras (List[Dict[str, Any]]): Each extra transformer should contain the following fields:</span>
<span class=linenos data-linenos=" 36 "></span><span class=sd>                    - name (str): The name of the extra transformer.</span>
<span class=linenos data-linenos=" 37 "></span><span class=sd>                    - type (str): The type of the extra transformer.</span>
<span class=linenos data-linenos=" 38 "></span><span class=sd>                    - (Optional) Any other field that the extra transformer for the type requires.</span>
<span class=linenos data-linenos=" 39 "></span><span class=sd>                - (Optional) tags (List[str]): The tags to add to the query result.</span>
<span class=linenos data-linenos=" 40 "></span><span class=sd>                - (Optional) collection_interval (int): The collection interval (in seconds) of the query.</span>
<span class=linenos data-linenos=" 41 "></span><span class=sd>                    Note:</span>
<span class=linenos data-linenos=" 42 "></span><span class=sd>                        If collection_interval is None, the query will be run every check run.</span>
<span class=linenos data-linenos=" 43 "></span><span class=sd>                        If the collection interval is less than check collection interval,</span>
<span class=linenos data-linenos=" 44 "></span><span class=sd>                        the query will be run every check run.</span>
<span class=linenos data-linenos=" 45 "></span><span class=sd>                        If the collection interval is greater than check collection interval,</span>
<span class=linenos data-linenos=" 46 "></span><span class=sd>                        the query will NOT BE RUN exactly at the collection interval.</span>
<span class=linenos data-linenos=" 47 "></span><span class=sd>                        The query will be run at the next check run after the collection interval has passed.</span>
<span class=linenos data-linenos=" 48 "></span><span class=sd>                - (Optional) metric_prefix (str): The prefix to add to the metric name.</span>
<span class=linenos data-linenos=" 49 "></span><span class=sd>                    Note: If the metric prefix is None, the default metric prefix `&lt;INTEGRATION&gt;.` will be used.</span>
<span class=linenos data-linenos=" 50 "></span><span class=sd>        &#39;&#39;&#39;</span>
<span class=linenos data-linenos=" 51 "></span>        <span class=c1># Contains the data to fill the rest of the attributes</span>
<span class=linenos data-linenos=" 52 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span> <span class=o>=</span> <span class=n>deepcopy</span><span class=p>(</span><span class=n>query_data</span> <span class=ow>or</span> <span class=p>{})</span>  <span class=c1># type: Dict[str, Any]</span>
<span class=linenos data-linenos=" 53 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># type: str</span>
<span class=linenos data-linenos=" 54 "></span>        <span class=c1># The actual query</span>
<span class=linenos data-linenos=" 55 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>query</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># type: str</span>
<span class=linenos data-linenos=" 56 "></span>        <span class=c1># Contains a mapping of column_name -&gt; column_type, transformer</span>
<span class=linenos data-linenos=" 57 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>column_transformers</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># type: Tuple[Tuple[str, Tuple[str, Transformer]]]</span>
<span class=linenos data-linenos=" 58 "></span>        <span class=c1># These transformers are used to collect extra metrics calculated from the query result</span>
<span class=linenos data-linenos=" 59 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>extra_transformers</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># type: List[Tuple[str, Transformer]]</span>
<span class=linenos data-linenos=" 60 "></span>        <span class=c1># Contains the tags defined in query_data, more tags can be added later from the query result</span>
<span class=linenos data-linenos=" 61 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>base_tags</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># type: List[str]</span>
<span class=linenos data-linenos=" 62 "></span>        <span class=c1># The collecton interval (in seconds) of the query. If None, the query will be run every check run.</span>
<span class=linenos data-linenos=" 63 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>collection_interval</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># type: int</span>
<span class=linenos data-linenos=" 64 "></span>        <span class=c1># The last time the query was executed. If None, the query has never been executed.</span>
<span class=linenos data-linenos=" 65 "></span>        <span class=c1># This is only used when the collection_interval is not None.</span>
<span class=linenos data-linenos=" 66 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>__last_execution_time</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># type: float</span>
<span class=linenos data-linenos=" 67 "></span>        <span class=c1># whether to ignore any defined namespace prefix. True when `metric_prefix` is defined.</span>
<span class=linenos data-linenos=" 68 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>metric_name_raw</span> <span class=o>=</span> <span class=kc>False</span>  <span class=c1># type: bool</span>
<span class=linenos data-linenos=" 69 "></span>
<span class=linenos data-linenos=" 70 "></span>    <span class=k>def</span> <span class=nf>compile</span><span class=p>(</span>
<span class=linenos data-linenos=" 71 "></span>        <span class=bp>self</span><span class=p>,</span>
<span class=linenos data-linenos=" 72 "></span>        <span class=n>column_transformers</span><span class=p>,</span>  <span class=c1># type: Dict[str, TransformerFactory]</span>
<span class=linenos data-linenos=" 73 "></span>        <span class=n>extra_transformers</span><span class=p>,</span>  <span class=c1># type: Dict[str, TransformerFactory]</span>
<span class=linenos data-linenos=" 74 "></span>    <span class=p>):</span>
<span class=linenos data-linenos=" 75 "></span>        <span class=c1># type: (...) -&gt; None</span>
<span class=linenos data-linenos=" 76 "></span>
<span class=linenos data-linenos=" 77 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 78 "></span><span class=sd>        This idempotent method will be called by `QueryManager.compile_queries` so you</span>
<span class=linenos data-linenos=" 79 "></span><span class=sd>        should never need to call it directly.</span>
<span class=linenos data-linenos=" 80 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 81 "></span>        <span class=c1># Check for previous compilation</span>
<span class=linenos data-linenos=" 82 "></span>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos=" 83 "></span>            <span class=k>return</span>
<span class=linenos data-linenos=" 84 "></span>
<span class=linenos data-linenos=" 85 "></span>        <span class=n>query_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 86 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=n>query_name</span><span class=p>:</span>
<span class=linenos data-linenos=" 87 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;query field `name` is required&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 88 "></span>        <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>query_name</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos=" 89 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;query field `name` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 90 "></span>
<span class=linenos data-linenos=" 91 "></span>        <span class=n>metric_prefix</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;metric_prefix&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 92 "></span>        <span class=k>if</span> <span class=n>metric_prefix</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos=" 93 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>metric_prefix</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos=" 94 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `metric_prefix` for </span><span class=si>{}</span><span class=s1> must be a string&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos=" 95 "></span>            <span class=k>elif</span> <span class=ow>not</span> <span class=n>metric_prefix</span><span class=p>:</span>
<span class=linenos data-linenos=" 96 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `metric_prefix` for </span><span class=si>{}</span><span class=s1> must not be empty&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos=" 97 "></span>
<span class=linenos data-linenos=" 98 "></span>        <span class=n>query</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;query&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 99 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=n>query</span><span class=p>:</span>
<span class=linenos data-linenos="100 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `query` for </span><span class=si>{}</span><span class=s1> is required&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="101 "></span>        <span class=k>elif</span> <span class=n>query_name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;custom query #&#39;</span><span class=p>)</span> <span class=ow>and</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="102 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `query` for </span><span class=si>{}</span><span class=s1> must be a string&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="103 "></span>
<span class=linenos data-linenos="104 "></span>        <span class=n>columns</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;columns&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="105 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=n>columns</span><span class=p>:</span>
<span class=linenos data-linenos="106 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `columns` for </span><span class=si>{}</span><span class=s1> is required&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="107 "></span>        <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>columns</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="108 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `columns` for </span><span class=si>{}</span><span class=s1> must be a list&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="109 "></span>
<span class=linenos data-linenos="110 "></span>        <span class=n>tags</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;tags&#39;</span><span class=p>,</span> <span class=p>[])</span>
<span class=linenos data-linenos="111 "></span>        <span class=k>if</span> <span class=n>tags</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tags</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="112 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `tags` for </span><span class=si>{}</span><span class=s1> must be a list&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="113 "></span>
<span class=linenos data-linenos="114 "></span>        <span class=c1># Keep track of all defined names</span>
<span class=linenos data-linenos="115 "></span>        <span class=n>sources</span> <span class=o>=</span> <span class=p>{}</span>
<span class=linenos data-linenos="116 "></span>
<span class=linenos data-linenos="117 "></span>        <span class=n>column_data</span> <span class=o>=</span> <span class=p>[]</span>
<span class=linenos data-linenos="118 "></span>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>column</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>columns</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="119 "></span>            <span class=c1># Columns can be ignored via configuration.</span>
<span class=linenos data-linenos="120 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>column</span><span class=p>:</span>
<span class=linenos data-linenos="121 "></span>                <span class=n>column_data</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>))</span>
<span class=linenos data-linenos="122 "></span>                <span class=k>continue</span>
<span class=linenos data-linenos="123 "></span>            <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>column</span><span class=p>,</span> <span class=nb>dict</span><span class=p>):</span>
<span class=linenos data-linenos="124 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;column #</span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> is not a mapping&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="125 "></span>
<span class=linenos data-linenos="126 "></span>            <span class=n>column_name</span> <span class=o>=</span> <span class=n>column</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="127 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>column_name</span><span class=p>:</span>
<span class=linenos data-linenos="128 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `name` for column #</span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> is required&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="129 "></span>            <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>column_name</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="130 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `name` for column #</span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> must be a string&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="131 "></span>            <span class=k>elif</span> <span class=n>column_name</span> <span class=ow>in</span> <span class=n>sources</span><span class=p>:</span>
<span class=linenos data-linenos="132 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
<span class=linenos data-linenos="133 "></span>                    <span class=s1>&#39;the name </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> was already defined in </span><span class=si>{}</span><span class=s1> #</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
<span class=linenos data-linenos="134 "></span>                        <span class=n>column_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>,</span> <span class=n>sources</span><span class=p>[</span><span class=n>column_name</span><span class=p>][</span><span class=s1>&#39;type&#39;</span><span class=p>],</span> <span class=n>sources</span><span class=p>[</span><span class=n>column_name</span><span class=p>][</span><span class=s1>&#39;index&#39;</span><span class=p>]</span>
<span class=linenos data-linenos="135 "></span>                    <span class=p>)</span>
<span class=linenos data-linenos="136 "></span>                <span class=p>)</span>
<span class=linenos data-linenos="137 "></span>
<span class=linenos data-linenos="138 "></span>            <span class=n>sources</span><span class=p>[</span><span class=n>column_name</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;column&#39;</span><span class=p>,</span> <span class=s1>&#39;index&#39;</span><span class=p>:</span> <span class=n>i</span><span class=p>}</span>
<span class=linenos data-linenos="139 "></span>
<span class=linenos data-linenos="140 "></span>            <span class=n>column_type</span> <span class=o>=</span> <span class=n>column</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;type&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="141 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>column_type</span><span class=p>:</span>
<span class=linenos data-linenos="142 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `type` for column </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> is required&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>column_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="143 "></span>            <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>column_type</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="144 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `type` for column </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> must be a string&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>column_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="145 "></span>            <span class=k>elif</span> <span class=n>column_type</span> <span class=o>==</span> <span class=s1>&#39;source&#39;</span><span class=p>:</span>
<span class=linenos data-linenos="146 "></span>                <span class=n>column_data</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>column_name</span><span class=p>,</span> <span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>)))</span>
<span class=linenos data-linenos="147 "></span>                <span class=k>continue</span>
<span class=linenos data-linenos="148 "></span>            <span class=k>elif</span> <span class=n>column_type</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>column_transformers</span><span class=p>:</span>
<span class=linenos data-linenos="149 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;unknown type `</span><span class=si>{}</span><span class=s1>` for column </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>column_type</span><span class=p>,</span> <span class=n>column_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="150 "></span>
<span class=linenos data-linenos="151 "></span>            <span class=n>__column_type_is_tag</span> <span class=o>=</span> <span class=n>column_type</span> <span class=ow>in</span> <span class=p>(</span><span class=s1>&#39;tag&#39;</span><span class=p>,</span> <span class=s1>&#39;tag_list&#39;</span><span class=p>,</span> <span class=s1>&#39;tag_not_null&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="152 "></span>            <span class=n>modifiers</span> <span class=o>=</span> <span class=p>{</span><span class=n>key</span><span class=p>:</span> <span class=n>value</span> <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>column</span><span class=o>.</span><span class=n>items</span><span class=p>()</span> <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=s1>&#39;type&#39;</span><span class=p>)}</span>
<span class=linenos data-linenos="153 "></span>
<span class=linenos data-linenos="154 "></span>            <span class=k>try</span><span class=p>:</span>
<span class=linenos data-linenos="155 "></span>                <span class=k>if</span> <span class=ow>not</span> <span class=n>__column_type_is_tag</span> <span class=ow>and</span> <span class=n>metric_prefix</span><span class=p>:</span>
<span class=linenos data-linenos="156 "></span>                    <span class=c1># if metric_prefix is defined, we prepend it to the column name</span>
<span class=linenos data-linenos="157 "></span>                    <span class=n>column_name</span> <span class=o>=</span> <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>.</span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>metric_prefix</span><span class=p>,</span> <span class=n>column_name</span><span class=p>)</span>
<span class=linenos data-linenos="158 "></span>                <span class=n>transformer</span> <span class=o>=</span> <span class=n>column_transformers</span><span class=p>[</span><span class=n>column_type</span><span class=p>](</span><span class=n>column_transformers</span><span class=p>,</span> <span class=n>column_name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>)</span>
<span class=linenos data-linenos="159 "></span>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<span class=linenos data-linenos="160 "></span>                <span class=n>error</span> <span class=o>=</span> <span class=s1>&#39;error compiling type `</span><span class=si>{}</span><span class=s1>` for column </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1>: </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
<span class=linenos data-linenos="161 "></span>                    <span class=n>column_type</span><span class=p>,</span> <span class=n>column_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>,</span> <span class=n>e</span>
<span class=linenos data-linenos="162 "></span>                <span class=p>)</span>
<span class=linenos data-linenos="163 "></span>
<span class=linenos data-linenos="164 "></span>                <span class=c1># Prepend helpful error text.</span>
<span class=linenos data-linenos="165 "></span>                <span class=c1>#</span>
<span class=linenos data-linenos="166 "></span>                <span class=c1># When an exception is raised in the context of another one, both will be printed. To avoid</span>
<span class=linenos data-linenos="167 "></span>                <span class=c1># this we set the context to None. https://www.python.org/dev/peps/pep-0409/</span>
<span class=linenos data-linenos="168 "></span>                <span class=n>raise_from</span><span class=p>(</span><span class=nb>type</span><span class=p>(</span><span class=n>e</span><span class=p>)(</span><span class=n>error</span><span class=p>),</span> <span class=kc>None</span><span class=p>)</span>
<span class=linenos data-linenos="169 "></span>            <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="170 "></span>                <span class=k>if</span> <span class=n>__column_type_is_tag</span><span class=p>:</span>
<span class=linenos data-linenos="171 "></span>                    <span class=n>column_data</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>column_name</span><span class=p>,</span> <span class=p>(</span><span class=n>column_type</span><span class=p>,</span> <span class=n>transformer</span><span class=p>)))</span>
<span class=linenos data-linenos="172 "></span>                <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="173 "></span>                    <span class=c1># All these would actually submit data. As that is the default case, we represent it as</span>
<span class=linenos data-linenos="174 "></span>                    <span class=c1># a reference to None since if we use e.g. `value` it would never be checked anyway.</span>
<span class=linenos data-linenos="175 "></span>                    <span class=n>column_data</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>column_name</span><span class=p>,</span> <span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=n>transformer</span><span class=p>)))</span>
<span class=linenos data-linenos="176 "></span>
<span class=linenos data-linenos="177 "></span>        <span class=n>submission_transformers</span> <span class=o>=</span> <span class=n>column_transformers</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>  <span class=c1># type: Dict[str, Transformer]</span>
<span class=linenos data-linenos="178 "></span>        <span class=n>submission_transformers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;tag&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="179 "></span>        <span class=n>submission_transformers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;tag_list&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="180 "></span>        <span class=n>submission_transformers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;tag_not_null&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="181 "></span>
<span class=linenos data-linenos="182 "></span>        <span class=n>extras</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;extras&#39;</span><span class=p>,</span> <span class=p>[])</span>  <span class=c1># type: List[Dict[str, Any]]</span>
<span class=linenos data-linenos="183 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>extras</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="184 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `extras` for </span><span class=si>{}</span><span class=s1> must be a list&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="185 "></span>
<span class=linenos data-linenos="186 "></span>        <span class=n>extra_data</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># type: List[Tuple[str, Transformer]]</span>
<span class=linenos data-linenos="187 "></span>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>extra</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>extras</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="188 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>extra</span><span class=p>,</span> <span class=nb>dict</span><span class=p>):</span>
<span class=linenos data-linenos="189 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;extra #</span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> is not a mapping&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="190 "></span>
<span class=linenos data-linenos="191 "></span>            <span class=n>extra_name</span> <span class=o>=</span> <span class=n>extra</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>  <span class=c1># type: str</span>
<span class=linenos data-linenos="192 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>extra_name</span><span class=p>:</span>
<span class=linenos data-linenos="193 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `name` for extra #</span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> is required&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="194 "></span>            <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>extra_name</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="195 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `name` for extra #</span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> must be a string&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="196 "></span>            <span class=k>elif</span> <span class=n>extra_name</span> <span class=ow>in</span> <span class=n>sources</span><span class=p>:</span>
<span class=linenos data-linenos="197 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
<span class=linenos data-linenos="198 "></span>                    <span class=s1>&#39;the name </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> was already defined in </span><span class=si>{}</span><span class=s1> #</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
<span class=linenos data-linenos="199 "></span>                        <span class=n>extra_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>,</span> <span class=n>sources</span><span class=p>[</span><span class=n>extra_name</span><span class=p>][</span><span class=s1>&#39;type&#39;</span><span class=p>],</span> <span class=n>sources</span><span class=p>[</span><span class=n>extra_name</span><span class=p>][</span><span class=s1>&#39;index&#39;</span><span class=p>]</span>
<span class=linenos data-linenos="200 "></span>                    <span class=p>)</span>
<span class=linenos data-linenos="201 "></span>                <span class=p>)</span>
<span class=linenos data-linenos="202 "></span>
<span class=linenos data-linenos="203 "></span>            <span class=n>sources</span><span class=p>[</span><span class=n>extra_name</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;extra&#39;</span><span class=p>,</span> <span class=s1>&#39;index&#39;</span><span class=p>:</span> <span class=n>i</span><span class=p>}</span>
<span class=linenos data-linenos="204 "></span>
<span class=linenos data-linenos="205 "></span>            <span class=n>extra_type</span> <span class=o>=</span> <span class=n>extra</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;type&#39;</span><span class=p>)</span>  <span class=c1># type: str  # Is the key in a transformers dict</span>
<span class=linenos data-linenos="206 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>extra_type</span><span class=p>:</span>
<span class=linenos data-linenos="207 "></span>                <span class=k>if</span> <span class=s1>&#39;expression&#39;</span> <span class=ow>in</span> <span class=n>extra</span><span class=p>:</span>
<span class=linenos data-linenos="208 "></span>                    <span class=n>extra_type</span> <span class=o>=</span> <span class=s1>&#39;expression&#39;</span>
<span class=linenos data-linenos="209 "></span>                <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="210 "></span>                    <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `type` for extra </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> is required&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>extra_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="211 "></span>            <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>extra_type</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="212 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `type` for extra </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> must be a string&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>extra_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="213 "></span>            <span class=k>elif</span> <span class=n>extra_type</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>extra_transformers</span> <span class=ow>and</span> <span class=n>extra_type</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>submission_transformers</span><span class=p>:</span>
<span class=linenos data-linenos="214 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;unknown type `</span><span class=si>{}</span><span class=s1>` for extra </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>extra_type</span><span class=p>,</span> <span class=n>extra_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="215 "></span>
<span class=linenos data-linenos="216 "></span>            <span class=n>transformer_factory</span> <span class=o>=</span> <span class=n>extra_transformers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span>
<span class=linenos data-linenos="217 "></span>                <span class=n>extra_type</span><span class=p>,</span> <span class=n>submission_transformers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>extra_type</span><span class=p>)</span>
<span class=linenos data-linenos="218 "></span>            <span class=p>)</span>  <span class=c1># type: TransformerFactory</span>
<span class=linenos data-linenos="219 "></span>
<span class=linenos data-linenos="220 "></span>            <span class=n>extra_source</span> <span class=o>=</span> <span class=n>extra</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;source&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="221 "></span>            <span class=k>if</span> <span class=n>extra_type</span> <span class=ow>in</span> <span class=n>submission_transformers</span><span class=p>:</span>
<span class=linenos data-linenos="222 "></span>                <span class=k>if</span> <span class=ow>not</span> <span class=n>extra_source</span><span class=p>:</span>
<span class=linenos data-linenos="223 "></span>                    <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `source` for extra </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> is required&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>extra_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="224 "></span>
<span class=linenos data-linenos="225 "></span>                <span class=n>modifiers</span> <span class=o>=</span> <span class=p>{</span><span class=n>key</span><span class=p>:</span> <span class=n>value</span> <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>extra</span><span class=o>.</span><span class=n>items</span><span class=p>()</span> <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=s1>&#39;type&#39;</span><span class=p>,</span> <span class=s1>&#39;source&#39;</span><span class=p>)}</span>
<span class=linenos data-linenos="226 "></span>            <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="227 "></span>                <span class=n>modifiers</span> <span class=o>=</span> <span class=p>{</span><span class=n>key</span><span class=p>:</span> <span class=n>value</span> <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>extra</span><span class=o>.</span><span class=n>items</span><span class=p>()</span> <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=s1>&#39;type&#39;</span><span class=p>)}</span>
<span class=linenos data-linenos="228 "></span>                <span class=n>modifiers</span><span class=p>[</span><span class=s1>&#39;sources&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>sources</span>
<span class=linenos data-linenos="229 "></span>
<span class=linenos data-linenos="230 "></span>            <span class=k>try</span><span class=p>:</span>
<span class=linenos data-linenos="231 "></span>                <span class=n>transformer</span> <span class=o>=</span> <span class=n>transformer_factory</span><span class=p>(</span><span class=n>submission_transformers</span><span class=p>,</span> <span class=n>extra_name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>)</span>
<span class=linenos data-linenos="232 "></span>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<span class=linenos data-linenos="233 "></span>                <span class=n>error</span> <span class=o>=</span> <span class=s1>&#39;error compiling type `</span><span class=si>{}</span><span class=s1>` for extra </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1>: </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>extra_type</span><span class=p>,</span> <span class=n>extra_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
<span class=linenos data-linenos="234 "></span>
<span class=linenos data-linenos="235 "></span>                <span class=n>raise_from</span><span class=p>(</span><span class=nb>type</span><span class=p>(</span><span class=n>e</span><span class=p>)(</span><span class=n>error</span><span class=p>),</span> <span class=kc>None</span><span class=p>)</span>
<span class=linenos data-linenos="236 "></span>            <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="237 "></span>                <span class=k>if</span> <span class=n>extra_type</span> <span class=ow>in</span> <span class=n>submission_transformers</span><span class=p>:</span>
<span class=linenos data-linenos="238 "></span>                    <span class=n>transformer</span> <span class=o>=</span> <span class=n>create_extra_transformer</span><span class=p>(</span><span class=n>transformer</span><span class=p>,</span> <span class=n>extra_source</span><span class=p>)</span>
<span class=linenos data-linenos="239 "></span>
<span class=linenos data-linenos="240 "></span>                <span class=n>extra_data</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>extra_name</span><span class=p>,</span> <span class=n>transformer</span><span class=p>))</span>
<span class=linenos data-linenos="241 "></span>
<span class=linenos data-linenos="242 "></span>        <span class=n>collection_interval</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;collection_interval&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="243 "></span>        <span class=k>if</span> <span class=n>collection_interval</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="244 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>collection_interval</span><span class=p>,</span> <span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>)):</span>
<span class=linenos data-linenos="245 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `collection_interval` for </span><span class=si>{}</span><span class=s1> must be a number&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="246 "></span>            <span class=k>elif</span> <span class=nb>int</span><span class=p>(</span><span class=n>collection_interval</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
<span class=linenos data-linenos="247 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
<span class=linenos data-linenos="248 "></span>                    <span class=s1>&#39;field `collection_interval` for </span><span class=si>{}</span><span class=s1> must be a positive number after rounding&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>)</span>
<span class=linenos data-linenos="249 "></span>                <span class=p>)</span>
<span class=linenos data-linenos="250 "></span>            <span class=n>collection_interval</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>collection_interval</span><span class=p>)</span>
<span class=linenos data-linenos="251 "></span>
<span class=linenos data-linenos="252 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>query_name</span>
<span class=linenos data-linenos="253 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>query</span> <span class=o>=</span> <span class=n>query</span>
<span class=linenos data-linenos="254 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>column_transformers</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>column_data</span><span class=p>)</span>
<span class=linenos data-linenos="255 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>extra_transformers</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>extra_data</span><span class=p>)</span>
<span class=linenos data-linenos="256 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>base_tags</span> <span class=o>=</span> <span class=n>tags</span>
<span class=linenos data-linenos="257 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>collection_interval</span> <span class=o>=</span> <span class=n>collection_interval</span>
<span class=linenos data-linenos="258 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>metric_name_raw</span> <span class=o>=</span> <span class=n>metric_prefix</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
<span class=linenos data-linenos="259 "></span>        <span class=k>del</span> <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span>
<span class=linenos data-linenos="260 "></span>
<span class=linenos data-linenos="261 "></span>    <span class=k>def</span> <span class=nf>should_execute</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=linenos data-linenos="262 "></span><span class=w>        </span><span class=sd>&#39;&#39;&#39;</span>
<span class=linenos data-linenos="263 "></span><span class=sd>        Check if the query should be executed based on the collection interval.</span>
<span class=linenos data-linenos="264 "></span>
<span class=linenos data-linenos="265 "></span><span class=sd>        :return: True if the query should be executed, False otherwise.</span>
<span class=linenos data-linenos="266 "></span><span class=sd>        &#39;&#39;&#39;</span>
<span class=linenos data-linenos="267 "></span>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>collection_interval</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="268 "></span>            <span class=c1># if the collection interval is None, the query should always be executed.</span>
<span class=linenos data-linenos="269 "></span>            <span class=k>return</span> <span class=kc>True</span>
<span class=linenos data-linenos="270 "></span>
<span class=linenos data-linenos="271 "></span>        <span class=n>now</span> <span class=o>=</span> <span class=n>get_timestamp</span><span class=p>()</span>
<span class=linenos data-linenos="272 "></span>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>__last_execution_time</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>or</span> <span class=n>now</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>__last_execution_time</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>collection_interval</span><span class=p>:</span>
<span class=linenos data-linenos="273 "></span>            <span class=c1># if the last execution time is None (the query has never been executed),</span>
<span class=linenos data-linenos="274 "></span>            <span class=c1># if the time since the last execution is greater than or equal to the collection interval,</span>
<span class=linenos data-linenos="275 "></span>            <span class=c1># the query should be executed.</span>
<span class=linenos data-linenos="276 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>__last_execution_time</span> <span class=o>=</span> <span class=n>now</span>
<span class=linenos data-linenos="277 "></span>            <span class=k>return</span> <span class=kc>True</span>
<span class=linenos data-linenos="278 "></span>
<span class=linenos data-linenos="279 "></span>        <span class=k>return</span> <span class=kc>False</span>
</code></pre></div> </details> <div class="doc doc-children"> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.utils.db.query.Query.__init__ class="doc doc-heading"> <code class="highlight language-python"><span class=fm>__init__</span><span class=p>(</span><span class=n>query_data</span><span class=p>)</span></code> <a href=#datadog_checks.base.utils.db.query.Query.__init__ class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p><strong>Parameters:</strong></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr> <td><code>query_data</code></td> <td> <code><span title="typing.Dict">Dict</span>[str, <span title="typing.Any">Any</span>]</code> </td> <td> <div class=doc-md-description> <p>The query data to run the query. It should contain the following fields: - name (str): The name of the query. - query (str): The query to run. - columns (List[Dict[str, Any]]): Each column should contain the following fields: - name (str): The name of the column. - type (str): The type of the column. - (Optional) Any other field that the column transformer for the type requires. - (Optional) extras (List[Dict[str, Any]]): Each extra transformer should contain the following fields: - name (str): The name of the extra transformer. - type (str): The type of the extra transformer. - (Optional) Any other field that the extra transformer for the type requires. - (Optional) tags (List[str]): The tags to add to the query result. - (Optional) collection_interval (int): The collection interval (in seconds) of the query. Note: If collection_interval is None, the query will be run every check run. If the collection interval is less than check collection interval, the query will be run every check run. If the collection interval is greater than check collection interval, the query will NOT BE RUN exactly at the collection interval. The query will be run at the next check run after the collection interval has passed. - (Optional) metric_prefix (str): The prefix to add to the metric name. Note: If the metric prefix is None, the default metric prefix <code>&lt;INTEGRATION&gt;.</code> will be used.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/utils/db/query.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="25 "></span><span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query_data</span><span class=p>):</span>
<span class=linenos data-linenos="26 "></span><span class=w>    </span><span class=sd>&#39;&#39;&#39;</span>
<span class=linenos data-linenos="27 "></span><span class=sd>    Parameters:</span>
<span class=linenos data-linenos="28 "></span><span class=sd>        query_data (Dict[str, Any]): The query data to run the query. It should contain the following fields:</span>
<span class=linenos data-linenos="29 "></span><span class=sd>            - name (str): The name of the query.</span>
<span class=linenos data-linenos="30 "></span><span class=sd>            - query (str): The query to run.</span>
<span class=linenos data-linenos="31 "></span><span class=sd>            - columns (List[Dict[str, Any]]): Each column should contain the following fields:</span>
<span class=linenos data-linenos="32 "></span><span class=sd>                - name (str): The name of the column.</span>
<span class=linenos data-linenos="33 "></span><span class=sd>                - type (str): The type of the column.</span>
<span class=linenos data-linenos="34 "></span><span class=sd>                - (Optional) Any other field that the column transformer for the type requires.</span>
<span class=linenos data-linenos="35 "></span><span class=sd>            - (Optional) extras (List[Dict[str, Any]]): Each extra transformer should contain the following fields:</span>
<span class=linenos data-linenos="36 "></span><span class=sd>                - name (str): The name of the extra transformer.</span>
<span class=linenos data-linenos="37 "></span><span class=sd>                - type (str): The type of the extra transformer.</span>
<span class=linenos data-linenos="38 "></span><span class=sd>                - (Optional) Any other field that the extra transformer for the type requires.</span>
<span class=linenos data-linenos="39 "></span><span class=sd>            - (Optional) tags (List[str]): The tags to add to the query result.</span>
<span class=linenos data-linenos="40 "></span><span class=sd>            - (Optional) collection_interval (int): The collection interval (in seconds) of the query.</span>
<span class=linenos data-linenos="41 "></span><span class=sd>                Note:</span>
<span class=linenos data-linenos="42 "></span><span class=sd>                    If collection_interval is None, the query will be run every check run.</span>
<span class=linenos data-linenos="43 "></span><span class=sd>                    If the collection interval is less than check collection interval,</span>
<span class=linenos data-linenos="44 "></span><span class=sd>                    the query will be run every check run.</span>
<span class=linenos data-linenos="45 "></span><span class=sd>                    If the collection interval is greater than check collection interval,</span>
<span class=linenos data-linenos="46 "></span><span class=sd>                    the query will NOT BE RUN exactly at the collection interval.</span>
<span class=linenos data-linenos="47 "></span><span class=sd>                    The query will be run at the next check run after the collection interval has passed.</span>
<span class=linenos data-linenos="48 "></span><span class=sd>            - (Optional) metric_prefix (str): The prefix to add to the metric name.</span>
<span class=linenos data-linenos="49 "></span><span class=sd>                Note: If the metric prefix is None, the default metric prefix `&lt;INTEGRATION&gt;.` will be used.</span>
<span class=linenos data-linenos="50 "></span><span class=sd>    &#39;&#39;&#39;</span>
<span class=linenos data-linenos="51 "></span>    <span class=c1># Contains the data to fill the rest of the attributes</span>
<span class=linenos data-linenos="52 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span> <span class=o>=</span> <span class=n>deepcopy</span><span class=p>(</span><span class=n>query_data</span> <span class=ow>or</span> <span class=p>{})</span>  <span class=c1># type: Dict[str, Any]</span>
<span class=linenos data-linenos="53 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># type: str</span>
<span class=linenos data-linenos="54 "></span>    <span class=c1># The actual query</span>
<span class=linenos data-linenos="55 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>query</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># type: str</span>
<span class=linenos data-linenos="56 "></span>    <span class=c1># Contains a mapping of column_name -&gt; column_type, transformer</span>
<span class=linenos data-linenos="57 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>column_transformers</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># type: Tuple[Tuple[str, Tuple[str, Transformer]]]</span>
<span class=linenos data-linenos="58 "></span>    <span class=c1># These transformers are used to collect extra metrics calculated from the query result</span>
<span class=linenos data-linenos="59 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>extra_transformers</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># type: List[Tuple[str, Transformer]]</span>
<span class=linenos data-linenos="60 "></span>    <span class=c1># Contains the tags defined in query_data, more tags can be added later from the query result</span>
<span class=linenos data-linenos="61 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>base_tags</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># type: List[str]</span>
<span class=linenos data-linenos="62 "></span>    <span class=c1># The collecton interval (in seconds) of the query. If None, the query will be run every check run.</span>
<span class=linenos data-linenos="63 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>collection_interval</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># type: int</span>
<span class=linenos data-linenos="64 "></span>    <span class=c1># The last time the query was executed. If None, the query has never been executed.</span>
<span class=linenos data-linenos="65 "></span>    <span class=c1># This is only used when the collection_interval is not None.</span>
<span class=linenos data-linenos="66 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>__last_execution_time</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># type: float</span>
<span class=linenos data-linenos="67 "></span>    <span class=c1># whether to ignore any defined namespace prefix. True when `metric_prefix` is defined.</span>
<span class=linenos data-linenos="68 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>metric_name_raw</span> <span class=o>=</span> <span class=kc>False</span>  <span class=c1># type: bool</span>
</code></pre></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.utils.db.query.Query.compile class="doc doc-heading"> <code class="highlight language-python"><span class=nb>compile</span><span class=p>(</span><span class=n>column_transformers</span><span class=p>,</span> <span class=n>extra_transformers</span><span class=p>)</span></code> <a href=#datadog_checks.base.utils.db.query.Query.compile class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>This idempotent method will be called by <code>QueryManager.compile_queries</code> so you should never need to call it directly.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/utils/db/query.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos=" 70 "></span><span class=k>def</span> <span class=nf>compile</span><span class=p>(</span>
<span class=linenos data-linenos=" 71 "></span>    <span class=bp>self</span><span class=p>,</span>
<span class=linenos data-linenos=" 72 "></span>    <span class=n>column_transformers</span><span class=p>,</span>  <span class=c1># type: Dict[str, TransformerFactory]</span>
<span class=linenos data-linenos=" 73 "></span>    <span class=n>extra_transformers</span><span class=p>,</span>  <span class=c1># type: Dict[str, TransformerFactory]</span>
<span class=linenos data-linenos=" 74 "></span><span class=p>):</span>
<span class=linenos data-linenos=" 75 "></span>    <span class=c1># type: (...) -&gt; None</span>
<span class=linenos data-linenos=" 76 "></span>
<span class=linenos data-linenos=" 77 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 78 "></span><span class=sd>    This idempotent method will be called by `QueryManager.compile_queries` so you</span>
<span class=linenos data-linenos=" 79 "></span><span class=sd>    should never need to call it directly.</span>
<span class=linenos data-linenos=" 80 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos=" 81 "></span>    <span class=c1># Check for previous compilation</span>
<span class=linenos data-linenos=" 82 "></span>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos=" 83 "></span>        <span class=k>return</span>
<span class=linenos data-linenos=" 84 "></span>
<span class=linenos data-linenos=" 85 "></span>    <span class=n>query_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 86 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=n>query_name</span><span class=p>:</span>
<span class=linenos data-linenos=" 87 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;query field `name` is required&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 88 "></span>    <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>query_name</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos=" 89 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;query field `name` must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 90 "></span>
<span class=linenos data-linenos=" 91 "></span>    <span class=n>metric_prefix</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;metric_prefix&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 92 "></span>    <span class=k>if</span> <span class=n>metric_prefix</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos=" 93 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>metric_prefix</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos=" 94 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `metric_prefix` for </span><span class=si>{}</span><span class=s1> must be a string&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos=" 95 "></span>        <span class=k>elif</span> <span class=ow>not</span> <span class=n>metric_prefix</span><span class=p>:</span>
<span class=linenos data-linenos=" 96 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `metric_prefix` for </span><span class=si>{}</span><span class=s1> must not be empty&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos=" 97 "></span>
<span class=linenos data-linenos=" 98 "></span>    <span class=n>query</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;query&#39;</span><span class=p>)</span>
<span class=linenos data-linenos=" 99 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=n>query</span><span class=p>:</span>
<span class=linenos data-linenos="100 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `query` for </span><span class=si>{}</span><span class=s1> is required&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="101 "></span>    <span class=k>elif</span> <span class=n>query_name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;custom query #&#39;</span><span class=p>)</span> <span class=ow>and</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="102 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `query` for </span><span class=si>{}</span><span class=s1> must be a string&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="103 "></span>
<span class=linenos data-linenos="104 "></span>    <span class=n>columns</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;columns&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="105 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=n>columns</span><span class=p>:</span>
<span class=linenos data-linenos="106 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `columns` for </span><span class=si>{}</span><span class=s1> is required&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="107 "></span>    <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>columns</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="108 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `columns` for </span><span class=si>{}</span><span class=s1> must be a list&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="109 "></span>
<span class=linenos data-linenos="110 "></span>    <span class=n>tags</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;tags&#39;</span><span class=p>,</span> <span class=p>[])</span>
<span class=linenos data-linenos="111 "></span>    <span class=k>if</span> <span class=n>tags</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tags</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="112 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `tags` for </span><span class=si>{}</span><span class=s1> must be a list&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="113 "></span>
<span class=linenos data-linenos="114 "></span>    <span class=c1># Keep track of all defined names</span>
<span class=linenos data-linenos="115 "></span>    <span class=n>sources</span> <span class=o>=</span> <span class=p>{}</span>
<span class=linenos data-linenos="116 "></span>
<span class=linenos data-linenos="117 "></span>    <span class=n>column_data</span> <span class=o>=</span> <span class=p>[]</span>
<span class=linenos data-linenos="118 "></span>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>column</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>columns</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="119 "></span>        <span class=c1># Columns can be ignored via configuration.</span>
<span class=linenos data-linenos="120 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=n>column</span><span class=p>:</span>
<span class=linenos data-linenos="121 "></span>            <span class=n>column_data</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>))</span>
<span class=linenos data-linenos="122 "></span>            <span class=k>continue</span>
<span class=linenos data-linenos="123 "></span>        <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>column</span><span class=p>,</span> <span class=nb>dict</span><span class=p>):</span>
<span class=linenos data-linenos="124 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;column #</span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> is not a mapping&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="125 "></span>
<span class=linenos data-linenos="126 "></span>        <span class=n>column_name</span> <span class=o>=</span> <span class=n>column</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="127 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=n>column_name</span><span class=p>:</span>
<span class=linenos data-linenos="128 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `name` for column #</span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> is required&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="129 "></span>        <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>column_name</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="130 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `name` for column #</span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> must be a string&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="131 "></span>        <span class=k>elif</span> <span class=n>column_name</span> <span class=ow>in</span> <span class=n>sources</span><span class=p>:</span>
<span class=linenos data-linenos="132 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
<span class=linenos data-linenos="133 "></span>                <span class=s1>&#39;the name </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> was already defined in </span><span class=si>{}</span><span class=s1> #</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
<span class=linenos data-linenos="134 "></span>                    <span class=n>column_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>,</span> <span class=n>sources</span><span class=p>[</span><span class=n>column_name</span><span class=p>][</span><span class=s1>&#39;type&#39;</span><span class=p>],</span> <span class=n>sources</span><span class=p>[</span><span class=n>column_name</span><span class=p>][</span><span class=s1>&#39;index&#39;</span><span class=p>]</span>
<span class=linenos data-linenos="135 "></span>                <span class=p>)</span>
<span class=linenos data-linenos="136 "></span>            <span class=p>)</span>
<span class=linenos data-linenos="137 "></span>
<span class=linenos data-linenos="138 "></span>        <span class=n>sources</span><span class=p>[</span><span class=n>column_name</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;column&#39;</span><span class=p>,</span> <span class=s1>&#39;index&#39;</span><span class=p>:</span> <span class=n>i</span><span class=p>}</span>
<span class=linenos data-linenos="139 "></span>
<span class=linenos data-linenos="140 "></span>        <span class=n>column_type</span> <span class=o>=</span> <span class=n>column</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;type&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="141 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=n>column_type</span><span class=p>:</span>
<span class=linenos data-linenos="142 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `type` for column </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> is required&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>column_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="143 "></span>        <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>column_type</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="144 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `type` for column </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> must be a string&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>column_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="145 "></span>        <span class=k>elif</span> <span class=n>column_type</span> <span class=o>==</span> <span class=s1>&#39;source&#39;</span><span class=p>:</span>
<span class=linenos data-linenos="146 "></span>            <span class=n>column_data</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>column_name</span><span class=p>,</span> <span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>)))</span>
<span class=linenos data-linenos="147 "></span>            <span class=k>continue</span>
<span class=linenos data-linenos="148 "></span>        <span class=k>elif</span> <span class=n>column_type</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>column_transformers</span><span class=p>:</span>
<span class=linenos data-linenos="149 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;unknown type `</span><span class=si>{}</span><span class=s1>` for column </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>column_type</span><span class=p>,</span> <span class=n>column_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="150 "></span>
<span class=linenos data-linenos="151 "></span>        <span class=n>__column_type_is_tag</span> <span class=o>=</span> <span class=n>column_type</span> <span class=ow>in</span> <span class=p>(</span><span class=s1>&#39;tag&#39;</span><span class=p>,</span> <span class=s1>&#39;tag_list&#39;</span><span class=p>,</span> <span class=s1>&#39;tag_not_null&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="152 "></span>        <span class=n>modifiers</span> <span class=o>=</span> <span class=p>{</span><span class=n>key</span><span class=p>:</span> <span class=n>value</span> <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>column</span><span class=o>.</span><span class=n>items</span><span class=p>()</span> <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=s1>&#39;type&#39;</span><span class=p>)}</span>
<span class=linenos data-linenos="153 "></span>
<span class=linenos data-linenos="154 "></span>        <span class=k>try</span><span class=p>:</span>
<span class=linenos data-linenos="155 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>__column_type_is_tag</span> <span class=ow>and</span> <span class=n>metric_prefix</span><span class=p>:</span>
<span class=linenos data-linenos="156 "></span>                <span class=c1># if metric_prefix is defined, we prepend it to the column name</span>
<span class=linenos data-linenos="157 "></span>                <span class=n>column_name</span> <span class=o>=</span> <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>.</span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>metric_prefix</span><span class=p>,</span> <span class=n>column_name</span><span class=p>)</span>
<span class=linenos data-linenos="158 "></span>            <span class=n>transformer</span> <span class=o>=</span> <span class=n>column_transformers</span><span class=p>[</span><span class=n>column_type</span><span class=p>](</span><span class=n>column_transformers</span><span class=p>,</span> <span class=n>column_name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>)</span>
<span class=linenos data-linenos="159 "></span>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<span class=linenos data-linenos="160 "></span>            <span class=n>error</span> <span class=o>=</span> <span class=s1>&#39;error compiling type `</span><span class=si>{}</span><span class=s1>` for column </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1>: </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
<span class=linenos data-linenos="161 "></span>                <span class=n>column_type</span><span class=p>,</span> <span class=n>column_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>,</span> <span class=n>e</span>
<span class=linenos data-linenos="162 "></span>            <span class=p>)</span>
<span class=linenos data-linenos="163 "></span>
<span class=linenos data-linenos="164 "></span>            <span class=c1># Prepend helpful error text.</span>
<span class=linenos data-linenos="165 "></span>            <span class=c1>#</span>
<span class=linenos data-linenos="166 "></span>            <span class=c1># When an exception is raised in the context of another one, both will be printed. To avoid</span>
<span class=linenos data-linenos="167 "></span>            <span class=c1># this we set the context to None. https://www.python.org/dev/peps/pep-0409/</span>
<span class=linenos data-linenos="168 "></span>            <span class=n>raise_from</span><span class=p>(</span><span class=nb>type</span><span class=p>(</span><span class=n>e</span><span class=p>)(</span><span class=n>error</span><span class=p>),</span> <span class=kc>None</span><span class=p>)</span>
<span class=linenos data-linenos="169 "></span>        <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="170 "></span>            <span class=k>if</span> <span class=n>__column_type_is_tag</span><span class=p>:</span>
<span class=linenos data-linenos="171 "></span>                <span class=n>column_data</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>column_name</span><span class=p>,</span> <span class=p>(</span><span class=n>column_type</span><span class=p>,</span> <span class=n>transformer</span><span class=p>)))</span>
<span class=linenos data-linenos="172 "></span>            <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="173 "></span>                <span class=c1># All these would actually submit data. As that is the default case, we represent it as</span>
<span class=linenos data-linenos="174 "></span>                <span class=c1># a reference to None since if we use e.g. `value` it would never be checked anyway.</span>
<span class=linenos data-linenos="175 "></span>                <span class=n>column_data</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>column_name</span><span class=p>,</span> <span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=n>transformer</span><span class=p>)))</span>
<span class=linenos data-linenos="176 "></span>
<span class=linenos data-linenos="177 "></span>    <span class=n>submission_transformers</span> <span class=o>=</span> <span class=n>column_transformers</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>  <span class=c1># type: Dict[str, Transformer]</span>
<span class=linenos data-linenos="178 "></span>    <span class=n>submission_transformers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;tag&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="179 "></span>    <span class=n>submission_transformers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;tag_list&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="180 "></span>    <span class=n>submission_transformers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;tag_not_null&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="181 "></span>
<span class=linenos data-linenos="182 "></span>    <span class=n>extras</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;extras&#39;</span><span class=p>,</span> <span class=p>[])</span>  <span class=c1># type: List[Dict[str, Any]]</span>
<span class=linenos data-linenos="183 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>extras</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
<span class=linenos data-linenos="184 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `extras` for </span><span class=si>{}</span><span class=s1> must be a list&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="185 "></span>
<span class=linenos data-linenos="186 "></span>    <span class=n>extra_data</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># type: List[Tuple[str, Transformer]]</span>
<span class=linenos data-linenos="187 "></span>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>extra</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>extras</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="188 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>extra</span><span class=p>,</span> <span class=nb>dict</span><span class=p>):</span>
<span class=linenos data-linenos="189 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;extra #</span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> is not a mapping&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="190 "></span>
<span class=linenos data-linenos="191 "></span>        <span class=n>extra_name</span> <span class=o>=</span> <span class=n>extra</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>  <span class=c1># type: str</span>
<span class=linenos data-linenos="192 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=n>extra_name</span><span class=p>:</span>
<span class=linenos data-linenos="193 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `name` for extra #</span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> is required&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="194 "></span>        <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>extra_name</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="195 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `name` for extra #</span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> must be a string&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="196 "></span>        <span class=k>elif</span> <span class=n>extra_name</span> <span class=ow>in</span> <span class=n>sources</span><span class=p>:</span>
<span class=linenos data-linenos="197 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
<span class=linenos data-linenos="198 "></span>                <span class=s1>&#39;the name </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> was already defined in </span><span class=si>{}</span><span class=s1> #</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
<span class=linenos data-linenos="199 "></span>                    <span class=n>extra_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>,</span> <span class=n>sources</span><span class=p>[</span><span class=n>extra_name</span><span class=p>][</span><span class=s1>&#39;type&#39;</span><span class=p>],</span> <span class=n>sources</span><span class=p>[</span><span class=n>extra_name</span><span class=p>][</span><span class=s1>&#39;index&#39;</span><span class=p>]</span>
<span class=linenos data-linenos="200 "></span>                <span class=p>)</span>
<span class=linenos data-linenos="201 "></span>            <span class=p>)</span>
<span class=linenos data-linenos="202 "></span>
<span class=linenos data-linenos="203 "></span>        <span class=n>sources</span><span class=p>[</span><span class=n>extra_name</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;extra&#39;</span><span class=p>,</span> <span class=s1>&#39;index&#39;</span><span class=p>:</span> <span class=n>i</span><span class=p>}</span>
<span class=linenos data-linenos="204 "></span>
<span class=linenos data-linenos="205 "></span>        <span class=n>extra_type</span> <span class=o>=</span> <span class=n>extra</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;type&#39;</span><span class=p>)</span>  <span class=c1># type: str  # Is the key in a transformers dict</span>
<span class=linenos data-linenos="206 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=n>extra_type</span><span class=p>:</span>
<span class=linenos data-linenos="207 "></span>            <span class=k>if</span> <span class=s1>&#39;expression&#39;</span> <span class=ow>in</span> <span class=n>extra</span><span class=p>:</span>
<span class=linenos data-linenos="208 "></span>                <span class=n>extra_type</span> <span class=o>=</span> <span class=s1>&#39;expression&#39;</span>
<span class=linenos data-linenos="209 "></span>            <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="210 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `type` for extra </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> is required&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>extra_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="211 "></span>        <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>extra_type</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="212 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `type` for extra </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> must be a string&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>extra_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="213 "></span>        <span class=k>elif</span> <span class=n>extra_type</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>extra_transformers</span> <span class=ow>and</span> <span class=n>extra_type</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>submission_transformers</span><span class=p>:</span>
<span class=linenos data-linenos="214 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;unknown type `</span><span class=si>{}</span><span class=s1>` for extra </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>extra_type</span><span class=p>,</span> <span class=n>extra_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="215 "></span>
<span class=linenos data-linenos="216 "></span>        <span class=n>transformer_factory</span> <span class=o>=</span> <span class=n>extra_transformers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span>
<span class=linenos data-linenos="217 "></span>            <span class=n>extra_type</span><span class=p>,</span> <span class=n>submission_transformers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>extra_type</span><span class=p>)</span>
<span class=linenos data-linenos="218 "></span>        <span class=p>)</span>  <span class=c1># type: TransformerFactory</span>
<span class=linenos data-linenos="219 "></span>
<span class=linenos data-linenos="220 "></span>        <span class=n>extra_source</span> <span class=o>=</span> <span class=n>extra</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;source&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="221 "></span>        <span class=k>if</span> <span class=n>extra_type</span> <span class=ow>in</span> <span class=n>submission_transformers</span><span class=p>:</span>
<span class=linenos data-linenos="222 "></span>            <span class=k>if</span> <span class=ow>not</span> <span class=n>extra_source</span><span class=p>:</span>
<span class=linenos data-linenos="223 "></span>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `source` for extra </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1> is required&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>extra_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="224 "></span>
<span class=linenos data-linenos="225 "></span>            <span class=n>modifiers</span> <span class=o>=</span> <span class=p>{</span><span class=n>key</span><span class=p>:</span> <span class=n>value</span> <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>extra</span><span class=o>.</span><span class=n>items</span><span class=p>()</span> <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=s1>&#39;type&#39;</span><span class=p>,</span> <span class=s1>&#39;source&#39;</span><span class=p>)}</span>
<span class=linenos data-linenos="226 "></span>        <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="227 "></span>            <span class=n>modifiers</span> <span class=o>=</span> <span class=p>{</span><span class=n>key</span><span class=p>:</span> <span class=n>value</span> <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>extra</span><span class=o>.</span><span class=n>items</span><span class=p>()</span> <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=s1>&#39;type&#39;</span><span class=p>)}</span>
<span class=linenos data-linenos="228 "></span>            <span class=n>modifiers</span><span class=p>[</span><span class=s1>&#39;sources&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>sources</span>
<span class=linenos data-linenos="229 "></span>
<span class=linenos data-linenos="230 "></span>        <span class=k>try</span><span class=p>:</span>
<span class=linenos data-linenos="231 "></span>            <span class=n>transformer</span> <span class=o>=</span> <span class=n>transformer_factory</span><span class=p>(</span><span class=n>submission_transformers</span><span class=p>,</span> <span class=n>extra_name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>)</span>
<span class=linenos data-linenos="232 "></span>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<span class=linenos data-linenos="233 "></span>            <span class=n>error</span> <span class=o>=</span> <span class=s1>&#39;error compiling type `</span><span class=si>{}</span><span class=s1>` for extra </span><span class=si>{}</span><span class=s1> of </span><span class=si>{}</span><span class=s1>: </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>extra_type</span><span class=p>,</span> <span class=n>extra_name</span><span class=p>,</span> <span class=n>query_name</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
<span class=linenos data-linenos="234 "></span>
<span class=linenos data-linenos="235 "></span>            <span class=n>raise_from</span><span class=p>(</span><span class=nb>type</span><span class=p>(</span><span class=n>e</span><span class=p>)(</span><span class=n>error</span><span class=p>),</span> <span class=kc>None</span><span class=p>)</span>
<span class=linenos data-linenos="236 "></span>        <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="237 "></span>            <span class=k>if</span> <span class=n>extra_type</span> <span class=ow>in</span> <span class=n>submission_transformers</span><span class=p>:</span>
<span class=linenos data-linenos="238 "></span>                <span class=n>transformer</span> <span class=o>=</span> <span class=n>create_extra_transformer</span><span class=p>(</span><span class=n>transformer</span><span class=p>,</span> <span class=n>extra_source</span><span class=p>)</span>
<span class=linenos data-linenos="239 "></span>
<span class=linenos data-linenos="240 "></span>            <span class=n>extra_data</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>extra_name</span><span class=p>,</span> <span class=n>transformer</span><span class=p>))</span>
<span class=linenos data-linenos="241 "></span>
<span class=linenos data-linenos="242 "></span>    <span class=n>collection_interval</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;collection_interval&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="243 "></span>    <span class=k>if</span> <span class=n>collection_interval</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="244 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>collection_interval</span><span class=p>,</span> <span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>)):</span>
<span class=linenos data-linenos="245 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;field `collection_interval` for </span><span class=si>{}</span><span class=s1> must be a number&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>))</span>
<span class=linenos data-linenos="246 "></span>        <span class=k>elif</span> <span class=nb>int</span><span class=p>(</span><span class=n>collection_interval</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
<span class=linenos data-linenos="247 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
<span class=linenos data-linenos="248 "></span>                <span class=s1>&#39;field `collection_interval` for </span><span class=si>{}</span><span class=s1> must be a positive number after rounding&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>query_name</span><span class=p>)</span>
<span class=linenos data-linenos="249 "></span>            <span class=p>)</span>
<span class=linenos data-linenos="250 "></span>        <span class=n>collection_interval</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>collection_interval</span><span class=p>)</span>
<span class=linenos data-linenos="251 "></span>
<span class=linenos data-linenos="252 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>query_name</span>
<span class=linenos data-linenos="253 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>query</span> <span class=o>=</span> <span class=n>query</span>
<span class=linenos data-linenos="254 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>column_transformers</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>column_data</span><span class=p>)</span>
<span class=linenos data-linenos="255 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>extra_transformers</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>extra_data</span><span class=p>)</span>
<span class=linenos data-linenos="256 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>base_tags</span> <span class=o>=</span> <span class=n>tags</span>
<span class=linenos data-linenos="257 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>collection_interval</span> <span class=o>=</span> <span class=n>collection_interval</span>
<span class=linenos data-linenos="258 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>metric_name_raw</span> <span class=o>=</span> <span class=n>metric_prefix</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
<span class=linenos data-linenos="259 "></span>    <span class=k>del</span> <span class=bp>self</span><span class=o>.</span><span class=n>query_data</span>
</code></pre></div> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-class"> <h3 id=datadog_checks.base.utils.db.core.QueryManager class="doc doc-heading"> <code>datadog_checks.base.utils.db.core.QueryManager</code> <a href=#datadog_checks.base.utils.db.core.QueryManager class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents first"> <p>This class is in charge of running any number of <code>Query</code> instances for a single Check instance.</p> <p>You will most often see it created during Check initialization like this:</p> <div class=highlight><pre><span></span><code><span class=bp>self</span><span class=o>.</span><span class=n>_query_manager</span> <span class=o>=</span> <span class=n>QueryManager</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>execute_query</span><span class=p>,</span>
    <span class=n>queries</span><span class=o>=</span><span class=p>[</span>
        <span class=n>queries</span><span class=o>.</span><span class=n>SomeQuery1</span><span class=p>,</span>
        <span class=n>queries</span><span class=o>.</span><span class=n>SomeQuery2</span><span class=p>,</span>
        <span class=n>queries</span><span class=o>.</span><span class=n>SomeQuery3</span><span class=p>,</span>
        <span class=n>queries</span><span class=o>.</span><span class=n>SomeQuery4</span><span class=p>,</span>
        <span class=n>queries</span><span class=o>.</span><span class=n>SomeQuery5</span><span class=p>,</span>
    <span class=p>],</span>
    <span class=n>tags</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>instance</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;tags&#39;</span><span class=p>,</span> <span class=p>[]),</span>
    <span class=n>error_handler</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_error_sanitizer</span><span class=p>,</span>
<span class=p>)</span>
<span class=bp>self</span><span class=o>.</span><span class=n>check_initializations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_query_manager</span><span class=o>.</span><span class=n>compile_queries</span><span class=p>)</span>
</code></pre></div> <p>Note: This class is not in charge of opening or closing connections, just running queries.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/utils/db/core.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="181 "></span><span class=k>class</span> <span class=nc>QueryManager</span><span class=p>(</span><span class=n>QueryExecutor</span><span class=p>):</span>
<span class=linenos data-linenos="182 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="183 "></span><span class=sd>    This class is in charge of running any number of `Query` instances for a single Check instance.</span>
<span class=linenos data-linenos="184 "></span>
<span class=linenos data-linenos="185 "></span><span class=sd>    You will most often see it created during Check initialization like this:</span>
<span class=linenos data-linenos="186 "></span>
<span class=linenos data-linenos="187 "></span><span class=sd>    ```python</span>
<span class=linenos data-linenos="188 "></span><span class=sd>    self._query_manager = QueryManager(</span>
<span class=linenos data-linenos="189 "></span><span class=sd>        self,</span>
<span class=linenos data-linenos="190 "></span><span class=sd>        self.execute_query,</span>
<span class=linenos data-linenos="191 "></span><span class=sd>        queries=[</span>
<span class=linenos data-linenos="192 "></span><span class=sd>            queries.SomeQuery1,</span>
<span class=linenos data-linenos="193 "></span><span class=sd>            queries.SomeQuery2,</span>
<span class=linenos data-linenos="194 "></span><span class=sd>            queries.SomeQuery3,</span>
<span class=linenos data-linenos="195 "></span><span class=sd>            queries.SomeQuery4,</span>
<span class=linenos data-linenos="196 "></span><span class=sd>            queries.SomeQuery5,</span>
<span class=linenos data-linenos="197 "></span><span class=sd>        ],</span>
<span class=linenos data-linenos="198 "></span><span class=sd>        tags=self.instance.get(&#39;tags&#39;, []),</span>
<span class=linenos data-linenos="199 "></span><span class=sd>        error_handler=self._error_sanitizer,</span>
<span class=linenos data-linenos="200 "></span><span class=sd>    )</span>
<span class=linenos data-linenos="201 "></span><span class=sd>    self.check_initializations.append(self._query_manager.compile_queries)</span>
<span class=linenos data-linenos="202 "></span><span class=sd>    ```</span>
<span class=linenos data-linenos="203 "></span>
<span class=linenos data-linenos="204 "></span><span class=sd>    Note: This class is not in charge of opening or closing connections, just running queries.</span>
<span class=linenos data-linenos="205 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="206 "></span>
<span class=linenos data-linenos="207 "></span>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
<span class=linenos data-linenos="208 "></span>        <span class=bp>self</span><span class=p>,</span>
<span class=linenos data-linenos="209 "></span>        <span class=n>check</span><span class=p>,</span>  <span class=c1># type: AgentCheck</span>
<span class=linenos data-linenos="210 "></span>        <span class=n>executor</span><span class=p>,</span>  <span class=c1># type:  QueriesExecutor</span>
<span class=linenos data-linenos="211 "></span>        <span class=n>queries</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>  <span class=c1># type: List[Dict[str, Any]]</span>
<span class=linenos data-linenos="212 "></span>        <span class=n>tags</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>  <span class=c1># type: List[str]</span>
<span class=linenos data-linenos="213 "></span>        <span class=n>error_handler</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>  <span class=c1># type: Callable[[str], str]</span>
<span class=linenos data-linenos="214 "></span>        <span class=n>hostname</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>  <span class=c1># type: str</span>
<span class=linenos data-linenos="215 "></span>    <span class=p>):</span>  <span class=c1># type: (...) -&gt; QueryManager</span>
<span class=linenos data-linenos="216 "></span><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="217 "></span><span class=sd>        - **check** (_AgentCheck_) - an instance of a Check</span>
<span class=linenos data-linenos="218 "></span><span class=sd>        - **executor** (_callable_) - a callable accepting a `str` query as its sole argument and returning</span>
<span class=linenos data-linenos="219 "></span><span class=sd>          a sequence representing either the full result set or an iterator over the result set</span>
<span class=linenos data-linenos="220 "></span><span class=sd>        - **queries** (_List[Dict]_) - a list of queries in dict format</span>
<span class=linenos data-linenos="221 "></span><span class=sd>        - **tags** (_List[str]_) - a list of tags to associate with every submission</span>
<span class=linenos data-linenos="222 "></span><span class=sd>        - **error_handler** (_callable_) - a callable accepting a `str` error as its sole argument and returning</span>
<span class=linenos data-linenos="223 "></span><span class=sd>          a sanitized string, useful for scrubbing potentially sensitive information libraries emit</span>
<span class=linenos data-linenos="224 "></span><span class=sd>        &quot;&quot;&quot;</span>
<span class=linenos data-linenos="225 "></span>        <span class=nb>super</span><span class=p>(</span><span class=n>QueryManager</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span>
<span class=linenos data-linenos="226 "></span>            <span class=n>executor</span><span class=o>=</span><span class=n>executor</span><span class=p>,</span>
<span class=linenos data-linenos="227 "></span>            <span class=n>submitter</span><span class=o>=</span><span class=n>check</span><span class=p>,</span>
<span class=linenos data-linenos="228 "></span>            <span class=n>queries</span><span class=o>=</span><span class=n>queries</span><span class=p>,</span>
<span class=linenos data-linenos="229 "></span>            <span class=n>tags</span><span class=o>=</span><span class=n>tags</span><span class=p>,</span>
<span class=linenos data-linenos="230 "></span>            <span class=n>error_handler</span><span class=o>=</span><span class=n>error_handler</span><span class=p>,</span>
<span class=linenos data-linenos="231 "></span>            <span class=n>hostname</span><span class=o>=</span><span class=n>hostname</span><span class=p>,</span>
<span class=linenos data-linenos="232 "></span>            <span class=n>logger</span><span class=o>=</span><span class=n>check</span><span class=o>.</span><span class=n>log</span><span class=p>,</span>
<span class=linenos data-linenos="233 "></span>        <span class=p>)</span>
<span class=linenos data-linenos="234 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>check</span> <span class=o>=</span> <span class=n>check</span>  <span class=c1># type: AgentCheck</span>
<span class=linenos data-linenos="235 "></span>
<span class=linenos data-linenos="236 "></span>        <span class=n>only_custom_queries</span> <span class=o>=</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>instance</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;only_custom_queries&#39;</span><span class=p>,</span> <span class=kc>False</span><span class=p>))</span>  <span class=c1># type: bool</span>
<span class=linenos data-linenos="237 "></span>        <span class=n>custom_queries</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>instance</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;custom_queries&#39;</span><span class=p>,</span> <span class=p>[]))</span>  <span class=c1># type: List[str]</span>
<span class=linenos data-linenos="238 "></span>        <span class=n>use_global_custom_queries</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>instance</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;use_global_custom_queries&#39;</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>  <span class=c1># type: str</span>
<span class=linenos data-linenos="239 "></span>
<span class=linenos data-linenos="240 "></span>        <span class=c1># Handle overrides</span>
<span class=linenos data-linenos="241 "></span>        <span class=k>if</span> <span class=n>use_global_custom_queries</span> <span class=o>==</span> <span class=s1>&#39;extend&#39;</span><span class=p>:</span>
<span class=linenos data-linenos="242 "></span>            <span class=n>custom_queries</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>init_config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;global_custom_queries&#39;</span><span class=p>,</span> <span class=p>[]))</span>
<span class=linenos data-linenos="243 "></span>        <span class=k>elif</span> <span class=p>(</span>
<span class=linenos data-linenos="244 "></span>            <span class=ow>not</span> <span class=n>custom_queries</span>
<span class=linenos data-linenos="245 "></span>            <span class=ow>and</span> <span class=s1>&#39;global_custom_queries&#39;</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>init_config</span>
<span class=linenos data-linenos="246 "></span>            <span class=ow>and</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=n>use_global_custom_queries</span><span class=p>)</span>
<span class=linenos data-linenos="247 "></span>        <span class=p>):</span>
<span class=linenos data-linenos="248 "></span>            <span class=n>custom_queries</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>init_config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;global_custom_queries&#39;</span><span class=p>,</span> <span class=p>[])</span>
<span class=linenos data-linenos="249 "></span>
<span class=linenos data-linenos="250 "></span>        <span class=c1># Override statement queries if only running custom queries</span>
<span class=linenos data-linenos="251 "></span>        <span class=k>if</span> <span class=n>only_custom_queries</span><span class=p>:</span>
<span class=linenos data-linenos="252 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>queries</span> <span class=o>=</span> <span class=p>[]</span>
<span class=linenos data-linenos="253 "></span>
<span class=linenos data-linenos="254 "></span>        <span class=c1># Deduplicate</span>
<span class=linenos data-linenos="255 "></span>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>custom_query</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>iter_unique</span><span class=p>(</span><span class=n>custom_queries</span><span class=p>),</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="256 "></span>            <span class=n>query</span> <span class=o>=</span> <span class=n>Query</span><span class=p>(</span><span class=n>custom_query</span><span class=p>)</span>
<span class=linenos data-linenos="257 "></span>            <span class=n>query</span><span class=o>.</span><span class=n>query_data</span><span class=o>.</span><span class=n>setdefault</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=s1>&#39;custom query #</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
<span class=linenos data-linenos="258 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>queries</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
<span class=linenos data-linenos="259 "></span>
<span class=linenos data-linenos="260 "></span>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>queries</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
<span class=linenos data-linenos="261 "></span>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s1>&#39;QueryManager initialized with no query&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="262 "></span>
<span class=linenos data-linenos="263 "></span>    <span class=k>def</span> <span class=nf>execute</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>extra_tags</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<span class=linenos data-linenos="264 "></span>        <span class=c1># This needs to stay here b/c when we construct a QueryManager in a check&#39;s __init__</span>
<span class=linenos data-linenos="265 "></span>        <span class=c1># there is no check ID at that point</span>
<span class=linenos data-linenos="266 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>log</span>
<span class=linenos data-linenos="267 "></span>
<span class=linenos data-linenos="268 "></span>        <span class=k>return</span> <span class=nb>super</span><span class=p>(</span><span class=n>QueryManager</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>extra_tags</span><span class=p>)</span>
</code></pre></div> </details> <div class="doc doc-children"> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.utils.db.core.QueryManager.__init__ class="doc doc-heading"> <code class="highlight language-python"><span class=fm>__init__</span><span class=p>(</span><span class=n>check</span><span class=p>,</span> <span class=n>executor</span><span class=p>,</span> <span class=n>queries</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>tags</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>error_handler</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>hostname</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span></code> <a href=#datadog_checks.base.utils.db.core.QueryManager.__init__ class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <ul> <li><strong>check</strong> (<em>AgentCheck</em>) - an instance of a Check</li> <li><strong>executor</strong> (<em>callable</em>) - a callable accepting a <code>str</code> query as its sole argument and returning a sequence representing either the full result set or an iterator over the result set</li> <li><strong>queries</strong> (<em>List[Dict]</em>) - a list of queries in dict format</li> <li><strong>tags</strong> (<em>List[str]</em>) - a list of tags to associate with every submission</li> <li><strong>error_handler</strong> (<em>callable</em>) - a callable accepting a <code>str</code> error as its sole argument and returning a sanitized string, useful for scrubbing potentially sensitive information libraries emit</li> </ul> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/utils/db/core.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="207 "></span><span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
<span class=linenos data-linenos="208 "></span>    <span class=bp>self</span><span class=p>,</span>
<span class=linenos data-linenos="209 "></span>    <span class=n>check</span><span class=p>,</span>  <span class=c1># type: AgentCheck</span>
<span class=linenos data-linenos="210 "></span>    <span class=n>executor</span><span class=p>,</span>  <span class=c1># type:  QueriesExecutor</span>
<span class=linenos data-linenos="211 "></span>    <span class=n>queries</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>  <span class=c1># type: List[Dict[str, Any]]</span>
<span class=linenos data-linenos="212 "></span>    <span class=n>tags</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>  <span class=c1># type: List[str]</span>
<span class=linenos data-linenos="213 "></span>    <span class=n>error_handler</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>  <span class=c1># type: Callable[[str], str]</span>
<span class=linenos data-linenos="214 "></span>    <span class=n>hostname</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>  <span class=c1># type: str</span>
<span class=linenos data-linenos="215 "></span><span class=p>):</span>  <span class=c1># type: (...) -&gt; QueryManager</span>
<span class=linenos data-linenos="216 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="217 "></span><span class=sd>    - **check** (_AgentCheck_) - an instance of a Check</span>
<span class=linenos data-linenos="218 "></span><span class=sd>    - **executor** (_callable_) - a callable accepting a `str` query as its sole argument and returning</span>
<span class=linenos data-linenos="219 "></span><span class=sd>      a sequence representing either the full result set or an iterator over the result set</span>
<span class=linenos data-linenos="220 "></span><span class=sd>    - **queries** (_List[Dict]_) - a list of queries in dict format</span>
<span class=linenos data-linenos="221 "></span><span class=sd>    - **tags** (_List[str]_) - a list of tags to associate with every submission</span>
<span class=linenos data-linenos="222 "></span><span class=sd>    - **error_handler** (_callable_) - a callable accepting a `str` error as its sole argument and returning</span>
<span class=linenos data-linenos="223 "></span><span class=sd>      a sanitized string, useful for scrubbing potentially sensitive information libraries emit</span>
<span class=linenos data-linenos="224 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="225 "></span>    <span class=nb>super</span><span class=p>(</span><span class=n>QueryManager</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span>
<span class=linenos data-linenos="226 "></span>        <span class=n>executor</span><span class=o>=</span><span class=n>executor</span><span class=p>,</span>
<span class=linenos data-linenos="227 "></span>        <span class=n>submitter</span><span class=o>=</span><span class=n>check</span><span class=p>,</span>
<span class=linenos data-linenos="228 "></span>        <span class=n>queries</span><span class=o>=</span><span class=n>queries</span><span class=p>,</span>
<span class=linenos data-linenos="229 "></span>        <span class=n>tags</span><span class=o>=</span><span class=n>tags</span><span class=p>,</span>
<span class=linenos data-linenos="230 "></span>        <span class=n>error_handler</span><span class=o>=</span><span class=n>error_handler</span><span class=p>,</span>
<span class=linenos data-linenos="231 "></span>        <span class=n>hostname</span><span class=o>=</span><span class=n>hostname</span><span class=p>,</span>
<span class=linenos data-linenos="232 "></span>        <span class=n>logger</span><span class=o>=</span><span class=n>check</span><span class=o>.</span><span class=n>log</span><span class=p>,</span>
<span class=linenos data-linenos="233 "></span>    <span class=p>)</span>
<span class=linenos data-linenos="234 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>check</span> <span class=o>=</span> <span class=n>check</span>  <span class=c1># type: AgentCheck</span>
<span class=linenos data-linenos="235 "></span>
<span class=linenos data-linenos="236 "></span>    <span class=n>only_custom_queries</span> <span class=o>=</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>instance</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;only_custom_queries&#39;</span><span class=p>,</span> <span class=kc>False</span><span class=p>))</span>  <span class=c1># type: bool</span>
<span class=linenos data-linenos="237 "></span>    <span class=n>custom_queries</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>instance</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;custom_queries&#39;</span><span class=p>,</span> <span class=p>[]))</span>  <span class=c1># type: List[str]</span>
<span class=linenos data-linenos="238 "></span>    <span class=n>use_global_custom_queries</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>instance</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;use_global_custom_queries&#39;</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>  <span class=c1># type: str</span>
<span class=linenos data-linenos="239 "></span>
<span class=linenos data-linenos="240 "></span>    <span class=c1># Handle overrides</span>
<span class=linenos data-linenos="241 "></span>    <span class=k>if</span> <span class=n>use_global_custom_queries</span> <span class=o>==</span> <span class=s1>&#39;extend&#39;</span><span class=p>:</span>
<span class=linenos data-linenos="242 "></span>        <span class=n>custom_queries</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>init_config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;global_custom_queries&#39;</span><span class=p>,</span> <span class=p>[]))</span>
<span class=linenos data-linenos="243 "></span>    <span class=k>elif</span> <span class=p>(</span>
<span class=linenos data-linenos="244 "></span>        <span class=ow>not</span> <span class=n>custom_queries</span>
<span class=linenos data-linenos="245 "></span>        <span class=ow>and</span> <span class=s1>&#39;global_custom_queries&#39;</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>init_config</span>
<span class=linenos data-linenos="246 "></span>        <span class=ow>and</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=n>use_global_custom_queries</span><span class=p>)</span>
<span class=linenos data-linenos="247 "></span>    <span class=p>):</span>
<span class=linenos data-linenos="248 "></span>        <span class=n>custom_queries</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>init_config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;global_custom_queries&#39;</span><span class=p>,</span> <span class=p>[])</span>
<span class=linenos data-linenos="249 "></span>
<span class=linenos data-linenos="250 "></span>    <span class=c1># Override statement queries if only running custom queries</span>
<span class=linenos data-linenos="251 "></span>    <span class=k>if</span> <span class=n>only_custom_queries</span><span class=p>:</span>
<span class=linenos data-linenos="252 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>queries</span> <span class=o>=</span> <span class=p>[]</span>
<span class=linenos data-linenos="253 "></span>
<span class=linenos data-linenos="254 "></span>    <span class=c1># Deduplicate</span>
<span class=linenos data-linenos="255 "></span>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>custom_query</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>iter_unique</span><span class=p>(</span><span class=n>custom_queries</span><span class=p>),</span> <span class=mi>1</span><span class=p>):</span>
<span class=linenos data-linenos="256 "></span>        <span class=n>query</span> <span class=o>=</span> <span class=n>Query</span><span class=p>(</span><span class=n>custom_query</span><span class=p>)</span>
<span class=linenos data-linenos="257 "></span>        <span class=n>query</span><span class=o>.</span><span class=n>query_data</span><span class=o>.</span><span class=n>setdefault</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=s1>&#39;custom query #</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
<span class=linenos data-linenos="258 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>queries</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
<span class=linenos data-linenos="259 "></span>
<span class=linenos data-linenos="260 "></span>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>queries</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
<span class=linenos data-linenos="261 "></span>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s1>&#39;QueryManager initialized with no query&#39;</span><span class=p>)</span>
</code></pre></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h4 id=datadog_checks.base.utils.db.core.QueryManager.execute class="doc doc-heading"> <code class="highlight language-python"><span class=n>execute</span><span class=p>(</span><span class=n>extra_tags</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span></code> <a href=#datadog_checks.base.utils.db.core.QueryManager.execute class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/utils/db/core.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="263 "></span><span class=k>def</span> <span class=nf>execute</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>extra_tags</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<span class=linenos data-linenos="264 "></span>    <span class=c1># This needs to stay here b/c when we construct a QueryManager in a check&#39;s __init__</span>
<span class=linenos data-linenos="265 "></span>    <span class=c1># there is no check ID at that point</span>
<span class=linenos data-linenos="266 "></span>    <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>check</span><span class=o>.</span><span class=n>log</span>
<span class=linenos data-linenos="267 "></span>
<span class=linenos data-linenos="268 "></span>    <span class=k>return</span> <span class=nb>super</span><span class=p>(</span><span class=n>QueryManager</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>extra_tags</span><span class=p>)</span>
</code></pre></div> </details> </div> </div> </div> </div> </div><h2 id=transformers>Transformers<a class=headerlink href=#transformers title="Permanent link">&para;</a></h2> <p><br></p> <div align=center> <video preload=auto autoplay loop muted> <source src=https://media.giphy.com/media/3RX9sUVwyCFSo/giphy.mp4 type=video/mp4> </video> </div> <h3 id=column>Column<a class=headerlink href=#column title="Permanent link">&para;</a></h3> <h4 id=match>match<a class=headerlink href=#match title="Permanent link">&para;</a></h4> <div class="doc doc-object doc-function"> <div class="doc doc-contents first"> <p>This is used for querying unstructured data.</p> <p>For example, say you want to collect the fields named <code>foo</code> and <code>bar</code>. Typically, they would be stored like:</p> <table> <thead> <tr> <th>foo</th> <th>bar</th> </tr> </thead> <tbody> <tr> <td>4</td> <td>2</td> </tr> </tbody> </table> <p>and would be queried like:</p> <div class=highlight><pre><span></span><code><span class=k>SELECT</span><span class=w> </span><span class=n>foo</span><span class=p>,</span><span class=w> </span><span class=n>bar</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>...</span>
</code></pre></div> <p>Often, you will instead find data stored in the following format:</p> <table> <thead> <tr> <th>metric</th> <th>value</th> </tr> </thead> <tbody> <tr> <td>foo</td> <td>4</td> </tr> <tr> <td>bar</td> <td>2</td> </tr> </tbody> </table> <p>and would be queried like:</p> <div class=highlight><pre><span></span><code><span class=k>SELECT</span><span class=w> </span><span class=n>metric</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>...</span>
</code></pre></div> <p>In this case, the <code>metric</code> column stores the name with which to match on and its <code>value</code> is stored in a separate column.</p> <p>The required <code>items</code> modifier is a mapping of matched names to column data values. Consider the values to be exactly the same as the entries in the <code>columns</code> top level field. You must also define a <code>source</code> modifier either for this transformer itself or in the values of <code>items</code> (which will take precedence). The source will be treated as the value of the match.</p> <p>Say this is your configuration:</p> <div class=highlight><pre><span></span><code><span class=nt>query</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">SELECT source1, source2, metric FROM TABLE</span>
<span class=nt>columns</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">value1</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">source</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">value2</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">source</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">metric_name</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">match</span>
<span class=w>    </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">value1</span>
<span class=w>    </span><span class=nt>items</span><span class=p>:</span>
<span class=w>      </span><span class=nt>foo</span><span class=p>:</span>
<span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test.foo</span>
<span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gauge</span>
<span class=w>        </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">value2</span>
<span class=w>      </span><span class=nt>bar</span><span class=p>:</span>
<span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test.bar</span>
<span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">monotonic_gauge</span>
</code></pre></div> <p>and the result set is:</p> <table> <thead> <tr> <th>source1</th> <th>source2</th> <th>metric</th> </tr> </thead> <tbody> <tr> <td>1</td> <td>2</td> <td>foo</td> </tr> <tr> <td>3</td> <td>4</td> <td>baz</td> </tr> <tr> <td>5</td> <td>6</td> <td>bar</td> </tr> </tbody> </table> <p>Here's what would be submitted:</p> <ul> <li><code>foo</code> - <code>test.foo</code> as a <code>gauge</code> with a value of <code>2</code></li> <li><code>bar</code> - <code>test.bar.total</code> as a <code>gauge</code> and <code>test.bar.count</code> as a <code>monotonic_count</code>, both with a value of <code>5</code></li> <li><code>baz</code> - nothing since it was not defined as a match item</li> </ul> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/utils/db/transform.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="144 "></span><span class=k>def</span> <span class=nf>get_match</span><span class=p>(</span><span class=n>transformers</span><span class=p>,</span> <span class=n>column_name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>):</span>
<span class=linenos data-linenos="145 "></span>    <span class=c1># type: (Dict[str, Transformer], str, Any) -&gt; Transformer</span>
<span class=linenos data-linenos="146 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="147 "></span><span class=sd>    This is used for querying unstructured data.</span>
<span class=linenos data-linenos="148 "></span>
<span class=linenos data-linenos="149 "></span><span class=sd>    For example, say you want to collect the fields named `foo` and `bar`. Typically, they would be stored like:</span>
<span class=linenos data-linenos="150 "></span>
<span class=linenos data-linenos="151 "></span><span class=sd>    | foo | bar |</span>
<span class=linenos data-linenos="152 "></span><span class=sd>    | --- | --- |</span>
<span class=linenos data-linenos="153 "></span><span class=sd>    | 4   | 2   |</span>
<span class=linenos data-linenos="154 "></span>
<span class=linenos data-linenos="155 "></span><span class=sd>    and would be queried like:</span>
<span class=linenos data-linenos="156 "></span>
<span class=linenos data-linenos="157 "></span><span class=sd>    ```sql</span>
<span class=linenos data-linenos="158 "></span><span class=sd>    SELECT foo, bar FROM ...</span>
<span class=linenos data-linenos="159 "></span><span class=sd>    ```</span>
<span class=linenos data-linenos="160 "></span>
<span class=linenos data-linenos="161 "></span><span class=sd>    Often, you will instead find data stored in the following format:</span>
<span class=linenos data-linenos="162 "></span>
<span class=linenos data-linenos="163 "></span><span class=sd>    | metric | value |</span>
<span class=linenos data-linenos="164 "></span><span class=sd>    | ------ | ----- |</span>
<span class=linenos data-linenos="165 "></span><span class=sd>    | foo    | 4     |</span>
<span class=linenos data-linenos="166 "></span><span class=sd>    | bar    | 2     |</span>
<span class=linenos data-linenos="167 "></span>
<span class=linenos data-linenos="168 "></span><span class=sd>    and would be queried like:</span>
<span class=linenos data-linenos="169 "></span>
<span class=linenos data-linenos="170 "></span><span class=sd>    ```sql</span>
<span class=linenos data-linenos="171 "></span><span class=sd>    SELECT metric, value FROM ...</span>
<span class=linenos data-linenos="172 "></span><span class=sd>    ```</span>
<span class=linenos data-linenos="173 "></span>
<span class=linenos data-linenos="174 "></span><span class=sd>    In this case, the `metric` column stores the name with which to match on and its `value` is</span>
<span class=linenos data-linenos="175 "></span><span class=sd>    stored in a separate column.</span>
<span class=linenos data-linenos="176 "></span>
<span class=linenos data-linenos="177 "></span><span class=sd>    The required `items` modifier is a mapping of matched names to column data values. Consider the values</span>
<span class=linenos data-linenos="178 "></span><span class=sd>    to be exactly the same as the entries in the `columns` top level field. You must also define a `source`</span>
<span class=linenos data-linenos="179 "></span><span class=sd>    modifier either for this transformer itself or in the values of `items` (which will take precedence).</span>
<span class=linenos data-linenos="180 "></span><span class=sd>    The source will be treated as the value of the match.</span>
<span class=linenos data-linenos="181 "></span>
<span class=linenos data-linenos="182 "></span><span class=sd>    Say this is your configuration:</span>
<span class=linenos data-linenos="183 "></span>
<span class=linenos data-linenos="184 "></span><span class=sd>    ```yaml</span>
<span class=linenos data-linenos="185 "></span><span class=sd>    query: SELECT source1, source2, metric FROM TABLE</span>
<span class=linenos data-linenos="186 "></span><span class=sd>    columns:</span>
<span class=linenos data-linenos="187 "></span><span class=sd>      - name: value1</span>
<span class=linenos data-linenos="188 "></span><span class=sd>        type: source</span>
<span class=linenos data-linenos="189 "></span><span class=sd>      - name: value2</span>
<span class=linenos data-linenos="190 "></span><span class=sd>        type: source</span>
<span class=linenos data-linenos="191 "></span><span class=sd>      - name: metric_name</span>
<span class=linenos data-linenos="192 "></span><span class=sd>        type: match</span>
<span class=linenos data-linenos="193 "></span><span class=sd>        source: value1</span>
<span class=linenos data-linenos="194 "></span><span class=sd>        items:</span>
<span class=linenos data-linenos="195 "></span><span class=sd>          foo:</span>
<span class=linenos data-linenos="196 "></span><span class=sd>            name: test.foo</span>
<span class=linenos data-linenos="197 "></span><span class=sd>            type: gauge</span>
<span class=linenos data-linenos="198 "></span><span class=sd>            source: value2</span>
<span class=linenos data-linenos="199 "></span><span class=sd>          bar:</span>
<span class=linenos data-linenos="200 "></span><span class=sd>            name: test.bar</span>
<span class=linenos data-linenos="201 "></span><span class=sd>            type: monotonic_gauge</span>
<span class=linenos data-linenos="202 "></span><span class=sd>    ```</span>
<span class=linenos data-linenos="203 "></span>
<span class=linenos data-linenos="204 "></span><span class=sd>    and the result set is:</span>
<span class=linenos data-linenos="205 "></span>
<span class=linenos data-linenos="206 "></span><span class=sd>    | source1 | source2 | metric |</span>
<span class=linenos data-linenos="207 "></span><span class=sd>    | ------- | ------- | ------ |</span>
<span class=linenos data-linenos="208 "></span><span class=sd>    | 1       | 2       | foo    |</span>
<span class=linenos data-linenos="209 "></span><span class=sd>    | 3       | 4       | baz    |</span>
<span class=linenos data-linenos="210 "></span><span class=sd>    | 5       | 6       | bar    |</span>
<span class=linenos data-linenos="211 "></span>
<span class=linenos data-linenos="212 "></span><span class=sd>    Here&#39;s what would be submitted:</span>
<span class=linenos data-linenos="213 "></span>
<span class=linenos data-linenos="214 "></span><span class=sd>    - `foo` - `test.foo` as a `gauge` with a value of `2`</span>
<span class=linenos data-linenos="215 "></span><span class=sd>    - `bar` - `test.bar.total` as a `gauge` and `test.bar.count` as a `monotonic_count`, both with a value of `5`</span>
<span class=linenos data-linenos="216 "></span><span class=sd>    - `baz` - nothing since it was not defined as a match item</span>
<span class=linenos data-linenos="217 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="218 "></span>    <span class=c1># Do work in a separate function to avoid having to `del` a bunch of variables</span>
<span class=linenos data-linenos="219 "></span>    <span class=n>compiled_items</span> <span class=o>=</span> <span class=n>_compile_match_items</span><span class=p>(</span><span class=n>transformers</span><span class=p>,</span> <span class=n>modifiers</span><span class=p>)</span>  <span class=c1># type: Dict[str, Tuple[str, Transformer]]</span>
<span class=linenos data-linenos="220 "></span>
<span class=linenos data-linenos="221 "></span>    <span class=k>def</span> <span class=nf>match</span><span class=p>(</span><span class=n>sources</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=linenos data-linenos="222 "></span>        <span class=c1># type: (Dict[str, Any], str, Dict[str, Any]) -&gt; None</span>
<span class=linenos data-linenos="223 "></span>        <span class=k>if</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>compiled_items</span><span class=p>:</span>
<span class=linenos data-linenos="224 "></span>            <span class=n>source</span><span class=p>,</span> <span class=n>transformer</span> <span class=o>=</span> <span class=n>compiled_items</span><span class=p>[</span><span class=n>value</span><span class=p>]</span>  <span class=c1># type: str, Transformer</span>
<span class=linenos data-linenos="225 "></span>            <span class=n>transformer</span><span class=p>(</span><span class=n>sources</span><span class=p>,</span> <span class=n>sources</span><span class=p>[</span><span class=n>source</span><span class=p>],</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<span class=linenos data-linenos="226 "></span>
<span class=linenos data-linenos="227 "></span>    <span class=k>return</span> <span class=n>match</span>
</code></pre></div> </details> </div> </div><h4 id=temporal_percent>temporal_percent<a class=headerlink href=#temporal_percent title="Permanent link">&para;</a></h4> <div class="doc doc-object doc-function"> <div class="doc doc-contents first"> <p>Send the result as percentage of time since the last check run as a <code>rate</code>.</p> <p>For example, say the result is a forever increasing counter representing the total time spent pausing for garbage collection since start up. That number by itself is quite useless, but as a percentage of time spent pausing since the previous collection interval it becomes a useful metric.</p> <p>There is one required parameter called <code>scale</code> that indicates what unit of time the result should be considered. Valid values are:</p> <ul> <li><code>second</code></li> <li><code>millisecond</code></li> <li><code>microsecond</code></li> <li><code>nanosecond</code></li> </ul> <p>You may also define the unit as an integer number of parts compared to seconds e.g. <code>millisecond</code> is equivalent to <code>1000</code>.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/utils/db/transform.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="100 "></span><span class=k>def</span> <span class=nf>get_temporal_percent</span><span class=p>(</span><span class=n>transformers</span><span class=p>,</span> <span class=n>column_name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>):</span>
<span class=linenos data-linenos="101 "></span>    <span class=c1># type: (Dict[str, Transformer], str, Any) -&gt; Transformer</span>
<span class=linenos data-linenos="102 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="103 "></span><span class=sd>    Send the result as percentage of time since the last check run as a `rate`.</span>
<span class=linenos data-linenos="104 "></span>
<span class=linenos data-linenos="105 "></span><span class=sd>    For example, say the result is a forever increasing counter representing the total time spent pausing for</span>
<span class=linenos data-linenos="106 "></span><span class=sd>    garbage collection since start up. That number by itself is quite useless, but as a percentage of time spent</span>
<span class=linenos data-linenos="107 "></span><span class=sd>    pausing since the previous collection interval it becomes a useful metric.</span>
<span class=linenos data-linenos="108 "></span>
<span class=linenos data-linenos="109 "></span><span class=sd>    There is one required parameter called `scale` that indicates what unit of time the result should be considered.</span>
<span class=linenos data-linenos="110 "></span><span class=sd>    Valid values are:</span>
<span class=linenos data-linenos="111 "></span>
<span class=linenos data-linenos="112 "></span><span class=sd>    - `second`</span>
<span class=linenos data-linenos="113 "></span><span class=sd>    - `millisecond`</span>
<span class=linenos data-linenos="114 "></span><span class=sd>    - `microsecond`</span>
<span class=linenos data-linenos="115 "></span><span class=sd>    - `nanosecond`</span>
<span class=linenos data-linenos="116 "></span>
<span class=linenos data-linenos="117 "></span><span class=sd>    You may also define the unit as an integer number of parts compared to seconds e.g. `millisecond` is</span>
<span class=linenos data-linenos="118 "></span><span class=sd>    equivalent to `1000`.</span>
<span class=linenos data-linenos="119 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="120 "></span>    <span class=n>scale</span> <span class=o>=</span> <span class=n>modifiers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;scale&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
<span class=linenos data-linenos="121 "></span>    <span class=k>if</span> <span class=n>scale</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="122 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;the `scale` parameter is required&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="123 "></span>
<span class=linenos data-linenos="124 "></span>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>scale</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="125 "></span>        <span class=n>scale</span> <span class=o>=</span> <span class=n>constants</span><span class=o>.</span><span class=n>TIME_UNITS</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>scale</span><span class=o>.</span><span class=n>lower</span><span class=p>())</span>
<span class=linenos data-linenos="126 "></span>        <span class=k>if</span> <span class=n>scale</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="127 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
<span class=linenos data-linenos="128 "></span>                <span class=s1>&#39;the `scale` parameter must be one of: </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s1>&#39; | &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>sorted</span><span class=p>(</span><span class=n>constants</span><span class=o>.</span><span class=n>TIME_UNITS</span><span class=p>)))</span>
<span class=linenos data-linenos="129 "></span>            <span class=p>)</span>
<span class=linenos data-linenos="130 "></span>    <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>scale</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
<span class=linenos data-linenos="131 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
<span class=linenos data-linenos="132 "></span>            <span class=s1>&#39;the `scale` parameter must be an integer representing parts of a second e.g. 1000 for millisecond&#39;</span>
<span class=linenos data-linenos="133 "></span>        <span class=p>)</span>
<span class=linenos data-linenos="134 "></span>
<span class=linenos data-linenos="135 "></span>    <span class=n>rate</span> <span class=o>=</span> <span class=n>transformers</span><span class=p>[</span><span class=s1>&#39;rate&#39;</span><span class=p>](</span><span class=n>transformers</span><span class=p>,</span> <span class=n>column_name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>)</span>  <span class=c1># type: Callable</span>
<span class=linenos data-linenos="136 "></span>
<span class=linenos data-linenos="137 "></span>    <span class=k>def</span> <span class=nf>temporal_percent</span><span class=p>(</span><span class=n>_</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=linenos data-linenos="138 "></span>        <span class=c1># type: (List, str, Dict[str, Any]) -&gt; None</span>
<span class=linenos data-linenos="139 "></span>        <span class=n>rate</span><span class=p>(</span><span class=n>_</span><span class=p>,</span> <span class=n>total_time_to_temporal_percent</span><span class=p>(</span><span class=nb>float</span><span class=p>(</span><span class=n>value</span><span class=p>),</span> <span class=n>scale</span><span class=o>=</span><span class=n>scale</span><span class=p>),</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<span class=linenos data-linenos="140 "></span>
<span class=linenos data-linenos="141 "></span>    <span class=k>return</span> <span class=n>temporal_percent</span>
</code></pre></div> </details> </div> </div><h4 id=time_elapsed>time_elapsed<a class=headerlink href=#time_elapsed title="Permanent link">&para;</a></h4> <div class="doc doc-object doc-function"> <div class="doc doc-contents first"> <p>Send the number of seconds elapsed from a time in the past as a <code>gauge</code>.</p> <p>For example, if the result is an instance of <a href=https://docs.python.org/3/library/datetime.html#datetime.datetime>datetime.datetime</a> representing 5 seconds ago, then this would submit with a value of <code>5</code>.</p> <p>The optional modifier <code>format</code> indicates what format the result is in. By default it is <code>native</code>, assuming the underlying library provides timestamps as <code>datetime</code> objects.</p> <p>If the value is a UNIX timestamp you can set the <code>format</code> modifier to <code>unix_time</code>.</p> <p>If the value is a string representation of a date, you must provide the expected timestamp format using the <a href=https://docs.python.org/3/library/datetime.html#strftime-and-strptime-format-codes>supported codes</a>.</p> <p>Example:</p> <div class=highlight><pre><span></span><code><span class=nt>columns</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">time_since_x</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">time_elapsed</span>
<span class=w>    </span><span class=nt>format</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">native</span><span class=w>  </span><span class=c1># default value and can be omitted</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">time_since_y</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">time_elapsed</span>
<span class=w>    </span><span class=nt>format</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">unix_time</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">time_since_z</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">time_elapsed</span>
<span class=w>    </span><span class=nt>format</span><span class=p>:</span><span class=w> </span><span class=s>&quot;%d/%m/%Y</span><span class=nv> </span><span class=s>%H:%M:%S&quot;</span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The code <code>%z</code> (lower case) is not supported on Windows.</p> </div> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/utils/db/transform.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="267 "></span><span class=k>def</span> <span class=nf>get_time_elapsed</span><span class=p>(</span><span class=n>transformers</span><span class=p>,</span> <span class=n>column_name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>):</span>
<span class=linenos data-linenos="268 "></span>    <span class=c1># type: (Dict[str, Transformer], str, Any) -&gt; Transformer</span>
<span class=linenos data-linenos="269 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="270 "></span><span class=sd>    Send the number of seconds elapsed from a time in the past as a `gauge`.</span>
<span class=linenos data-linenos="271 "></span>
<span class=linenos data-linenos="272 "></span><span class=sd>    For example, if the result is an instance of</span>
<span class=linenos data-linenos="273 "></span><span class=sd>    [datetime.datetime](https://docs.python.org/3/library/datetime.html#datetime.datetime) representing 5 seconds ago,</span>
<span class=linenos data-linenos="274 "></span><span class=sd>    then this would submit with a value of `5`.</span>
<span class=linenos data-linenos="275 "></span>
<span class=linenos data-linenos="276 "></span><span class=sd>    The optional modifier `format` indicates what format the result is in. By default it is `native`, assuming the</span>
<span class=linenos data-linenos="277 "></span><span class=sd>    underlying library provides timestamps as `datetime` objects.</span>
<span class=linenos data-linenos="278 "></span>
<span class=linenos data-linenos="279 "></span><span class=sd>    If the value is a UNIX timestamp you can set the `format` modifier to `unix_time`.</span>
<span class=linenos data-linenos="280 "></span>
<span class=linenos data-linenos="281 "></span><span class=sd>    If the value is a string representation of a date, you must provide the expected timestamp format using the</span>
<span class=linenos data-linenos="282 "></span><span class=sd>    [supported codes](https://docs.python.org/3/library/datetime.html#strftime-and-strptime-format-codes).</span>
<span class=linenos data-linenos="283 "></span>
<span class=linenos data-linenos="284 "></span><span class=sd>    Example:</span>
<span class=linenos data-linenos="285 "></span>
<span class=linenos data-linenos="286 "></span><span class=sd>    ```yaml</span>
<span class=linenos data-linenos="287 "></span><span class=sd>    columns:</span>
<span class=linenos data-linenos="288 "></span><span class=sd>      - name: time_since_x</span>
<span class=linenos data-linenos="289 "></span><span class=sd>        type: time_elapsed</span>
<span class=linenos data-linenos="290 "></span><span class=sd>        format: native  # default value and can be omitted</span>
<span class=linenos data-linenos="291 "></span><span class=sd>      - name: time_since_y</span>
<span class=linenos data-linenos="292 "></span><span class=sd>        type: time_elapsed</span>
<span class=linenos data-linenos="293 "></span><span class=sd>        format: unix_time</span>
<span class=linenos data-linenos="294 "></span><span class=sd>      - name: time_since_z</span>
<span class=linenos data-linenos="295 "></span><span class=sd>        type: time_elapsed</span>
<span class=linenos data-linenos="296 "></span><span class=sd>        format: &quot;%d/%m/%Y %H:%M:%S&quot;</span>
<span class=linenos data-linenos="297 "></span><span class=sd>    ```</span>
<span class=linenos data-linenos="298 "></span><span class=sd>    !!! note</span>
<span class=linenos data-linenos="299 "></span><span class=sd>        The code `%z` (lower case) is not supported on Windows.</span>
<span class=linenos data-linenos="300 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="301 "></span>    <span class=n>time_format</span> <span class=o>=</span> <span class=n>modifiers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;format&#39;</span><span class=p>,</span> <span class=s1>&#39;native&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="302 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>time_format</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="303 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;the `format` parameter must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="304 "></span>
<span class=linenos data-linenos="305 "></span>    <span class=n>gauge</span> <span class=o>=</span> <span class=n>transformers</span><span class=p>[</span><span class=s1>&#39;gauge&#39;</span><span class=p>](</span><span class=n>transformers</span><span class=p>,</span> <span class=n>column_name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>)</span>
<span class=linenos data-linenos="306 "></span>
<span class=linenos data-linenos="307 "></span>    <span class=k>if</span> <span class=n>time_format</span> <span class=o>==</span> <span class=s1>&#39;native&#39;</span><span class=p>:</span>
<span class=linenos data-linenos="308 "></span>
<span class=linenos data-linenos="309 "></span>        <span class=k>def</span> <span class=nf>time_elapsed</span><span class=p>(</span><span class=n>_</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=linenos data-linenos="310 "></span>            <span class=c1># type: (List, str, Dict[str, Any]) -&gt; None</span>
<span class=linenos data-linenos="311 "></span>            <span class=n>value</span> <span class=o>=</span> <span class=n>ensure_aware_datetime</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
<span class=linenos data-linenos="312 "></span>            <span class=n>gauge</span><span class=p>(</span><span class=n>_</span><span class=p>,</span> <span class=p>(</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(</span><span class=n>value</span><span class=o>.</span><span class=n>tzinfo</span><span class=p>)</span> <span class=o>-</span> <span class=n>value</span><span class=p>)</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>(),</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<span class=linenos data-linenos="313 "></span>
<span class=linenos data-linenos="314 "></span>    <span class=k>elif</span> <span class=n>time_format</span> <span class=o>==</span> <span class=s1>&#39;unix_time&#39;</span><span class=p>:</span>
<span class=linenos data-linenos="315 "></span>
<span class=linenos data-linenos="316 "></span>        <span class=k>def</span> <span class=nf>time_elapsed</span><span class=p>(</span><span class=n>_</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=linenos data-linenos="317 "></span>            <span class=n>gauge</span><span class=p>(</span><span class=n>_</span><span class=p>,</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>value</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<span class=linenos data-linenos="318 "></span>
<span class=linenos data-linenos="319 "></span>    <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="320 "></span>
<span class=linenos data-linenos="321 "></span>        <span class=k>def</span> <span class=nf>time_elapsed</span><span class=p>(</span><span class=n>_</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=linenos data-linenos="322 "></span>            <span class=c1># type: (List, str, Dict[str, Any]) -&gt; None</span>
<span class=linenos data-linenos="323 "></span>            <span class=n>value</span> <span class=o>=</span> <span class=n>ensure_aware_datetime</span><span class=p>(</span><span class=n>datetime</span><span class=o>.</span><span class=n>strptime</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>time_format</span><span class=p>))</span>
<span class=linenos data-linenos="324 "></span>            <span class=n>gauge</span><span class=p>(</span><span class=n>_</span><span class=p>,</span> <span class=p>(</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(</span><span class=n>value</span><span class=o>.</span><span class=n>tzinfo</span><span class=p>)</span> <span class=o>-</span> <span class=n>value</span><span class=p>)</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>(),</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<span class=linenos data-linenos="325 "></span>
<span class=linenos data-linenos="326 "></span>    <span class=k>return</span> <span class=n>time_elapsed</span>
</code></pre></div> </details> </div> </div><h4 id=monotonic_gauge>monotonic_gauge<a class=headerlink href=#monotonic_gauge title="Permanent link">&para;</a></h4> <div class="doc doc-object doc-function"> <div class="doc doc-contents first"> <p>Send the result as both a <code>gauge</code> suffixed by <code>.total</code> and a <code>monotonic_count</code> suffixed by <code>.count</code>.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/utils/db/transform.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="82 "></span><span class=k>def</span> <span class=nf>get_monotonic_gauge</span><span class=p>(</span><span class=n>transformers</span><span class=p>,</span> <span class=n>column_name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>):</span>
<span class=linenos data-linenos="83 "></span>    <span class=c1># type: (Dict[str, Transformer], str, Any) -&gt; Transformer</span>
<span class=linenos data-linenos="84 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="85 "></span><span class=sd>    Send the result as both a `gauge` suffixed by `.total` and a `monotonic_count` suffixed by `.count`.</span>
<span class=linenos data-linenos="86 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="87 "></span>    <span class=n>gauge</span> <span class=o>=</span> <span class=n>transformers</span><span class=p>[</span><span class=s1>&#39;gauge&#39;</span><span class=p>](</span><span class=n>transformers</span><span class=p>,</span> <span class=s1>&#39;</span><span class=si>{}</span><span class=s1>.total&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>column_name</span><span class=p>),</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>)</span>  <span class=c1># type: Callable</span>
<span class=linenos data-linenos="88 "></span>    <span class=n>monotonic_count</span> <span class=o>=</span> <span class=n>transformers</span><span class=p>[</span><span class=s1>&#39;monotonic_count&#39;</span><span class=p>](</span>
<span class=linenos data-linenos="89 "></span>        <span class=n>transformers</span><span class=p>,</span> <span class=s1>&#39;</span><span class=si>{}</span><span class=s1>.count&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>column_name</span><span class=p>),</span> <span class=o>**</span><span class=n>modifiers</span>
<span class=linenos data-linenos="90 "></span>    <span class=p>)</span>  <span class=c1># type: Callable</span>
<span class=linenos data-linenos="91 "></span>
<span class=linenos data-linenos="92 "></span>    <span class=k>def</span> <span class=nf>monotonic_gauge</span><span class=p>(</span><span class=n>_</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=linenos data-linenos="93 "></span>        <span class=c1># type: (List, str, Dict[str, Any]) -&gt; None</span>
<span class=linenos data-linenos="94 "></span>        <span class=n>gauge</span><span class=p>(</span><span class=n>_</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<span class=linenos data-linenos="95 "></span>        <span class=n>monotonic_count</span><span class=p>(</span><span class=n>_</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<span class=linenos data-linenos="96 "></span>
<span class=linenos data-linenos="97 "></span>    <span class=k>return</span> <span class=n>monotonic_gauge</span>
</code></pre></div> </details> </div> </div><h4 id=service_check>service_check<a class=headerlink href=#service_check title="Permanent link">&para;</a></h4> <div class="doc doc-object doc-function"> <div class="doc doc-contents first"> <p>Submit a service check.</p> <p>The required modifier <code>status_map</code> is a mapping of values to statuses. Valid statuses include:</p> <ul> <li><code>OK</code></li> <li><code>WARNING</code></li> <li><code>CRITICAL</code></li> <li><code>UNKNOWN</code></li> </ul> <p>Any encountered values that are not defined will be sent as <code>UNKNOWN</code>.</p> <p>In addition, a <code>message</code> modifier can be passed which can contain placeholders (based on Python's str.format) for other column names from the same query to add a message dynamically to the service_check.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/utils/db/transform.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="230 "></span><span class=k>def</span> <span class=nf>get_service_check</span><span class=p>(</span><span class=n>transformers</span><span class=p>,</span> <span class=n>column_name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>):</span>
<span class=linenos data-linenos="231 "></span>    <span class=c1># type: (Dict[str, Transformer], str, Any) -&gt; Transformer</span>
<span class=linenos data-linenos="232 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="233 "></span><span class=sd>    Submit a service check.</span>
<span class=linenos data-linenos="234 "></span>
<span class=linenos data-linenos="235 "></span><span class=sd>    The required modifier `status_map` is a mapping of values to statuses. Valid statuses include:</span>
<span class=linenos data-linenos="236 "></span>
<span class=linenos data-linenos="237 "></span><span class=sd>    - `OK`</span>
<span class=linenos data-linenos="238 "></span><span class=sd>    - `WARNING`</span>
<span class=linenos data-linenos="239 "></span><span class=sd>    - `CRITICAL`</span>
<span class=linenos data-linenos="240 "></span><span class=sd>    - `UNKNOWN`</span>
<span class=linenos data-linenos="241 "></span>
<span class=linenos data-linenos="242 "></span><span class=sd>    Any encountered values that are not defined will be sent as `UNKNOWN`.</span>
<span class=linenos data-linenos="243 "></span>
<span class=linenos data-linenos="244 "></span><span class=sd>    In addition, a `message` modifier can be passed which can contain placeholders</span>
<span class=linenos data-linenos="245 "></span><span class=sd>    (based on Python&#39;s str.format) for other column names from the same query to add a message</span>
<span class=linenos data-linenos="246 "></span><span class=sd>    dynamically to the service_check.</span>
<span class=linenos data-linenos="247 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="248 "></span>    <span class=c1># Do work in a separate function to avoid having to `del` a bunch of variables</span>
<span class=linenos data-linenos="249 "></span>    <span class=n>status_map</span> <span class=o>=</span> <span class=n>_compile_service_check_statuses</span><span class=p>(</span><span class=n>modifiers</span><span class=p>)</span>
<span class=linenos data-linenos="250 "></span>    <span class=n>message_field</span> <span class=o>=</span> <span class=n>modifiers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;message&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
<span class=linenos data-linenos="251 "></span>
<span class=linenos data-linenos="252 "></span>    <span class=n>service_check_method</span> <span class=o>=</span> <span class=n>transformers</span><span class=p>[</span><span class=s1>&#39;__service_check&#39;</span><span class=p>](</span><span class=n>transformers</span><span class=p>,</span> <span class=n>column_name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>)</span>  <span class=c1># type: Callable</span>
<span class=linenos data-linenos="253 "></span>
<span class=linenos data-linenos="254 "></span>    <span class=k>def</span> <span class=nf>service_check</span><span class=p>(</span><span class=n>sources</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=linenos data-linenos="255 "></span>        <span class=c1># type: (List, str, Dict[str, Any]) -&gt; None</span>
<span class=linenos data-linenos="256 "></span>        <span class=n>check_status</span> <span class=o>=</span> <span class=n>status_map</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>ServiceCheck</span><span class=o>.</span><span class=n>UNKNOWN</span><span class=p>)</span>
<span class=linenos data-linenos="257 "></span>        <span class=k>if</span> <span class=ow>not</span> <span class=n>message_field</span> <span class=ow>or</span> <span class=n>check_status</span> <span class=o>==</span> <span class=n>ServiceCheck</span><span class=o>.</span><span class=n>OK</span><span class=p>:</span>
<span class=linenos data-linenos="258 "></span>            <span class=n>message</span> <span class=o>=</span> <span class=kc>None</span>
<span class=linenos data-linenos="259 "></span>        <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="260 "></span>            <span class=n>message</span> <span class=o>=</span> <span class=n>message_field</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=o>**</span><span class=n>sources</span><span class=p>)</span>
<span class=linenos data-linenos="261 "></span>
<span class=linenos data-linenos="262 "></span>        <span class=n>service_check_method</span><span class=p>(</span><span class=n>sources</span><span class=p>,</span> <span class=n>check_status</span><span class=p>,</span> <span class=n>message</span><span class=o>=</span><span class=n>message</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<span class=linenos data-linenos="263 "></span>
<span class=linenos data-linenos="264 "></span>    <span class=k>return</span> <span class=n>service_check</span>
</code></pre></div> </details> </div> </div><h4 id=tag>tag<a class=headerlink href=#tag title="Permanent link">&para;</a></h4> <div class="doc doc-object doc-function"> <div class="doc doc-contents first"> <p>Convert a column to a tag that will be used in every subsequent submission.</p> <p>For example, if you named the column <code>env</code> and the column returned the value <code>prod1</code>, all submissions from that row will be tagged by <code>env:prod1</code>.</p> <p>This also accepts an optional modifier called <code>boolean</code> that when set to <code>true</code> will transform the result to the string <code>true</code> or <code>false</code>. So for example if you named the column <code>alive</code> and the result was the number <code>0</code> the tag will be <code>alive:false</code>.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/utils/db/transform.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="34 "></span><span class=k>def</span> <span class=nf>get_tag</span><span class=p>(</span><span class=n>transformers</span><span class=p>,</span> <span class=n>column_name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>):</span>
<span class=linenos data-linenos="35 "></span>    <span class=c1># type: (Dict[str, Transformer], str, Any) -&gt; Transformer</span>
<span class=linenos data-linenos="36 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="37 "></span><span class=sd>    Convert a column to a tag that will be used in every subsequent submission.</span>
<span class=linenos data-linenos="38 "></span>
<span class=linenos data-linenos="39 "></span><span class=sd>    For example, if you named the column `env` and the column returned the value `prod1`, all submissions</span>
<span class=linenos data-linenos="40 "></span><span class=sd>    from that row will be tagged by `env:prod1`.</span>
<span class=linenos data-linenos="41 "></span>
<span class=linenos data-linenos="42 "></span><span class=sd>    This also accepts an optional modifier called `boolean` that when set to `true` will transform the result</span>
<span class=linenos data-linenos="43 "></span><span class=sd>    to the string `true` or `false`. So for example if you named the column `alive` and the result was the</span>
<span class=linenos data-linenos="44 "></span><span class=sd>    number `0` the tag will be `alive:false`.</span>
<span class=linenos data-linenos="45 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="46 "></span>    <span class=n>template</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=si>{}</span><span class=s1>:{{}}&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>column_name</span><span class=p>)</span>
<span class=linenos data-linenos="47 "></span>    <span class=n>boolean</span> <span class=o>=</span> <span class=n>is_affirmative</span><span class=p>(</span><span class=n>modifiers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;boolean&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>))</span>
<span class=linenos data-linenos="48 "></span>
<span class=linenos data-linenos="49 "></span>    <span class=k>def</span> <span class=nf>tag</span><span class=p>(</span><span class=n>_</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=linenos data-linenos="50 "></span>        <span class=c1># type: (List, str, Dict[str, Any]) -&gt; str</span>
<span class=linenos data-linenos="51 "></span>        <span class=k>if</span> <span class=n>boolean</span><span class=p>:</span>
<span class=linenos data-linenos="52 "></span>            <span class=n>value</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>is_affirmative</span><span class=p>(</span><span class=n>value</span><span class=p>))</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>
<span class=linenos data-linenos="53 "></span>
<span class=linenos data-linenos="54 "></span>        <span class=k>return</span> <span class=n>template</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
<span class=linenos data-linenos="55 "></span>
<span class=linenos data-linenos="56 "></span>    <span class=k>return</span> <span class=n>tag</span>
</code></pre></div> </details> </div> </div><h4 id=tag_list>tag_list<a class=headerlink href=#tag_list title="Permanent link">&para;</a></h4> <div class="doc doc-object doc-function"> <div class="doc doc-contents first"> <p>Convert a column to a list of tags that will be used in every submission.</p> <p>Tag name is determined by <code>column_name</code>. The column value represents a list of values. It is expected to be either a list of strings, or a comma-separated string.</p> <p>For example, if the column is named <code>server_tag</code> and the column returned the value <code>us,primary</code>, then all submissions for that row will be tagged by <code>server_tag:us</code> and <code>server_tag:primary</code>.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/utils/db/transform.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="59 "></span><span class=k>def</span> <span class=nf>get_tag_list</span><span class=p>(</span><span class=n>transformers</span><span class=p>,</span> <span class=n>column_name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>):</span>
<span class=linenos data-linenos="60 "></span>    <span class=c1># type: (Dict[str, Transformer], str, Any) -&gt; Transformer</span>
<span class=linenos data-linenos="61 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="62 "></span><span class=sd>    Convert a column to a list of tags that will be used in every submission.</span>
<span class=linenos data-linenos="63 "></span>
<span class=linenos data-linenos="64 "></span><span class=sd>    Tag name is determined by `column_name`. The column value represents a list of values. It is expected to be either</span>
<span class=linenos data-linenos="65 "></span><span class=sd>    a list of strings, or a comma-separated string.</span>
<span class=linenos data-linenos="66 "></span>
<span class=linenos data-linenos="67 "></span><span class=sd>    For example, if the column is named `server_tag` and the column returned the value `us,primary`, then all</span>
<span class=linenos data-linenos="68 "></span><span class=sd>    submissions for that row will be tagged by `server_tag:us` and `server_tag:primary`.</span>
<span class=linenos data-linenos="69 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="70 "></span>    <span class=n>template</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=si>%s</span><span class=s1>:</span><span class=si>{}</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>column_name</span>
<span class=linenos data-linenos="71 "></span>
<span class=linenos data-linenos="72 "></span>    <span class=k>def</span> <span class=nf>tag_list</span><span class=p>(</span><span class=n>_</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=linenos data-linenos="73 "></span>        <span class=c1># type: (List, str, Dict[str, Any]) -&gt; List[str]</span>
<span class=linenos data-linenos="74 "></span>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="75 "></span>            <span class=n>value</span> <span class=o>=</span> <span class=p>[</span><span class=n>v</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>value</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>)]</span>
<span class=linenos data-linenos="76 "></span>
<span class=linenos data-linenos="77 "></span>        <span class=k>return</span> <span class=p>[</span><span class=n>template</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>value</span><span class=p>]</span>
<span class=linenos data-linenos="78 "></span>
<span class=linenos data-linenos="79 "></span>    <span class=k>return</span> <span class=n>tag_list</span>
</code></pre></div> </details> </div> </div><h3 id=extra>Extra<a class=headerlink href=#extra title="Permanent link">&para;</a></h3> <p>Every column transformer (except <code>tag</code>) is supported at this level, the only difference being one must set a <code>source</code> to retrieve the desired value.</p> <p>So for example here:</p> <div class=highlight><pre><span></span><code><span class=nt>columns</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo.bar</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rate</span>
<span class=nt>extras</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo.current</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gauge</span>
<span class=w>    </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo.bar</span>
</code></pre></div> <p>the metric <code>foo.current</code> will be sent as a gauge with the value of <code>foo.bar</code>.</p> <h4 id=percent>percent<a class=headerlink href=#percent title="Permanent link">&para;</a></h4> <div class="doc doc-object doc-function"> <div class="doc doc-contents first"> <p>Send a percentage based on 2 sources as a <code>gauge</code>.</p> <p>The required modifiers are <code>part</code> and <code>total</code>.</p> <p>For example, if you have this configuration:</p> <div class=highlight><pre><span></span><code><span class=nt>columns</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.total</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gauge</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.used</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gauge</span>
<span class=nt>extras</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.utilized</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">percent</span>
<span class=w>    </span><span class=nt>part</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.used</span>
<span class=w>    </span><span class=nt>total</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.total</span>
</code></pre></div> <p>then the extra metric <code>disk.utilized</code> would be sent as a <code>gauge</code> calculated as <code>disk.used / disk.total * 100</code>.</p> <p>If the source of <code>total</code> is <code>0</code>, then the submitted value will always be sent as <code>0</code> too.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/utils/db/transform.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="436 "></span><span class=k>def</span> <span class=nf>get_percent</span><span class=p>(</span><span class=n>transformers</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>):</span>
<span class=linenos data-linenos="437 "></span>    <span class=c1># type: (Dict[str, Callable], str, Any) -&gt; Transformer</span>
<span class=linenos data-linenos="438 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="439 "></span><span class=sd>    Send a percentage based on 2 sources as a `gauge`.</span>
<span class=linenos data-linenos="440 "></span>
<span class=linenos data-linenos="441 "></span><span class=sd>    The required modifiers are `part` and `total`.</span>
<span class=linenos data-linenos="442 "></span>
<span class=linenos data-linenos="443 "></span><span class=sd>    For example, if you have this configuration:</span>
<span class=linenos data-linenos="444 "></span>
<span class=linenos data-linenos="445 "></span><span class=sd>    ```yaml</span>
<span class=linenos data-linenos="446 "></span><span class=sd>    columns:</span>
<span class=linenos data-linenos="447 "></span><span class=sd>      - name: disk.total</span>
<span class=linenos data-linenos="448 "></span><span class=sd>        type: gauge</span>
<span class=linenos data-linenos="449 "></span><span class=sd>      - name: disk.used</span>
<span class=linenos data-linenos="450 "></span><span class=sd>        type: gauge</span>
<span class=linenos data-linenos="451 "></span><span class=sd>    extras:</span>
<span class=linenos data-linenos="452 "></span><span class=sd>      - name: disk.utilized</span>
<span class=linenos data-linenos="453 "></span><span class=sd>        type: percent</span>
<span class=linenos data-linenos="454 "></span><span class=sd>        part: disk.used</span>
<span class=linenos data-linenos="455 "></span><span class=sd>        total: disk.total</span>
<span class=linenos data-linenos="456 "></span><span class=sd>    ```</span>
<span class=linenos data-linenos="457 "></span>
<span class=linenos data-linenos="458 "></span><span class=sd>    then the extra metric `disk.utilized` would be sent as a `gauge` calculated as `disk.used / disk.total * 100`.</span>
<span class=linenos data-linenos="459 "></span>
<span class=linenos data-linenos="460 "></span><span class=sd>    If the source of `total` is `0`, then the submitted value will always be sent as `0` too.</span>
<span class=linenos data-linenos="461 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="462 "></span>    <span class=n>available_sources</span> <span class=o>=</span> <span class=n>modifiers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;sources&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="463 "></span>
<span class=linenos data-linenos="464 "></span>    <span class=n>part</span> <span class=o>=</span> <span class=n>modifiers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;part&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
<span class=linenos data-linenos="465 "></span>    <span class=k>if</span> <span class=n>part</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="466 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;the `part` parameter is required&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="467 "></span>    <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>part</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="468 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;the `part` parameter must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="469 "></span>    <span class=k>elif</span> <span class=n>part</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>available_sources</span><span class=p>:</span>
<span class=linenos data-linenos="470 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;the `part` parameter `</span><span class=si>{}</span><span class=s1>` is not an available source&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>part</span><span class=p>))</span>
<span class=linenos data-linenos="471 "></span>
<span class=linenos data-linenos="472 "></span>    <span class=n>total</span> <span class=o>=</span> <span class=n>modifiers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;total&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
<span class=linenos data-linenos="473 "></span>    <span class=k>if</span> <span class=n>total</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="474 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;the `total` parameter is required&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="475 "></span>    <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>total</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="476 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;the `total` parameter must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="477 "></span>    <span class=k>elif</span> <span class=n>total</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>available_sources</span><span class=p>:</span>
<span class=linenos data-linenos="478 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;the `total` parameter `</span><span class=si>{}</span><span class=s1>` is not an available source&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>total</span><span class=p>))</span>
<span class=linenos data-linenos="479 "></span>
<span class=linenos data-linenos="480 "></span>    <span class=k>del</span> <span class=n>available_sources</span>
<span class=linenos data-linenos="481 "></span>    <span class=n>gauge</span> <span class=o>=</span> <span class=n>transformers</span><span class=p>[</span><span class=s1>&#39;gauge&#39;</span><span class=p>](</span><span class=n>transformers</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>)</span>
<span class=linenos data-linenos="482 "></span>    <span class=n>gauge</span> <span class=o>=</span> <span class=n>create_extra_transformer</span><span class=p>(</span><span class=n>gauge</span><span class=p>)</span>
<span class=linenos data-linenos="483 "></span>
<span class=linenos data-linenos="484 "></span>    <span class=k>def</span> <span class=nf>percent</span><span class=p>(</span><span class=n>sources</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=linenos data-linenos="485 "></span>        <span class=n>gauge</span><span class=p>(</span><span class=n>sources</span><span class=p>,</span> <span class=n>compute_percent</span><span class=p>(</span><span class=n>sources</span><span class=p>[</span><span class=n>part</span><span class=p>],</span> <span class=n>sources</span><span class=p>[</span><span class=n>total</span><span class=p>]),</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<span class=linenos data-linenos="486 "></span>
<span class=linenos data-linenos="487 "></span>    <span class=k>return</span> <span class=n>percent</span>
</code></pre></div> </details> </div> </div><h4 id=expression>expression<a class=headerlink href=#expression title="Permanent link">&para;</a></h4> <div class="doc doc-object doc-function"> <div class="doc doc-contents first"> <p>This allows the evaluation of a limited subset of Python syntax and built-in functions.</p> <div class=highlight><pre><span></span><code><span class=nt>columns</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.total</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gauge</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.used</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gauge</span>
<span class=nt>extras</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.free</span>
<span class=w>    </span><span class=nt>expression</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.total - disk.used</span>
<span class=w>    </span><span class=nt>submit_type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gauge</span>
</code></pre></div> <p>For brevity, if the <code>expression</code> attribute exists and <code>type</code> does not then it is assumed the type is <code>expression</code>. The <code>submit_type</code> can be any transformer and any extra options are passed down to it.</p> <p>The result of every expression is stored, so in lieu of a <code>submit_type</code> the above example could also be written as:</p> <div class=highlight><pre><span></span><code><span class=nt>columns</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.total</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gauge</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.used</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gauge</span>
<span class=nt>extras</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">free</span>
<span class=w>    </span><span class=nt>expression</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.total - disk.used</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.free</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gauge</span>
<span class=w>    </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">free</span>
</code></pre></div> <p>The order matters though, so for example the following will fail:</p> <div class=highlight><pre><span></span><code><span class=nt>columns</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.total</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gauge</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.used</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gauge</span>
<span class=nt>extras</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.free</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gauge</span>
<span class=w>    </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">free</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">free</span>
<span class=w>    </span><span class=nt>expression</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disk.total - disk.used</span>
</code></pre></div> <p>since the source <code>free</code> does not yet exist.</p> <details class=quote> <summary>Source code in <code>datadog_checks_base/datadog_checks/base/utils/db/transform.py</code></summary> <div class=highlight><pre><span></span><code><span class=linenos data-linenos="329 "></span><span class=k>def</span> <span class=nf>get_expression</span><span class=p>(</span><span class=n>transformers</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>):</span>
<span class=linenos data-linenos="330 "></span>    <span class=c1># type: (Dict[str, Transformer], str, Dict[str, Any]) -&gt; Transformer</span>
<span class=linenos data-linenos="331 "></span><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=linenos data-linenos="332 "></span><span class=sd>    This allows the evaluation of a limited subset of Python syntax and built-in functions.</span>
<span class=linenos data-linenos="333 "></span>
<span class=linenos data-linenos="334 "></span><span class=sd>    ```yaml</span>
<span class=linenos data-linenos="335 "></span><span class=sd>    columns:</span>
<span class=linenos data-linenos="336 "></span><span class=sd>      - name: disk.total</span>
<span class=linenos data-linenos="337 "></span><span class=sd>        type: gauge</span>
<span class=linenos data-linenos="338 "></span><span class=sd>      - name: disk.used</span>
<span class=linenos data-linenos="339 "></span><span class=sd>        type: gauge</span>
<span class=linenos data-linenos="340 "></span><span class=sd>    extras:</span>
<span class=linenos data-linenos="341 "></span><span class=sd>      - name: disk.free</span>
<span class=linenos data-linenos="342 "></span><span class=sd>        expression: disk.total - disk.used</span>
<span class=linenos data-linenos="343 "></span><span class=sd>        submit_type: gauge</span>
<span class=linenos data-linenos="344 "></span><span class=sd>    ```</span>
<span class=linenos data-linenos="345 "></span>
<span class=linenos data-linenos="346 "></span><span class=sd>    For brevity, if the `expression` attribute exists and `type` does not then it is assumed the type is</span>
<span class=linenos data-linenos="347 "></span><span class=sd>    `expression`. The `submit_type` can be any transformer and any extra options are passed down to it.</span>
<span class=linenos data-linenos="348 "></span>
<span class=linenos data-linenos="349 "></span><span class=sd>    The result of every expression is stored, so in lieu of a `submit_type` the above example could also be written as:</span>
<span class=linenos data-linenos="350 "></span>
<span class=linenos data-linenos="351 "></span><span class=sd>    ```yaml</span>
<span class=linenos data-linenos="352 "></span><span class=sd>    columns:</span>
<span class=linenos data-linenos="353 "></span><span class=sd>      - name: disk.total</span>
<span class=linenos data-linenos="354 "></span><span class=sd>        type: gauge</span>
<span class=linenos data-linenos="355 "></span><span class=sd>      - name: disk.used</span>
<span class=linenos data-linenos="356 "></span><span class=sd>        type: gauge</span>
<span class=linenos data-linenos="357 "></span><span class=sd>    extras:</span>
<span class=linenos data-linenos="358 "></span><span class=sd>      - name: free</span>
<span class=linenos data-linenos="359 "></span><span class=sd>        expression: disk.total - disk.used</span>
<span class=linenos data-linenos="360 "></span><span class=sd>      - name: disk.free</span>
<span class=linenos data-linenos="361 "></span><span class=sd>        type: gauge</span>
<span class=linenos data-linenos="362 "></span><span class=sd>        source: free</span>
<span class=linenos data-linenos="363 "></span><span class=sd>    ```</span>
<span class=linenos data-linenos="364 "></span>
<span class=linenos data-linenos="365 "></span><span class=sd>    The order matters though, so for example the following will fail:</span>
<span class=linenos data-linenos="366 "></span>
<span class=linenos data-linenos="367 "></span><span class=sd>    ```yaml</span>
<span class=linenos data-linenos="368 "></span><span class=sd>    columns:</span>
<span class=linenos data-linenos="369 "></span><span class=sd>      - name: disk.total</span>
<span class=linenos data-linenos="370 "></span><span class=sd>        type: gauge</span>
<span class=linenos data-linenos="371 "></span><span class=sd>      - name: disk.used</span>
<span class=linenos data-linenos="372 "></span><span class=sd>        type: gauge</span>
<span class=linenos data-linenos="373 "></span><span class=sd>    extras:</span>
<span class=linenos data-linenos="374 "></span><span class=sd>      - name: disk.free</span>
<span class=linenos data-linenos="375 "></span><span class=sd>        type: gauge</span>
<span class=linenos data-linenos="376 "></span><span class=sd>        source: free</span>
<span class=linenos data-linenos="377 "></span><span class=sd>      - name: free</span>
<span class=linenos data-linenos="378 "></span><span class=sd>        expression: disk.total - disk.used</span>
<span class=linenos data-linenos="379 "></span><span class=sd>    ```</span>
<span class=linenos data-linenos="380 "></span>
<span class=linenos data-linenos="381 "></span><span class=sd>    since the source `free` does not yet exist.</span>
<span class=linenos data-linenos="382 "></span><span class=sd>    &quot;&quot;&quot;</span>
<span class=linenos data-linenos="383 "></span>    <span class=n>available_sources</span> <span class=o>=</span> <span class=n>modifiers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;sources&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="384 "></span>
<span class=linenos data-linenos="385 "></span>    <span class=n>expression</span> <span class=o>=</span> <span class=n>modifiers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;expression&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
<span class=linenos data-linenos="386 "></span>    <span class=k>if</span> <span class=n>expression</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<span class=linenos data-linenos="387 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;the `expression` parameter is required&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="388 "></span>    <span class=k>elif</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>expression</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<span class=linenos data-linenos="389 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;the `expression` parameter must be a string&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="390 "></span>    <span class=k>elif</span> <span class=ow>not</span> <span class=n>expression</span><span class=p>:</span>
<span class=linenos data-linenos="391 "></span>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;the `expression` parameter must not be empty&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="392 "></span>
<span class=linenos data-linenos="393 "></span>    <span class=k>if</span> <span class=ow>not</span> <span class=n>modifiers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;verbose&#39;</span><span class=p>,</span> <span class=kc>False</span><span class=p>):</span>
<span class=linenos data-linenos="394 "></span>        <span class=c1># Sort the sources in reverse order of length to prevent greedy matching</span>
<span class=linenos data-linenos="395 "></span>        <span class=n>available_sources</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>available_sources</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>s</span><span class=p>:</span> <span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>s</span><span class=p>))</span>
<span class=linenos data-linenos="396 "></span>
<span class=linenos data-linenos="397 "></span>        <span class=c1># Escape special characters, mostly for the possible dots in metric names</span>
<span class=linenos data-linenos="398 "></span>        <span class=n>available_sources</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=n>re</span><span class=o>.</span><span class=n>escape</span><span class=p>,</span> <span class=n>available_sources</span><span class=p>))</span>
<span class=linenos data-linenos="399 "></span>
<span class=linenos data-linenos="400 "></span>        <span class=c1># Finally, utilize the order by relying on the guarantees provided by the alternation operator</span>
<span class=linenos data-linenos="401 "></span>        <span class=n>available_sources</span> <span class=o>=</span> <span class=s1>&#39;|&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>available_sources</span><span class=p>)</span>
<span class=linenos data-linenos="402 "></span>
<span class=linenos data-linenos="403 "></span>        <span class=n>expression</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span>
<span class=linenos data-linenos="404 "></span>            <span class=n>SOURCE_PATTERN</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>available_sources</span><span class=p>),</span>
<span class=linenos data-linenos="405 "></span>            <span class=c1># Replace by the particular source that matched</span>
<span class=linenos data-linenos="406 "></span>            <span class=k>lambda</span> <span class=n>match_obj</span><span class=p>:</span> <span class=s1>&#39;SOURCES[&quot;</span><span class=si>{}</span><span class=s1>&quot;]&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>match_obj</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)),</span>
<span class=linenos data-linenos="407 "></span>            <span class=n>expression</span><span class=p>,</span>
<span class=linenos data-linenos="408 "></span>        <span class=p>)</span>
<span class=linenos data-linenos="409 "></span>
<span class=linenos data-linenos="410 "></span>    <span class=n>expression</span> <span class=o>=</span> <span class=nb>compile</span><span class=p>(</span><span class=n>expression</span><span class=p>,</span> <span class=n>filename</span><span class=o>=</span><span class=n>name</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;eval&#39;</span><span class=p>)</span>
<span class=linenos data-linenos="411 "></span>
<span class=linenos data-linenos="412 "></span>    <span class=k>del</span> <span class=n>available_sources</span>
<span class=linenos data-linenos="413 "></span>
<span class=linenos data-linenos="414 "></span>    <span class=k>if</span> <span class=s1>&#39;submit_type&#39;</span> <span class=ow>in</span> <span class=n>modifiers</span><span class=p>:</span>
<span class=linenos data-linenos="415 "></span>        <span class=k>if</span> <span class=n>modifiers</span><span class=p>[</span><span class=s1>&#39;submit_type&#39;</span><span class=p>]</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>transformers</span><span class=p>:</span>
<span class=linenos data-linenos="416 "></span>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;unknown submit_type `</span><span class=si>{}</span><span class=s1>`&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>modifiers</span><span class=p>[</span><span class=s1>&#39;submit_type&#39;</span><span class=p>]))</span>
<span class=linenos data-linenos="417 "></span>
<span class=linenos data-linenos="418 "></span>        <span class=n>submit_method</span> <span class=o>=</span> <span class=n>transformers</span><span class=p>[</span><span class=n>modifiers</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;submit_type&#39;</span><span class=p>)](</span><span class=n>transformers</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=o>**</span><span class=n>modifiers</span><span class=p>)</span>  <span class=c1># type: Transformer</span>
<span class=linenos data-linenos="419 "></span>        <span class=n>submit_method</span> <span class=o>=</span> <span class=n>create_extra_transformer</span><span class=p>(</span><span class=n>submit_method</span><span class=p>)</span>  <span class=c1># type: Callable</span>
<span class=linenos data-linenos="420 "></span>
<span class=linenos data-linenos="421 "></span>        <span class=k>def</span> <span class=nf>execute_expression</span><span class=p>(</span><span class=n>sources</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=linenos data-linenos="422 "></span>            <span class=c1># type: (Dict[str, Any], Dict[str, Any]) -&gt; float</span>
<span class=linenos data-linenos="423 "></span>            <span class=n>result</span> <span class=o>=</span> <span class=nb>eval</span><span class=p>(</span><span class=n>expression</span><span class=p>,</span> <span class=n>ALLOWED_GLOBALS</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;SOURCES&#39;</span><span class=p>:</span> <span class=n>sources</span><span class=p>})</span>  <span class=c1># type: float</span>
<span class=linenos data-linenos="424 "></span>            <span class=n>submit_method</span><span class=p>(</span><span class=n>sources</span><span class=p>,</span> <span class=n>result</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<span class=linenos data-linenos="425 "></span>            <span class=k>return</span> <span class=n>result</span>
<span class=linenos data-linenos="426 "></span>
<span class=linenos data-linenos="427 "></span>    <span class=k>else</span><span class=p>:</span>
<span class=linenos data-linenos="428 "></span>
<span class=linenos data-linenos="429 "></span>        <span class=k>def</span> <span class=nf>execute_expression</span><span class=p>(</span><span class=n>sources</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=linenos data-linenos="430 "></span>            <span class=c1># type: (Dict[str, Any], Dict[str, Any]) -&gt; Any</span>
<span class=linenos data-linenos="431 "></span>            <span class=k>return</span> <span class=nb>eval</span><span class=p>(</span><span class=n>expression</span><span class=p>,</span> <span class=n>ALLOWED_GLOBALS</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;SOURCES&#39;</span><span class=p>:</span> <span class=n>sources</span><span class=p>})</span>
<span class=linenos data-linenos="432 "></span>
<span class=linenos data-linenos="433 "></span>    <span class=k>return</span> <span class=n>execute_expression</span>
</code></pre></div> </details> </div> </div> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">September 15, 2023</span> </small> </div> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../tls/ class="md-footer__link md-footer__link--prev" aria-label="Previous: TLS/SSL"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> TLS/SSL </div> </div> </a> <a href=../openmetrics/ class="md-footer__link md-footer__link--next" aria-label="Next: OpenMetrics"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> OpenMetrics </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; Datadog, Inc. 2020-present </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://www.datadoghq.com/blog/engineering/ target=_blank rel=noopener title=www.datadoghq.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M192 32c0 17.7 14.3 32 32 32 123.7 0 224 100.3 224 224 0 17.7 14.3 32 32 32s32-14.3 32-32C512 128.9 383.1 0 224 0c-17.7 0-32 14.3-32 32zm0 96c0 17.7 14.3 32 32 32 70.7 0 128 57.3 128 128 0 17.7 14.3 32 32 32s32-14.3 32-32c0-106-86-192-192-192-17.7 0-32 14.3-32 32zm-96 16c0-26.5-21.5-48-48-48S0 117.5 0 144v224c0 79.5 64.5 144 144 144s144-64.5 144-144-64.5-144-144-144h-16v96h16c26.5 0 48 21.5 48 48s-21.5 48-48 48-48-21.5-48-48V144z"/></svg> </a> <a href=https://github.com/DataDog target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> <a href=https://twitter.com/datadoghq target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://www.instagram.com/datadoghq target=_blank rel=noopener title=www.instagram.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["content.action.edit", "content.code.copy", "navigation.expand", "navigation.footer", "navigation.instant", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.cd18aaf1.min.js></script> </body> </html>